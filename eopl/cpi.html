<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.8" />
  <title>5 传递续文的解释器</title>
  <link rel="stylesheet" type="text/css" href="scribble.css" title="default" />
  <link rel="stylesheet" type="text/css" href="racket.css" title="default" />
  <link rel="stylesheet" type="text/css" href="tip.css" title="default" />
  <link rel="stylesheet" type="text/css" href="footnote.css" title="default" />
  <script type="text/javascript" src="scribble-common.js"></script>
  <script src="katex/katex.min.js"></script>
  <script src="onload.js"></script>

</head>

<body id="scribble-racket-lang-org">
  <div class="tocset">
    <div class="tocview">
      <div class="tocviewlist tocviewlisttopspace">
        <div class="tocviewtitle">
          <table cellspacing="0" cellpadding="0">
            <tr>
              <td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle"
                  onclick="TocviewToggle(this," tocview_0");">▼</a></td>
              <td></td>
              <td><a href="index.html" class="tocviewlink" data-pltdoc="x">编程语言要素</a></td>
            </tr>
          </table>
        </div>
        <div class="tocviewsublisttop" style="display: block;" id="tocview_0">
          <table cellspacing="0" cellpadding="0">
            <tr>
              <td align="right"></td>
              <td><a href="fw-trans.html" class="tocviewlink" data-pltdoc="x">译者的话</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="glo.html" class="tocviewlink" data-pltdoc="x">译名表</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="fw.html" class="tocviewlink" data-pltdoc="x">序</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="pf.html" class="tocviewlink" data-pltdoc="x">前言</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="awk.html" class="tocviewlink" data-pltdoc="x">致谢</a></td>
            </tr>
            <tr>
              <td align="right">1 </td>
              <td><a href="isd.html" class="tocviewlink" data-pltdoc="x">归纳式数据集</a></td>
            </tr>
            <tr>
              <td align="right">2 </td>
              <td><a href="da.html" class="tocviewlink" data-pltdoc="x">数据抽象</a></td>
            </tr>
            <tr>
              <td align="right">3 </td>
              <td><a href="expr.html" class="tocviewlink" data-pltdoc="x">表达式</a></td>
            </tr>
            <tr>
              <td align="right">4 </td>
              <td><a href="state.html" class="tocviewlink" data-pltdoc="x">状态</a></td>
            </tr>
            <tr>
              <td align="right">5 </td>
              <td><a href="" class="tocviewselflink" data-pltdoc="x">传递续文的解释器</a></td>
            </tr>
            <tr>
              <td align="right">6 </td>
              <td><a href="cps.html" class="tocviewlink" data-pltdoc="x">续文传递风格</a></td>
            </tr>
            <tr>
              <td align="right">7 </td>
              <td><a href="types.html" class="tocviewlink" data-pltdoc="x">类型</a></td>
            </tr>
            <tr>
              <td align="right">8 </td>
              <td><a href="modules.html" class="tocviewlink" data-pltdoc="x">模块</a></td>
            </tr>
            <tr>
              <td align="right">9 </td>
              <td><a href="oac.html" class="tocviewlink" data-pltdoc="x">对象和类</a></td>
            </tr>
            <tr>
              <td align="right">10 </td>
              <td><a href="further-reading.html" class="tocviewlink" data-pltdoc="x">扩展阅读</a></td>
            </tr>
            <tr>
              <td align="right">11 </td>
              <td><a href="sllgen-parsing-system.html" class="tocviewlink" data-pltdoc="x">SLLGEN解析系统</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="bib.html" class="tocviewlink" data-pltdoc="x">参考书目</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="indices.html" class="tocviewlink" data-pltdoc="x">索引</a></td>
            </tr>
          </table>
        </div>
      </div>
      <div class="tocviewlist">
        <table cellspacing="0" cellpadding="0">
          <tr>
            <td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle"
                onclick="TocviewToggle(this," tocview_1");">►</a></td>
            <td>5 </td>
            <td><a href="" class="tocviewselflink" data-pltdoc="x">传递续文的解释器</a></td>
          </tr>
        </table>
        <div class="tocviewsublistbottom" style="display: none;" id="tocview_1">
          <table cellspacing="0" cellpadding="0">
            <tr>
              <td align="right">5.1 </td>
              <td><a href="#%28part._s5..1%29" class="tocviewlink" data-pltdoc="x">传递续文的解释器</a></td>
            </tr>
            <tr>
              <td align="right">5.2 </td>
              <td><a href="#%28part._s5..2%29" class="tocviewlink" data-pltdoc="x">跳跃式解释器</a></td>
            </tr>
            <tr>
              <td align="right">5.3 </td>
              <td><a href="#%28part._s5..3%29" class="tocviewlink" data-pltdoc="x">指令式解释器</a></td>
            </tr>
            <tr>
              <td align="right">5.4 </td>
              <td><a href="#%28part._s5..4%29" class="tocviewlink" data-pltdoc="x">异常</a></td>
            </tr>
            <tr>
              <td align="right">5.5 </td>
              <td><a href="#%28part._s5..5%29" class="tocviewlink" data-pltdoc="x">线程</a></td>
            </tr>
          </table>
        </div>
      </div>
    </div>
    <div class="tocsub">
      <div class="tocsubtitle">On this page:</div>
      <table class="tocsublist" cellspacing="0">
        <tr>
          <td><span class="tocsublinknumber">5.1<tt> </tt></span><a href="#%28part._s5..1%29" class="tocsubseclink"
              data-pltdoc="x">传递续文的解释器</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">5.2<tt> </tt></span><a href="#%28part._s5..2%29" class="tocsubseclink"
              data-pltdoc="x">跳跃式解释器</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">5.3<tt> </tt></span><a href="#%28part._s5..3%29" class="tocsubseclink"
              data-pltdoc="x">指令式解释器</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">5.4<tt> </tt></span><a href="#%28part._s5..4%29" class="tocsubseclink"
              data-pltdoc="x">异常</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">5.5<tt> </tt></span><a href="#%28part._s5..5%29" class="tocsubseclink"
              data-pltdoc="x">线程</a></td>
        </tr>
      </table>
    </div>
  </div>
  <div class="maincolumn">
    <div class="main">
      <div class="navsettop"><span class="navleft">
          <div class="nosearchform"></div>  <span class="tocsettoggle">  <a href="javascript:void(0);"
              title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span>
        </span><span class="navright">  <a href="state.html" title="backward to " 4 状态"" data-pltdoc="x">← prev</a>  <a
            href="index.html" title="up to " 编程语言要素"" data-pltdoc="x">up</a>  <a href="cps.html" title="forward to " 6
            续文传递风格"" data-pltdoc="x">next →</a></span> </div>
      <h3>5<tt> </tt><a name="(part._cpi)"></a>传递续文的解释器</h3>
      <p><a name="(idx._(gentag._726))"></a>
        <a name="(idx._(gentag._727))"></a>
        在<a href="expr.html" data-pltdoc="x">表达式</a>，我们用环境的概念探讨绑定行为，建立每部分程序执行的数据上下文。
        这里，我们将用类似方式探讨每部分程序执行的<span class="emph">控制上下文</span> (<span class="emph">control context</span>)。
        我们将介绍<span class="emph">续文</span> (<span class="emph">continuation</span>) 的概念，用来抽象控制上下文。我们将要编写的
        解释器会取一续文参数，从而彰显控制上下文。
      </p>
      <p>考虑下面的Scheme阶乘函数定义。</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fact</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                  class="hspace"> </span><span class="RktSym">n</span><span class="RktPn">)</span><span
                  class="hspace"> </span><span class="RktVal">1</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">*</span><span class="hspace"> </span><span
                  class="RktSym">n</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">fact</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym"><span class="nobreak">-</span></span><span class="hspace"> </span><span
                  class="RktSym">n</span><span class="hspace"> </span><span class="RktVal">1</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>我们可以用推导建模 <span class="stt">fact</span> 的计算过程：</p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(fact 4)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (* 4 (fact 3))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (* 4 (* 3 (fact 2)))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (* 4 (* 3 (* 2 (fact 1))))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (* 4 (* 3 (* 2 (* 1 (fact 0)))))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (* 4 (* 3 (* 2 (* 1 1))))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (* 4 (* 3 (* 2 1)))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (* 4 (* 3 2))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (* 4 6)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= 24</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>这是阶乘的自然递归定义。每次调用 <span class="stt">fact</span> 都保证返回值与调用处的 <span class="stt">n</span> 相乘。
        这样，随着计算进行，<span class="stt">fact</span> 在越来越大的<span class="emph">控制上下文</span> 中调用。比较这一行为
        与下列过程。</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">fact-iter</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">fact-iter-acc</span><span class="hspace"> </span><span class="RktSym">n</span><span
                    class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">fact-iter-acc</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                    class="hspace"> </span><span class="RktSym">a</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                    class="hspace"> </span><span class="RktSym">n</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktSym">a</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">fact-iter-acc</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym"><span class="nobreak">-</span></span><span
                    class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                    class="RktVal">1</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">*</span><span class="hspace"> </span><span
                    class="RktSym">n</span><span class="hspace"> </span><span class="RktSym">a</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>用这个定义，我们计算：</p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(</span><a
                    name="(elem._fact-iter)"></a><span class="stt">fact-iter 4)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (fact-iter-acc 4 1)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (fact-iter-acc 3 4)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (fact-iter-acc 2 12)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (fact-iter-acc 1 24)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (fact-iter-acc 0 24)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= 24</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>这里，<span class="stt">fact-iter-acc</span> 总是在同样的控制上下文内调用：在本例中，是没有任何上下
        文。当 <span class="stt">fact-iter-acc</span> 调用自身时，它在 <span class="stt">fact-iter-acc</span> 执行的
        “尾端”，除了把返回值作为 <span class="stt">fact-iter-acc</span> 调用的结
        果，不需再做任何保证。我们称之为<span class="emph">尾调用</span> (<span class="emph">tail call</span>)。这样，上述推导中的每
        一步都形如 <span class="stt">(fact-iter-acc </span><span class="texMathInline">n</span><span class="stt">
        </span><span class="texMathInline">a</span><span class="stt">)</span>。<a name="(idx._(gentag._728))"></a></p>
      <p>当 <span class="stt">fact</span> 这样的过程执行时，每次递归调用都要记录额外的控制信息，此信息保留到
        调用返回为止。在上面的第一个推导中，这反映了控制上下文的增长。这样的过程呈现
        出<span class="emph">递归性控制行为</span> (<span class="emph">recursive control behavior</span>)。
        <a name="(idx._(gentag._729))"></a>
      </p>
      <p>与之相对，<span class="stt">fact-iter-acc</span> 调用自身时，不需记录额外的控制信息。递归调用发生在
        表达式的同一层（上述推导的最外层）反映了这一点。在这种情况下，当递归深度（没有对
        应返回的递归调用数目）增加时，系统不需要不断增长的内存存放控制上下文。只需使用有
        限内存存放控制信息的过程呈现出<span class="emph">迭代性控制行为</span> (<span class="emph">iterative control behavior</span>)。
        <a name="(idx._(gentag._730))"></a>
        <a name="(idx._(gentag._731))"></a>
      </p>
      <p><a name="(idx._(gentag._732))"></a>
        为什么这些程序呈现出不同的控制行为呢？在阶乘的递归定义中，过程 <span class="stt">fact</span>
        在<span class="emph">操作数位置</span> (<span class="emph">operand position</span>) 调用。我们需要保存这个调用的上下文，
        因为我们需要记住，过程调用执行完毕之后，仍需求出操作数的值，并执行外层调用，在本
        例中，是完成待做的乘法。这给出一条重要原则：</p>
      <blockquote class="Tip">
        <blockquote class="SCentered">
          <p><span style="font-weight: bold">不是过程调用，而是操作数的求值导致控制上下文扩大。</span>
            <a name="(idx._(gentag._733))"></a>
          </p>
        </blockquote>
      </blockquote>
      <p>本章，我们学习如何跟踪和操作控制上下文。我们的核心工具是
        名为<span class="emph">续文</span> (<span class="emph">continuation</span>) 的数据类型。就像环境是数据上下文的抽象表示，续文
        是控制上下文的抽象表示。我们将探索续文，编写直接传递续文参数的解释器，就像之前直
        接传递环境参数的解释器。一旦处理了简单情况，我们就能明白如何给语言添加组件，以更
        加复杂的方式处理控制上下文，譬如异常和线程。</p>
      <p>在<a href="cps.html" data-pltdoc="x">续文传递风格</a>，我们展示如何用转换解释器的技术转换所有程序。我们说以这种方式转换
        而得的程序具有<span class="emph">续文传递风格</span> (<span class="emph">continuation-passing style</span>)。<a
          href="cps.html" data-pltdoc="x">续文传递风格</a>还
        展示了续文的其他一些重要应用。
        <a name="(idx._(gentag._734))"></a>
        <a name="(idx._(gentag._735))"></a>
      </p>
      <h4>5.1<tt> </tt><a name="(part._s5..1)"></a>传递续文的解释器</h4>
      <p><a name="(idx._(gentag._736))"></a>
        <a name="(idx._(gentag._737))"></a>
        <a name="(idx._(gentag._738))"></a>
        <a name="(idx._(gentag._739))"></a>
        在我们的新解释器中，<span class="stt">value-of</span> 等主要过程将取第三个参数。这一参数——<span class="emph">续
          文</span>——用来抽象每个表达式求值时的控制上下文。
      </p>
      <p>我们从<span class="EoplFigureRef"></span>，即<a href="expr.html#%28part._s3..4%29"
          data-pltdoc="x">LETREC：支持递归过程的语言</a>中的 LETREC 语言解释器入手。我们把
        <span class="stt">value-of-program</span> 的结果叫做 <span
          class="texMathInline">\mathit{FinalAnswer}</span>，以强调这个表达值是程
        序的最终值。
      </p>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="texMathInline">\mathit{FinalAnswer}</span> = <span
                  class="texMathInline">\mathit{ExpVal}</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">value-of-program</span></span> : <span
                  class="texMathInline">\mathit{Program} \to \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">value-of-program</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">pgm</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">program</span><span class="hspace"> </span><span
                  class="RktSym">pgm</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">a-program</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">init-env</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">value-of</span></span> : <span
                  class="texMathInline">\mathit{Exp} \times \mathit{Env} \to \mathit{ExpVal}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">value-of</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                  class="RktSym">exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">const-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">num</span><span class="RktPn">)</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">num-val</span><span class="hspace"> </span><span
                  class="RktSym">num</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">var-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">apply-env</span><span class="hspace"> </span><span class="RktSym">env</span><span
                  class="hspace"> </span><span class="RktSym">var</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">diff-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">num1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->num</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">              </span><span class="RktPn">(</span><span
                  class="RktSym">num2</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->num</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">num-val</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym"><span class="nobreak">-</span></span><span class="hspace"> </span><span
                  class="RktSym">num1</span><span class="hspace"> </span><span class="RktSym">num2</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">zero?-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">num1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->num</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                  class="hspace"> </span><span class="RktSym">num1</span><span class="RktPn">)</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">bool-val</span><span
                  class="hspace"> </span><span class="RktVal">#t</span><span class="RktPn">)</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">bool-val</span><span
                  class="hspace"> </span><span class="RktVal">#f</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">if-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">exp2</span><span class="hspace"> </span><span
                  class="RktSym">exp3</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">expval->bool</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">value-of</span><span
                  class="hspace"> </span><span class="RktSym">exp1</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp3</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">let-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">exp1</span><span class="hspace"> </span><span
                  class="RktSym">body</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">val1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">extend-env</span><span
                  class="hspace"> </span><span class="RktSym">var</span><span class="hspace"> </span><span
                  class="RktSym">val1</span><span class="hspace"> </span><span class="RktSym">env</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">proc-val</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">procedure</span><span class="hspace"> </span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">body</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">call-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">rator</span><span class="hspace"> </span><span class="RktSym">rand</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">proc1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->proc</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">rator</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">              </span><span class="RktPn">(</span><span
                  class="RktSym">arg</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">rand</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">apply-procedure</span><span class="hspace"> </span><span
                  class="RktSym">proc1</span><span class="hspace"> </span><span class="RktSym">arg</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">letrec-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">p-name</span><span class="hspace"> </span><span class="RktSym">b-var</span><span
                  class="hspace"> </span><span class="RktSym">p-body</span><span class="hspace"> </span><span
                  class="RktSym">letrec-body</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">letrec-body</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">extend-env-rec</span><span class="hspace"> </span><span
                  class="RktSym">p-name</span><span class="hspace"> </span><span class="RktSym">b-var</span><span
                  class="hspace"> </span><span class="RktSym">p-body</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">apply-procedure</span></span> : <span
                  class="texMathInline">\mathit{Proc} \times \mathit{ExpVal} \to \mathit{ExpVal}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-procedure</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">proc1</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">proc</span><span class="hspace"> </span><span
                  class="RktSym">proc1</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">procedure</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">extend-env</span><span
                  class="hspace"> </span><span class="RktSym">var</span><span class="hspace"> </span><span
                  class="RktSym">val</span><span class="hspace"> </span><span class="RktSym">saved-env</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p>传递环境的解释器<a name="(elem._fig-5..1)"></a></p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._740))"></a></div>
        </p>
      </blockquote>
      <p>我们的目标是重写解释器，避免在调用 <span class="stt">value-of</span> 时产生控制上下文。当控制上下文
        需要增加时，我们扩展续文参数，就像在<a href="expr.html" data-pltdoc="x">表达式</a>中，程序产生数据上下文时，扩展
        解释器的环境一样。彰显控制上下文，我们就能看到它如何消长。之后，
        从<a href="#%28part._s5..4%29" data-pltdoc="x">异常</a>到<a href="#%28part._s5..5%29"
          data-pltdoc="x">线程</a>，我们将用它给我们的语言添加新的控制行为。</p>
      <p>现在，我们知道环境表示一个从符号到指代值的函数。续文表示什么呢？表达式的续文表示
        一个过程，它取表达式的结果，完成计算。所以我们的接口必须包含一个过程
        <span class="stt">apply-cont</span>，它取一续文 <span class="stt">cont</span>，一个表达值 <span class="stt">val</span>，完成由
        <span class="stt">cont</span> 指
        定的计算。<span class="stt">apply-cont</span> 的合约为：
      </p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="texMathInline">\mathit{FinalAnswer}</span> = <span
                    class="texMathInline">\mathit{ExpVal}</span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">apply-cont</span></span> : <span
                    class="texMathInline">\mathit{Cont} \times \mathit{ExpVal} \to \mathit{FinalAnswer}</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>我们把 <span class="stt">apply-cont</span> 的结果叫做 <span class="texMathInline">\mathit{FinalAnswer}</span>
          是为了提醒自己，它是
          计算最终的值：程序的其他部分都不用它。</p>
      </blockquote>
      <p>接口应该包含什么样的续文构造器？随着我们分析解释器，这些续文构造器自会显现。首先，
        我们需要一个续文构造器，在不需再对计算值进行操作时生成上下文。我们把这个续文叫做
        <span class="stt">(end-cont)</span>，其定义为：
      </p>
      <blockquote class="SubFlow">
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(apply-cont (end-cont) </span><span class="texMathInline">val</span><span
                    class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (begin</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(eopl:printf
                    "计算结束.~%")</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                    class="texMathInline">val</span><span class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>调用 <span class="stt">(end-cont)</span> 打印出一条计算结束消息，并返回程序的值。因为
          <span class="stt">(end-cont)</span> 打印出一条消息，我们可以看出它调用了多少次。在正确的计算中，它只
          应调用一次。
        </p>
      </blockquote>
      <p>我们把 <span class="stt">value-of-program</span> 重写为：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">value-of-program</span></span> : <span
                  class="texMathInline">\mathit{Program} \to \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">value-of-program</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">pgm</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">program</span><span class="hspace"> </span><span
                  class="RktSym">pgm</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">a-program</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">init-env</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">end-cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>现在我们可以写出 <span class="stt">value-of/k</span>。我们依次考虑 <span class="stt">value-of</span> 的各个分支。
        <span class="stt">value-of</span> 的前几行只是算出一个值，然后返回，不会再次调用 <span class="stt">value-of</span>。在传
        递续文的解释器中，这些行调用 <span class="stt">apply-cont</span>，把对应的值传给续文：
      </p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">value-of/k</span></span> : <span
                  class="texMathInline">\mathit{Exp} \times \mathit{Env} \times \mathit{Cont} \to \mathit{ExpVal}</span>
              </td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">value-of/k</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                  class="RktSym">exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">const-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">num</span><span class="RktPn">)</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">apply-cont</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">num-val</span><span class="hspace"> </span><span class="RktSym">num</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">var-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">apply-env</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktSym">var</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="hspace"> </span><span class="RktSym">cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">proc-val</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">procedure</span><span class="hspace"> </span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">body</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktSym">...</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>目前，<span class="stt">cont</span> 唯一可能的值是终止续文，但这马上就会改变。很容易看出，如果程序为
        上述表达式之一，表达式的值将传给 <span class="stt">end-cont</span>（通过 <span class="stt">apply-cont</span>）。</p>
      <p><span class="stt">letrec</span> 的行为也不复杂：它不调用 <span class="stt">value-of</span>，而是创建一个新环境，然后在新
        环境中求主体的值，主体的值就是整个表达式的值。这表明主体和整个表达式在同样的控制
        上下文中执行。因此，主体的值应返回给整个表达式的续文。所以我们写：
        <a name="(idx._(gentag._741))"></a>
      </p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span
                  class="RktSym">letrec-exp</span><span class="RktMeta"></span><span class="hspace"> </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">p-name</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktSym">p-var</span><span class="RktMeta"></span><span class="hspace"> </span><span
                  class="RktMeta"></span><span class="RktSym">p-body</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">letrec-body</span><span
                  class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktSym">letrec-body</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">extend-env-rec</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktSym">p-name</span><span class="RktMeta"></span><span class="hspace"> </span><span
                  class="RktMeta"></span><span class="RktSym">p-var</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">p-body</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktSym">env</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                  class="RktMeta"></span><span class="RktSym">cont</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>这解释了一条通用原则：</p>
      <blockquote class="Tip">
        <blockquote class="SCentered">
          <p><span style="font-weight: bold">尾调用不扩大续文
              <a name="(idx._(gentag._742))"></a>
              <a name="(idx._(gentag._743))"></a></span></p>
        </blockquote>
        <p class="TipContent">若 <span class="texMathInline">exp_1</span> 的值作为 <span class="texMathInline">exp_2</span>
          的值返回，则
          <span class="texMathInline">exp_1</span> 和<span class="texMathInline">exp_2</span> 应在同样的续文中执行。
        </p>
      </blockquote>
      <p>写成这样是不对的：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">letrec-exp</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">p-name</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">p-var</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">p-body</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">letrec-body</span><span
                    class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">apply-cont</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">cont</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">letrec-body</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">      </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">extend-env-rec</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">p-name</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">p-var</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">p-body</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">env</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">      </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">end-cont</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>因为调用 <span class="stt">value-of/k</span> 是在操作数位置：它要作为 <span class="stt">apply-cont</span> 的操作数。另外，
          由于使用续文 <span class="stt">(end-cont)</span> 会在计算完成之前打印出计算结束消息，这种错误很容易
          排查。</p>
      </blockquote>
      <p>接下来我们考虑 <span class="stt">zero?</span> 表达式。在 <span class="stt">zero?</span> 表达式中，我们得求出实参的值，然
        后返回给依赖该值的续文。所以我们要在新的续文中求实参的值，这个续文会取得返回值，
        然后做适当处理。</p>
      <p>那么，在 <span class="stt">value-of/k</span> 中，我们写：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">zero?-exp</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                    class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">exp1</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">env</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">zero1-cont</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>其中，<span class="stt">(zero1-cont cont)</span> 是一续文，具有如下性质：</p>
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(apply-cont (zero1-cont </span><span class="texMathInline">cont</span><span
                    class="stt">) </span><span class="texMathInline">val</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (apply-cont </span><span class="texMathInline">cont</span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(bool-val</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(zero? (expval->num
                  </span><span class="texMathInline">val</span><span class="stt">))))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>就像 <span class="stt">letrec</span>，我们不能把 <span class="stt">value-of/k</span> 写成：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">zero?-exp</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                    class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">val</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktPn">(</span><span class="RktSym">value-of/k</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">exp1</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">env</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">end-cont</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">apply-cont</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">cont</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">      </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">bool-val</span><span
                    class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span
                    class="hspace">        </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                    class="RktSym">zero?</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">expval->num</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">val</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>因为调用 <span class="stt">value-of/k</span> 是在操作数位置。<span class="stt">let</span> 声明的右边是在操作数位置，因为
          <span class="stt">(let ((</span><span class="texMathInline">var</span><span class="stt"> </span><span
            class="texMathInline">exp_1</span><span class="stt">)) </span><span class="texMathInline">exp_2</span><span
            class="stt">)</span> 等效于 <span class="stt">((lambda (</span><span class="texMathInline">var</span><span
            class="stt">)</span><span class="stt">
          </span><span class="texMathInline">exp_2</span><span class="stt">) </span><span
            class="texMathInline">exp_1</span><span class="stt">)</span>。<span class="stt">value-of/k</span> 调用的值最终成为
          <span class="stt">expval->num</span> 的操作
          数。像之前那样，如果我们运行这段代码，计算结束消息会出现两次：一次在计算中间，一
          次在真正结束时。
        </p>
      </blockquote>
      <p><span class="stt">let</span> 表达式只比 <span class="stt">zero?</span> 表达式稍微复杂一点：求出声明右侧的值之后，我们在
        适当的扩展环境内求主体的值。原来的 <span class="stt">let</span> 代码为：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">let-exp</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktPn">(</span><span class="RktSym">var</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">exp1</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">body</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">val1</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktPn">(</span><span class="RktSym">value-of</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">exp1</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">env</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">value-of</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">body</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">      </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">extend-env</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">var</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">val1</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">env</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>在传递续文的解释器中，我们在完成剩余计算的上下文中求 <span class="texMathInline">exp_1</span> 的值。所以，在
          <span class="stt">value-of/k</span> 中我们写：
        </p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">let-exp</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktPn">(</span><span class="RktSym">var</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">exp1</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">body</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">exp1</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">env</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">let-exp-cont</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">var</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">body</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">env</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>然后我们给续文的接口添加规范：</p>
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(apply-cont (let-exp-cont </span><span class="texMathInline">var</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">body</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">env</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">cont</span><span
                    class="stt">) </span><span class="texMathInline">val</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of/k </span><span class="texMathInline">body</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">(extend-env </span><span
                    class="texMathInline">var</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">val</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">env</span><span
                    class="stt">) </span><span class="texMathInline">cont</span><span class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p><span class="stt">let</span> 表达式主体的值成为 <span class="stt">let</span> 表达式的值，所以求 <span class="stt">let</span>
        表达式主体时的
        续文与求整个 <span class="stt">let</span> 表达式的相同。这是<span style="font-weight: bold">尾调用不扩大续文</span>的又一例子。
        <a name="(idx._(gentag._744))"></a>
      </p>
      <p><a name="(idx._(gentag._745))"></a>
        下面我们处理 <span class="stt">if</span> 表达式。在 <span class="stt">if</span> 表达式中，我们首先求条件的值，但条件的结
        果不是整个表达式的值。我们要新生成一个续文，查看条件表达式的结果是否为真，然后求
        真值表达式或假值表达式的值。所以在 <span class="stt">value-of/k</span> 中我们写：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if-exp</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktPn">(</span><span class="RktSym">exp1</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">exp2</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">exp3</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">exp1</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">env</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">if-test-cont</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">exp2</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">exp3</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">body</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">env</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">cont</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>其中，<span class="stt">if-test-cont</span> 是另一个续文构造器，满足如下规范：</p>
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(apply-cont (if-test-cont </span><span class="texMathInline">exp_2</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">exp_3</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">env</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">cont</span><span
                    class="stt">) </span><span class="texMathInline">val</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (if (expval->bool </span><span class="texMathInline">val</span><span
                    class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of/k </span><span
                    class="texMathInline">exp_2</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">env</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">cont</span><span
                    class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of/k </span><span
                    class="texMathInline">exp_3</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">env</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">cont</span><span
                    class="stt">))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p><a name="(idx._(gentag._746))"></a>
        现在，我们有了四个续文构造器。我们可以用过程表示法或者数据结构表示法实现它们。过
        程表示法如<span class="EoplFigureRef"></span> 所示，数据结构表示法使用 <span class="stt">define-datatype</span>，
        如<span class="EoplFigureRef"></span> 所示。
        <a name="(idx._(gentag._747))"></a>
        <a name="(idx._(gentag._748))"></a>
        <a name="(idx._(gentag._749))"></a>
      </p>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="texMathInline">\mathit{Cont}</span> = <span class="texMathInline">\mathit{ExpVal}</span>
                -> <span class="texMathInline">\mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">end-cont</span></span> : <span
                  class="texMathInline">\mathit{()} \to \mathit{Cont}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">end-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">begin</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">eopl:printf</span><span class="hspace"> </span><span
                  class="RktVal">"计算结束.~%"</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">zero1-cont</span></span> : <span
                  class="texMathInline">\mathit{Cont} \to \mathit{Cont}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">zero1-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="hspace"> </span><span class="RktSym">cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">bool-val</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">zero?</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->num</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">let-exp-cont</span></span> : <span
                  class="texMathInline">\mathit{Var} \times \mathit{Exp} \times \mathit{Env} \times \mathit{Cont} \to
                  \mathit{Cont}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">let-exp-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">body</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">extend-env</span><span
                  class="hspace"> </span><span class="RktSym">var</span><span class="hspace"> </span><span
                  class="RktSym">val</span><span class="hspace"> </span><span class="RktSym">env</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">if-test-cont</span></span> : <span
                  class="texMathInline">\mathit{Exp} \times \mathit{Exp} \times \mathit{Env} \times \mathit{Cont} \to
                  \mathit{Cont}</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span><span class="RktSym">:</span><span class="hspace"> </span><span
                  class="RktSym">Exp</span><span class="hspace"> </span><span class="RktSym">×</span><span
                  class="hspace"> </span><span class="RktSym">Exp</span><span class="hspace"> </span><span
                  class="RktSym">×</span><span class="hspace"> </span><span class="RktSym">Env</span><span
                  class="hspace"> </span><span class="RktSym">×</span><span class="hspace"> </span><span
                  class="RktSym">Cont</span><span class="hspace"> </span><span class="RktSym">→</span><span
                  class="hspace"> </span><span class="RktSym">Cont</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">if-test-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">exp3</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">expval->bool</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp3</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">apply-cont</span></span> : <span
                  class="texMathInline">\mathit{Cont} \times \mathit{ExpVal} \to \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">v</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">v</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <blockquote class="caption">
          <p>用过程表示续文
            <a name="(idx._(gentag._750))"></a>
            <a name="(idx._(gentag._751))"></a><a name="(elem._fig-5..2)"></a>
          </p>
        </blockquote>
      </blockquote>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define-datatype</span><span
                  class="hspace"> </span><span class="RktSym">continuation</span><span class="hspace"> </span><span
                  class="RktSym">continuation?</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">end-cont</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">zero1-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">continuation?</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">let-exp-cont</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">identifier?</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">env</span><span
                  class="hspace"> </span><span class="RktSym">environment?</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">continuation?</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">if-test-cont</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">exp3</span><span
                  class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">env</span><span
                  class="hspace"> </span><span class="RktSym">environment?</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">continuation?</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">apply-cont</span></span> : <span
                  class="texMathInline">\mathit{Cont} \times \mathit{ExpVal} \to \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">continuation</span><span class="hspace"> </span><span
                  class="RktSym">cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">end-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">begin</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">eopl:printf</span><span class="hspace"> </span><span
                  class="RktVal">"计算结束.~%"</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">zero1-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="hspace"> </span><span class="RktSym">saved-cont</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span class="RktSym">bool-val</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">zero?</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->num</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">let-exp-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">body</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">extend-env</span><span class="hspace"> </span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                  class="RktSym">saved-env</span><span class="RktPn">)</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">if-test-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp2</span><span class="hspace"> </span><span class="RktSym">exp3</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">expval->bool</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp3</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <blockquote class="caption">
          <p>用数据结构表示续文
            <a name="(idx._(gentag._752))"></a>
            <a name="(idx._(gentag._753))"></a><a name="(elem._fig-5..3)"></a>
          </p>
        </blockquote>
      </blockquote>
      <p>下面这个简单算例展示了各部分如何配合。像 <a href="expr.html#%28part._s3..3%29" data-pltdoc="x">PROC：有过程的语言</a>那样，我们用
        <span class="texMathInline">\textnormal{\guillemotleft} exp \textnormal{\guillemotright}</span> 指代表达式
        <span class="texMathInline">exp</span> 的抽象语法树。设 <span class="texMathInline">\rho_0</span> 是一环境，<span
          class="stt">b</span> 在其中绑定到 <span class="stt">(bool-val
          #t)</span>；<span class="texMathInline">cont_0</span> 是初始续文，即 <span class="stt">(end-cont)</span>
        的值。注释说明不是正式的，应与
        <span class="stt">value-of/k</span> 的定义和 <span class="stt">apply-cont</span> 的规范对照阅读。这个例子是预测性的，因
        为我们让 <span class="stt">letrec</span> 引入了过程，但还不知道如何调用它。
      </p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(value-of/k <<letrec p(x)=x in if b then 3 else 4>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                  class="texMathInline">\rho_0</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">cont_0</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="Smaller"><span class="emph">令<span
                      class="texMathInline">\rho_0</span>为</span><span class="stt">(extend-env-rec ... </span><span
                    class="texMathInline">\rho_0</span><span class="stt">)</span></span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(value-of/k <<if b then 3 else 4>> </span><span
                  class="texMathInline">\rho_1</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">cont_0</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="Smaller"><span class="emph">然后，求条件表达式的值</span></span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(value-of/k <<b>> </span><span class="texMathInline">\rho_1</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt">(test-cont <<3>> <<4>> </span><span
                  class="texMathInline">\rho_1</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">cont_0</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="Smaller"><span class="emph">把</span><span
                    class="stt">b</span><span class="emph">的值传给续文</span></span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(apply-cont (test-cont <<3>> <<4>> </span><span
                  class="texMathInline">\rho_1</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">cont_0</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">            </span><span class="stt">(bool-val
                  #f))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="Smaller"><span class="emph">求真值表达式</span></span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(value-of/k <<3>> </span><span class="texMathInline">\rho_1</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">cont_0</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="Smaller"><span class="emph">把表达式的值传给续文</span></span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(apply-cont </span><span class="texMathInline">cont_0</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt">(num-val 3))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="Smaller"><span class="emph">在最后的续文中处理最终答案</span></span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(begin (eopl:printf ...) (num-val 3))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p><a name="(idx._(gentag._754))"></a>
        差值表达式给我们的解释器带来了新困难，因为它得求两个操作数的值。我们还像 <span class="stt">if</span>
        那样开始，先求第一个实参：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">diff-exp</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktPn">(</span><span class="RktSym">exp1</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">exp2</span><span
                  class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktSym">exp1</span><span class="RktMeta"></span><span class="hspace"> </span><span
                  class="RktMeta"></span><span class="RktSym">env</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">diff1-cont</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktSym">exp2</span><span class="RktMeta"></span><span class="hspace"> </span><span
                  class="RktMeta"></span><span class="RktSym">env</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktMeta"></span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>当 <span class="stt">(diff1-cont exp2 env cont)</span> 收到一个值，它应求 <span class="stt">exp2</span> 的值，求值时的上
        下文应保存 <span class="stt">exp1</span> 的值。我们将其定义为：</p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(apply-cont (diff1-cont </span><span class="texMathInline">exp_2</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">env</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">cont</span><span class="stt">) </span><span
                  class="texMathInline">val1</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of/k </span><span class="texMathInline">exp_2</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">env</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(diff2-cont </span><span
                  class="texMathInline">val1</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">cont</span><span class="stt">))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>当 <span class="stt">(diff2-cont val1 cont)</span> 收到一个值，我们得到了两个操作数的值，所以，我们
        可以把二者的差继续传给等待中的 <span class="stt">cont</span>。定义为：</p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(apply-cont (diff2-cont </span><span class="texMathInline">val1</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">cont</span><span class="stt">) </span><span
                  class="texMathInline">val2</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (let ((num1 (expval->num </span><span class="texMathInline">val1</span><span
                  class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">        </span><span class="stt">(num2 (expval->num
                </span><span class="texMathInline">val2</span><span class="stt">)))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(apply-cont </span><span
                  class="texMathInline">cont</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(num-val (- num1
                  num2))))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>让我们看看该系统的例子。</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplComputationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><a name="(elem._cps-computation)"></a><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"><<-(-(44,11),3)>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:end-cont))</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">开始处理第一个操作数</span></span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"><<-(44,11)>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff1-cont <<3>>
                  </span><span class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span
                    class="stt">#(struct:end-cont)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">开始处理第一个操作数</span></span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<44>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff1-cont <<11>>
                  </span><span class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">#(struct:diff1-cont <<3>>
                  </span><span class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span
                    class="stt">#(struct:end-cont))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">把</span><span class="stt">
                      <<44>>
                    </span>的值传给续文</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff1-cont <<11>>
                  </span><span class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">#(struct:diff1-cont <<3>>
                  </span><span class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">       </span><span
                    class="stt">#(struct:end-cont)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(num-val 44))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">现在，开始处理第二个操作数</span></span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<11>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff2-cont (num-val
                    44)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">#(struct:diff1-cont <<3>>
                  </span><span class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span
                    class="stt">#(struct:end-cont))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">把值传给续文</span></span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff2-cont (num-val
                    44)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">#(struct:diff1-cont <<3>>
                  </span><span class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span
                    class="stt">#(struct:end-cont)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(num-val 11))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph"><span
                        class="texMathInline">44-11</span>等于<span
                        class="texMathInline">33</span>，传给续文</span></span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff1-cont <<3>>
                  </span><span class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span
                    class="stt">#(struct:end-cont))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(num-val 33))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">开始处理第二个操作数</span><span
                      class="stt">
                      <<3>>
                    </span></span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<3>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff2-cont (num-val
                    33)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span
                    class="stt">#(struct:end-cont)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">把值传给续文</span></span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff2-cont (num-val
                    33)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span
                    class="stt">#(struct:end-cont))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(num-val 3))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph"><span
                        class="texMathInline">33-3</span>等于<span class="texMathInline">30</span>，传给续文</span></span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:end-cont)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(num-val 30))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p><span class="stt">apply-cont</span> 打印出消息“计算结束”，返回计算的最终
          结果 <span class="stt">(num-val 30)</span>。</p>
      </blockquote>
      <p><a name="(idx._(gentag._755))"></a>
        我们的语言中最后要处理的是过程调用。在传递环境的解释器中，我们写：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">call-exp</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktPn">(</span><span class="RktSym">rator</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">rand</span><span
                  class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">proc1</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktPn">(</span><span class="RktSym">expval->proc</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="RktMeta"></span><span class="hspace"> </span><span
                  class="RktMeta"></span><span class="RktSym">rator</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">env</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">        </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">arg</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktPn">(</span><span class="RktSym">value-of</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">rand</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktSym">env</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">apply-procedure</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktSym">proc1</span><span class="RktMeta"></span><span class="hspace"> </span><span
                  class="RktMeta"></span><span class="RktSym">arg</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>就像在 <span class="stt">diff-exp</span> 中一样，这里要处理两个调用。所以我们必须先择其一，然后转换
        余下部分来处理第二个。此外，我们必须把续文传给 <span class="stt">apply-procedure</span>，因为
        <span class="stt">apply-procedure</span> 要调用 <span class="stt">value-of/k</span>。
      </p>
      <p>我们选择先求操作符的值，所以在 <span class="stt">value-of/k</span> 中我们写：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">call-exp</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">rator</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">rand</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">rator</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">rator-cont</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">rand</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">env</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">cont</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>就像 <span class="stt">diff-exp</span>，<span class="stt">rator-cont</span> 在适当的环境中求操作数的值：</p>
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(apply-cont (rator-cont </span><span class="texMathInline">rand</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">env</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">cont</span><span class="stt">) </span><span
                    class="texMathInline">val1</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of/k </span><span class="texMathInline">rand</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">env</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(rand-cont </span><span
                    class="texMathInline">val1</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">cont</span><span class="stt">))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p><a name="(idx._(gentag._756))"></a>
          当 <span class="stt">rand-cont</span> 收到一个值，它就可以调用过程了：</p>
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(apply-cont (rand-cont </span><span class="texMathInline">val1</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">cont</span><span class="stt">) </span><span
                    class="texMathInline">val2</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (let ((proc1 (expval->proc </span><span class="texMathInline">val1</span><span
                    class="stt">)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(apply-procedure/k proc1
                  </span><span class="texMathInline">val2</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">cont</span><span
                    class="stt">))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>最后，我们还要修改 <span class="stt">apply-procedure</span>，以符合续文传递风格：</p>
        <blockquote class="EoplCodeInset">
          <p>
          <div class="SIntrapara">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span style="font-weight: bold"><span class="stt">apply-procedure/k</span></span> : <span
                      class="texMathInline">\mathit{Proc} \times \mathit{ExpVal} \times \mathit{Cont} \to
                      \mathit{FinalAnswer}</span></td>
                </tr>
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                      class="RktSym">apply-procedure/k</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">proc1</span><span
                      class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                      class="RktSym">cont</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                      class="hspace"> </span><span class="RktSym">proc</span><span class="hspace"> </span><span
                      class="RktSym">proc1</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">      </span><span class="RktPn">(</span><span
                      class="RktSym">procedure</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                      class="hspace"> </span><span class="RktSym">saved-env</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">        </span><span class="RktPn">(</span><span
                      class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">body</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">          </span><span class="RktPn">(</span><span
                      class="RktSym">extend-env</span><span class="hspace"> </span><span class="RktSym">var</span><span
                      class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                      class="RktSym">saved-env</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">          </span><span class="RktSym">cont</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
              </table>
            </blockquote>
          </div>
          <div class="SIntrapara"><a name="(idx._(gentag._757))"></a></div>
          </p>
        </blockquote>
      </blockquote>
      <p>传递续文的解释器展示完毕。完整的解释器如<span class="EoplFigureRef"></span> 和
        <span class="stt">fig-5.5</span> 所示。续文的完整规范如<span class="EoplFigureRef"></span> 所示。
      </p>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">value-of-program</span></span> : <span
                  class="texMathInline">\mathit{Program} \to \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">value-of-program</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">pgm</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">program</span><span class="hspace"> </span><span
                  class="RktSym">pgm</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">a-program</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">init-env</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">end-cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">value-of/k</span></span> : <span
                  class="texMathInline">\mathit{Exp} \times \mathit{Env} \times \mathit{Cont} \to
                  \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">value-of/k</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                  class="RktSym">exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">const-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">num</span><span class="RktPn">)</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">apply-cont</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">num-val</span><span class="hspace"> </span><span class="RktSym">num</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">var-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">apply-env</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktSym">var</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="hspace"> </span><span class="RktSym">cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span class="RktSym">proc-val</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">procedure</span><span class="hspace"> </span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">body</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">letrec-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">p-name</span><span class="hspace"> </span><span class="RktSym">b-var</span><span
                  class="hspace"> </span><span class="RktSym">p-body</span><span class="hspace"> </span><span
                  class="RktSym">letrec-body</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">letrec-body</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">extend-env-rec</span><span class="hspace"> </span><span
                  class="RktSym">p-name</span><span class="hspace"> </span><span class="RktSym">b-var</span><span
                  class="hspace"> </span><span class="RktSym">p-body</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktSym">cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">zero?-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">env</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">zero1-cont</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">if-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">exp2</span><span class="hspace"> </span><span
                  class="RktSym">exp3</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">env</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">if-test-cont</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">exp3</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">let-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">exp1</span><span class="hspace"> </span><span
                  class="RktSym">body</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">env</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">let-exp-cont</span><span class="hspace"> </span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">body</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">diff-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">env</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">diff1-cont</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">call-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">rator</span><span class="hspace"> </span><span class="RktSym">rand</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">rator</span><span
                  class="hspace"> </span><span class="RktSym">env</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">rator-cont</span><span class="hspace"> </span><span class="RktSym">rand</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p>传递续文的解释器（第1部分）
              <a name="(idx._(gentag._758))"></a>
              <a name="(idx._(gentag._759))"></a><a name="(elem._fig-5..4)"></a>
            </p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._760))"></a></div>
        </p>
      </blockquote>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">apply-procedure</span></span> : <span
                  class="texMathInline">\mathit{Proc} \times \mathit{ExpVal} \times \mathit{FinalAnswer} \to
                  \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-procedure/k</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">proc1</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">proc</span><span class="hspace"> </span><span
                  class="RktSym">proc1</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">procedure</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">body</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">extend-env</span><span class="hspace"> </span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                  class="RktSym">saved-env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktSym">cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p>传递续文的解释器（第2部分）
              <a name="(idx._(gentag._761))"></a>
              <a name="(idx._(gentag._762))"></a><a name="(elem._fig-5..5)"></a>
            </p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._763))"></a></div>
        </p>
      </blockquote>
      <p><a name="(elem._tail-call-explain)"></a>现在我们可以验证断言：不是过程调用，而是实参的求
        值扩大了控制上下文。具体来说，如果我们在某个续文 <span class="texMathInline">cont_1</span> 中求过程调用
        <span class="stt">(</span><span class="texMathInline">exp_1</span><span class="stt"> </span><span
          class="texMathInline">exp_2</span><span class="stt">)</span> 的值，求 <span class="texMathInline">exp_1</span>
        得到的过程主体也将在 <span class="texMathInline">cont_1</span> 中
        求值。
      </p>
      <p>但过程调用本身不会增大控制上下文。考虑 <span class="stt">(</span><span class="texMathInline">exp_1</span><span class="stt">
        </span><span class="texMathInline">exp_2</span><span class="stt">)</span> 的求值，其中
        <span class="texMathInline">exp_1</span> 的值是一个过程 <span class="texMathInline">proc_1</span>，<span
          class="texMathInline">exp_2</span> 的值是某个表达值 <span class="texMathInline">val_2</span>。
      </p>
      <blockquote class="EoplComputationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(value-of/k <<(< /span><span class="texMathInline">exp_1</span><span
                      class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                      class="texMathInline">exp_2</span><span class="stt">)>> </span><span
                      class="texMathInline">\rho_1</span><span class="stt"></span><span class="hspace"> </span><span
                      class="stt"></span><span class="texMathInline">cont_1</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="Smaller"><span class="emph">求操作符的值</span></span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(value-of/k <<< /span><span class="texMathInline">exp_1</span><span class="stt">>>
                    </span><span class="texMathInline">\rho_1</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(rator-cont <<< /span><span
                      class="texMathInline">exp_2</span><span class="stt">>> </span><span
                      class="texMathInline">\rho_1</span><span class="stt"></span><span class="hspace"> </span><span
                      class="stt"></span><span class="texMathInline">cont_1</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="Smaller"><span class="emph">把过程值传给续文</span></span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(apply-cont</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(rator-cont <<< /span><span
                      class="texMathInline">exp_2</span><span class="stt">>> </span><span
                      class="texMathInline">\rho_1</span><span class="stt"></span><span class="hspace"> </span><span
                      class="stt"></span><span class="texMathInline">cont_1</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                  class="texMathInline">proc_1</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="Smaller"><span class="emph">求操作符的值</span></span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(value-of/k <<< /span><span class="texMathInline">exp_2</span><span class="stt">>>
                    </span><span class="texMathInline">\rho_1</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(rand-cont <<< /span><span
                      class="texMathInline">proc_1</span><span class="stt">>> </span><span
                      class="texMathInline">cont_1</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="Smaller"><span class="emph">把参数值传给续文</span></span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(apply-cont</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(rand-cont <<< /span><span
                      class="texMathInline">proc_1</span><span class="stt">>> </span><span
                      class="texMathInline">cont_1</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                  class="texMathInline">val_2</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="Smaller"><span class="emph">调用过程</span></span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(apply-procedure/k </span><span class="texMathInline">proc_1</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">val_2</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">cont_1</span><span class="stt">)</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>所以，过程调用时，过程主体在过程调用所在的续文中求值。操作数的求值需要控制上下文，
        进入过程主体则不需要。
        <a name="(idx._(gentag._764))"></a>
        <a name="(idx._(gentag._765))"></a>
        <a name="(idx._(gentag._766))"></a>
        <a name="(idx._(gentag._767))"></a>
        <a name="(idx._(gentag._768))"></a>
      </p>
      <blockquote class="EoplFigure">
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(apply-cont (end-cont) </span><span class="texMathInline">val</span><span
                    class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (begin</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(eopl:printf</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">"计算结束.~%")</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                    class="texMathInline">val</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont (diff1-cont </span><span class="texMathInline">exp_2</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">env</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">cont</span><span class="stt">) </span><span
                    class="texMathInline">val1</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of/k </span><span class="texMathInline">exp_2</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">env</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt">(diff2-cont </span><span class="texMathInline">val1</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">cont</span><span
                    class="stt">))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont (diff2-cont </span><span class="texMathInline">val1</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">cont</span><span class="stt">) </span><span
                    class="texMathInline">val2</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (let ((num1 (expval->num </span><span class="texMathInline">val1</span><span
                    class="stt">))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">(num2 (expval->num
                  </span><span class="texMathInline">val2</span><span class="stt">)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(apply-cont </span><span
                    class="texMathInline">cont</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt">(num-val (- num1 num2))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont (rator-cont </span><span class="texMathInline">rand</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">env</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">cont</span><span class="stt">) </span><span
                    class="texMathInline">val1</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of/k </span><span class="texMathInline">rand</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">env</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt">(rand-cont </span><span class="texMathInline">val1</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">cont</span><span
                    class="stt">))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont (rand-cont </span><span class="texMathInline">val1</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">cont</span><span class="stt">) </span><span
                    class="texMathInline">val2</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (let ((proc1 (expval->proc </span><span class="texMathInline">val1</span><span
                    class="stt">)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(apply-procedure/k proc1
                  </span><span class="texMathInline">val2</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">cont</span><span
                    class="stt">))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont (zero1-cont </span><span class="texMathInline">cont</span><span
                    class="stt">) </span><span class="texMathInline">val</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (apply-cont </span><span class="texMathInline">cont</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">(bool-val (zero? (expval->num
                  </span><span class="texMathInline">val</span><span class="stt">))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont (if-test-cont </span><span class="texMathInline">exp_2</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">exp_3</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">env</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">cont</span><span
                    class="stt">) </span><span class="texMathInline">val</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (if (expval->bool </span><span class="texMathInline">val</span><span
                    class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of/k </span><span
                    class="texMathInline">exp_2</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">env</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">cont</span><span
                    class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of/k </span><span
                    class="texMathInline">exp_3</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">env</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">cont</span><span
                    class="stt">))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont (let-exp-cont </span><span class="texMathInline">var</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">body</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">env</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">cont</span><span
                    class="stt">) </span><span class="texMathInline">val1</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of/k </span><span class="texMathInline">body</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">(extend-env </span><span
                    class="texMathInline">var</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">val1</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">env</span><span
                    class="stt">) </span><span class="texMathInline">cont</span><span class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p><span class="EoplFigureRef"></span> 中续文的规范
              <a name="(idx._(gentag._769))"></a>
              <a name="(idx._(gentag._770))"></a><a name="(elem._fig-5..6)"></a>
            </p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._771))"></a></div>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..1)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._772))"></a>
          <a name="(idx._(gentag._773))"></a>
          用过程表示法实现续文数据类型。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..2)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._774))"></a>
          <a name="(idx._(gentag._775))"></a>
          用数据结构表示法实现续文数据类型。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..3)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>给解释器添加 <span class="stt">let2</span>。<span class="stt">let2</span> 表达式就像 <span
            class="stt">let</span> 表达式，但要指定两个变量。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..4)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>给解释器添加 <span class="stt">let3</span>。<span class="stt">let3</span> 表达式就像 <span
            class="stt">let</span> 表达式，但要指定三个变量。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..5)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._776))"></a>
          给语言添加<span class="EoplExerciseRef"></span> 中的列表。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..6)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._777))"></a>
          给语言添加<span class="EoplExerciseRef"></span> 中的 <span class="stt">list</span> 表达式。提示：添加两个续文构造器，
          一个用来求列表首元素的值，一个用来求列表剩余元素的值。
          <a name="(idx._(gentag._778))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..7)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._779))"></a>
          给解释器添加多声明的 <span class="stt">let</span>（<span class="EoplExerciseRef"></span>）。
          <a name="(idx._(gentag._780))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..8)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._781))"></a>
          给解释器添加多参数过程（<span class="EoplExerciseRef"></span>）。
          <a name="(idx._(gentag._782))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..9)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._783))"></a>
          修改这个解释器，实现 IMPLICIT-REFS 语言。提示：添加新的续文构造器
          <span class="stt">(set-rhs-cont env var cont)</span>。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..10)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>修改前一题的解答，不要在续文中保存环境。
          <a name="(idx._(gentag._784))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..11)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._785))"></a>
          给传递续文的解释器添加<span class="EoplExerciseRef"></span> 中的 <span class="stt">begin</span> 表达式。确保调用
          <span class="stt">value-of</span> 和 <span class="stt">value-of-rands</span> 时不需要生成控制上下文。
          <a name="(idx._(gentag._786))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..12)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>给<span class="EoplFigureRef"></span>–<span class="stt">fig-5.6</span> 的解释器添加辅助过程，生成类似
          <span class="stt">cps-computation</span> 计算的输出。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..13)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._787))"></a>
          把 <span class="stt">fact</span> 和 <span class="stt">fact-iter</span> 翻译为 LETREC 语言。你可以给语言添加乘法操作符。
          然后，用前一道练习中带有辅助组件的解释器计算 <span class="stt">(fact 4)</span> 和 <span class="stt">(fact-iter 4)</span>。
          将它们和本章开头的计算比较。在 <span class="stt">(fact 4)</span> 的跟踪日志中找出 <span class="stt">(* 4 (* 3 (* 2
            (fact 1))))</span>。调用 <span class="stt">(fact 1)</span> 时，<span class="stt">apply-procedure/k</span> 的续文是什么？
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..14)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._788))"></a>
          <a name="(idx._(gentag._789))"></a>
          前面练习中的辅助组件产生大量输出。修改辅助组件，只跟踪计算过程中最大续文
          的<span class="emph">尺寸</span>。我们用续文构造器的使用次数衡量续文的大小，所
          以<span class="stt">cps-computation</span>的计算中，续文最大尺寸是 3。然后，用 <span class="stt">fact</span> 和
          <span class="stt">fact-iter</span> 计算几个操作数的值。验证 <span class="stt">fact</span> 使用的续文最大尺寸随其参数递增，
          但 <span class="stt">fact-iter</span> 使用的续文最大尺寸是常数。
          <a name="(idx._(gentag._790))"></a>
          <a name="(idx._(gentag._791))"></a>
          <a name="(idx._(gentag._792))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..15)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._793))"></a>
          <a name="(idx._(gentag._794))"></a>
          我们的续文数据类型只有一个常量 <span class="stt">end-cont</span>，所有其他续文构造器都有一个续文参数。
          用列表表示和实现续文。用空列表表示 <span class="stt">end-cont</span>，用首项为其他数据结构
          （名为<span class="emph">帧</span> (<span class="emph">frame</span>) 或<span class="emph">活跃记录表</span> (<span
            class="emph">activation record</span>)），余项为已保
          存续文的非空列表表示其他续文。观察可知，解释器把这些列表当成（帧的）堆栈。
          <a name="(idx._(gentag._795))"></a>
          <a name="(idx._(gentag._796))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..16)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._797))"></a>
          <a name="(idx._(gentag._798))"></a>
          <a name="(idx._(gentag._799))"></a>
          扩展传递续文的解释器，处理<span class="EoplExerciseRef"></span> 中的语言。给 <span class="stt">result-of</span> 传递
          一个续文参数，确保 <span class="stt">result-of</span> 不在扩大控制上下文的位置调用。因为语句不返回值，
          需要区分普通续文和语句续文；后者通常叫<span class="emph">命令续文</span> (<span class="emph">command continuation</span>)。
          续文接口应包含过程 <span class="stt">apply-command-cont</span>，它取一命令续文并使用它。用数据结构和
          无参数过程两种方式实现命令续文。
          <a name="(idx._(gentag._800))"></a>
          <a name="(idx._(gentag._801))"></a>
          <a name="(idx._(gentag._802))"></a>
        </p>
      </blockquote>
      <h4>5.2<tt> </tt><a name="(part._s5..2)"></a>跳跃式解释器</h4>
      <p><a name="(idx._(gentag._803))"></a>
        <a name="(idx._(gentag._804))"></a>
        有人可能想用普通的过程式语言转译解释器，使用数据结构表示续文，从而避免高阶函数。
        但是，用大多数过程式语言做这种翻译都很困难：<a name="(elem._imper-reason)"></a>它们不只在
        必要时才扩大控制上下文，而且在每个函数调用处扩大控制上下文（即堆栈！）。在我们的
        系统中，由于过程调用在计算结束之前不返回，在那之前，系统的堆栈将一直增高。
      </p>
      <p><a name="(idx._(gentag._805))"></a>
        <a name="(elem._imperative-lang)"></a>这种行为不无道理：在这种语言中，几乎所有的过程调用
        都出现在赋值语句的右边，所以几乎所有过程调用都要扩大控制上下文，以便记录待完成的
        赋值。因此，体系结构为这种最常见的情形做了优化。而且，由于大多数语言在堆栈中存储
        环境信息，所有过程调用生成的控制上下文都不能忘了移除这一信息。
      </p>
      <p><a name="(idx._(gentag._806))"></a>
        在这种语言中，一种解决方案是使用<span class="emph">跳跃</span> (<span class="emph">trampolining</span>) 技术。为了避免产生无
        限长的调用链，我们把调用链打断，让解释器中的某个过程返回一个无参数过程。这个过程
        在调用时继续计算。整个计算由一个名叫<span class="emph">跳床</span> (<span class="emph">trampoline</span>) 的过程驱动，它从一
        个过程调用弹射到另一个。例如，我们可以在 <span class="stt">apply-procedure/k</span>的主体周围插入一
        个 <span class="stt">(lambda () ...)</span>，因为在我们的语言中，只要不执行过程调用，表达式的运行时
        间就是有限的。</p>
      <p>得出的代码如<span class="EoplFigureRef"></span> 所示，它也展示了解释器中所有的尾调用。因为我们
        修改了 <span class="stt">apply-procedure/k</span>，不再让它返回一个 <span class="texMathInline">\mathit{ExpVal}</span>，而是返回一
        个过程，我们得重写它和它所调用所有过程的合约。所以，我们必须检查解释器中所有过程
        的合约。</p>
      <p><a name="(idx._(gentag._807))"></a>
        我们从 <span class="stt">value-of-program</span> 开始。由于这是调用解释器的过程，它的合约保持不变。
        它调用 <span class="stt">value-of/k</span>，把结果传给 <span class="stt">trampoline</span>。因为我们要操作
        <span class="stt">value-of/k</span> 的结果，所以它不是 <span class="texMathInline">\mathit{FinalAnswer}</span>。我们明明没有修改
        <span class="stt">value-of/k</span> 的代码，怎么会这样呢？过程 <span class="stt">value-of/k</span> 在尾部递归调用
        <span class="stt">apply-cont</span>，<span class="stt">apply-cont</span> 在尾部递归调用 <span
          class="stt">apply-procedure/k</span>，所以
        <span class="stt">apply-procedure/k</span> 的任何结果都可能成为 <span class="stt">value-of/k</span> 的结果。而我们修改了
        <span class="stt">apply-procedure/k</span>，它的返回值与之前不同。
      </p>
      <p>我们引入<span class="emph">弹球</span> (<span class="emph"><span
            class="texMathInline">\mathit{Bounce}</span></span>)，作为 <span class="stt">value-of/k</span> 的可能结果（我们
        叫它弹球，因为它是跳床的输入）。这一集合的值是什么呢？<span class="stt">value-of/k</span> 在尾部递归
        调用自身和 <span class="stt">apply-cont</span>，这些是它里面所有的尾递归。所以能成为 <span class="stt">value-of/k</span>
        结果的值只能是 <span class="stt">apply-cont</span> 的结果。而且，<span class="stt">apply-procedure/k</span> 在尾部递归调
        用 <span class="stt">value-of/k</span>，所以不论 <span class="texMathInline">\mathit{Bounce}</span> 是什么，它是 <span
          class="stt">value-of/k</span>、
        <span class="stt">apply-cont</span> 和 <span class="stt">apply-procedure/k</span> 结果的集合。
      </p>
      <p>过程 <span class="stt">value-of/k</span> 和 <span class="stt">apply-cont</span> 只是在尾部调用其他过程。真正把值放入
        <span class="texMathInline">\mathit{Bounce}</span> 中的是 <span class="stt">apply-procedure/k</span>。这些是什么样的值呢？我们来看
        代码。
      </p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-procedure/k</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">proc1</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">proc</span><span class="hspace"> </span><span
                  class="RktSym">proc1</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">...</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                  class="hspace"> </span><span class="RktSym">body</span><span class="hspace"> </span><span
                  class="RktSym">...</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>
      <div class="SIntrapara">已知 <span class="stt">apply-procedure/k</span> 返回无参数的过程，该过程在调用时返回一个
        <span class="texMathInline">\mathit{ExpVal}</span>，或调用 <span class="stt">value-of/k</span>、<span
          class="stt">apply-cont</span> 或
        <span class="stt">apply-procedure/k</span> 之一的结果，也就是 <span class="texMathInline">\mathit{Bounce}</span>。所以，
        <span class="stt">apply-procedure/k</span> 可能的取值由如下集合描述：
        <span class="texMathDisplay">\mathit{ExpVal} \cup (() \to \mathit{Bounce})</span>
      </div>
      <div class="SIntrapara">
        <blockquote class="SubFlow">
          <p>这和 <span class="stt">value-of/k</span> 的可能结果相同，所以我们得出结论：
            <span class="texMathDisplay">\mathit{Bounce} = \mathit{ExpVal} \cup (() \to \mathit{Bounce})</span>
            合约为：
            <span class="texMathDisplay">\begin{alignedat}{-1}
              &<span style="font-weight: bold">value-of-program</span> : \mathit{Program} \to \mathit{FinalAnswer} \\
              &<span style="font-weight: bold">trampoline</span> : \mathit{Bounce} \to \mathit{FinalAnswer} \\
              &<span style="font-weight: bold">value-of/k</span> : \mathit{Exp} \times \mathit{Env} \times \mathit{Cont}
              \to \mathit{Bounce} \\
              &<span style="font-weight: bold">apply-cont</span> : \mathit{Cont} \times \mathit{ExpVal} \to
              \mathit{Bounce} \\
              &<span style="font-weight: bold">apply-procedure/k</span> : \mathit{Proc} \times \mathit{ExpVal} \times
              \mathit{FinalAnswer} \to \mathit{Bounce}
              \end{alignedat}</span>
            <a name="(idx._(gentag._808))"></a>
          </p>
        </blockquote>
      </div>
      </p>
      <p>过程 <span class="stt">trampoline</span> 满足其合约：首先给它传入一个 <span class="texMathInline">\mathit{Bounce}</span>。如果其参
        数是一个<span class="texMathInline">\mathit{ExpVal}</span>（也是 <span
          class="texMathInline">\mathit{FinalAnswer}</span>），那么返回；否则，参
        数一定是一个返回值为 <span class="texMathInline">\mathit{Bounce}</span> 的过程。所以，它调用这个无参数过程，然
        后调用自身处理其结果，返回值总是一个 <span class="texMathInline">\mathit{Bounce}</span>（在 <a href="types.html#%28part._s7..4%29"
          data-pltdoc="x">INFERRED：带有类型推导的语言</a>我们将
        看到如何自动完成这个推理过程）。</p>
      <p><span class="stt">apply-procedure/k</span> 返回的每个无参数过程都表示计算流程中的一个快照。我们可以
        在计算中的不同位置返回这样的快照。在 <a href="#%28part._s5..5%29" data-pltdoc="x">线程</a>，我们将看到如何用这一思想模拟
        多线程程序中的原子操作。</p>
      <p>
      <div class="SIntrapara">
        <blockquote class="EoplFigure">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="texMathInline">\mathit{Bounce}</span> = <span class="texMathInline">\mathit{ExpVal}
                    \cup (() \to \mathit{Bounce})</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">value-of-program</span></span> : <span
                    class="texMathInline">\mathit{Program} \to \mathit{FinalAnswer}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">value-of-program</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">pgm</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">program</span><span class="hspace"> </span><span
                    class="RktSym">pgm</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">a-program</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">trampoline</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">init-env</span><span
                    class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">end-cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">trampoline</span></span> : <span
                    class="texMathInline">\mathit{Bounce} \to \mathit{FinalAnswer}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">trampoline</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">bounce</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">expval?</span><span
                    class="hspace"> </span><span class="RktSym">bounce</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktSym">bounce</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">trampoline</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">bounce</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">value-of/k</span></span> : <span
                    class="texMathInline">\mathit{Exp} \times \mathit{Env} \times \mathit{Cont} \to
                    \mathit{Bounce}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">value-of/k</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                    class="RktSym">cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                    class="RktSym">exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">...</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                    class="hspace"> </span><span class="RktSym">...</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">...</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">apply-cont</span><span
                    class="hspace"> </span><span class="RktSym">...</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">apply-cont</span></span> : <span
                    class="texMathInline">\mathit{Cont} \times \mathit{ExpVal} \to \mathit{Bounce}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">apply-cont</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">continuation</span><span class="hspace"> </span><span
                    class="RktSym">cont</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">...</span><span
                    class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">...</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                    class="hspace"> </span><span class="RktSym">...</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">...</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">apply-cont</span><span
                    class="hspace"> </span><span class="RktSym">...</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">...</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">apply-procedure/k</span><span class="hspace"> </span><span
                    class="RktSym">...</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">apply-procedure/k</span></span> : <span
                    class="texMathInline">\mathit{Proc} \times \mathit{ExpVal} \times \mathit{Cont} \to
                    \mathit{Bounce}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">apply-procedure/k</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">proc1</span><span
                    class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                    class="RktSym">cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">procedure</span><span class="hspace"> </span><span
                    class="RktSym">proc1</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">...</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                    class="hspace"> </span><span class="RktSym">...</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
          <p>
          <div class="SIntrapara">
            <blockquote class="caption">
              <p>用过程表示跳床
                <a name="(idx._(gentag._809))"></a>
                <a name="(idx._(gentag._810))"></a><a name="(elem._fig-5..7)"></a>
              </p>
            </blockquote>
          </div>
          <div class="SIntrapara"><a name="(idx._(gentag._811))"></a></div>
          </p>
        </blockquote>
      </div>
      <div class="SIntrapara"><a name="(idx._(gentag._812))"></a>
        <a name="(idx._(gentag._813))"></a>
        <a name="(idx._(gentag._814))"></a>
      </div>
      </p>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..17)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>修改跳跃式解释器，把所有调用 <span class="stt">apply-procedure/k</span> 的地方（只有一处）放入
          <span class="stt">(lambda () ...)</span> 中。这一修改需要更改合约吗？
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..18)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._815))"></a>
          <a name="(idx._(gentag._816))"></a>
          <span class="EoplFigureRef"></span> 中的跳床系统使用过程表示 <span class="texMathInline">\mathit{Bounce}</span>。改用数据结构
          表示法。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..19)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>不要在 <span class="stt">apply-procedure/k</span> 主体周围插入 <span class="stt">(lambda ()
            ...)</span>，改为在
          <span class="stt">apply-cont</span> 的主体周围插入。修改合约，使之符合这一更改。<span class="texMathInline">\mathit{Bounce}</span>
          的定义需要修改吗？然后，用数据结构表示法替换过程表示法表示 <span class="texMathInline">\mathit{Bounce}</span>，
          像<span class="EoplExerciseRef"></span> 那样。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..20)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>在<span class="EoplExerciseRef"></span> 中，<span class="stt">trampoline</span> 返回 <span
            class="texMathInline">\mathit{FinalAnswer}</span> 之前的
          最后一颗弹球形如 <span class="stt">(apply-cont (end-cont) </span><span class="texMathInline">val</span><span
            class="stt">)</span>，其中，<span class="texMathInline">val</span> 是
          <span class="texMathInline">\mathit{ExpVal}</span>。利用这一点优化<span class="EoplExerciseRef"></span> 中弹球的表示。
          <a name="(idx._(gentag._817))"></a>
          <a name="(idx._(gentag._818))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..21)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>用普通的过程式语言实现跳跃式解释器。用<span class="EoplExerciseRef"></span> 中的数据结构表示快照，
          把 <span class="stt">trampoline</span> 中对自身的递归调用替换为普通的 <span class="stt">while</span> 或其它循环结构。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..22)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._819))"></a>
          有人可能想用普通的过程式语言转译<a href="expr.html" data-pltdoc="x">表达式</a>中传递环境的解释器。同样是因
          为<a href="#%28elem._imper-reason%29" data-pltdoc="x">上述</a>原因，除了最简单的情况，这种转换都会失败。跳跃技
          术在这种情况下也有效吗？</p>
      </blockquote>
      <h4>5.3<tt> </tt><a name="(part._s5..3)"></a>指令式解释器</h4>
      <p><a name="(idx._(gentag._820))"></a>
        <a name="(idx._(gentag._821))"></a>
        在<a href="state.html" data-pltdoc="x">状态</a>中我们看到，给共享变量赋值有时可以替代绑定。
        考虑<span class="EoplFigureRef"></span> 顶部的老例子 <span class="stt">even</span> 和 <span class="stt">odd</span>。
        <a name="(idx._(gentag._822))"></a><a name="(idx._(gentag._823))"></a>
      </p>
      <p>可以用<span class="EoplFigureRef"></span> 中间的程序替代它们。其中，共享变量 <span class="stt">x</span> 供两个过程
        交换信息。在顶部的例子中，过程主体在环境中查找相关数据；在另一个程序中，它们从存
        储器中查找相关数据。</p>
      <p>考虑<span class="EoplFigureRef"></span> 底部的计算跟踪日志。它可能是二者中任一计算跟踪日志。当
        我们记录调用的过程和实参时，它是第一个计算的跟踪日志；当我们记录调用的过程和寄存
        器 <span class="stt">x</span> 的值时，它是第二个计算的跟踪日志。</p>
      <p>而当我们记录程序计数器的位置和寄存器 <span class="stt">x</span> 的内容时，这又可以解释为
        <a name="(idx._(gentag._824))"></a>
        <span class="emph">goto</span>（名为<span class="emph">流程图程序</span> (<span class="emph">flowchart
          program</span>)）的跟踪日志。
      </p>
      <blockquote class="EoplFigure">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">letrec</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span><span class="stt">even(x) = if zero?(x)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">           </span><span class="stt">then 1</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">           </span><span class="stt">else (odd
                    sub1(x))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span><span class="stt">odd(x) = if zero?(x)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">          </span><span class="stt">then 0</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">          </span><span class="stt">else (even
                    sub1(x))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in (odd 13)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p><span class="texMathInline">\rule{\linewidth}{1pt}</span></p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let x = 0</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in letrec</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">even() = if
                    zero?(x)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">             </span><span class="stt">then 1</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">             </span><span class="stt">else let d = set
                    x = sub1(x)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                  </span><span class="stt">in
                    (odd)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">odd() = if zero?(x)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">            </span><span class="stt">then 0</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">            </span><span class="stt">else let d = set x
                    = sub1(x)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                 </span><span class="stt">in
                    (even)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in let d = set x =
                    13</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in (odd)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p><span class="texMathInline">\rule{\linewidth}{0.5pt}</span></p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">x = 13;</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">goto odd;</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">even: if (x=0) then return(1)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">               </span><span class="stt">else {x =
                    x-1;</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                     </span><span class="stt">goto
                    odd;}</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">odd:</span><span class="hspace">  </span><span class="stt">if (x=0) then
                    return(0)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">               </span><span class="stt">else {x =
                    x-1;</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                     </span><span class="stt">goto
                    even;}</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p><span class="texMathInline">\rule{\linewidth}{0.5pt}</span></p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(odd 13)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (even 12)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (odd 11)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">...</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (odd 1)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (even 0)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= 1</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <blockquote class="caption">
          <p>跟踪日志相同的三个程序<a name="(elem._fig-5..8)"></a></p>
        </blockquote>
      </blockquote>
      <p><a name="(idx._(gentag._825))"></a>
        <a name="(idx._(gentag._826))"></a>
        能如此，只是因为原代码中 <span class="stt">even</span> 和 <span class="stt">odd</span> 的调用不扩大控制上下文：它们是尾
        调用。我们不能这样转换 <span class="stt">fact</span>，因为 <span class="stt">fact</span> 的跟踪日志无限增长：
        “程序计数器”不是像这里一样出现在跟踪日志的最外层，而
        是出现在控制上下文中。
      </p>
      <p>任何不需要控制上下文的程序都可以这样转换。这给了我们一条重要原理：</p>
      <blockquote class="Tip">
        <blockquote class="SCentered">
          <p><span style="font-weight: bold">无参数的尾调用等同于跳转。
              <a name="(idx._(gentag._827))"></a></span></p>
        </blockquote>
      </blockquote>
      <p>如果一组过程只通过尾调用互相调用，那么我们可以像像<span class="EoplFigureRef"></span> 那样，翻
        译程序，用赋值代替绑定，然后把赋值程序转译为流程图程序。</p>
      <p>本节，我们用这一原理翻译传递续文的解释器，将其转换为适合无高阶过程语言的形式。</p>
      <p>我们首先从<span class="EoplFigureRef"></span> 和 <span class="stt">fig-5.5</span> 中的解释器开始，用数据结构
        表示续文。续文的数据结构表示如<span class="EoplFigureRef"></span> 和 <span class="stt">fig-5.10</span> 所示。</p>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!ht]</div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define-datatype</span><span
                    class="hspace"> </span><span class="RktSym">continuation</span><span class="hspace"> </span><span
                    class="RktSym">continuation?</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">end-cont</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">zero1-cont</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">saved-cont</span><span class="hspace"> </span><span
                    class="RktSym">continuation?</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">let-exp-cont</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                    class="hspace"> </span><span class="RktSym">identifier?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">body</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">saved-env</span><span class="hspace"> </span><span
                    class="RktSym">environment?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">saved-cont</span><span class="hspace"> </span><span
                    class="RktSym">continuation?</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">if-test-cont</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">exp2</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">exp3</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">saved-env</span><span class="hspace"> </span><span
                    class="RktSym">environment?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">saved-cont</span><span class="hspace"> </span><span
                    class="RktSym">continuation?</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">diff1-cont</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">exp2</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">saved-env</span><span class="hspace"> </span><span
                    class="RktSym">environment?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">saved-cont</span><span class="hspace"> </span><span
                    class="RktSym">continuation?</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">diff2-cont</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">val1</span><span
                    class="hspace"> </span><span class="RktSym">expval?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">saved-cont</span><span class="hspace"> </span><span
                    class="RktSym">continuation?</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">rator-cont</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">rand</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">saved-env</span><span class="hspace"> </span><span
                    class="RktSym">environment?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">saved-cont</span><span class="hspace"> </span><span
                    class="RktSym">continuation?</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">rand-cont</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">val1</span><span
                    class="hspace"> </span><span class="RktSym">expval?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">saved-cont</span><span class="hspace"> </span><span
                    class="RktSym">continuation?</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <blockquote class="caption">
          <p>用数据结构实现的续文（第1部分）
            <a name="(idx._(gentag._828))"></a>
            <a name="(idx._(gentag._829))"></a><a name="(elem._fig-5..9)"></a>
          </p>
        </blockquote>
      </blockquote>
      <p>我们的第一个任务是列出需要通过共享寄存器通信的过程。这些过程及其形参为：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">exp</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">env</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">cont</span><span class="RktPn">)</span><span
                    class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">apply-cont</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">cont</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">val</span><span class="RktPn">)</span><span
                    class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="RktMeta"></span><span class="RktPn">(</span><span
                    class="RktSym">apply-procedure/k</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">proc1</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">val</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">cont</span><span class="RktPn">)</span><span
                    class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
      </blockquote>
      <p>所以我们需要五个寄存器：<span class="stt">exp</span>、<span class="stt">env</span>、<span class="stt">cont</span>、<span
          class="stt">val</span> 和 <span class="stt">proc1</span>。
        上面的三个过程各改为一个无参数过程，每个实参的值存入对应的寄存器，调用无参数过程，
        换掉上述过程的调用。所以，这段代码</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">value-of/k</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                    class="RktSym">cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                    class="RktSym">exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">const-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">num</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">apply-cont</span><span class="hspace"> </span><span
                    class="RktSym">cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">num-val</span><span class="hspace"> </span><span class="RktSym">num</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktSym">...</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>可以替换为：</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">value-of/k</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                    class="RktSym">exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">const-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">num</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">val</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">num-val</span><span
                    class="hspace"> </span><span class="RktSym">num</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">apply-cont</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktSym">...</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
      </blockquote>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">apply-cont</span></span> : <span
                  class="texMathInline">\mathit{Cont} \times \mathit{ExpVal} \to \mathit{Bounce}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">continuation</span><span class="hspace"> </span><span
                  class="RktSym">cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">end-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">begin</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">eopl:printf</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktVal">"计算结束.~%"</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">zero1-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="hspace"> </span><span class="RktSym">saved-cont</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span class="RktSym">bool-val</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">zero?</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->num</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">let-exp-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">body</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">extend-env</span><span class="hspace"> </span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                  class="RktSym">saved-env</span><span class="RktPn">)</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">if-test-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp2</span><span class="hspace"> </span><span class="RktSym">exp3</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">expval->bool</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp3</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">diff1-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp2</span><span class="hspace"> </span><span class="RktSym">saved-env</span><span
                  class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">exp2</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktSym">saved-env</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">diff2-cont</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">diff2-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">val1</span><span class="hspace"> </span><span class="RktSym">saved-cont</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">num1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->num</span><span class="hspace"> </span><span class="RktSym">val1</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">              </span><span class="RktPn">(</span><span
                  class="RktSym">num2</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->num</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="hspace"> </span><span class="RktSym">saved-cont</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">num-val</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym"><span class="nobreak">-</span></span><span class="hspace"> </span><span
                  class="RktSym">num1</span><span class="hspace"> </span><span class="RktSym">num2</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">rator-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">rand</span><span class="hspace"> </span><span class="RktSym">saved-env</span><span
                  class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">rand</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">rand-cont</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">rand-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">val1</span><span class="hspace"> </span><span class="RktSym">saved-cont</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">proc</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->proc</span><span class="hspace"> </span><span class="RktSym">val1</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">apply-procedure/k</span><span class="hspace"> </span><span
                  class="RktSym">proc</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <blockquote class="caption">
          <p>用数据结构实现的续文（第2部分）
            <a name="(idx._(gentag._830))"></a>
            <a name="(idx._(gentag._831))"></a><a name="(elem._fig-5..10)"></a>
          </p>
        </blockquote>
      </blockquote>
      <p>现在，我们依次转换四个过程。我们还要修改 <span class="stt">value-of-program</span> 的主体，因为那是
        最初调用 <span class="stt">value-of/k</span>的地方。只有三点小麻烦：</p>
      <ol>
        <li>
          <p>存储器在过程调用之间往往保持不变。这对应上例中的赋值 <span class="stt">(set! cont
              cont)</span>。我们大可移除这样的赋值。</p>
        </li>
        <li>
          <p>我们必须确保 <span class="stt">cases</span> 表达式中的字段不与寄存器重名。否则字段会遮蔽寄存
            器，寄存器就无法访问了。例如，在 <span class="stt">value-of-program</span> 中，如果我们写：</p>
          <blockquote class="EoplCodeInset">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span class="hspace">     </span><span class="RktPn">(</span><span
                      class="RktSym">cases</span><span class="RktMeta"></span><span class="hspace"> </span><span
                      class="RktMeta"></span><span class="RktSym">program</span><span class="RktMeta"></span><span
                      class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">pgn</span><span
                      class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">     </span><span class="RktMeta"></span><span class="hspace">  </span><span
                      class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">a-program</span><span
                      class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                      class="RktPn">(</span><span class="RktSym">exp</span><span class="RktPn">)</span><span
                      class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">     </span><span class="RktMeta"></span><span
                      class="hspace">    </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">value-of/k</span><span class="RktMeta"></span><span class="hspace"> </span><span
                      class="RktMeta"></span><span class="RktSym">exp</span><span class="RktMeta"></span><span
                      class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">init-env</span><span class="RktPn">)</span><span class="RktMeta"></span><span
                      class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">end-cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
                </tr>
              </table>
            </blockquote>
          </blockquote>
          <p>那么 <span class="stt">exp</span> 绑定到局部变量，我们无法给全局寄存器 <span class="stt">exp</span> 赋值。解决方法是重
            命名局部变量，避免冲突：</p>
          <blockquote class="EoplCodeInset">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span class="hspace">     </span><span class="RktPn">(</span><span
                      class="RktSym">cases</span><span class="RktMeta"></span><span class="hspace"> </span><span
                      class="RktMeta"></span><span class="RktSym">program</span><span class="RktMeta"></span><span
                      class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">pgn</span><span
                      class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">     </span><span class="RktMeta"></span><span class="hspace">  </span><span
                      class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">a-program</span><span
                      class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                      class="RktPn">(</span><span class="RktSym">exp1</span><span class="RktPn">)</span><span
                      class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">     </span><span class="RktMeta"></span><span
                      class="hspace">    </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">value-of/k</span><span class="RktMeta"></span><span class="hspace"> </span><span
                      class="RktMeta"></span><span class="RktSym">exp1</span><span class="RktMeta"></span><span
                      class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">init-env</span><span class="RktPn">)</span><span class="RktMeta"></span><span
                      class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">end-cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
                </tr>
              </table>
            </blockquote>
          </blockquote>
          <p>然后，可以写：</p>
          <blockquote class="EoplCodeInset">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span class="hspace">     </span><span class="RktPn">(</span><span
                      class="RktSym">cases</span><span class="RktMeta"></span><span class="hspace"> </span><span
                      class="RktMeta"></span><span class="RktSym">program</span><span class="RktMeta"></span><span
                      class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">pgn</span><span
                      class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">     </span><span class="RktMeta"></span><span class="hspace">  </span><span
                      class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">a-program</span><span
                      class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                      class="RktPn">(</span><span class="RktSym">exp1</span><span class="RktPn">)</span><span
                      class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">     </span><span class="RktMeta"></span><span
                      class="hspace">    </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">set!</span><span class="RktMeta"></span><span class="hspace"> </span><span
                      class="RktMeta"></span><span class="RktSym">cont</span><span class="RktMeta"></span><span
                      class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">end-cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">     </span><span class="RktMeta"></span><span
                      class="hspace">    </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">set!</span><span class="RktMeta"></span><span class="hspace"> </span><span
                      class="RktMeta"></span><span class="RktSym">exp</span><span class="RktMeta"></span><span
                      class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">exp1</span><span
                      class="RktPn">)</span><span class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">     </span><span class="RktMeta"></span><span
                      class="hspace">    </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">set!</span><span class="RktMeta"></span><span class="hspace"> </span><span
                      class="RktMeta"></span><span class="RktSym">env</span><span class="RktMeta"></span><span
                      class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">init-env</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">     </span><span class="RktMeta"></span><span
                      class="hspace">    </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">value-of/k</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span><span class="RktMeta"></span></td>
                </tr>
              </table>
            </blockquote>
          </blockquote>
          <p>我们已仔细挑选数据类型中的字段名，避免这种冲突。</p>
        </li>
        <li>
          <p>一次调用中如果两次使用同一寄存器，又会造成一点麻烦。考虑转换 <span class="stt">(cons (f
              (car x)) (f (cdr x)))</span> 中的第一个调用，其中，<span class="stt">x</span> 是 <span class="stt">f</span> 的形参。不做过多
            考虑的话，这个调用可以转换为：</p>
          <blockquote class="EoplCodeInset">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">begin</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                      class="hspace"> </span><span class="RktSym">x</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym">car</span><span class="hspace"> </span><span
                      class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                      class="hspace"> </span><span class="RktSym">cont</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym">arg1-cont</span><span class="hspace"> </span><span
                      class="RktSym">x</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                      class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                      class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
              </table>
            </blockquote>
          </blockquote>
          <p>但这是不对的，因为它给寄存器 <span class="stt">x</span> 赋了新值，但 <span class="stt">x</span> 原先的值还有用。解决方
            法是调整赋值顺序，把正确的值放入寄存器中，或者使用临时变量。大多情况下，要避免
            这种问题，可以先给续文变量赋值：</p>
          <blockquote class="EoplCodeInset">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">begin</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                      class="hspace"> </span><span class="RktSym">cont</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym">arg1-cont</span><span class="hspace"> </span><span
                      class="RktSym">x</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                      class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                      class="hspace"> </span><span class="RktSym">x</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym">car</span><span class="hspace"> </span><span
                      class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                      class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
              </table>
            </blockquote>
          </blockquote>
          <p>有时临时变量无法避免；考虑 <span class="stt">(f y x)</span>，其中 <span class="stt">x</span> 和 <span class="stt">y</span> 是
            <span class="stt">f</span> 的形参。
            我们的例子中还未遇到这种麻烦。</p>
        </li>
      </ol>
      <p>翻译完的解释器如<span class="EoplFigureRef"></span>–<span class="stt">fig-5.14</span> 所示。这个过程
        叫做<span class="emph">寄存</span> (<span class="emph">registerization</span>)。很容易用支持跳转的指令式语言翻译它。
        <a name="(idx._(gentag._832))"></a>
        <a name="(idx._(gentag._833))"></a>
      </p>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">exp</span><span class="hspace"> </span><span class="RktVal">'</span><span
                  class="RktVal">uninitialized</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="hspace"> </span><span class="RktVal">'</span><span
                  class="RktVal">uninitialized</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="hspace"> </span><span class="RktVal">'</span><span
                  class="RktVal">uninitialized</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">val</span><span class="hspace"> </span><span class="RktVal">'</span><span
                  class="RktVal">uninitialized</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">proc1</span><span class="hspace"> </span><span class="RktVal">'</span><span
                  class="RktVal">uninitialized</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">value-of-program</span></span> : <span
                  class="texMathInline">\mathit{Program} \to \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">value-of-program</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">pgm</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">program</span><span class="hspace"> </span><span
                  class="RktSym">pgm</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">a-program</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">end-cont</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">exp</span><span class="hspace"> </span><span
                  class="RktSym">exp1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">init-env</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">value-of/k</span></span> : <span
                  class="texMathInline">\mathit{()} \to \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold">用法</span> : 依赖寄存器</td>
            </tr>
            <tr>
              <td><span class="stt">exp</span> : <span class="texMathInline">\mathit{Exp}</span></td>
            </tr>
            <tr>
              <td><span class="stt">env</span> : <span class="texMathInline">\mathit{Env}</span></td>
            </tr>
            <tr>
              <td><span class="stt">cont</span> : <span class="texMathInline">\mathit{Cont}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">value-of/k</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                  class="RktSym">exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">const-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">num</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">num-val</span><span class="hspace"> </span><span
                  class="RktSym">num</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">var-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">apply-env</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="hspace"> </span><span class="RktSym">var</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">proc-val</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">procedure</span><span class="hspace"> </span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">letrec-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">p-name</span><span class="hspace"> </span><span class="RktSym">b-var</span><span
                  class="hspace"> </span><span class="RktSym">p-body</span><span class="hspace"> </span><span
                  class="RktSym">letrec-body</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">exp</span><span class="hspace"> </span><span
                  class="RktSym">letrec-body</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">extend-env-rec</span><span class="hspace"> </span><span
                  class="RktSym">p-name</span><span class="hspace"> </span><span class="RktSym">b-var</span><span
                  class="hspace"> </span><span class="RktSym">p-body</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td>\begin{comment}<span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td>\end{comment}
                \smallskip</td>
            </tr>
          </table>
        </blockquote>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p>指令式解释器（第1部分）
              <a name="(idx._(gentag._834))"></a><a name="(elem._fig-5..11)"></a>
            </p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._835))"></a></div>
        </p>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!ht]</div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td>\smallskip
                  \begin{comment}</td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktPn">(</span></td>
              </tr>
              <tr>
                <td>\end{comment}</td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">zero?-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero1-cont</span><span
                    class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktSym">exp1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">value-of/k</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">let-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                    class="hspace"> </span><span class="RktSym">body</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">let-exp-cont</span><span
                    class="hspace"> </span><span class="RktSym">var</span><span class="hspace"> </span><span
                    class="RktSym">body</span><span class="hspace"> </span><span class="RktSym">env</span><span
                    class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktSym">exp1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">value-of/k</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">if-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                    class="hspace"> </span><span class="RktSym">exp3</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">if-test-cont</span><span
                    class="hspace"> </span><span class="RktSym">exp2</span><span class="hspace"> </span><span
                    class="RktSym">exp3</span><span class="hspace"> </span><span class="RktSym">env</span><span
                    class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktSym">exp1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">value-of/k</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">diff-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">diff1-cont</span><span
                    class="hspace"> </span><span class="RktSym">exp2</span><span class="hspace"> </span><span
                    class="RktSym">env</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktSym">exp1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">value-of/k</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">call-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">rator</span><span class="hspace"> </span><span class="RktSym">rand</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">rator-cont</span><span
                    class="hspace"> </span><span class="RktSym">rand</span><span class="hspace"> </span><span
                    class="RktSym">env</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktSym">rator</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">value-of/k</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p>指令式解释器（第2部分）
              <a name="(idx._(gentag._836))"></a><a name="(elem._fig-5..12)"></a>
            </p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._837))"></a></div>
        </p>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!ht]</div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">apply-cont</span></span> : <span
                    class="texMathInline">\mathit{()} \to \mathit{FinalAnswer}</span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold">用法</span> : 读取寄存器</td>
              </tr>
              <tr>
                <td><span class="stt">cont</span> : <span class="texMathInline">\mathit{Cont}</span></td>
              </tr>
              <tr>
                <td><span class="stt">val</span> : <span class="texMathInline">\mathit{ExpVal}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">apply-cont</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">continuation</span><span class="hspace"> </span><span
                    class="RktSym">cont</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">end-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">eopl:printf</span><span class="hspace"> </span><span
                    class="RktVal">"计算结束.~%"</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">zero1-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">val</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">bool-val</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">expval->num</span><span
                    class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">apply-cont</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">let-exp-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                    class="hspace"> </span><span class="RktSym">saved-env</span><span class="hspace"> </span><span
                    class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktSym">body</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">env</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">extend-env</span><span
                    class="hspace"> </span><span class="RktSym">var</span><span class="hspace"> </span><span
                    class="RktSym">val</span><span class="hspace"> </span><span class="RktSym">saved-env</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">value-of/k</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">if-test-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp2</span><span class="hspace"> </span><span class="RktSym">exp3</span><span
                    class="hspace"> </span><span class="RktSym">saved-env</span><span class="hspace"> </span><span
                    class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">expval->bool</span><span
                    class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktSym">exp2</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktSym">exp3</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">env</span><span
                    class="hspace"> </span><span class="RktSym">saved-env</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">value-of/k</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td>\begin{comment}<span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td>\end{comment}
                  \smallskip</td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p>指令式解释器（第3部分）
              <a name="(idx._(gentag._838))"></a><a name="(elem._fig-5..13)"></a>
            </p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._839))"></a></div>
        </p>
      </blockquote>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td>\smallskip
                \begin{comment}</td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktPn">(</span></td>
            </tr>
            <tr>
              <td>\end{comment}</td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">diff1-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp2</span><span class="hspace"> </span><span class="RktSym">saved-env</span><span
                  class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">diff2-cont</span><span class="hspace"> </span><span
                  class="RktSym">val</span><span class="hspace"> </span><span class="RktSym">saved-cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">exp</span><span class="hspace"> </span><span
                  class="RktSym">exp2</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktSym">saved-env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">diff2-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">val1</span><span class="hspace"> </span><span class="RktSym">saved-cont</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">num1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->num</span><span class="hspace"> </span><span class="RktSym">val1</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">               </span><span class="RktPn">(</span><span
                  class="RktSym">num2</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->num</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">num-val</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                    class="nobreak">-</span></span><span class="hspace"> </span><span class="RktSym">num1</span><span
                  class="hspace"> </span><span class="RktSym">num2</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">rator-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">rand</span><span class="hspace"> </span><span class="RktSym">saved-env</span><span
                  class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">rand-cont</span><span class="hspace"> </span><span
                  class="RktSym">val</span><span class="hspace"> </span><span class="RktSym">saved-cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">exp</span><span class="hspace"> </span><span
                  class="RktSym">rand</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktSym">saved-env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">rand-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">rator-val</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">rator-proc</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->proc</span><span class="hspace"> </span><span
                  class="RktSym">rator-val</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">proc1</span><span
                  class="hspace"> </span><span class="RktSym">rator-proc</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">apply-procedure/k</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">apply-procedure/k</span></span> : <span
                  class="texMathInline">\mathit{()} \to \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold">用法</span> : 依赖寄存器</td>
            </tr>
            <tr>
              <td><span class="stt">proc1</span> : <span class="texMathInline">\mathit{Proc}</span></td>
            </tr>
            <tr>
              <td><span class="stt">val</span> : <span class="texMathInline">\mathit{ExpVal}</span></td>
            </tr>
            <tr>
              <td><span class="stt">cont</span> : <span class="texMathInline">\mathit{Cont}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-procedure/k</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">proc</span><span class="hspace"> </span><span
                  class="RktSym">proc1</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">procedure</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">exp</span><span class="hspace"> </span><span
                  class="RktSym">body</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">extend-env</span><span class="hspace"> </span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p>指令式解释器（第4部分）
              <a name="(idx._(gentag._840))"></a><a name="(elem._fig-5..14)"></a>
            </p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._841))"></a></div>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..23)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>如果删去解释器某一分支中的“goto”会怎样？解释器会出什
          么错？</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..24)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>设计一些例子，解释上文提到的每个麻烦。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..25)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._842))"></a>
          寄存支持多参数过程的解释器（<span class="EoplExerciseRef"></span>）。
          <a name="(idx._(gentag._843))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..26)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._844))"></a>
          用跳床转换这个解释器，用 <span class="stt">(set! pc apply-procedure/k)</span> 替换
          <span class="stt">apply-procedure/k</span> 的调用，并使用下面这样的驱动器：
        </p>
        <blockquote class="EoplCodeInset">
          <p>
          <div class="SIntrapara">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                      class="RktSym">trampoline</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">pc</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                      class="hspace"> </span><span class="RktSym">pc</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym">trampoline</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym">pc</span><span class="RktPn">)</span><span
                      class="RktPn">)</span><span class="hspace"> </span><span class="RktSym">val</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
              </table>
            </blockquote>
          </div>
          <div class="SIntrapara"><a name="(idx._(gentag._845))"></a></div>
          </p>
        </blockquote>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..27)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>设计一个语言特性，导致最后给 <span class="stt">cont</span> 赋值时，必须用临时变量。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..28)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>给本节的解释器添加<span class="EoplExerciseRef"></span> 中的辅助组件。由于续文表示方式相同，可以
          复用那里的代码。验证本节的指令式解释器生成的跟踪日志与<span class="EoplExerciseRef"></span> 中的
          解释器<span class="emph">完全</span>相同。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..29)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._846))"></a>
          转换本节的 <span class="stt">fact-iter</span>（<span class="stt">fact-iter</span>）。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..30)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._847))"></a>
          <a name="(idx._(gentag._848))"></a>
          <a name="(idx._(gentag._849))"></a>
          <a name="(idx._(gentag._850))"></a>
          <a name="(idx._(gentag._851))"></a>
          <a name="(idx._(gentag._852))"></a>
          <a name="(idx._(gentag._853))"></a>
          修改本节的解释器，让过程使用<span class="EoplExerciseRef"></span> 中的动态绑定。提示：像本章这样
          转换<span class="EoplExerciseRef"></span> 中的解释器；二者不同的部分转换后才会不同。
          像<span class="EoplExerciseRef"></span> 那样给解释器添加辅助组件。观察可知，就像当前状态中只有一
          个续文，当前状态只会压入或弹出一个环境，而且环境与续文同时压入或弹出。由此我们得
          出结论，动态绑定具有<span class="emph">动态期限</span> (<span class="emph">dynamic extent</span>)：即，形参的绑定保留
          到过程返回为止。词法绑定则与之不同，绑定包裹在闭包内时可以无限期地保留。
          <a name="(idx._(gentag._854))"></a>
          <a name="(idx._(gentag._855))"></a>
          <a name="(idx._(gentag._856))"></a>
          <a name="(idx._(gentag._857))"></a>
          <a name="(idx._(gentag._858))"></a>
          <a name="(idx._(gentag._859))"></a>
          <a name="(idx._(gentag._860))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..31)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>添加全局寄存器，排除本节代码中剩余的 <span class="stt">let</span> 表达式。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..32)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>改进前一题的解答，尽可能减少全局寄存器的数量。不到 5 个就可以。除了本节解释器中
          已经用到的，不要使用其他数据结构。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..33)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._861))"></a>
          把本节的解释器翻译为指令式语言。做两次，一次使用宿主语言中的无参数过程调用，一次
          使用 <span class="stt">goto</span>。计算量增加时，这二者性能如何？</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..34)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>如<span
            class="stt">imperative-lang</span>所述，用大多数指令式语言都难以完成这种翻译，因为它们
          在所有过程调用中使用堆栈，即使是尾调用。而且，对大型解释器，由 <span class="stt">goto</span> 链接的
          代码可能太过庞大，以致某些编译器无法处理。把本节的解释器翻译为指令式语言，
          用<span class="EoplExerciseRef"></span> 中的跳跃技术规避这一难题。</p>
      </blockquote>
      <h4>5.4<tt> </tt><a name="(part._s5..4)"></a>异常</h4>
      <p><a name="(idx._(gentag._862))"></a>
        <a name="(idx._(gentag._863))"></a>
        迄今为止，我们只用续文管理语言中的普通控制流。但是续文还能让我们修改控制上下文。让
        我们来给我们的语言添加<span class="emph">异常处理</span> (<span class="emph">exception handling</span>)。我们给语言新
        增两个生成式：
      </p>
      <blockquote class="Small">
        <p><span class="Iidentity">\begin{align*}\mathit{Expression} &::= <span class="stt">try </span><span
              class="Iidentity">\mathit{Expression}</span><span class="stt"> catch (</span><span
              class="Iidentity">\mathit{Identifier}</span><span class="stt">) </span><span
              class="Iidentity">\mathit{Expression}</span> \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">try-exp (exp1 var handler-exp)</span>} \\[5pt]
            \mathit{Expression} &::= <span class="stt">raise </span><span class="Iidentity">\mathit{Expression}</span>
            \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">raise-exp (exp)</span>}\end{align*}</span></p>
      </blockquote>
      <p><span class="stt">try</span> 表达式在 <span class="stt">catch</span> 从句描述的异常处理上下文中求第一个参数的值。如果该
        表达式正常返回，它的值就是整个 <span class="stt">try</span> 表达式的值，异常处理器（即
        <span class="stt">handler-exp</span>）则被移除。
      </p>
      <p><span class="stt">raise</span> 表达式求出参数的值，以该值抛出一个异常。这个值会传给最接近的异常处理
        器，并绑定到这个处理器的变量。然后，处理器主体将被求值。处理器主体可以返回一个值，
        这个值称为对应 <span class="stt">try</span> 表达式的值；或者，它可以抛出另一个异常，
        将异常<span class="emph">传播</span> (<span class="emph">propagate</span>) 出去；这时，该异常会传给第二接近的异常处理器。</p>
      <p>这里是一个例子（暂时假设我们给语言添加了字符串）。</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let list-index =</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">proc (str)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">letrec inner
                    (lst)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">       </span><span class="stt">= if null?(lst)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">         </span><span class="stt">then
                    raise("ListIndexFailed")</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">         </span><span class="stt">else if
                    string-equal?(car(lst), str)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">              </span><span class="stt">then 0</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">              </span><span class="stt">else -((inner
                    cdr(lst)), -1)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>过程 <span class="stt">list-index</span> 是个咖喱式过程，它取一个字符串，一个字符串列表，返回字符串
          在列表中的位置。如果找不到期望的列表元素，<span class="stt">inner</span> 抛出一个异常，跳过所有待做
          的减法，把 <span class="stt">"ListIndexFailed"</span> 传给最接近的异常处理器。</p>
      </blockquote>
      <p>这个异常处理器可以利用调用处的信息对异常做适当处理。</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let find-member-number =</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">proc (member-name)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">... try ((list-index
                    member-name) member-list)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">            </span><span class="stt">catch (exn)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">             </span><span
                    class="stt">raise("CantFindMemberNumber")</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>过程 <span class="stt">find-member-number</span> 取一字符串，用 <span class="stt">list-index</span> 找出字符串在列表
          <span class="stt">member-name</span> 中的位置。<span class="stt">find-member-number</span> 的调用者没办法知道
          <span class="stt">list-index</span>，所以 <span class="stt">find-member-number</span> 把错误消息翻译成调用者能够理解的异
          常。
        </p>
      </blockquote>
      <p>根据程序的用途，还有一种可能是，元素名不在列表中时，<span class="stt">find-member-number</span> 返回
        一个默认值。</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let find-member-number =</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">proc (member-name)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">... try ((list-index
                    member-name) member-list)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">           </span><span class="stt">catch (exn)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">            </span><span
                    class="stt">the-default-member-number</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>在这些程序中，我们忽略了异常的值。在其他情况下，<span class="stt">raise</span> 传出的值可能包含一部
          分可供调用者利用的信息。</p>
      </blockquote>
      <p>用传递续文的解释器实现这种异常处理机制直截了当。我们从 <span class="stt">try</span> 表达式开始。在续
        文的数据结构表示中，我们添加两个构造器：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">try-cont</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">var</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">identifier?</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">handler-exp</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">expression?</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">env</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">environment?</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">continuation?</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                    class="RktSym">raise1-cont</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">saved-cont</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">continuation?</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>在 <span class="stt">value-of/k</span> 中，我们给 <span class="stt">try</span> 添加下面的从句：</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">try-exp</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktPn">(</span><span class="RktSym">exp1</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">var</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">handler-exp</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">exp1</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">env</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">try-cont</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">var</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">handler-exp</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">env</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
      </blockquote>
      <p>求 <span class="stt">try</span> 表达式主体的值时会发生什么呢？如果主体正常返回，那么这个值应该传给
        <span class="stt">try</span> 表达式的续文，也就是此处的 <span class="stt">cont</span>：
      </p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(apply-cont (try-cont </span><span class="texMathInline">var</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">handler\mbox{-}exp</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt"></span><span class="texMathInline">env</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">cont</span><span class="stt">) </span><span
                  class="texMathInline">val</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (apply-cont </span><span class="texMathInline">cont</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">val</span><span class="stt">)</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>如果一个异常抛出了呢？首先，我们当然得求出 <span class="stt">raise</span> 参数的值。</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">raise-exp</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktPn">(</span><span class="RktSym">exp1</span><span class="RktPn">)</span><span
                  class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktSym">exp1</span><span class="RktMeta"></span><span class="hspace"> </span><span
                  class="RktMeta"></span><span class="RktSym">env</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">raise1-cont</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>当 <span class="stt">exp1</span> 的值返回给 <span class="stt">raise1-cont</span> 时，我们要查找续文中最接近的异常处理器，
        即最上层的 <span class="stt">try-cont</span> 续文。所以，我们把续文规范写成：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(apply-cont (raise1-cont </span><span class="texMathInline">cont</span><span
                    class="stt">) </span><span class="texMathInline">val</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (apply-handler </span><span class="texMathInline">val</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">cont</span><span class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>其中，<span class="stt">apply-handler</span> 是一过程，它找出最接近的异常处理器，然后调用它
          （<span class="EoplFigureRef"></span>）。</p>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!t]</div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">apply-handler</span></span> : <span
                    class="texMathInline">\mathit{ExpVal} \times \mathit{Cont} \to \mathit{FinalAnswer}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">apply-handler</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                    class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">continuation</span><span class="hspace"> </span><span
                    class="RktSym">cont</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">try-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">handler-exp</span><span
                    class="hspace"> </span><span class="RktSym">saved-env</span><span class="hspace"> </span><span
                    class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">handler-exp</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">extend-env</span><span class="hspace"> </span><span class="RktSym">var</span><span
                    class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                    class="RktSym">saved-env</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktSym">saved-cont</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">end-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">report-uncaught-exception</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">diff1-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp2</span><span class="hspace"> </span><span class="RktSym">saved-env</span><span
                    class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">apply-handler</span><span class="hspace"> </span><span class="RktSym">val</span><span
                    class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">diff2-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">val1</span><span class="hspace"> </span><span class="RktSym">saved-cont</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">apply-handler</span><span class="hspace"> </span><span class="RktSym">val</span><span
                    class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktSym">...</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <blockquote class="caption">
          <p>过程 <span class="stt">apply-handler</span><a name="(elem._fig-5..15)"></a></p>
        </blockquote>
      </blockquote>
      <p>要明白怎样将这些结合到一起，我们考虑用被定语言实现的 <span class="stt">index</span>。令 <span class="texMathInline">exp_0</span> 指
        代表达式：</p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">let index</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">     </span><span class="stt">= proc (n)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">        </span><span class="stt">letrec inner
                  (lst)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">          </span><span class="stt">= if null?
                  (lst)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">            </span><span class="stt">then raise 99</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">            </span><span class="stt">else if
                  zero?(-(car(lst), n))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">                 </span><span class="stt">then 0</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">                 </span><span class="stt">else -((inner
                  cdr(lst)), -1)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">          </span><span class="stt">in proc (lst)</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">              </span><span class="stt">try (inner
                  lst)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">               </span><span class="stt">catch (x)
                  -1</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">in ((index 5) list(2, 3))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>我们从任意环境 <span class="texMathInline">\rho_0</span> 和续文 <span class="texMathInline">cont_0</span> 开始求 <span
          class="texMathInline">exp_0</span> 的值，只展示计算的
        关键部分，并插入注释。</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplComputationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<let index=... in ((index 5) list(2, 3))>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_0</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">cont_0</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">执行</span><span
                      class="stt">let</span><span class="emph">主体</span></span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<((index 5) list(2, 3))>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">((index</span><span
                    class="hspace">               </span><span class="stt"></span><span class="Smaller"><span
                      class="emph">称之为</span><span class="texMathInline">\rho_1</span></span><span class="stt"></span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">#(struct:proc-val</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">#(struct:procedure n
                    <<letrec ...>> </span><span class="texMathInline">\rho_0</span><span class="stt">)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">(i #(struct:num-val
                    1))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">(v #(struct:num-val
                    5))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">(x #(struct:num-val
                    10)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:end-cont))</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">最后求</span><span
                      class="stt">try</span><span class="emph">的值</span></span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<try (inner lst) catch (x) -1>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">((lst</span><span
                    class="hspace">                 </span><span class="stt"></span><span class="Smaller"><span
                      class="emph">称之为</span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span></span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">#(struct:list-val</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">(#(struct:num-val 2)
                    #(struct:num-val 3))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">(inner ...)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">(n #(struct:num-val
                    5))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt"></span><span
                    class="texMathInline">\rho_0</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:end-cont))</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">在</span><span
                      class="stt">try-cont</span><span class="emph">续文中求</span><span class="stt">try</span><span
                      class="emph">主体的值</span></span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<(inner lst)>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:try-cont x <<-1>>
                  </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span
                    class="stt">#(struct:end-cont)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="stt">lst</span><span
                      class="emph">绑定到</span><span class="texMathInline">(2 \ 3)</span>，<span class="emph">求</span><span
                      class="stt">inner</span><span class="emph">主体的值</span></span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<if null?(lst) ...>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:try-cont x <<-1>>
                  </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span
                    class="stt">#(struct:end-cont)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">求条件的值，进入递归所在的行</span></span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"><<-((inner cdr(lst)),
                      -1)>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:try-cont x <<-1>>
                  </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span
                    class="stt">#(struct:end-cont)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">求</span><span
                      class="stt">diff-exp</span><span class="emph">第一个参数的值</span></span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<(inner cdr(lst))>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff1-cont <<-1>>
                  </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">#(struct:try-cont x
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span
                    class="stt">#(struct:end-cont))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="stt">lst</span><span
                      class="emph">绑定到</span><span class="texMathInline">(3)</span>，<span class="emph">求</span><span
                      class="stt">inner</span><span class="emph">主体的值</span></span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<if null?(lst) ...>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">((lst #(struct:list-val
                    (#(struct:num-val 3)))) </span><span class="Smaller"><span class="emph">称之为</span><span
                      class="texMathInline">\rho_{lst=(3)}</span></span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">(inner ...)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt"></span><span
                    class="texMathInline">\rho_0</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff1-cont <<-1>>
                  </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">#(struct:try-cont x
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span
                    class="stt">#(struct:end-cont))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">求条件的值，进入递归所在的行</span></span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"><<-((inner cdr(lst)),
                      -1)>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_{lst=(3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff1-cont <<-1>>
                  </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">#(struct:try-cont x
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span
                    class="stt">#(struct:end-cont))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">求</span><span
                      class="stt">diff-exp</span><span class="emph">第一个参数的值</span></span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<(inner cdr(lst))>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_{lst=(3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff1-cont <<-1>>
                  </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">#(struct:diff1-cont
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">#(struct:try-cont x
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">           </span><span
                    class="stt">#(struct:end-cont)))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="stt">lst</span><span
                      class="emph">绑定到</span><span class="texMathInline">()</span>，<span class="emph">求</span><span
                      class="stt">inner</span><span class="emph">主体的值</span></span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<if null?(lst) ...>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">((lst #(struct:list-val
                    ()))</span><span class="hspace">     </span><span class="stt"></span><span class="Smaller"><span
                      class="emph">称之为</span><span class="texMathInline">\rho_{lst=()}</span></span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">(inner ...)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">(n #(struct:num-val
                    5))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">...)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff1-cont <<-1>>
                  </span><span class="texMathInline">\rho_{lst=(3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">#(struct:diff1-cont
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">#(struct:try-cont x
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">           </span><span
                    class="stt">#(struct:end-cont)))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">求</span><span
                      class="stt">raise</span><span class="emph">表达式参数的值</span></span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<99>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_{lst=()}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:raise1-cont</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">#(struct:diff1-cont
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">#(struct:diff1-cont
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">           </span><span class="stt">#(struct:try-cont x
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">              </span><span
                    class="stt">#(struct:end-cont))))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">用</span><span
                      class="stt">apply-handler</span><span class="emph">展开续文，直到找出一个异常处理器</span></span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-handler</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:num-val 99)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">#(struct:diff1-cont
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">#(struct:diff1-cont
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">           </span><span class="stt">#(struct:try-cont x
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">              </span><span
                    class="stt">#(struct:end-cont)))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">=</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-handler</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:num-val 99)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:diff1-cont <<-1>>
                  </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">#(struct:try-cont x
                    <<-1>> </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span
                    class="stt">#(struct:end-cont))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">=</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-handler</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:num-val 99)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:try-cont x <<-1>>
                  </span><span class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span
                    class="stt">#(struct:end-cont)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="Smaller"><span class="emph">找到异常处理器；把异常值绑定到</span><span
                      class="stt">x</span></span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of/k</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:const-exp
                    -1)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">((x #(struct:num-val
                    99))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_{lst=(2 \ 3)}</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt">...)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">#(struct:end-cont))</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">=</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont #(struct:end-cont) #(struct:const-exp -1))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">=</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">#(struct:const-exp -1)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>如果列表包含期望值，那么我们不需调用 <span class="stt">apply-handler</span>，而是调用
        <span class="stt">apply-cont</span>，并执行续文中所有待完成的 <span class="stt">diff</span>。
        <a name="(idx._(gentag._864))"></a>
        <a name="(idx._(gentag._865))"></a>
      </p>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..35)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>这种实现很低效，因为异常抛出时，<span class="stt">apply-handler</span> 必须在续文中线性查找处理器。
          让所有续文都能直接使用 <span class="stt">try-cont</span> 续文，从而避免这种查找。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..36)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>另一种避免 <span class="stt">apply-handler</span> 线性查找的设计是使用两个续文，一个正常续文，一个异
          常续文。修改本节的解释器，改用两个续文，实现这一目标。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..37)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>修改被定语言，在过程调用的实参数目错误时抛出异常。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..38)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>修改被定语言，添加除法表达式，并在被零除时抛出异常。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..39)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>目前，异常处理器可以重新抛出异常，把它传播出去；或者返回一个值，作为 <span class="stt">try</span> 表
          达式的值。还可以这样设计语言：允许计算从异常抛出的位置继续。修改本节的解释器，在
          <span class="stt">raise</span> 调用处的续文中运行异常处理器的主体，完成这种设计。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..40)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>把
          <span class="stt">raise</span> 异常处的续文作为第二个参数传递，使被定语言中的异常处理器既能返回也
          能继续。这可能需要把续文作为一种新的表达值。为用值调用续文设计恰当的语法。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..41)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._866))"></a>
          <a name="(idx._(gentag._867))"></a>
          我们展示了如何用数据结构表示的续文实现异常。我们没办法马上用<a href="da.html#%28part._s2..2..3%29" data-pltdoc="x">过程表示法</a>中的
          步骤得到过程表示法，因为我们现在有两个观测器：<span class="stt">apply-handler</span> 和
          <span class="stt">apply-cont</span>。用一对过程实现本节的续文：一个单参数过程，表示 <span class="stt">apply-cont</span>
          中续文的动作；一个无参数过程，表示 <span class="stt">apply-handler</span> 中续文的动作。
          <a name="(idx._(gentag._868))"></a>
          <a name="(idx._(gentag._869))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..42)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._870))"></a>
          <a name="(idx._(gentag._871))"></a>
          <a name="(idx._(gentag._872))"></a>
          前一道练习只在抛出异常时捕获续文。添加形式 <span class="stt">letcc </span><span
            class="texMathInline">\mathit{Identifier}</span><span class="stt"> in</span><span class="stt">
          </span><span class="texMathInline">\mathit{Expression}</span>，允许在语言中的任意位置捕获续文，其规范为：
        </p>
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(value-of/k (letcc </span><span class="texMathInline">var</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">body</span><span class="stt">) </span><span
                    class="texMathInline">\rho</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">cont</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of/k </span><span class="texMathInline">body</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">(extend-env </span><span
                    class="texMathInline">var</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">cont</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">\rho</span><span
                    class="stt">) </span><span class="texMathInline">cont</span><span class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>这样捕获的续文可用 <span class="stt">throw</span> 调用：表达式 <span class="stt">throw </span><span
            class="texMathInline">\mathit{Expression}</span><span class="stt"> to</span><span class="stt">
          </span><span class="texMathInline">\mathit{Expression}</span> 求出两个子表达式的值。第二个表达式应返回一续文，应用于
          第一个表达式的值。<span class="stt">throw</span> 表达式当前的续文则被忽略。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..43)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>修改前一道练习被定语言中的 <span class="stt">letcc</span>，把捕获的续文作为一种新的过程，这样就能写
          <span class="stt">(</span><span class="texMathInline">exp_1</span><span class="stt"> </span><span
            class="texMathInline">exp_2</span><span class="stt">)</span>，而不必写 <span class="stt">throw </span><span
            class="texMathInline">\mathit{Expression}</span><span class="stt"> to</span><span class="stt">
          </span><span class="texMathInline">\mathit{Expression}</span>。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..44)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>前面练习里的
          <span class="stt">letcc</span> 和 <span class="stt">throw</span> 还有一种设计方式，只需给语言添加一个过程。
          这个过程在 Scheme 中叫做 <span class="stt">call-with-current-continuation</span>，它取一个单参数过程
          <span class="stt">p</span>，并给 <span class="stt">p</span> 传递一个单参数过程，这个过程在调用时，将其参数传递给当前的续
          文<span class="stt">cont</span>。<span class="stt">call-with-current-continuation</span> 可用 <span
            class="stt">letcc</span> 和 <span class="stt">throw</span>
          定义如下：
        </p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let call-with-current-continuation</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">= proc (p)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">          </span><span class="stt">letcc cont</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">          </span><span class="stt">in (p proc (v) throw
                    v to cont)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in ...</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>给语言添加 <span class="stt">call-with-current-continuation</span>。然后写一个翻译器，用只有
          <span class="stt">call-with-current-continuation</span> 的语言翻译具有 <span class="stt">letcc</span> 和 <span
            class="stt">throw</span> 的语
          言。
          <a name="(idx._(gentag._873))"></a>
          <a name="(idx._(gentag._874))"></a>
          <a name="(idx._(gentag._875))"></a>
        </p>
      </blockquote>
      <h4>5.5<tt> </tt><a name="(part._s5..5)"></a>线程</h4>
      <p><a name="(idx._(gentag._876))"></a>
        <a name="(idx._(gentag._877))"></a>
        许多编程任务中，可能需要一次进行多项计算。当这些计算作为同一进程的一部分，运行在
        同一地址空间，通常称它们为<span class="emph">线程</span> (<span class="emph">thread</span>)。本节，我们将看到如何修改解释器，
        模拟多线程程序的执行。
      </p>
      <p>我们的多线程解释器不做单线程计算，而且维护多个线程。就像本章之前展示的那样，每
        个线程包含一项正在进行的计算。线程使用<a href="state.html" data-pltdoc="x">状态</a>中的赋值，通过共享内存通信。
        <a name="(idx._(gentag._878))"></a><a name="(idx._(gentag._879))"></a>
      </p>
      <p>在我们的系统中，整个计算包含一个线程<span class="emph">池</span> (<span class="emph">pool</span>)。每个
        线程<span class="emph">在运行</span> (<span class="emph">running</span>)、<span class="emph">可运行</span> (<span
          class="emph">runnable</span>) 或者<span class="emph">受
          阻塞</span> (<span class="emph">blocked</span>)。在我们的系统中，一次只能有一个线程在运行。在多 CPU 系统中，可以有若干线程
        同时运行。可运行的线程记录在名为<span class="emph">就绪队列</span> (<span class="emph">ready queue</span>)的队列中。还有些线
        程因为种种原因未能就绪，我们说这些线程<span class="emph">受阻塞</span>。本节稍后介绍受阻塞线程。</p>
      <p>线程调度由<span class="emph">调度器</span> (<span class="emph">scheduler</span>) 执行，就绪队列为其状态的一部分。
        <a name="(idx._(gentag._880))"></a>
        此外，它保存一个计时器，当一个线程执行若干步骤（即线程的<span class="emph">时间片</span> (<span class="emph">time slice</span>)
        <a name="(idx._(gentag._881))"></a>
        或<span class="emph">量子</span> (<span class="emph">quantum</span>)）时，它中断线程，将其放回就绪队列，并从就绪队列中选出一
        个新的线程来运行。这叫做<span class="emph">抢占式调度</span> (<span class="emph">pre-emptive scheduling</span>)。
      </p>
      <p><a name="(idx._(gentag._882))"></a>
        <a name="(idx._(gentag._883))"></a>
      </p>
      <p>我们的新语言基于 IMPLICIT-REFS，名叫 THREADS。在 THREADS 中，新线程由名为
        <span class="stt">spawn</span> 的结构创建。<span class="stt">spawn</span> 取一参数，该参数的值应为一个过程。新创建的线程
        运行时，给那个过程传递一个任意参数。该线程不是立刻运行，而是放入就绪队列中，轮到
        它时才运行。<span class="stt">spawn</span> 的执行只求效果；在我们的系统中，我们为它任选一个返回值 73。
      </p>
      <p>我们来看这种语言的两个示例程序。<span class="EoplFigureRef"></span> 定义了一个过程 <span class="stt">noisy</span>，
        它取一个列表，打印出列表的第一个元素，然后递归处理列表的剩余部分。这里，主体中的
        表达式创建两个线程，分别打印列表 <span class="stt">[1,2,3,4,5]</span> 和 <span class="stt">[6,7,8,9,10]</span>。两个列表
        究竟如何穿插取决于调度器；在本例中，在被调度器打断之前，每个线程打印出列表中的两
        个元素，</p>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!ht]</div>
        <div class="SIntrapara">
          <blockquote class="EoplCodeInset">
            <table cellspacing="0" cellpadding="0" class="SVerbatim">
              <tr>
                <td>
                  <p><span class="stt">test: two-non-cooperating-threads</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace"> </span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">letrec</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">  </span><span class="stt">noisy (l) = if
                      null?(l)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">              </span><span class="stt">then 0</span>
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">              </span><span class="stt">else begin
                      print(car(l)); (noisy cdr(l)) end</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">in</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">   </span><span class="stt">begin</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">    </span><span class="stt">spawn(proc (d) (noisy
                      [1,2,3,4,5]));</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">    </span><span class="stt">spawn(proc (d) (noisy
                      [6,7,8,9,10]));</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">    </span><span class="stt">print(100);</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">    </span><span class="stt">33</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">   </span><span class="stt">end</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace"> </span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">100</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">1</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">2</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">6</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">7</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">3</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">4</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">8</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">9</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">5</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">10</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">正确结果: 33</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">实际结果: #(struct:num-val 33)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">正确</span></p>
                </td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <blockquote class="caption">
          <p>两个交错运行的线程<a name="(elem._fig-5..16)"></a></p>
        </blockquote>
      </blockquote>
      <p><span class="EoplFigureRef"></span> 展示了一个生产者和一个消费者，由初始值为 0 的缓存相联系。
        生产者取一参数 <span class="stt">n</span>，进入 <span class="stt">wait</span>，循环 5 次，然后把 <span class="stt">n</span>
        放入缓存。每次进
        入 <span class="stt">wait</span> 循环，它打印一个倒数计时器（以 200s 为单位）的值。消费者取一参数
        （但忽略它），进入一循环，等待缓存变成非零值。每次进入循环时，它打印一个计数器
        （以 100s 为单位）的值，以展示它等结果等了多久。主线程将生产者放入就绪队列，打印
        出 300，并在自身中启动消费者。所以，前两项，300 和 205，分别由主线程和生产者线程
        打印。<span class="NoteBox"><span class="NoteContent">原文为So the first two items, 300 and 205, are printed by the
            main
            thread. 实则205是生产者所在线程打印。</span></span>就像前一个例子那样，在被打断之前，消费者线
        程和生产者线程各自循环大约两次。</p>
      <blockquote class="EoplFigure">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let buffer = 0</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in let producer = proc (n)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">letrec</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">         </span><span class="stt">wait(k) = if
                    zero?(k)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                   </span><span class="stt">then set
                    buffer = n</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                   </span><span class="stt">else
                    begin</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                         </span><span
                    class="stt">print(-(k,-200));</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                         </span><span class="stt">(wait
                    -(k,1))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                        </span><span
                    class="stt">end</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">         </span><span class="stt">in (wait 5)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in let consumer = proc
                    (d)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">           </span><span class="stt">letrec busywait (k)
                    = if zero?(buffer)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                                 </span><span
                    class="stt">then begin</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                                       </span><span
                    class="stt">print(-(k,-100));</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                                       </span><span
                    class="stt">(busywait -(k,-1))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                                      </span><span
                    class="stt">end</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                                 </span><span
                    class="stt">else buffer</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">           </span><span class="stt">in (busywait
                    0)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in begin</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">          </span><span class="stt">spawn(proc (d)
                    (producer 44));</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">          </span><span class="stt">print(300);</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">          </span><span class="stt">(consumer 86)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">         </span><span class="stt">end</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">300</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">205</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">100</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">101</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">204</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">203</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">102</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">103</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">202</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">201</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">104</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">105</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">正确结果: 44</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">实际结果: #(struct:num-val 44)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">正确</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <blockquote class="caption">
          <p>由缓存连接的生产者和消费者<a name="(elem._fig-5..17)"></a></p>
        </blockquote>
      </blockquote>
      <p>实现从 IMPLICIT-REFS 语言传递续文的解释器开始。这与<a href="#%28part._s5..1%29" data-pltdoc="x">传递续文的解释器</a>中的类似，只是多
        了 IMPLICIT-REFS 中的存储器（当然！），以及<span class="EoplExerciseRef"></span> 中的续文构造器
        <span class="stt">set-rhs-cont</span>。
      </p>
      <p>我们给这个解释器添加一个调度器。调度器状态由四个值组成，接口提供六个过程来操作这
        些值，如<span class="EoplFigureRef"></span> 所示。</p>
      <p><span class="EoplFigureRef"></span> 展示了本接口的实现。这里 <span class="stt">(enqueue </span><span
          class="texMathInline">q</span><span class="stt"> </span><span class="texMathInline">val</span><span
          class="stt">)</span> 返回
        一队列，除了把 <span class="texMathInline">val</span> 放在末尾之外，与 <span class="texMathInline">q</span> 相同。<span
          class="stt">(dequeue </span><span class="texMathInline">q</span><span class="stt"> </span><span
          class="texMathInline">f</span><span class="stt">)</span>
        取出队头及剩余部分，将它们作为参数传递给 <span class="texMathInline">f</span>。</p>
      <p>我们用无参数且返回表达值的 Scheme 过程表示线程：</p>
      <blockquote class="Small">
        <blockquote>
          <p><span class="texMathInline">\mathit{Thread} = () \to \mathit{ExpVal}</span></p>
        </blockquote>
      </blockquote>
      <p>如果就绪队列非空，那么过程 <span class="stt">run-next-thread</span> 从就绪队列取出第一个线程并运行，
        赋予它一个大小为 <span class="stt">the-max-time-slice</span> 的新时间片。如果还有就绪线程，它还把
        <span class="stt">the-ready-queue</span> 设置为剩余线程队列。如果就绪队列为空，<span class="stt">run-next-thread</span>
        返回 <span class="stt">the-final-answer</span>，计算至此全部终止。
      </p>
      <p><a name="(idx._(gentag._884))"></a>
        然后我们来看解释器。<span class="stt">spawn</span> 表达式在某个续文中求参数的值，这个续文执行时，将
        一个新线程放入就绪队列，并将 73 返回给 <span class="stt">spawn</span> 的调用者。新的线程执行时，将一
        个任意值（这里选 28）传给 <span class="stt">spawn</span> 参数求值得到的过程。要完成这些，我们给
        <span class="stt">value-of/k</span> 新增从句：
      </p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">spawn-exp</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                    class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">value-of/k</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">exp</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">env</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">spawn-cont</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>给 <span class="stt">apply-cont</span> 新增从句：</p>
        <blockquote class="EoplCodeInset">
          <p>
          <div class="SIntrapara">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span
                      class="RktSym">spawn-cont</span><span class="RktMeta"></span><span class="hspace"> </span><span
                      class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">saved-cont</span><span
                      class="RktPn">)</span><span class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                      class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">let</span><span
                      class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                      class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">proc1</span><span
                      class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                      class="RktPn">(</span><span class="RktSym">expval->proc</span><span class="RktMeta"></span><span
                      class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">val</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                      class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">place-on-ready-queue!</span><span class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktMeta"></span><span
                      class="hspace">      </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">lambda</span><span class="RktMeta"></span><span class="hspace"> </span><span
                      class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span
                      class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktMeta"></span><span
                      class="hspace">        </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">apply-procedure/k</span><span class="RktMeta"></span><span
                      class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">proc1</span><span
                      class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktMeta"></span><span
                      class="hspace">          </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">num-val</span><span class="RktMeta"></span><span class="hspace"> </span><span
                      class="RktMeta"></span><span class="RktVal">28</span><span class="RktPn">)</span><span
                      class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktMeta"></span><span
                      class="hspace">          </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                      class="RktSym">end-subthread-cont</span><span class="RktPn">)</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktMeta"></span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                      class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">apply-cont</span><span
                      class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                      class="RktSym">saved-cont</span><span class="RktMeta"></span><span class="hspace"> </span><span
                      class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">num-val</span><span
                      class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                      class="RktVal">73</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
                </tr>
              </table>
            </blockquote>
          </div>
          <div class="SIntrapara"><a name="(idx._(gentag._885))"></a></div>
          </p>
        </blockquote>
        <blockquote class="EoplFigure">
          <p>
          <div class="SIntrapara">[!ht]
          </div>
          <div class="SIntrapara">
            <blockquote class="SubFlow">
              <p>
              <div class="SIntrapara">\begin{cornerbox}[title=调度器的内部状态]
              </div>
              <div class="SIntrapara">
                <table cellspacing="0" cellpadding="0">
                  <tr>
                    <td>
                      <p><span class="stt">the-ready-queue</span></p>
                    </td>
                    <td>
                      <p><span class="hspace"> </span></p>
                    </td>
                    <td>
                      <p>就绪队列</p>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <p><span class="stt">the-final-answer</span></p>
                    </td>
                    <td>
                      <p><span class="hspace"> </span></p>
                    </td>
                    <td>
                      <p>主线程结束时的值</p>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <p><span class="stt">the-max-time-slice</span></p>
                    </td>
                    <td>
                      <p><span class="hspace"> </span></p>
                    </td>
                    <td>
                      <p>每个线程运行的步数</p>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <p><span class="stt">the-time-remaining</span></p>
                    </td>
                    <td>
                      <p><span class="hspace"> </span></p>
                    </td>
                    <td>
                      <p>当前运行线程剩余的步数</p>
                    </td>
                  </tr>
                </table>
              </div>
              <div class="SIntrapara">
                \end{cornerbox}</div>
              </p>
            </blockquote>
          </div>
          </p>
          <blockquote class="SubFlow">
            <p>
            <div class="SIntrapara">\begin{cornerbox}[title=调度器的接口]
            </div>
            <div class="SIntrapara">
              <table cellspacing="0" cellpadding="0">
                <tr>
                  <td>
                    <p><span style="font-weight: bold">initialize-scheduler!</span></p>
                  </td>
                  <td>
                    <p><span class="hspace"> </span></p>
                  </td>
                  <td>
                    <p><span class="texMathInline">: \mathit{Int} \to \mathit{Unspecified}</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p></p>
                  </td>
                  <td>
                    <p><span class="hspace"> </span></p>
                  </td>
                  <td>
                    <p>初始化调度器状态</p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span style="font-weight: bold">place-on-ready-queue!</span></p>
                  </td>
                  <td>
                    <p><span class="hspace"> </span></p>
                  </td>
                  <td>
                    <p><span class="texMathInline">: \mathit{Thread} \to \mathit{Unspecified}</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p></p>
                  </td>
                  <td>
                    <p><span class="hspace"> </span></p>
                  </td>
                  <td>
                    <p>把线程放入就绪队列</p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span style="font-weight: bold">run-next-thread</span></p>
                  </td>
                  <td>
                    <p><span class="hspace"> </span></p>
                  </td>
                  <td>
                    <p><span class="texMathInline">: \mathit{()} \to \mathit{FinalAnswer}</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p></p>
                  </td>
                  <td>
                    <p><span class="hspace"> </span></p>
                  </td>
                  <td>
                    <p>运行下一个线程。如果没有就绪线程，返回最终答案。</p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span style="font-weight: bold">set-final-answer!</span></p>
                  </td>
                  <td>
                    <p><span class="hspace"> </span></p>
                  </td>
                  <td>
                    <p><span class="texMathInline">: \mathit{ExpVal} \to \mathit{Unspecified}</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p></p>
                  </td>
                  <td>
                    <p><span class="hspace"> </span></p>
                  </td>
                  <td>
                    <p>设置最终答案</p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span style="font-weight: bold">time-expired?</span></p>
                  </td>
                  <td>
                    <p><span class="hspace"> </span></p>
                  </td>
                  <td>
                    <p><span class="texMathInline">: \mathit{()} \to \mathit{Bool}</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p></p>
                  </td>
                  <td>
                    <p><span class="hspace"> </span></p>
                  </td>
                  <td>
                    <p>判断计时器是否为0</p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span style="font-weight: bold">decrement-timer!</span></p>
                  </td>
                  <td>
                    <p><span class="hspace"> </span></p>
                  </td>
                  <td>
                    <p><span class="texMathInline">: \mathit{()} \to \mathit{Unspecified}</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p></p>
                  </td>
                  <td>
                    <p><span class="hspace"> </span></p>
                  </td>
                  <td>
                    <p>递减<span class="stt">the-time-remaining</span></p>
                  </td>
                </tr>
              </table>
            </div>
            <div class="SIntrapara">
              \end{cornerbox}</div>
            </p>
          </blockquote>
          <blockquote class="caption">
            <p>调度器的状态和接口
              <a name="(idx._(gentag._886))"></a><a name="(elem._fig-5..18)"></a>
            </p>
          </blockquote>
        </blockquote>
        <blockquote class="EoplFigure">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">initialize-scheduler!</span></span> : <span
                    class="texMathInline">\mathit{Int} \to \mathit{Unspecified}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">initialize-scheduler!</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">ticks</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                    class="hspace"> </span><span class="RktSym">the-ready-queue</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">empty-queue</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                    class="hspace"> </span><span class="RktSym">the-final-answer</span><span
                    class="hspace"> </span><span class="RktVal">'</span><span class="RktVal">uninitialized</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                    class="hspace"> </span><span class="RktSym">the-max-time-slice</span><span
                    class="hspace"> </span><span class="RktSym">ticks</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                    class="hspace"> </span><span class="RktSym">the-time-remaining</span><span
                    class="hspace"> </span><span class="RktSym">the-max-time-slice</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">place-on-ready-queue!</span></span> : <span
                    class="texMathInline">\mathit{Thread} \to \mathit{Unspecified}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">place-on-ready-queue!</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">th</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                    class="hspace"> </span><span class="RktSym">the-ready-queue</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">enqueue</span><span class="hspace"> </span><span
                    class="RktSym">the-ready-queue</span><span class="hspace"> </span><span
                    class="RktSym">th</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">run-next-thread</span></span> : <span
                    class="texMathInline">\mathit{()} \to \mathit{FinalAnswer}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">run-next-thread</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">empty?</span><span
                    class="hspace"> </span><span class="RktSym">the-ready-queue</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">begin</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">when</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">debug-mode?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">            </span><span class="RktPn">(</span><span
                    class="RktSym">eopl:printf</span><span class="hspace"> </span><span
                    class="RktVal">"计算结束.~%"</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktSym">the-final-answer</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">begin</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">when</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">debug-mode?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">            </span><span class="RktPn">(</span><span
                    class="RktSym">eopl:printf</span><span class="hspace"> </span><span
                    class="RktVal">"切换到另一线程.~%"</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">dequeue</span><span class="hspace"> </span><span
                    class="RktSym">the-ready-queue</span></td>
              </tr>
              <tr>
                <td><span class="hspace">            </span><span class="RktPn">(</span><span
                    class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">first-ready-thread</span><span class="hspace"> </span><span
                    class="RktSym">other-ready-thread</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">              </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span
                    class="RktSym">the-ready-queue</span><span class="hspace"> </span><span
                    class="RktSym">other-ready-thread</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">              </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span
                    class="RktSym">the-time-remaining</span><span class="hspace"> </span><span
                    class="RktSym">the-max-time-slice</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">              </span><span class="RktPn">(</span><span
                    class="RktSym">first-ready-thread</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">set-final-answer!</span></span> : <span
                    class="texMathInline">\mathit{ExpVal} \to \mathit{Unspecified}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">set-final-answer!</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                    class="hspace"> </span><span class="RktSym">the-final-answer</span><span
                    class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">time-expired?</span></span> : <span
                    class="texMathInline">\mathit{ExpVal} \to \mathit{Bool}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">time-expired?</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                    class="hspace"> </span><span class="RktSym">the-time-remaining</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">decrease-timer!</span></span> : <span
                    class="texMathInline">\mathit{()} \to \mathit{Unspecified}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">decrease-timer!</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                    class="hspace"> </span><span class="RktSym">the-time-remaining</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                      class="nobreak">-</span></span><span class="hspace"> </span><span
                    class="RktSym">the-time-remaining</span><span class="hspace"> </span><span
                    class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
          <blockquote class="caption">
            <p>调度器
              <a name="(idx._(gentag._887))"></a><a name="(elem._fig-5..19)"></a>
            </p>
          </blockquote>
        </blockquote>
        <blockquote class="EoplFigure">
          <blockquote class="EoplCodeInset">
            <table cellspacing="0" cellpadding="0" class="SVerbatim">
              <tr>
                <td>
                  <p><span class="stt">let x = 0</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">in let mut = mutex()</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in let incr_x = proc
                      (id)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">                    </span><span class="stt">proc
                      (dummy)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">                     </span><span class="stt">set x =
                      -(x,-1)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in begin</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">          </span><span class="stt">spawn((incr_x
                      100));</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">          </span><span class="stt">spawn((incr_x
                      200));</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">          </span><span class="stt">spawn((incr_x
                      300))</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">         </span><span class="stt">end</span></p>
                </td>
              </tr>
            </table>
          </blockquote>
          <blockquote class="caption">
            <p>不安全的计数器<a name="(elem._fig-5..20)"></a></p>
          </blockquote>
        </blockquote>
        <p>跳跃式解释器生成快照时也要做这样：它将计算打包（这里的 <span class="stt">(lambda ()
            (apply-procedure/k ...))</span>），然后把它传给另一个过程处理。在跳床的例子中，我们把
          线程传给跳床，后者直接执行前者。这里，我们把新线程放入就绪队列，继续我们的现有计
          算。</p>
      </blockquote>
      <p>这带来一个关键问题：每个线程应在什么续文中运行？</p>
      <ul>
        <li>
          <p>运行主线程的续文应记录主线程的值，作为最终答案，然后运行剩余线程。</p>
        </li>
        <li>
          <p>子线程结束时无法报告它的值，所以运行子线程的续文应忽略其值，然后直接运行
            剩余线程。</p>
        </li>
      </ul>
      <p><a name="(idx._(gentag._888))"></a>
        由此我们得出两种新续文，其行为由 <span class="stt">apply-cont</span> 中的以下几行实现：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span
                  class="RktSym">end-main-thread-cont</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                  class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">set-final-answer!</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktSym">val</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">run-next-thread</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"> </span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                  class="RktSym">end-subthread-cont</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                  class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">run-next-thread</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>我们从 <span class="stt">value-of-program</span> 入手整个系统：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">value-of-program</span></span> : <span
                  class="texMathInline">\mathit{Int} \times \mathit{Program} \to \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">value-of-program</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">timeslice</span><span
                  class="hspace"> </span><span class="RktSym">pgm</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span
                  class="RktSym">initialize-store!</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span
                  class="RktSym">initialize-scheduler!</span><span class="hspace"> </span><span
                  class="RktSym">timeslice</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">program</span><span class="hspace"> </span><span
                  class="RktSym">pgm</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">a-program</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">value-of/k</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktSym">exp1</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">init-env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">end-main-thread-cont</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>最后，我们修改 <span class="stt">apply-cont</span>，让它在每次调用时递减计时器。如果计时器到期，那就
        中止当前计算。在实现时，我们先把一个线程放入就绪队列，它用调用
        <span class="stt">run-next-thread</span> 时恢复的计时器再次调用 <span class="stt">apply-cont</span>。
      </p>
      <blockquote class="EoplCodeInset">
        <p>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">apply-cont</span></span> : <span
                    class="texMathInline">\mathit{Cont} \times \mathit{ExpVal} \to \mathit{FinalAnswer}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">apply-cont</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">time-expired?</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">begin</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">place-on-ready-queue!</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">apply-cont</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">run-next-thread</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">begin</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">decrement-timer!</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">cases</span><span class="hspace"> </span><span
                    class="RktSym">continuation</span><span class="hspace"> </span><span class="RktSym">cont</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktSym">...</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._889))"></a></div>
        </p>
      </blockquote>
      <p><a name="(idx._(gentag._890))"></a>
        <a name="(idx._(gentag._891))"></a>
        <a name="(idx._(gentag._892))"></a>
        共享变量不是可靠的通信方式，因为多个线程可能试图写同一变量。例如，
        考虑<span class="EoplFigureRef"></span> 中的程序。这里，我们创建了三个线程，试图累加同一个计数
        器 <span class="stt">x</span>。如果一个线程读取了计数器，但在更新计数器之前被打断，那么两个线程将把
        计数器设置成同样的值。因此，计数器可能变成 2，甚至是 1，而不是 3。
        <a name="(idx._(gentag._893))"></a>
      </p>
      <p>我们想要确保不会发生这种混乱。同样地，我们想要组织我们的程序，
        避免<span class="EoplFigureRef"></span> 中的程序空转。恰恰相反，它应该能够进入休眠状态，并在生
        产者向共享缓存插入值时唤醒。</p>
      <p><a name="(idx._(gentag._894))"></a>
        <a name="(idx._(gentag._895))"></a>
        <a name="(idx._(gentag._896))"></a>
        有许多方式设计这类同步组件。一种简单的方式是使用<span class="emph">互斥锁</span> (<span class="emph">mutex exclusion</span>, <span
          class="emph">mutex</span>) 或<span class="emph">二元信号量</span> (<span class="emph">binary semaphore</span>)。
      </p>
      <p>互斥锁可能<span class="emph">打开</span> (<span class="emph">open</span>) 或<span class="emph">关闭</span> (<span
          class="emph">closed</span>)。它还包含一个等待互斥锁打
        开的线程队列。互斥锁有三种操作：</p>
      <ul>
        <li>
          <p><span class="stt">mutex</span>，无参数操作，创建一个初始状态为打开的互斥锁。</p>
        </li>
        <li>
          <p><span class="stt">wait</span>，单参数操作，线程用它表明想要访问某一互斥锁。它的参数必须是一把
            互斥锁。它的行为取决于互斥锁的状态。</p>
          <ul>
            <li>
              <p>若互斥锁关闭，当前线程放入互斥锁的等待队列中，并中止。我们说当前线
                程<span class="emph">受阻塞</span>，等待这把互斥锁。</p>
            </li>
            <li>
              <p>若互斥锁打开，则将其关闭，并让当前线程继续执行。</p>
            </li>
          </ul>
          <p><span class="stt">wait</span>的执行只求效果；它的返回值未定义。</p>
        </li>
        <li>
          <p><span class="stt">signal</span>，单参数操作，线程用它表明准备释放某一互斥锁。它的参数必须是一
            把互斥锁。</p>
          <ul>
            <li>
              <p>若互斥锁关闭，且等待队列中没有线程，则将其打开，并让当前线程继续执行。</p>
            </li>
            <li>
              <p>若互斥锁关闭，且等待队列中仍有线程，则从中选出一个线程，放入调度器的等待
                队列，互斥锁则保持关闭。执行 <span class="stt">signal</span> 的线程继续计算。</p>
            </li>
            <li>
              <p>若互斥锁打开，则保持打开，线程继续执行。</p>
            </li>
          </ul>
          <p><span class="stt">signal</span>的执行只求效果；它的返回值未定义。<span class="stt">signal</span> 操作总是成功：执行它的
            线程仍然是运行线程。</p>
        </li>
      </ul>
      <p><a name="(idx._(gentag._897))"></a>
        这些属性保证在一对连续的 <span class="stt">wait</span> 和 <span class="stt">signal</span> 之间，只有一个线程可以执行。这
        部分程序叫做<span class="emph">关键区域</span> (<span class="emph">critical region</span>)。在关键区域内，两个线程不可能同时
        执行。例如，<span class="EoplFigureRef"></span> 展示了我们之前的例子，只是在关键行周围插入了一
        把互斥锁。在这个程序中，一次只有一个线程可以执行 <span class="stt">set x = -(x,-1)</span>；所以计数
        器一定能够到达终值 3。
        <a name="(idx._(gentag._898))"></a>
      </p>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!t]</div>
        <div class="SIntrapara">
          <blockquote class="EoplCodeInset">
            <table cellspacing="0" cellpadding="0" class="SVerbatim">
              <tr>
                <td>
                  <p><span class="stt">let x = 0</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">in let mut = mutex()</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in let incr_x = proc
                      (id)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">                    </span><span class="stt">proc
                      (dummy)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">                      </span><span
                      class="stt">begin</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">                        </span><span
                      class="stt">wait(mut);</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">                        </span><span class="stt">set
                      x = -(x,-1);</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">                        </span><span
                      class="stt">signal(mut)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">                      </span><span
                      class="stt">end</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in begin</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">          </span><span class="stt">spawn((incr_x
                      100));</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">          </span><span class="stt">spawn((incr_x
                      200));</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">          </span><span class="stt">spawn((incr_x
                      300))</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">         </span><span class="stt">end</span></p>
                </td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <blockquote class="caption">
          <p>使用互斥锁的安全计数器<a name="(elem._fig-5..21)"></a></p>
        </blockquote>
      </blockquote>
      <p>我们用两个引用模拟互斥锁：一个指向其状态（开启或关闭），一个指向等待这把锁的线程
        列表。我们还把互斥锁作为一种表达值。</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define-datatype</span><span
                  class="hspace"> </span><span class="RktSym">mutex</span><span class="hspace"> </span><span
                  class="RktSym">mutex?</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">a-mutex</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span
                  class="RktSym">ref-to-closed?</span><span class="hspace"> </span><span
                  class="RktSym">reference?</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span
                  class="RktSym">ref-to-wait-queue</span><span class="hspace"> </span><span
                  class="RktSym">reference?</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>我们给 <span class="stt">value-of/k</span> 添加适当的行：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">mutex-exp</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktPn">)</span><span
                    class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">apply-cont</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">cont</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">mutex-val</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktPn">(</span><span class="RktSym">new-mutex</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>其中：</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">new-mutex</span></span> : <span
                    class="texMathInline">\mathit{()} \to \mathit{Mutex}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">new-mutex</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">a-mutex</span></td>
              </tr>
              <tr>
                <td><span class="hspace">     </span><span class="RktPn">(</span><span class="RktSym">newref</span><span
                    class="hspace"> </span><span class="RktVal">#f</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">     </span><span class="RktPn">(</span><span class="RktSym">newref</span><span
                    class="hspace"> </span><span class="RktVal">'</span><span class="RktVal">(</span><span
                    class="RktVal">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
      </blockquote>
      <p><span class="stt">wait</span> 和 <span class="stt">signal</span> 作为新的单参数操作，只是调用过程 <span
          class="stt">wait-for-mutex</span> 和
        <span class="stt">signal-mutex</span>。<span class="stt">wait</span> 和 <span class="stt">signal</span>
        都求出它们唯一参数的值，所以，在
        <span class="stt">apply-cont</span> 中我们写：
      </p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">wait-cont</span><span
                  class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">saved-cont</span><span
                  class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">wait-for-mutex</span><span
                  class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">expval->mutex</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktSym">val</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="RktMeta"></span><span class="hspace"> </span><span
                  class="RktMeta"></span><span class="RktSym">saved-cont</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                  class="RktSym">num-val</span><span class="RktMeta"></span><span class="hspace"> </span><span
                  class="RktMeta"></span><span class="RktVal">52</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"> </span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                  class="RktSym">signal-cont</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">saved-cont</span><span
                  class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">  </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">signal-mutex</span><span
                  class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">expval->mutex</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktSym">val</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktMeta"></span><span class="hspace">    </span><span
                  class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                  class="RktPn">(</span><span class="RktPn">)</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="RktMeta"></span><span class="hspace"> </span><span
                  class="RktMeta"></span><span class="RktSym">saved-cont</span><span class="RktMeta"></span><span
                  class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                  class="RktSym">num-val</span><span class="RktMeta"></span><span class="hspace"> </span><span
                  class="RktMeta"></span><span class="RktVal">53</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktMeta"></span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>现在，我们可以写出 <span class="stt">wait-for-mutex</span> 和 <span class="stt">signal-mutex</span>。这些过程取两个参数：
        一个互斥锁，一个线程，其工作方式如上所述（<span class="EoplFigureRef"></span>）。</p>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">wait-for-mutex</span></span> : <span
                  class="texMathInline">\mathit{Mutex} \times \mathit{Thread} \to \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold">用法</span> : <span class="stt">等待互斥锁开启，然后关闭它</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">wait-for-mutex</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">m</span><span
                  class="hspace"> </span><span class="RktSym">th</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">mutex</span><span class="hspace"> </span><span
                  class="RktSym">m</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">a-mutex</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">ref-to-closed?</span><span
                  class="hspace"> </span><span class="RktSym">ref-to-wait-queue</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">cond</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">deref</span><span class="hspace"> </span><span
                  class="RktSym">ref-to-closed?</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">setref!</span><span class="hspace"> </span><span
                  class="RktSym">ref-to-wait-queue</span></td>
            </tr>
            <tr>
              <td><span class="hspace">              </span><span class="RktPn">(</span><span
                  class="RktSym">enqueue</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">deref</span><span class="hspace"> </span><span
                  class="RktSym">ref-to-wait-queue</span><span class="RktPn">)</span><span class="hspace"> </span><span
                  class="RktSym">th</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">run-next-thread</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span class="RktSym">else</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">setref!</span><span class="hspace"> </span><span
                  class="RktSym">ref-to-closed?</span><span class="hspace"> </span><span class="RktVal">#t</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">th</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">signal-mutex</span></span> : <span
                  class="texMathInline">\mathit{Mutex} \times \mathit{Thread} \to \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">signal-mutex</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">m</span><span
                  class="hspace"> </span><span class="RktSym">th</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">mutex</span><span class="hspace"> </span><span
                  class="RktSym">m</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">a-mutex</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">ref-to-closed?</span><span
                  class="hspace"> </span><span class="RktSym">ref-to-wait-queue</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">closed?</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">deref</span><span class="hspace"> </span><span
                  class="RktSym">ref-to-closed?</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">              </span><span class="RktPn">(</span><span
                  class="RktSym">wait-queue</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">deref</span><span class="hspace"> </span><span
                  class="RktSym">ref-to-wait-queue</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktSym">closed?</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">if</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">empty?</span><span class="hspace"> </span><span class="RktSym">wait-queue</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">              </span><span class="RktPn">(</span><span
                  class="RktSym">begin</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                </span><span class="RktPn">(</span><span
                  class="RktSym">setref!</span><span class="hspace"> </span><span
                  class="RktSym">ref-to-closed?</span><span class="hspace"> </span><span class="RktVal">#f</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                </span><span class="RktPn">(</span><span
                  class="RktSym">th</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">              </span><span class="RktPn">(</span><span
                  class="RktSym">begin</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                </span><span class="RktPn">(</span><span
                  class="RktSym">dequeue</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                  </span><span class="RktSym">wait-queue</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                  </span><span class="RktPn">(</span><span
                  class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">first-waiting-th</span><span class="hspace"> </span><span
                  class="RktSym">other-waiting-ths</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                    </span><span class="RktPn">(</span><span
                  class="RktSym">place-on-ready-queue!</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                      </span><span class="RktSym">first-waiting-th</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                    </span><span class="RktPn">(</span><span
                  class="RktSym">setref!</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                      </span><span class="RktSym">ref-to-wait-queue</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                      </span><span class="RktSym">other-waiting-ths</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                </span><span class="RktPn">(</span><span
                  class="RktSym">th</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">th</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <blockquote class="caption">
          <p><span class="stt">wait-for-mutex</span> 和 <span class="stt">signal-mutex</span>
            <a name="(idx._(gentag._899))"></a>
            <a name="(idx._(gentag._900))"></a>
            <a name="(idx._(gentag._901))"></a><a name="(elem._fig-5..22)"></a>
          </p>
        </blockquote>
      </blockquote>
      <p><a name="(idx._(gentag._902))"></a>
        <a name="(idx._(gentag._903))"></a>
        <a name="(idx._(gentag._904))"></a>
        <a name="(idx._(gentag._905))"></a>
        <a name="(idx._(gentag._906))"></a>
        <a name="(idx._(gentag._907))"></a>
        <a name="(idx._(gentag._908))"></a>
        <a name="(idx._(gentag._909))"></a>
        <a name="(idx._(gentag._910))"></a>
      </p>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..45)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>给本节的语言添加形式 <span class="stt">yield</span>。线程不论何时执行 <span
            class="stt">yield</span>，都将自身放入就绪队
          列之中，就绪队列头部的线程接着执行。当线程继续时，就好像调用 <span class="stt">yield</span> 返回了
          99。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..46)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>在<span
            class="EoplExerciseRef"></span> 的系统中，线程放入就绪队列，既可能是因为耗尽时间片，也可
          能是因为它选择让步。在后一种情况下，线程会以一个完整的时间片重启。修改系统，让就
          绪队列记录每个线程的剩余时间片（如果有的话），在线程重启时仍使用剩余的时间片。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..47)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>如果剩余两个子线程，二者都在等待另一个子线程持有的互斥锁会怎样？</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..48)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._911))"></a>
          我们用过程表示线程。将其改为数据结构表示法。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..49)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._912))"></a>
          <a name="(idx._(gentag._913))"></a>
          为 THREADS 完成<span class="EoplExerciseRef"></span>（用堆栈上的帧表示续文）。
          <a name="(idx._(gentag._914))"></a>
          <a name="(idx._(gentag._915))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..50)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._916))"></a>
          寄存本节的解释器。必须寄存的互递归尾调用过程有哪些？</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..51)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>我们想要组织我们的程序，避免<span class="EoplFigureRef"></span> 中的程序空转。恰恰相反，它应该
          能够进入休眠状态，并在生产者向共享缓存插入值时唤醒。用具有互斥锁的程序完成这些，
          或者实现一种同步操作符完成这些。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..52)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>写出使用互斥锁的程序，如<span class="EoplFigureRef"></span>，但主线程等待所有三个子线程结束，
          然后返回 <span class="stt">x</span> 的值。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..53)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>修改线程的表示，添加<span class="emph">线程描述符</span> (<span class="emph">thread
            identifier</span>)。每个新线程都有一个新
          的线程描述符。当子线程创建时，传给它的不是本节中的任意值 28，而是它的线程描述符。
          子线程的描述符也作为 <span class="stt">spawn</span> 表达式的值返回给父线程。给解释器添加辅助组件，跟
          踪线程描述符的创建。验证就绪队列中一个线程描述符至多出现一次。子线程如何获知父线
          程的描述符？原程序的线程描述符应如何处理？</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..54)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>给<span
            class="EoplExerciseRef"></span> 的解释器添加组件 <span class="stt">kill</span>。<span class="stt">kill</span>
          结构取一线程号，在
          就绪队列或所有等待队列中找出对应的线程，然后删除它。此外，当它找到目标线程时，返
          回真；在所有队列中都找不到指定线程号时，返回假。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..55)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>给<span
            class="EoplExerciseRef"></span> 的解释器添加线程通信组件，一个线程可以用另一线程的描述符
          给它发送一个值。线程可以选择接收消息，没有线程给它发消息时可以阻塞。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..56)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>修改<span
            class="EoplExerciseRef"></span> 的解释器，不要使用共享存储器，而是让每个线程具有自己的
          存储器。在这种语言中，几乎可以排除互斥锁。重写本节语言的示例程序，但不用互斥锁。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..57)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>在你最爱的操作系统教材中，有各种各样的同步机制。挑出三种，在本节的框架下实现它们。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex5..58)"></a><span class="texMathInline">\textnormal{[}<span class="emph">绝对</span> <span
              class="texMathInline">{\star}</span>\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._917))"></a>
          和朋友吃些披萨吧，但是一人一次一定只拿一块！</p>
      </blockquote>
      <div class="navsetbottom"><span class="navleft">
          <div class="nosearchform"></div>  <span class="tocsettoggle">  <a href="javascript:void(0);"
              title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span>
        </span><span class="navright">  <a href="state.html" title="backward to " 4 状态"" data-pltdoc="x">← prev</a>  <a
            href="index.html" title="up to " 编程语言要素"" data-pltdoc="x">up</a>  <a href="cps.html" title="forward to " 6
            续文传递风格"" data-pltdoc="x">next →</a></span> </div>
    </div>
  </div>
  <div id="contextindicator"> </div>
</body>

</html>