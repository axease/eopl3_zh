<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.8" />
  <title>3 表达式</title>
  <link rel="stylesheet" type="text/css" href="scribble.css" title="default" />
  <link rel="stylesheet" type="text/css" href="footnote.css" title="default" />
  <link rel="stylesheet" type="text/css" href="racket.css" title="default" />
  <script type="text/javascript" src="scribble-common.js"></script>
  <script src="katex/katex.min.js"></script>
  <script src="onload.js"></script>

</head>

<body id="scribble-racket-lang-org">
  <div class="tocset">
    <div class="tocview">
      <div class="tocviewlist tocviewlisttopspace">
        <div class="tocviewtitle">
          <table cellspacing="0" cellpadding="0">
            <tr>
              <td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle"
                  onclick="TocviewToggle(this," tocview_0");">▼</a></td>
              <td></td>
              <td><a href="index.html" class="tocviewlink" data-pltdoc="x">编程语言要素</a></td>
            </tr>
          </table>
        </div>
        <div class="tocviewsublisttop" style="display: block;" id="tocview_0">
          <table cellspacing="0" cellpadding="0">
            <tr>
              <td align="right"></td>
              <td><a href="fw-trans.html" class="tocviewlink" data-pltdoc="x">译者的话</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="glo.html" class="tocviewlink" data-pltdoc="x">译名表</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="fw.html" class="tocviewlink" data-pltdoc="x">序</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="pf.html" class="tocviewlink" data-pltdoc="x">前言</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="awk.html" class="tocviewlink" data-pltdoc="x">致谢</a></td>
            </tr>
            <tr>
              <td align="right">1 </td>
              <td><a href="isd.html" class="tocviewlink" data-pltdoc="x">归纳式数据集</a></td>
            </tr>
            <tr>
              <td align="right">2 </td>
              <td><a href="da.html" class="tocviewlink" data-pltdoc="x">数据抽象</a></td>
            </tr>
            <tr>
              <td align="right">3 </td>
              <td><a href="" class="tocviewselflink" data-pltdoc="x">表达式</a></td>
            </tr>
            <tr>
              <td align="right">4 </td>
              <td><a href="state.html" class="tocviewlink" data-pltdoc="x">状态</a></td>
            </tr>
            <tr>
              <td align="right">5 </td>
              <td><a href="cpi.html" class="tocviewlink" data-pltdoc="x">传递续文的解释器</a></td>
            </tr>
            <tr>
              <td align="right">6 </td>
              <td><a href="cps.html" class="tocviewlink" data-pltdoc="x">续文传递风格</a></td>
            </tr>
            <tr>
              <td align="right">7 </td>
              <td><a href="types.html" class="tocviewlink" data-pltdoc="x">类型</a></td>
            </tr>
            <tr>
              <td align="right">8 </td>
              <td><a href="modules.html" class="tocviewlink" data-pltdoc="x">模块</a></td>
            </tr>
            <tr>
              <td align="right">9 </td>
              <td><a href="oac.html" class="tocviewlink" data-pltdoc="x">对象和类</a></td>
            </tr>
            <tr>
              <td align="right">10 </td>
              <td><a href="further-reading.html" class="tocviewlink" data-pltdoc="x">扩展阅读</a></td>
            </tr>
            <tr>
              <td align="right">11 </td>
              <td><a href="sllgen-parsing-system.html" class="tocviewlink" data-pltdoc="x">SLLGEN解析系统</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="bib.html" class="tocviewlink" data-pltdoc="x">参考书目</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="indices.html" class="tocviewlink" data-pltdoc="x">索引</a></td>
            </tr>
          </table>
        </div>
      </div>
      <div class="tocviewlist">
        <table cellspacing="0" cellpadding="0">
          <tr>
            <td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle"
                onclick="TocviewToggle(this," tocview_1");">►</a></td>
            <td>3 </td>
            <td><a href="" class="tocviewselflink" data-pltdoc="x">表达式</a></td>
          </tr>
        </table>
        <div class="tocviewsublistbottom" style="display: none;" id="tocview_1">
          <table cellspacing="0" cellpadding="0">
            <tr>
              <td align="right">3.1 </td>
              <td><a href="#%28part._s3..1%29" class="tocviewlink" data-pltdoc="x">规范和实现策略</a></td>
            </tr>
            <tr>
              <td align="right">3.2 </td>
              <td><a href="#%28part._s3..2%29" class="tocviewlink" data-pltdoc="x">LET：一门简单语言</a></td>
            </tr>
            <tr>
              <td align="right">3.3 </td>
              <td><a href="#%28part._s3..3%29" class="tocviewlink" data-pltdoc="x">PROC：有过程的语言</a></td>
            </tr>
            <tr>
              <td align="right">3.4 </td>
              <td><a href="#%28part._s3..4%29" class="tocviewlink" data-pltdoc="x">LETREC：支持递归过程的语言</a></td>
            </tr>
            <tr>
              <td align="right">3.5 </td>
              <td><a href="#%28part._s3..5%29" class="tocviewlink" data-pltdoc="x">定界和变量绑定</a></td>
            </tr>
            <tr>
              <td align="right">3.6 </td>
              <td><a href="#%28part._s3..6%29" class="tocviewlink" data-pltdoc="x">消除变量名</a></td>
            </tr>
            <tr>
              <td align="right">3.7 </td>
              <td><a href="#%28part._s3..7%29" class="tocviewlink" data-pltdoc="x">实现词法地址</a></td>
            </tr>
          </table>
        </div>
      </div>
    </div>
    <div class="tocsub">
      <div class="tocsubtitle">On this page:</div>
      <table class="tocsublist" cellspacing="0">
        <tr>
          <td><span class="tocsublinknumber">3.1<tt> </tt></span><a href="#%28part._s3..1%29" class="tocsubseclink"
              data-pltdoc="x">规范和实现策略</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.2<tt> </tt></span><a href="#%28part._s3..2%29" class="tocsubseclink"
              data-pltdoc="x">LET：一门简单语言</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.2.1<tt> </tt></span><a href="#%28part._s3..2..1%29" class="tocsubseclink"
              data-pltdoc="x">定义语法</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.2.2<tt> </tt></span><a href="#%28part._s3..2..2%29" class="tocsubseclink"
              data-pltdoc="x">定义值</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.2.3<tt> </tt></span><a href="#%28part._s3..2..3%29" class="tocsubseclink"
              data-pltdoc="x">环境</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.2.4<tt> </tt></span><a href="#%28part._s3..2..4%29" class="tocsubseclink"
              data-pltdoc="x">定义表达式的行为</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.2.5<tt> </tt></span><a href="#%28part._s3..2..5%29" class="tocsubseclink"
              data-pltdoc="x">定义程序的行为</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.2.6<tt> </tt></span><a href="#%28part._s3..2..6%29" class="tocsubseclink"
              data-pltdoc="x">定义条件</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.2.7<tt> </tt></span><a href="#%28part._s3..2..7%29" class="tocsubseclink"
              data-pltdoc="x">定义 <span class="stt">let</span></a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.2.8<tt> </tt></span><a href="#%28part._s3..2..8%29" class="tocsubseclink"
              data-pltdoc="x">实现 LET 规范</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.3<tt> </tt></span><a href="#%28part._s3..3%29" class="tocsubseclink"
              data-pltdoc="x">PROC：有过程的语言</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.3.1<tt> </tt></span><a href="#%28part._s3..3..1%29" class="tocsubseclink"
              data-pltdoc="x">一个例子</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.3.2<tt> </tt></span><a href="#%28part._s3..3..2%29" class="tocsubseclink"
              data-pltdoc="x">表示过程</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.4<tt> </tt></span><a href="#%28part._s3..4%29" class="tocsubseclink"
              data-pltdoc="x">LETREC：支持递归过程的语言</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.5<tt> </tt></span><a href="#%28part._s3..5%29" class="tocsubseclink"
              data-pltdoc="x">定界和变量绑定</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.6<tt> </tt></span><a href="#%28part._s3..6%29" class="tocsubseclink"
              data-pltdoc="x">消除变量名</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.7<tt> </tt></span><a href="#%28part._s3..7%29" class="tocsubseclink"
              data-pltdoc="x">实现词法地址</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.7.1<tt> </tt></span><a href="#%28part._s3..7..1%29" class="tocsubseclink"
              data-pltdoc="x">翻译器</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">3.7.2<tt> </tt></span><a href="#%28part._s3..7..2%29" class="tocsubseclink"
              data-pltdoc="x">无名解释器</a></td>
        </tr>
      </table>
    </div>
  </div>
  <div class="maincolumn">
    <div class="main">
      <div class="navsettop"><span class="navleft">
          <div class="nosearchform"></div>  <span class="tocsettoggle">  <a href="javascript:void(0);"
              title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span>
        </span><span class="navright">  <a href="da.html" title="backward to " 2 数据抽象"" data-pltdoc="x">← prev</a>  <a
            href="index.html" title="up to " 编程语言要素"" data-pltdoc="x">up</a>  <a href="state.html" title="forward to " 4
            状态"" data-pltdoc="x">next →</a></span> </div>
      <h3>3<tt> </tt><a name="(part._expr)"></a>表达式</h3>
      <p>本章研究变量绑定及其作用域。我们用一系列小型语言解释这些概念。我们为这些语言写出
        规范，遵照<a href="isd.html" data-pltdoc="x">归纳式数据集</a>的解释器秘方实现其解释器。我们的规范和解释器取一
        名为<span class="emph">环境</span> (<span class="emph">environment</span>) 的上下文参数，以记录待求值的表达式中各个变量的含
        义。</p>
      <h4>3.1<tt> </tt><a name="(part._s3..1)"></a>规范和实现策略</h4>
      <p>
      <div class="SIntrapara"><a name="(idx._(gentag._340))"></a>
        我们的规范包含若干断言，形如：
      </div>
      <div class="SIntrapara">
        <blockquote class="SubFlow">
          <p><span class="texMathDisplay"><span class="stt">(value-of </span><span class="texMathInline">exp</span><span
                class="stt"> </span><span class="texMathInline">\rho</span><span class="stt">)</span> = val</span></p>
          <p>意为在环境 <span class="texMathInline">\rho</span> 中，表达式 <span class="texMathInline">exp</span> 的值应为 <span
              class="texMathInline">val</span>。我们像<a href="isd.html" data-pltdoc="x">归纳式数据集</a>那样，
            写出推理规则和方程，以便推导出这样的断言。我们手写规则和方程，找出某些表达式的期
            望值。</p>
        </blockquote>
      </div>
      </p>
      <p><a name="(idx._(gentag._341))"></a>而我们的目标是写出程序，
        <a name="(idx._(gentag._342))"></a>
        <a name="(idx._(gentag._343))"></a>
        <a name="(idx._(gentag._344))"></a>
        实现语言。概况如<span class="EoplFigureRef"></span> 所示。首先是程序，由我们要实现的语言写出。
        这叫做<span class="emph">源语言</span> (<span class="emph">source language</span>) 或<span class="emph">被定语言</span>
        (<span class="emph">defined language</span>)。前
        端接收程序文本（由源语言写成的程序），将其转化为抽象语法树，然后将语法树传给解释
        器。解释器是一程序，它查看一段数据结构，根据结构执行一些动作。当然，解释器自身也
        由某种语言写成。我们把那种语言叫做<span class="emph">实现语言</span> (<span class="emph">implementation language</span>)
        <a name="(idx._(gentag._345))"></a>
        或<span class="emph">定义语言</span> (<span class="emph">defining language</span>)。我们的大多数实现都遵照这种方式。
      </p>
      <p><a name="(idx._(gentag._346))"></a>
        另一种常见的组织方式如<span class="EoplFigureRef"></span> 所示。其中，编译器替代了解释器，将
        抽象语法树翻译为另一种语言（称为<span class="emph">目标语言</span> (<span class="emph">target language</span>)）写成的
        程序，然后执行。目标语言可能像<span class="EoplFigureRef"></span> 那样，由一个解释器执行，也
        可能翻译成更底层的语言执行。
        <a name="(idx._(gentag._347))"></a>
      </p>
      <p>通常，目标语言是一种机器语言，由硬件解释。但目标语言也可能是一种特定用途的语言，
        比原本的语言简单，为它写一个解释器相对容易。这样，程序可以编译一次，然后在多种不
        同的硬件平台上执行。出于历史原因，常称这样的目标语言为<span class="emph">字节码</span> (<span class="emph">byte
          code</span>)，称其解释器称为<span class="emph">虚拟机</span> (<span class="emph">virtual machine</span>)。
        <a name="(idx._(gentag._348))"></a>
        <a name="(idx._(gentag._349))"></a>
        <a name="(idx._(gentag._350))"></a>
      </p>
      <p>编译器常常分为两部分：<span class="emph">分析器</span> (<span class="emph">analyzer</span>)，尝试推断关于程序的有效信
        息；<span class="emph">翻译器</span> (<span class="emph">translator</span>)，执行翻译，可能用到来自分析器的信息。这些
        阶段既能用推理规则指定，也能用专写规范的语言指定。然后是实现。
        <a href="cps.html" data-pltdoc="x">续文传递风格</a>和<a href="types.html" data-pltdoc="x">类型</a>探讨了一些简单的分析器和翻译器。
      </p>
      <p><a name="(idx._(gentag._351))"></a>
        不论采用哪种实现策略，我们都需要一个<span class="emph">前端</span> (<span class="emph">front end</span>)，将程序转换为
        抽象语法树。因为程序只是字符串，我们的前端要将这些字符组成有意义的单元。分组通常
        分为两个阶段：<span class="emph">扫描</span> (<span class="emph">scanning</span>) 和<span class="emph">解析</span> (<span
          class="emph">parsing</span>)。
        <a name="(idx._(gentag._352))"></a>
      </p>
      <p>扫描就是将字符序列分为单词、数字、标点、注释等等。这些单元叫做<span class="emph">词条</span> (<span class="emph">lexical
          item</span>)、<span class="emph">词素</span> (<span class="emph">lexeme</span>)、或者最常见的<span
          class="emph">词牌</span> (<span class="emph">token</span>)。把程序分
        为词牌的方式叫做语言的<span class="emph">词法规范</span> (<span class="emph">lexical specification</span>)。扫描器取一字符序
        列，生成词牌序列。
        <a name="(idx._(gentag._353))"></a>
        <a name="(idx._(gentag._354))"></a>
      </p>
      <p>解析就是将词牌序列组成有层次的语法结构，如表达式、语句和块。这就像用从句组织（或
        称图解<span class="NoteBox"><span class="NoteContent">西方有diagram sentence之说，以树状图表示句子结构，如我国中学生学习英
            文之主、谓、宾。——<span class="emph">译注</span></span></span>）句子。我们称之为语言的<span class="emph">句法</span> (<span
          class="emph">syntactic</span>)
        或<span class="emph">语法</span> (<span class="emph">grammatical</span>) 结构。解析器取一词牌序列（由扫描器给出），生成一棵
        抽象语法树。<a name="(idx._(gentag._355))"></a></p>
      <p><a name="(idx._(gentag._356))"></a>
        设计前端的标准方式是使用<span class="emph">解析器生成器</span> (<span class="emph">parser generator</span>)。解析器生
        成器是一程序，取一词法规范和语法，生成一个扫描器和解析器。</p>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!ht]
        </div>
        <div class="SIntrapara">
          <blockquote class="EoplSubfigure">
            <blockquote class="SCentered">
              <p><img src="exe-via-interpreter.svg" alt="由解释器执行" width="300.6pt" height="108.0pt" /></p>
            </blockquote>
            <blockquote class="caption">
              <p>由解释器执行<a name="(elem._fig-3..1-a)"></a></p>
            </blockquote>
          </blockquote>
        </div>
        </p>
        <blockquote class="EoplSubfigure">
          <blockquote class="SCentered">
            <p><img src="exe-via-compiler.svg" alt="由编译器执行" width="408.6pt" height="187.2pt" /></p>
          </blockquote>
          <blockquote class="caption">
            <p>由编译器执行<a name="(elem._fig-3..1-b)"></a></p>
          </blockquote>
        </blockquote>
        <blockquote class="caption">
          <p>语言处理系统块状图<a name="(elem._fig-3..1)"></a></p>
        </blockquote>
      </blockquote>
      <p>大多数主流语言都有解析器生成系统。如果没有解析器生成器，或者没有合适的，可以手写
        扫描器和解析器。编译器教材描述了这一过程。本书使用的解析技术及相关语法设计从简，
        专为满足我们的需求。
        <a name="(idx._(gentag._357))"></a>
      </p>
      <p>另一种方式是忽略具体语法的细节，把表达式写成列表结构，
        就像<a href="da.html#%28part._s2..5%29" data-pltdoc="x">抽象语法及其表示</a>和<span class="EoplExerciseRef"></span>中，处理
        lambda 演算表达式那样。
        <a name="(idx._(gentag._358))"></a>
        <a name="(idx._(gentag._359))"></a>
      </p>
      <h4>3.2<tt> </tt><a name="(part._s3..2)"></a>LET：一门简单语言</h4>
      <p><a name="(idx._(gentag._360))"></a>
        我们先来定义一种非常简单的语言，根据它最有趣的特性，将其命名为 LET。</p>
      <h5>3.2.1<tt> </tt><a name="(part._s3..2..1)"></a>定义语法</h5>
      <p><span class="EoplFigureRef"></span> 展示了我们这门简单语言的语法。在这种语言中，程序只能是一个表达式。表达式是
        个整数常量、差值表达式、判零表达式、条件表达式、变量、或 <span class="stt">let</span> 表达式。</p>
      <p>这里是本门语言写成的一个简单表达式，及其抽象语法表示。</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">scan&parse</span><span class="hspace"> </span><span
                  class="RktVal">"-(55, -(x,11))"</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="RktVal">#</span><span class="RktVal">(</span><span class="RktVal">struct:a-program</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktVal">#</span><span class="RktVal">(</span><span
                  class="RktVal">struct:diff-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktVal">#</span><span class="RktVal">(</span><span
                  class="RktVal">struct:const-exp</span><span class="hspace"> </span><span class="RktVal">55</span><span
                  class="RktVal">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktVal">#</span><span class="RktVal">(</span><span
                  class="RktVal">struct:diff-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktVal">#</span><span class="RktVal">(</span><span
                  class="RktVal">struct:var-exp</span><span class="hspace"> </span><span class="RktVal">x</span><span
                  class="RktVal">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktVal">#</span><span class="RktVal">(</span><span
                  class="RktVal">struct:const-exp</span><span class="hspace"> </span><span class="RktVal">11</span><span
                  class="RktVal">)</span><span class="RktVal">)</span><span class="RktVal">)</span><span
                  class="RktVal">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>[!ht]
          <br />
          <span class="Iidentity">\begin{align*}\mathit{Program} &::= \mathit{Expression} \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">a-program (exp1)</span>} \\[5pt]
            \mathit{Expression} &::= \mathit{Number} \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">const-exp (num)</span>} \\[5pt]
            \mathit{Expression} &::= <span class="stt">(- </span><span class="Iidentity">\mathit{Expression}</span><span
              class="stt"> , </span><span class="Iidentity">\mathit{Expression}</span><span class="stt">)</span>
            \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">diff-exp (exp1 exp2)</span>} \\[5pt]
            \mathit{Expression} &::= <span class="stt">(zero? </span><span
              class="Iidentity">\mathit{Expression}</span><span class="stt">)</span> \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">zero?-exp (exp1)</span>} \\[5pt]
            \mathit{Expression} &::= <span class="stt">if </span><span class="Iidentity">\mathit{Expression}</span><span
              class="stt"> then </span><span class="Iidentity">\mathit{Expression}</span><span class="stt"> else
            </span><span class="Iidentity">\mathit{Expression}</span> \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">if-exp (exp1 exp2 exp3)</span>} \\[5pt]
            \mathit{Expression} &::= \mathit{Identifier} \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">var-exp (var)</span>} \\[5pt]
            \mathit{Expression} &::= <span class="stt">let </span><span
              class="Iidentity">\mathit{Identifier}</span><span class="stt"> = </span><span
              class="Iidentity">\mathit{Expression}</span><span class="stt"> in </span><span
              class="Iidentity">\mathit{Expression}</span> \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">let-exp (var exp1 body)</span>}\end{align*}</span>
        </p>
        <blockquote class="caption">
          <p>LET语言的语法<a name="(elem._fig-3..2)"></a></p>
        </blockquote>
      </blockquote>
      <h5>3.2.2<tt> </tt><a name="(part._s3..2..2)"></a>定义值</h5>
      <p>任何编程语言的规范之中，最重要的一部分就是语言能处理的值的集合。每种语言至少有两
        个这样的集合：<span class="emph">表达值</span> (<span class="emph">expressed values</span>) 和<span class="emph">指代值</span>
        (<span class="emph">denoted values</span>)。
        <a name="(idx._(gentag._361))"></a>
        <a name="(idx._(gentag._362))"></a>
        表达值是指表达式可能的取值，指代值是指可以绑定到变量的值。
      </p>
      <p>本章的语言中，表达值和指代值总是相同。它们是：</p>
      <blockquote class="SubFlow">
        <p><a name="(elem._pass-by-value)"></a><span class="Iidentity">\begin{align*}\mathit{ExpVal} &= \mathit{Int} +
            \mathit{Bool} \\
            \mathit{DenVal} &= \mathit{Int} + \mathit{Bool}\end{align*}</span></p>
        <p><a href="state.html" data-pltdoc="x">状态</a>展示表达值和指代值不同的语言。</p>
      </blockquote>
      <p>要使用这个定义，我们要有表达值数据类型的接口。我们有这几个接口：</p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span style="font-weight: bold"><span class="stt">num-val</span></span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt"></span><span class="texMathInline">: \mathit{Int} \to
                  \mathit{ExpVal}</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span style="font-weight: bold"><span class="stt">bool-val</span></span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span class="texMathInline">:
                  \mathit{Bool} \to \mathit{ExpVal}</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span style="font-weight: bold"><span
                    class="stt">expval->num</span></span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">: \mathit{ExpVal} \to \mathit{Int}</span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span style="font-weight: bold"><span
                    class="stt">expval->bool</span></span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">: \mathit{ExpVal} \to \mathit{Bool}</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>我们假定，当传给 <span class="stt">expval->num</span> 的参数不是整数值，或传给 <span class="stt">expval->bool</span> 的
        参数不是布尔值时，二者行为未定义。</p>
      <h5>3.2.3<tt> </tt><a name="(part._s3..2..3)"></a>环境</h5>
      <p><a name="(idx._(gentag._363))"></a>
        若要求取表达式的值，我们得知道每个变量的值。我们靠环境记录这些值，就像<a href="da.html#%28part._s2..2%29" data-pltdoc="x">数据类型的表示策略</a>那样。</p>
      <p>环境是一函数，定义域为变量的有限集合，值域为指代值。我们用一些缩写表示环境。</p>
      <ul>
        <li>
          <p><span class="texMathInline">\rho</span> 表示任一环境。</p>
        </li>
        <li>
          <p><span class="texMathInline">\textnormal{[]}</span> 表示空环境。</p>
        </li>
        <li>
          <p><span class="texMathInline">\text{[}var = val\text{]}\rho</span> 表示 <span class="stt">(extend-env
            </span><span class="texMathInline">var</span><span class="stt"> </span><span
              class="texMathInline">val</span><span class="stt">
            </span><span class="texMathInline">\rho</span><span class="stt">)</span>。</p>
        </li>
        <li>
          <p><span class="texMathInline">\text{[}var_1 = val_1, var_2 = val2\text{]}\rho</span> 是 <span
              class="texMathInline">var_1 =
              val_1(\text{[}var_2 = val_2\text{]}\rho)</span> 的缩写，其余同理。</p>
        </li>
        <li>
          <p><span class="texMathInline">\text{[}var_1 = val_1, var_2 = val2,\dots\text{]}</span> 表示的环境中，
            <span class="texMathInline">var_1</span> 的值为 <span class="texMathInline">val_1</span>，其余同理。
          </p>
        </li>
      </ul>
      <p>我们偶尔用不同缩进表示复杂环境，以便阅读。例如，我们可能把</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">extend-env</span><span class="hspace"> </span><span
                    class="RktVal">'</span><span class="RktVal">x</span><span class="hspace"> </span><span
                    class="RktVal">3</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span
                    class="RktSym">extend-env</span><span class="hspace"> </span><span class="RktVal">'</span><span
                    class="RktVal">y</span><span class="hspace"> </span><span class="RktVal">7</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">extend-env</span><span class="hspace"> </span><span class="RktVal">'</span><span
                    class="RktVal">u</span><span class="hspace"> </span><span class="RktVal">5</span><span
                    class="hspace"> </span><span class="texMathInline">\rho</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>缩写为</p>
        <p>
        <div class="SIntrapara">
          <blockquote class="EoplCodeInset">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span class="RktPn">[</span><span class="RktSym">x=3</span><span class="RktPn">]</span></td>
                </tr>
                <tr>
                  <td><span class="hspace"> </span><span class="RktPn">[</span><span class="RktSym">y=7</span><span
                      class="RktPn">]</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">[</span><span class="RktSym">u=5</span><span
                      class="RktPn">]</span><span class="texMathInline">\rho</span></td>
                </tr>
              </table>
            </blockquote>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._364))"></a></div>
        </p>
      </blockquote>
      <h5>3.2.4<tt> </tt><a name="(part._s3..2..4)"></a>定义表达式的行为</h5>
      <p><a name="(idx._(gentag._365))"></a>
        <a name="(idx._(gentag._366))"></a>
        <a name="(idx._(gentag._367))"></a>
        我们语言中的六种表达式各对应一个左边为 <span class="texMathInline">\mathit{Expression}</span> 的生成式。表达式
        接口包含七个过程，六个是构造器，一个是观测器。我们用 <span class="texMathInline">\mathit{ExpVal}</span> 表示表
        达值的集合。
      </p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">构造器：</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span style="font-weight: bold"><span class="stt">const-exp</span></span><span
                  class="stt">: </span><span class="texMathInline">\mathit{Int} \to \mathit{Exp}</span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span style="font-weight: bold"><span class="stt">zero?-exp</span></span><span
                  class="stt">: </span><span class="texMathInline">\mathit{Exp} \to \mathit{Exp}</span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span style="font-weight: bold"><span class="stt">if-exp</span></span><span
                  class="stt">: </span><span class="texMathInline">\mathit{Exp} \times \mathit{Exp} \times \mathit{Exp}
                  \to \mathit{Exp}</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span style="font-weight: bold"><span class="stt">diff-exp</span></span><span
                  class="stt">: </span><span class="texMathInline">\mathit{Exp} \times \mathit{Exp} \to
                  \mathit{Exp}</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span style="font-weight: bold"><span class="stt">var-exp</span></span><span
                  class="stt">: </span><span class="texMathInline">\mathit{Var} \to \mathit{Exp}</span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span style="font-weight: bold"><span class="stt">let-exp</span></span><span
                  class="stt">: </span><span class="texMathInline">\mathit{Var} \times \mathit{Exp} \times \mathit{Exp}
                  \to \mathit{Exp}</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">观测器：</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span style="font-weight: bold"><span class="stt">value-of</span></span><span
                  class="stt">: </span><span class="texMathInline">\mathit{Exp} \times \mathit{Env} \to
                  \mathit{ExpVal}</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>实现之前，我们先写出这些过程的行为规范。依照解释器秘方，我们希望 <span class="stt">value-of</span>
        查看表达式，判断其类别，然后返回恰当的值。</p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(value-of (const-exp </span><span class="texMathInline">n</span><span class="stt">)
                </span><span class="texMathInline">\rho</span><span class="stt">) = (num-val </span><span
                  class="texMathInline">n</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(value-of (var-exp </span><span class="texMathInline">var</span><span class="stt">)
                </span><span class="texMathInline">\rho</span><span class="stt">) = (apply-env </span><span
                  class="texMathInline">\rho</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">var</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(value-of (diff-exp </span><span class="texMathInline">exp_1</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">exp_2</span><span class="stt">) </span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (num-val</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(-</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(expval->num (value-of
                </span><span class="texMathInline">exp_1</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt"></span><span class="texMathInline">\rho</span><span
                  class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(expval->num (value-of
                </span><span class="texMathInline">exp_2</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt"></span><span class="texMathInline">\rho</span><span
                  class="stt">))))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>任何环境中，常量表达式的值都是这个常量。变量引用的值从某一环境中查询而得。差值表
        达式的值为第一个操作数在某一环境中的值减去第二个操作数在同一环境中的值。当然，准
        确来说，我们得确保操作数的值是数字，且结果是表示为表达值的数字。</p>
      <p><span class="EoplFigureRef"></span> 展示了如何结合这些规则求取构造器生成的表达式的值。在本例以
        及其他例子中，我们用 <span class="texMathInline">\textnormal{\guillemotleft} exp
          \textnormal{\guillemotright}</span> 表示表达式 <span class="texMathInline">exp</span> 的抽象语法树，用 <span
          class="texMathInline">\lceil n
          \rceil</span> 表示 <span class="stt">(num-val </span><span class="texMathInline">n</span><span
          class="stt">)</span>，用 <span class="texMathInline">\lfloor val \rfloor</span> 表示
        <span class="stt">(expval->num </span><span class="texMathInline">val</span><span
          class="stt">)</span>。我们还运用了一点事实：<span class="texMathInline">\lfloor \lceil n \rceil
          \rfloor = n</span>。
        <a name="(idx._(gentag._368))"></a>
        <a name="(idx._(gentag._369))"></a>
        <a name="(idx._(gentag._370))"></a>
      </p>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..1)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>列出<span class="EoplFigureRef"></span> 中所有应用 <span class="texMathInline">\lfloor
            \lceil n \rceil \rfloor = n</span> 的地方。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..2)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>给出一个表达值
          <span class="texMathInline">val \in \mathit{ExpVal}</span>，且 <span class="texMathInline">\lceil \lfloor val
            \rfloor
            \rceil \neq val</span>。</p>
      </blockquote>
      <h5>3.2.5<tt> </tt><a name="(part._s3..2..5)"></a>定义程序的行为</h5>
      <p>在我们的语言中，整个程序只是一个表达式。要找出这个表达式的值，我们要定义程序中自
        由变量的值。所以程序的值就是在适当的初始环境中求出的该表达式的值。我们把初始环境
        设为 <span class="stt">[i=1,v=5,x=10]</span>。</p>
      <blockquote class="EoplEquationInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">value-of-program</span><span
                  class="hspace"> </span><span class="texMathInline">exp</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="RktSym">=</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="texMathInline">exp</span><span
                  class="hspace"> </span><span class="RktPn">[</span><span class="stt">i=</span><span
                  class="texMathInline">\lceil \tt{1} \rceil</span>,<span class="stt">v=</span><span
                  class="texMathInline">\lceil \tt{5} \rceil</span>,<span class="stt">x=</span><span
                  class="texMathInline">\lceil \tt{10} \rceil</span><span class="RktPn">]</span><span
                  class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <h5>3.2.6<tt> </tt><a name="(part._s3..2..6)"></a>定义条件</h5>
      <p><a name="(idx._(gentag._371))"></a>
        接下来是这门语言的布尔值接口。这门语言有一个布尔值构造器 <span class="stt">zero?</span>，一个布尔值
        观测器 <span class="stt">if</span> 表达式。</p>
      <p>当且仅当操作数的值为0，<span class="stt">zero?</span> 表达式的值为真。像<span class="EoplDefinitionRef"></span> 那样，
        可将其写成一条推理规则。我们以 <span class="stt">bool-val</span> 为构造器，把布尔值转换为表达值；以
        <span class="stt">expval->num</span> 为提取器，判断表达式的值是否为整数，如果是，则返回该整数。
      </p>
      <blockquote class="EoplFigure">
        <p>令 <span class="texMathInline">\rho =</span> <span class="stt">[i=1,v=5,x=10]</span>。<br /></p>
        <blockquote class="TwoColumns">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"><<-(-(x,3), -(v,i))>></span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of <<-(x,3)>> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of <<-(v,i)>> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt">)</span><span
                    class="texMathInline">\rceil</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt"></span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of <<x>> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt"></span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of <<3>> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of <<-(v,i)>> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt">)</span><span
                    class="texMathInline">\rceil</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">10</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt"></span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of <<3>> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of <<-(v,i)>> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt">)</span><span
                    class="texMathInline">\rceil</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">10</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">3)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of <<-(v,i)>> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt">)</span><span
                    class="texMathInline">\rceil</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">7</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of <<-(v,i)>> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt">)</span><span
                    class="texMathInline">\rceil</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="texMathInline">\columnbreak</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">7</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt"></span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of <<v>> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt"></span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of <<i>> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt">))</span><span
                    class="texMathInline">\rceil</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">7</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">5</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt"></span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of <<i>> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt">))</span><span
                    class="texMathInline">\rceil</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">7</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">5</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">1))</span><span
                    class="texMathInline">\rceil</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">7</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">4)</span><span
                    class="texMathInline">\rceil</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">3</span><span
                    class="texMathInline">\rceil</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <blockquote class="caption">
          <p>按照规范做简单运算<a name="(elem._fig-3..3)"></a></p>
        </blockquote>
      </blockquote>
      <p><span class="texMathDisplay">\infer{\begin{alignedat}{-1}
          &<span class="hspace"> </span><span class="stt">(value-of (zero?-exp </span><span
            class="texMathInline">exp_1</span><span class="stt">) </span><span class="texMathInline">\rho</span><span
            class="stt">)</span> \\
          &\hphantom{xx}= \begin{cases}
          <span class="stt">(bool-val #t)</span> & 若 <span class="stt">(expval->num </span><span
            class="texMathInline">val_1</span><span class="stt">)</span> = 0 \\
          <span class="stt">(bool-val #f)</span> & 若 <span class="stt">(expval->num </span><span
            class="texMathInline">val_1</span><span class="stt">)</span> \neq 0 \hphantom{x}
          \end{cases}
          \end{alignedat}}
          {<span class="stt">(value-of </span><span class="texMathInline">exp_1</span><span class="stt"> </span><span
            class="texMathInline">\rho</span><span class="stt">) = </span><span
            class="texMathInline">val_1</span>}</span></p>
      <p>一个 <span class="stt">if</span> 表达式就是一个布尔值观测器。欲求 <span class="stt">if</span> 表达式 <span
          class="stt">(if-exp</span><span class="stt">
        </span><span class="texMathInline">exp_1</span><span class="stt"> </span><span
          class="texMathInline">exp_2</span><span class="stt"> </span><span class="texMathInline">exp_3</span><span
          class="stt">)</span> 的值，首先判断子表达式 <span class="texMathInline">exp_1</span> 的值；若该值为
        真，整个表达式的值应为子表达式 <span class="texMathInline">exp_2</span> 的值，否则为子表达式 <span class="texMathInline">exp_3</span>
        的值。这
        也很容易写成推理规则。就像在前一个例子中使用 <span class="stt">expval->num</span> 一样，我们用
        <span class="stt">expval->bool</span> 提取表达值的布尔部分。
      </p>
      <p><span class="texMathDisplay">\infer{\begin{alignedat}{-1}
          &<span class="hspace"> </span><span class="stt">(value-of (if-exp </span><span
            class="texMathInline">exp_1</span><span class="stt"> </span><span class="texMathInline">exp_2</span><span
            class="stt"> </span><span class="texMathInline">exp_3</span><span class="stt">) </span><span
            class="texMathInline">\rho</span><span class="stt">) </span> \\
          &\hphantom{xx}= \begin{cases}
          <span class="stt">(value-of </span><span class="texMathInline">exp_2</span><span class="stt"> </span><span
            class="texMathInline">\rho</span><span class="stt">)</span> & 若 <span class="stt">(expval->bool </span><span
            class="texMathInline">val_1</span><span class="stt">)</span> = <span class="stt">#t</span> \\
          <span class="stt">(value-of </span><span class="texMathInline">exp_3</span><span class="stt"> </span><span
            class="texMathInline">\rho</span><span class="stt">)</span> & 若 <span class="stt">(expval->bool </span><span
            class="texMathInline">val_1</span><span class="stt">)</span> = <span class="stt">#f</span> \hphantom{x}
          \end{cases}
          \end{alignedat}}
          {<span class="stt">(value-of </span><span class="texMathInline">exp_1</span><span class="stt"> </span><span
            class="texMathInline">\rho</span><span class="stt">) = </span><span
            class="texMathInline">val_1</span>}</span></p>
      <p><a name="(idx._(gentag._372))"></a>
        用这种推理规则很容易指定任意表达式的期望行为，但却不适合展示推理过程。像
        <span class="stt">(value-of </span><span class="texMathInline">exp_1</span><span class="stt"> </span><span
          class="texMathInline">\rho</span><span class="stt">)</span> 这样的前件表示一部分计算，所以一个计算过程应
        该是一棵树，就像<span class="stt">deriv-tree</span>那种。很不幸的是，这样的树极为晦涩。因此，我
        们经常把规则转为方程，然后就能用相等代换展示计算过程。
      </p>
      <p><a name="(idx._(gentag._373))"></a>
        <span class="stt">if-exp</span> 的方程式规范是：
      </p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(value-of (if-exp </span><span class="texMathInline">exp_1</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">exp_2</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">exp_3</span><span class="stt">) </span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (if (expval->bool (value-of </span><span class="texMathInline">exp_1</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">\rho</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of </span><span
                  class="texMathInline">exp_2</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of </span><span
                  class="texMathInline">exp_3</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">\rho</span><span class="stt">))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p><a name="(idx._(gentag._374))"></a>
        <span class="EoplFigureRef"></span> 展示了用这些规则进行简单运算的过程。
      </p>
      <blockquote class="EoplFigure">
        <p>[!t]令 <span class="texMathInline">\rho =</span> <span class="stt">[x=</span><span
            class="texMathInline">\lceil</span><span class="stt">33</span><span class="texMathInline">\rceil</span><span
            class="stt">,y=</span><span class="texMathInline">\lceil</span><span class="stt">22</span><span
            class="texMathInline">\rceil</span><span class="stt">]</span>。<br /></p>
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(value-of</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                  <<if zero?(-(x,11)) then -(y,2) else -(y,4)>>
                </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (if (expval->bool (value-of <<zero?(-(x,11))>> </span><span
                  class="texMathInline">\rho</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of <<-(y,2)>>
                </span><span class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of <<-(y,4)>>
                </span><span class="texMathInline">\rho</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (if (expval->bool (bool-val #f))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of <<-(y,2)>>
                </span><span class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of <<-(y,4)>>
                </span><span class="texMathInline">\rho</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (if #f</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of <<-(y,2)>>
                </span><span class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of <<-(y,4)>>
                </span><span class="texMathInline">\rho</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of <<-(y,4)>> </span><span class="texMathInline">\rho</span><span
                  class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">18</span><span
                  class="texMathInline">\rceil</span></p>
            </td>
          </tr>
        </table>
        <blockquote class="caption">
          <p>条件表达式的简单计算过程<a name="(elem._fig-3..4)"></a></p>
        </blockquote>
      </blockquote>
      <h5>3.2.7<tt> </tt><a name="(part._s3..2..7)"></a>定义 <span class="stt">let</span></h5>
      <p><a name="(idx._(gentag._375))"></a>
        <a name="(idx._(gentag._376))"></a>
        <a name="(idx._(gentag._377))"></a>
        <a name="(idx._(gentag._378))"></a>
        接下来我们处理用 <span class="stt">let</span> 表达式创建新变量绑定的问题。我们给这门解释性语言添加语
        法，以关键字 <span class="stt">let</span> 起始，然后是一个声明，关键字 <span class="stt">in</span>，及其主体。例如，
      </p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let x = 5</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in -(x, 3)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>像 <span class="stt">lambda</span> 变量绑定一样（见<a href="isd.html#%28part._s1..2..4%29" data-pltdoc="x"><span
              class="stt">occurs-free?</span></a>），<span class="stt">let</span> 变量绑定于主体之中。</p>
      </blockquote>
      <p>如同其主体，整个 <span class="stt">let</span> 形式也是一个表达式，所以 <span class="stt">let</span> 表达式可以嵌套，例如</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let z = 5</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in let x = 3</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in let y = -(x,
                    1)</span><span class="hspace">    </span><span class="stt">% 这里 x = 3</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in let x = 4</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">         </span><span class="stt">in -(z, -(x,y)) % 这里
                    x = 4</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>在本例中，第一个差值表达式中使用的 <span class="stt">x</span> 指代外层声明，另一个差值表达式中使用的
          <span class="stt">x</span> 指代内层声明，所以整个表达式的值是3。
        </p>
      </blockquote>
      <p><span class="stt">let</span> 声明的右边也是一个表达式，所以它可以任意复杂。例如</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let x = 7</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in let y = 2</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in let y = let x =
                    -(x,1)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">              </span><span class="stt">in -(x,y)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in -(-(x,8), y)</span>
                </p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>这里第三行声明的 <span class="stt">x</span> 绑定到 6，所以 <span class="stt">y</span> 的值是 4，整个表达式的值是
          <span class="texMathInline">((-1)-4) = -5</span>。
        </p>
      </blockquote>
      <p>可以将规范写成一条规则。</p>
      <p><span class="texMathDisplay">\infer{\begin{alignedat}{-1}
          &<span class="hspace"> </span><span class="stt">(value-of (let-exp </span><span
            class="texMathInline">var</span><span class="stt"> </span><span class="texMathInline">exp_1</span><span
            class="stt"> </span><span class="texMathInline">body</span><span class="stt">) </span><span
            class="texMathInline">\rho</span><span class="stt">) </span> \\
          &\hphantom{xx}= <span class="stt">(value-of </span><span class="texMathInline">body</span><span class="stt">
            [</span><span class="texMathInline">var</span><span class="stt">=</span><span
            class="texMathInline">val_1</span><span class="stt">]</span><span class="texMathInline">\rho</span><span
            class="stt">) </span>
          \end{alignedat}}
          {<span class="stt">(value-of </span><span class="texMathInline">exp_1</span><span class="stt"> </span><span
            class="texMathInline">\rho</span><span class="stt">) = </span><span
            class="texMathInline">val_1</span>}</span></p>
      <p>像之前那样，将其转为方程通常更方便。</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(value-of (let-exp </span><span class="texMathInline">var</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">exp_1</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">body</span><span class="stt">) </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of </span><span class="texMathInline">body</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">[var=(value-of </span><span
                    class="texMathInline">exp_1</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">\rho</span><span class="stt">)]</span><span
                    class="texMathInline">\rho</span><span class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p><span class="EoplFigureRef"></span> 展示了一个例子，其中 <span class="texMathInline">\rho_0</span> 表示任意环境。</p>
      </blockquote>
      <p>
      <div class="SIntrapara">
        <blockquote class="EoplFigure">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<let x=7</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">in let y = 2</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">       </span><span class="stt">in let y = let x =
                    -(x,1) in -(x,y)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">          </span><span class="stt">in
                    -(-(x,8),y)>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho_0</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                    <<let y=2</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in let y = let x =
                    -(x,1) in -(x,y)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">         </span><span class="stt">in
                    -(-(x,8),y)>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">[x=</span><span
                    class="texMathInline">\lceil</span><span class="stt">7</span><span
                    class="texMathInline">\rceil</span><span class="stt">]</span><span
                    class="texMathInline">\rho_0</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                    <<let y=let x=-(x,1) in -(x,y)</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in -(-(x,8),y)>></span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">[y=</span><span
                    class="texMathInline">\lceil</span><span class="stt">2</span><span
                    class="texMathInline">\rceil</span><span class="stt">][x=</span><span
                    class="texMathInline">\lceil</span><span class="stt">7</span><span
                    class="texMathInline">\rceil</span><span class="stt">]</span><span
                    class="texMathInline">\rho_0</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">令 </span><span class="texMathInline">\rho_1</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt">= [y=</span><span class="texMathInline">\lceil</span><span
                    class="stt">2</span><span class="texMathInline">\rceil</span><span class="stt">][x=</span><span
                    class="texMathInline">\lceil</span><span class="stt">7</span><span
                    class="texMathInline">\rceil</span><span class="stt">]</span><span
                    class="texMathInline">\rho_0</span><span class="stt">。</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"><<-(-(x,8),y)>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">[y=(value-of <<let
                      x=-(x,1) in -(x,y)>> </span><span class="texMathInline">\rho_1</span><span class="stt">)]</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                    class="texMathInline">\rho_1</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"><<-(-(x,8),y)>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">[y=(value-of <<-(x,2)>>
                      [x=(value-of <<-(x,1)>> </span><span class="texMathInline">\rho_1</span><span
                    class="stt">)]</span><span class="texMathInline">\rho_1</span><span class="stt">)]</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                    class="texMathInline">\rho_1</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"><<-(-(x,8),y)>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">[y=(value-of <<-(x,2)>>
                      [x=</span><span class="texMathInline">\lceil</span><span class="stt">6</span><span
                    class="texMathInline">\rceil</span><span class="stt">]</span><span
                    class="texMathInline">\rho_1</span><span class="stt">)]</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                    class="texMathInline">\rho_1</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"><<-(-(x,8),y)>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">[y=</span><span
                    class="texMathInline">\lceil</span><span class="stt">4</span><span
                    class="texMathInline">\rceil</span><span class="stt">]</span><span
                    class="texMathInline">\rho_1</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(- (- 7 8)
                    4)</span><span class="texMathInline">\rceil</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">-5</span><span
                    class="texMathInline">\rceil</span></p>
              </td>
            </tr>
          </table>
          <blockquote class="caption">
            <p><span class="stt">let</span> 一例<a name="(elem._fig-3..5)"></a></p>
          </blockquote>
        </blockquote>
      </div>
      <div class="SIntrapara"><a name="(idx._(gentag._379))"></a>
        <a name="(idx._(gentag._380))"></a>
        <a name="(idx._(gentag._381))"></a>
        <a name="(idx._(gentag._382))"></a>
      </div>
      </p>
      <h5>3.2.8<tt> </tt><a name="(part._s3..2..8)"></a>实现 LET 规范</h5>
      <p>接下来的任务是用一组Scheme过程实现这一规范。我们的实现以 SLLGEN<span class="NoteBox"><span class="NoteContent">见
            <a href="sllgen-parsing-system.html#%28elem._sllgen%29" data-pltdoc="x">附录B</a>。——<span
              class="emph">译注</span></span></span> 为前端，表达式用<span class="EoplFigureRef"></span>
        中的数据类型表示。在我们的实现中，表达值的表示如<span class="EoplFigureRef"></span> 所示。数据
        类型声明了构造器 <span class="stt">num-val</span> 和 <span class="stt">bool-val</span>，用来将整数值和布尔值转换为表达值。
        我们还定义了提取器，用来将表达值转为整数或布尔值。如果表达值类型不符预期，提取器
        报错。</p>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!t]</div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define-datatype</span><span
                    class="hspace"> </span><span class="RktSym">program</span><span class="hspace"> </span><span
                    class="RktSym">program?</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">a-program</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define-datatype</span><span
                    class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                    class="RktSym">expression?</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">const-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">num</span><span
                    class="hspace"> </span><span class="RktSym">number?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">diff-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">exp2</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">zero?-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">if-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">exp2</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">exp3</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">var-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                    class="hspace"> </span><span class="RktSym">identifier?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">let-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                    class="hspace"> </span><span class="RktSym">identifier?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">body</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <blockquote class="caption">
          <p>LET 语言的语法数据类型<a name="(elem._fig-3..6)"></a></p>
        </blockquote>
      </blockquote>
      <p>只要满足<a href="da.html#%28part._s2..2%29" data-pltdoc="x">数据类型的表示策略</a>中的定义，任意一种环境实现都可使用。过程 <span
          class="stt">init-env</span> 创建
        指定的初始环境，供 <span class="stt">value-of-program</span> 使用。</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">init-env</span></span> : <span
                  class="texMathInline">() \to \mathit{Env}</span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold">用法</span> : <span class="stt">(init-env)</span> = <span
                  class="stt">[i=</span><span class="texMathInline">\lceil</span><span class="stt">1</span><span
                  class="texMathInline">\rceil</span><span class="stt">,v=</span><span
                  class="texMathInline">\lceil</span><span class="stt">5</span><span
                  class="texMathInline">\rceil</span><span class="stt">,x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">10</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">init-env</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">extend-env</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">     </span><span class="RktVal">'</span><span class="RktVal">i</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">num-val</span><span
                  class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">     </span><span class="RktPn">(</span><span class="RktSym">extend-env</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktVal">'</span><span class="RktVal">v</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">num-val</span><span
                  class="hspace"> </span><span class="RktVal">5</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">extend-env</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">       </span><span class="RktVal">'</span><span class="RktVal">x</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">num-val</span><span
                  class="hspace"> </span><span class="RktVal">10</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">       </span><span class="RktPn">(</span><span
                  class="RktSym">empty-env</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!t]</div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define-datatype</span><span
                    class="hspace"> </span><span class="RktSym">expval</span><span class="hspace"> </span><span
                    class="RktSym">expval?</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">num-val</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">num</span><span
                    class="hspace"> </span><span class="RktSym">number?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">bool-val</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">bool</span><span
                    class="hspace"> </span><span class="RktSym">boolean?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">expval->num</span></span> : <span
                    class="texMathInline">\mathit{ExpVal} \to \mathit{Int}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">expval->num</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">expval</span><span class="hspace"> </span><span
                    class="RktSym">val</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">num-val</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">num</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="RktSym">num</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">else</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">report-expval-extractor-error</span><span class="hspace"> </span><span
                    class="RktVal">'</span><span class="RktVal">num</span><span class="hspace"> </span><span
                    class="RktSym">val</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">expval->bool</span></span> : <span
                    class="texMathInline">\mathit{ExpVal} \to \mathit{Bool}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">expval->bool</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">expval</span><span class="hspace"> </span><span
                    class="RktSym">val</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">bool-val</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">bool</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="RktSym">bool</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">else</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">report-expval-extractor-error</span><span class="hspace"> </span><span
                    class="RktVal">'</span><span class="RktVal">bool</span><span class="hspace"> </span><span
                    class="RktSym">val</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p>LET 语言的表达值<a name="(elem._fig-3..7)"></a></p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._383))"></a></div>
        </p>
      </blockquote>
      <p>现在我们可以写出解析器，如<span class="EoplFigureRef"></span> 和<span class="stt">fig-3.9</span> 所示。主过程
        是 <span class="stt">run</span>，它取一个字符串，解析它，把结果传给 <span class="stt">value-of-program</span>。最令人感
        兴趣的过程是 <span class="stt">value-of</span>，它取一表达式和一环境，用解释器秘方计算规范所要求的答
        案。在代码中，我们插入了相关的推理规则定义，以便观察 <span class="stt">value-of</span> 的代码如何与
        规范对应。
        <a name="(idx._(gentag._384))"></a>
      </p>
      <blockquote class="SubFlow">
        <p><span class="Smaller"><br /><a name="(elem._ex-note)"></a>在下面的练习以及全书之中，短语
            “扩展语言，添加……”表示向语言规范添加规则或者方程，
            并增改相应的解释器，实现指定特性。</span></p>
      </blockquote>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">run</span></span> : <span
                  class="texMathInline">\mathit{String} \to \mathit{ExpVal}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">run</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">string</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span
                  class="RktSym">value-of-program</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">scan&parse</span><span class="hspace"> </span><span class="RktSym">string</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">value-of-program</span></span> : <span
                  class="texMathInline">\mathit{Program} \to \mathit{ExpVal}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">value-of-program</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">pgm</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">program</span><span class="hspace"> </span><span
                  class="RktSym">pgm</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">a-program</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">init-env</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">value-of</span></span> : <span
                  class="texMathInline">\mathit{ExpVal} \times \mathit{Env} \to \mathit{Bool}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">value-of</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                  class="RktSym">exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="texMathInline">\fbox{<span class="hspace"> </span><span
                    class="stt">(value-of (const-exp </span><span class="texMathInline">n</span><span class="stt">)
                  </span><span class="texMathInline">\rho</span><span class="stt">) = n</span>}</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">const-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">num</span><span class="RktPn">)</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">num-val</span><span class="hspace"> </span><span
                  class="RktSym">num</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="texMathInline">\fbox{<span class="hspace"> </span><span
                    class="stt">(value-of (var-exp </span><span class="texMathInline">var</span><span class="stt">)
                  </span><span class="texMathInline">\rho</span><span class="stt">) = </span><span
                    class="stt">(apply-env </span><span class="texMathInline">\rho</span><span class="stt"> </span><span
                    class="texMathInline">var</span><span class="stt">)</span>}</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">var-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">apply-env</span><span class="hspace"> </span><span class="RktSym">env</span><span
                  class="hspace"> </span><span class="RktSym">var</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span
                  class="texMathInline">\fbox{\begin{math}\begin{alignedat}{-1}&<span class="hspace"> </span><span
                    class="stt">(value-of (diff-exp </span><span class="texMathInline">exp_1</span><span class="stt">
                  </span><span class="texMathInline">exp_2</span><span class="stt">) </span><span
                    class="texMathInline">\rho</span><span class="stt">) =</span> \\ &\hphantom{xxx}<span
                    class="texMathInline">\lceil</span><span class="stt">(- </span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of </span><span
                    class="texMathInline">exp_1</span><span class="stt"> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt"> </span><span
                    class="texMathInline">\lfloor</span><span class="stt">(value-of </span><span
                    class="texMathInline">exp_2</span><span class="stt"> </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span><span
                    class="texMathInline">\rfloor</span><span class="stt">)</span><span
                    class="texMathInline">\rceil</span>\end{alignedat}\end{math}}</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">diff-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">val1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">              </span><span class="RktPn">(</span><span
                  class="RktSym">val2</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">num1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->num</span><span class="hspace"> </span><span class="RktSym">val1</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                </span><span class="RktPn">(</span><span
                  class="RktSym">num2</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">expval->num</span><span class="hspace"> </span><span class="RktSym">val2</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">num-val</span></td>
            </tr>
            <tr>
              <td><span class="hspace">              </span><span class="RktPn">(</span><span class="RktSym"><span
                    class="nobreak">-</span></span><span class="hspace"> </span><span class="RktSym">num1</span><span
                  class="hspace"> </span><span class="RktSym">num2</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td>\begin{comment}</td>
            </tr>
            <tr>
              <td><span class="RktSym">...</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td>\end{comment}
                \smallskip</td>
            </tr>
          </table>
        </blockquote>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p>LET 语言的解释器<a name="(elem._fig-3..8)"></a></p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._385))"></a></div>
        </p>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!ht]</div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td>\smallskip
                  \begin{comment}</td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">...</span></td>
              </tr>
              <tr>
                <td>\end{comment}</td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span
                    class="texMathInline">\fbox{\infer{\begin{alignedat}{-1}&<span class="stt">(value-of (zero?-exp
                    </span><span class="texMathInline">exp_1</span><span class="stt">) </span><span
                      class="texMathInline">\rho</span><span class="stt">)</span> \\ &\hphantom{x}= \begin{cases} <span
                      class="stt">(bool-val #t)</span> & 若 <span class="stt">(expval->num </span><span
                      class="texMathInline">val_1</span><span class="stt">)</span> = 0 \\ <span class="stt">(bool-val
                      #f)</span> & 若 <span class="stt">(expval->num </span><span class="texMathInline">val_1</span><span
                      class="stt">)</span> \neq 0 \end{cases} \end{alignedat}}{<span class="stt">(value-of </span><span
                      class="texMathInline">exp_1</span><span class="stt"> </span><span
                      class="texMathInline">\rho</span><span class="stt">) = </span><span
                      class="texMathInline">val_1</span>}}</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">zero?-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">val1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                    class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">let</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">num1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">expval->num</span><span class="hspace"> </span><span class="RktSym">val1</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">            </span><span class="RktPn">(</span><span
                    class="RktSym">if</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">zero?</span><span class="hspace"> </span><span class="RktSym">num1</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">              </span><span class="RktPn">(</span><span
                    class="RktSym">bool-val</span><span class="hspace"> </span><span class="RktVal">#t</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">              </span><span class="RktPn">(</span><span
                    class="RktSym">bool-val</span><span class="hspace"> </span><span class="RktVal">#f</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span
                    class="texMathInline">\fbox{\infer{\begin{alignedat}{-1}&<span class="stt">(value-of (if-exp
                    </span><span class="texMathInline">exp_1</span><span class="stt"> </span><span
                      class="texMathInline">exp_2</span><span class="stt"> </span><span
                      class="texMathInline">exp_3</span><span class="stt">) </span><span
                      class="texMathInline">\rho</span><span class="stt">)</span> \\ &\hphantom{x}= \begin{cases} <span
                      class="stt">(value-of </span><span class="texMathInline">exp_2</span><span class="stt">
                    </span><span class="texMathInline">\rho</span><span class="stt">)</span> & 若 <span
                      class="stt">(expval->bool </span><span class="texMathInline">val_1</span><span
                      class="stt">)</span> = <span class="stt">#t</span> \\ <span class="stt">(value-of </span><span
                      class="texMathInline">exp_3</span><span class="stt"> </span><span
                      class="texMathInline">\rho</span><span class="stt">)</span> & 若 <span class="stt">(expval->bool
                    </span><span class="texMathInline">val_1</span><span class="stt">)</span> = <span
                      class="stt">#f</span> \end{cases} \end{alignedat}}{<span class="stt">(value-of </span><span
                      class="texMathInline">exp_1</span><span class="stt"> </span><span
                      class="texMathInline">\rho</span><span class="stt">) = </span><span
                      class="texMathInline">val_1</span>}}</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">if-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                    class="hspace"> </span><span class="RktSym">exp3</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">expval->bool</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">value-of</span><span
                    class="hspace"> </span><span class="RktSym">exp1</span><span class="hspace"> </span><span
                    class="RktSym">env</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                    class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp3</span><span
                    class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span
                    class="texMathInline">\fbox{\infer{\begin{alignedat}{-1}&<span class="stt">(value-of (let-exp
                    </span><span class="texMathInline">var</span><span class="stt"> </span><span
                      class="texMathInline">exp_1</span><span class="stt"> </span><span
                      class="texMathInline">body</span><span class="stt">) </span><span
                      class="texMathInline">\rho</span><span class="stt">)</span> \\ &\hphantom{x}= <span
                      class="stt">(value-of </span><span class="texMathInline">body</span><span class="stt">
                      [</span><span class="texMathInline">var</span><span class="stt">=</span><span
                      class="texMathInline">val_1</span><span class="stt">]</span><span
                      class="texMathInline">\rho</span><span class="stt">)</span> \end{alignedat}}{<span
                      class="stt">(value-of </span><span class="texMathInline">exp_1</span><span class="stt">
                    </span><span class="texMathInline">\rho</span><span class="stt">) = </span><span
                      class="texMathInline">val_1</span>}}</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">let-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                    class="hspace"> </span><span class="RktSym">body</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">val1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                    class="hspace"> </span><span class="RktSym">env</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">body</span></td>
              </tr>
              <tr>
                <td><span class="hspace">            </span><span class="RktPn">(</span><span
                    class="RktSym">extend-env</span><span class="hspace"> </span><span class="RktSym">var</span><span
                    class="hspace"> </span><span class="RktSym">val1</span><span class="hspace"> </span><span
                    class="RktSym">env</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p>LET 语言的解释器，续<a name="(elem._fig-3..9)"></a></p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._386))"></a></div>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..3)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>我们只有一个算术操作，选减法为什么比加法好？</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..4)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._387))"></a>
          <a name="(idx._(gentag._388))"></a>
          把<span class="EoplFigureRef"></span> 中的推导写成<span class="stt">deriv-tree</span>那样的推理树。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..5)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>把<span class="EoplFigureRef"></span> 中的推导写成<span class="stt">deriv-tree</span>那样的推理树。
          <a name="(idx._(gentag._389))"></a>
          <a name="(idx._(gentag._390))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..6)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>扩展语言，添加新操作符 <span class="stt">minus</span>，它取一参数 <span
            class="texMathInline">n</span>，返回 <span class="texMathInline">-n</span>。例如，
          <span class="stt">minus(- (minus(5), 9))</span> 的值应为14。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..7)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>扩展语言，添加加法、乘法和整数除法操作。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..8)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>向该语言添加等值比较谓词 <span class="stt">equal?</span>，以及顺序比较谓词 <span
            class="stt">greater?</span> 和
          <span class="stt">less?</span>。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..9)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._391))"></a>
          向该语言添加列表处理操作，包括 <span class="stt">cons</span>、<span class="stt">car</span>、<span class="stt">cdr</span>、<span
            class="stt">null?</span> 和
          <span class="stt">emptylist</span>。列表可以包含任何表达值，包括其他列表。像<a href="#%28part._s3..2..2%29"
            data-pltdoc="x">定义值</a>那样，给
          出语言表达值和指代值的定义。例如：
        </p>
        <blockquote class="SubFlow">
          <blockquote class="EoplCodeInset">
            <table cellspacing="0" cellpadding="0" class="SVerbatim">
              <tr>
                <td>
                  <p><span class="stt">let x = 4</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">in cons(x,</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">        </span><span
                      class="stt">cons(cons(-(x,1),</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">                  </span><span
                      class="stt">emptylist),</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">             </span><span
                      class="stt">emptylist))</span></p>
                </td>
              </tr>
            </table>
          </blockquote>
          <p>应返回一表达值，表示列表 <span class="stt">(4 (3))</span>。
            <a name="(idx._(gentag._392))"></a>
          </p>
        </blockquote>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..10)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._393))"></a>
          向该语言添加操作 <span class="stt">list</span>。该操作取任意数量的参数，返回一表达值，包含由参数值组
          成的列表。例如：</p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let x = 4</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in list(x, -(x,1), -(x,3))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>应返回一表达值，表示列表 <span class="stt">(4 3 1)</span>。
          <a name="(idx._(gentag._394))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..11)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>真正的语言可能有很多上述练习那样的操作符。调整解释器代码，以便添加新操作符。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..12)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._395))"></a>
          向该语言添加 <span class="stt">cond</span> 表达式。语法为：</p>
        <p><span class="texMathDisplay">\mathit{Expression} ::= <span class="stt">cond </span><span
              class="texMathInline">\{}<span class="texMathInline">\mathit{Expression}</span> <span
                class="hspace"> </span><span class="stt">==> </span> <span
                class="texMathInline">\mathit{Expression}</span><span class="texMathInline">\</span>^{*}</span><span
              class="stt"> end</span></span></p>
        <p>在这种表达式里，<span class="stt">==></span> 左边的表达式按序求值，直到其中一个返回真。整个表达式的
          值是真值表达式右边对应表达式的值。如果没有条件为真，该表达式应报错。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..13)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._396))"></a>
          修改语言，把整数作为唯一的表达值。修改 <span class="stt">if</span>，以 0 为假，以所有其他值为真。相
          应地修改谓词。
          <a name="(idx._(gentag._397))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..14)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._398))"></a>
          前一题的另一做法是给语言添加新的非终结符 <span class="texMathInline">\mathit{Bool\mbox{-}exp}</span>，作为布尔
          值表达式。修改条件表达式的生成式：</p>
        <p><span class="texMathDisplay">\mathit{Expression} ::= <span class="stt">if </span><span
              class="texMathInline">\mathit{Bool\mbox{-}exp}</span><span class="stt"> then </span><span
              class="texMathInline">\mathit{Expression}</span><span class="stt"> else </span><span
              class="texMathInline">\mathit{Expression}</span></span></p>
        <p>为 <span class="texMathInline">\mathit{Bool\mbox{-}exp}</span> 写出适当的生成式，实现 <span
            class="stt">value-of-bool-exp</span>。
          按这种方式，<span class="EoplExerciseRef"></span> 中的谓词应放在哪里？</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..15)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._399))"></a>
          扩展语言，添加新操作 <span class="stt">print</span>，它取一参数，打印出来，返回整数1。在我们的规范框
          架下，为什么不能表示这一操作？
          <a name="(idx._(gentag._400))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..16)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._401))"></a>
          扩展语言，允许 <span class="stt">let</span> 声明任意数量的变量，语法为：<br /></p>
        <p><span class="texMathDisplay">\mathit{Expression} ::= <span class="stt">let </span><span
              class="texMathInline">\{}<span class="texMathInline">\mathit{Identifier}</span> = <span
                class="texMathInline">\mathit{Expression}\</span>^*</span><span class="stt"> in </span><span
              class="texMathInline">\mathit{Expression}</span></span></p>
        <p>像 Scheme 中的 <span class="stt">let</span> 那样，声明右边在当前环境中求值，每个新变量绑定到对应声明
          右边的值，然后求主体的值。例如：</p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let x = 30</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in let x = -(x,1)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">       </span><span class="stt">y = -(x,2)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in -(x,y)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>值应为1。
          <a name="(idx._(gentag._402))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..17)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._403))"></a>
          扩展语言，添加表达式 <span class="stt">let*</span>，像 Scheme 的 <span class="stt">let*</span> 那样。则：</p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let x = 30</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in let* x = -(x,1) y = -(x,2)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in -(x,y)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>值应为2。
          <a name="(idx._(gentag._404))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..18)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._405))"></a>
          向该语言添加表达式：</p>
        <p><span class="texMathDisplay">\mathit{Expression} ::= <span class="stt">unpack </span><span
              class="texMathInline">\{\mathit{Identifier}\}^*</span><span class="stt"> = </span><span
              class="texMathInline">\mathit{Expression}</span><span class="stt"> in </span><span
              class="texMathInline">\mathit{Expression}</span></span></p>
        <p>则：如果 <span class="stt">lst</span> 恰好是三元素的列表，<span class="stt">unpack x y z = lst in ...</span> 将 <span
            class="stt">x</span>、
          <span class="stt">y</span> 和 <span class="stt">z</span> 绑定到 <span class="stt">lst</span> 的各元素；否则报错。例如：
        </p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let u = 7</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in unpack x y = cons(u,cons(3,emptylist))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in -(x,y)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>值应为4。
          <a name="(idx._(gentag._406))"></a>
        </p>
      </blockquote>
      <h4>3.3<tt> </tt><a name="(part._s3..3)"></a>PROC：有过程的语言</h4>
      <p><a name="(idx._(gentag._407))"></a>
        目前为止，我们的语言只能进行定义好的操作。要想让这种解释性语言更有用，必须能创建
        新过程。我们把新语言叫做 PROC。</p>
      <p><a name="(idx._(gentag._408))"></a>
        按照 Scheme 的设计，我们把过程作为语言的表达值，则：</p>
      <blockquote class="SubFlow">
        <p><span class="Iidentity">\begin{align*}\mathit{ExpVal} &= \mathit{Int} + \mathit{Bool} + \mathit{Proc} \\
            \mathit{DenVal} &= \mathit{Int} + \mathit{Bool} + \mathit{Proc}\end{align*}</span></p>
        <p>其中，<span class="texMathInline">\mathit{Proc}</span> 是一值集合，表示过程。我们把 <span
            class="texMathInline">\mathit{Proc}</span> 作为一种
          抽象数据类型。下面我们考虑它的接口和规范。</p>
      </blockquote>
      <p><a name="(idx._(gentag._409))"></a>
        <a name="(idx._(gentag._410))"></a>
        <a name="(idx._(gentag._411))"></a>
        <a name="(idx._(gentag._412))"></a>
        我们还需要语法来创建和调用过程。对应的生成式为：
      </p>
      <p><span class="Iidentity">\begin{align*}\mathit{Expression} &::= <span class="stt">proc (</span><span
            class="Iidentity">\mathit{Identifier}</span><span class="stt">) </span><span
            class="Iidentity">\mathit{Expression}</span> \\[-3pt]
          &\mathrel{\phantom{::=}} \fbox{<span class="stt">proc-exp (var body)</span>} \\[5pt]
          \mathit{Expression} &::= <span class="stt">letrec(</span><span
            class="Iidentity">\mathit{Expression}</span><span class="stt"> </span><span
            class="Iidentity">\mathit{Expression}</span><span class="stt">)</span> \\[-3pt]
          &\mathrel{\phantom{::=}} \fbox{<span class="stt">call-exp (rator rand)</span>}\end{align*}</span></p>
      <p><a name="(idx._(gentag._413))"></a>
        <a name="(idx._(gentag._414))"></a>
        <a name="(idx._(gentag._415))"></a>
        <a name="(idx._(gentag._416))"></a>
        <a name="(idx._(gentag._417))"></a>
        <a name="(idx._(gentag._418))"></a>
        在 <span class="stt">(proc </span><span class="texMathInline">var</span><span class="stt"> </span><span
          class="texMathInline">body</span><span class="stt">)</span> 中，变量 <span class="texMathInline">var</span> 是<span
          class="emph">绑定
          变量</span> (<span class="emph">bound variable</span>) 或<span class="emph">形参</span> (<span class="emph">formal
          parameter</span>)。在过程调用 <span class="stt">(call-exp </span><span class="texMathInline">exp_1</span><span
          class="stt">
        </span><span class="texMathInline">exp_2</span><span class="stt">)</span> 中，表达式 <span
          class="texMathInline">exp_1</span> 是<span class="emph">操作符</span> (<span class="emph">operator</span>)，表达式
        <span class="texMathInline">exp_2</span>
        是<span class="emph">操作数</span> (<span class="emph">operand</span>) 或<a name="(idx._(gentag._419))"></a><span
          class="emph">实际参数</span> (<span class="emph">actual
          parameter</span>)。我们用<a name="(idx._(gentag._420))"></a><span class="emph">实参</span> (<span
          class="emph">argument</span>) 指代实
        际参数的值。
      </p>
      <p>这是这种语言的两个小例子。</p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">let f = proc (x) -(x,11)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">in (f (f 77))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(proc (f) (f (f 77))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span><span class="stt">proc (x) -(x,11))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>第一个程序创建过程 <span class="stt">f</span>，将实参减11，然后用 77 两次调用 <span class="stt">f</span>，得到的答案为55。
        第二个程序创建的过程取一参数，连续两次用 77 调用该参数；然后将减 11 的过程传给创
        建的过程，结果仍为 55。</p>
      <p>现在我们来看数据类型 <span class="texMathInline">\mathit{Proc}</span>。它的接口包含构造器 <span class="stt">procedure</span>，用于
        创建过程值；观测器 <span class="stt">apply-procedure</span>，用于调用过程值。</p>
      <p>接下来的任务是，明确表示过程的值需要包含哪些信息。欲知此，我们考虑在程序中任意位
        置写 <span class="stt">proc</span> 表达式时发生了什么。</p>
      <p>词法作用域规则告诉我们，调用一个过程时，过程的形参绑定到调用时的实参，然后在该环
        境内求值过程的主体。过程中出现的自由变量也应该遵守词法绑定规则。考虑表达式：</p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">let x = 200</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">in let f = proc (z) -(z,x)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in let x = 100</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in let g = proc (z)
                  -(z,x)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">         </span><span class="stt">in -((f 1), (g
                  1))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p><a name="(idx._(gentag._421))"></a>
        <a name="(idx._(gentag._422))"></a>
        这里我们两次求值表达式 <span class="stt">proc (z) -(z,x)</span>。第一次求值时，<span class="stt">x</span> 绑定到 200，所
        以根据词法绑定规则，得到的过程将实参减 200，我们将其命名为 <span class="stt">f</span>。第二次求值时，
        <span class="stt">x</span> 绑定到 100，得出的过程应将实参减 100，我们将该过程命名为 <span class="stt">g</span>。
      </p>
      <p><a name="(idx._(gentag._423))"></a>
        这两个过程由同一个表达式生成，而行为不同。由此可得，<span class="stt">proc</span> 表达式的值一定以某
        种方式依赖求值环境。因此，构造器 <span class="stt">procedure</span> 必定取三个参数：绑定变量、主体以
        及环境。<span class="stt">proc</span> 表达式定义为：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(value-of (proc-exp </span><span class="texMathInline">var</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">body</span><span class="stt">) </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (proc-val (procedure </span><span class="texMathInline">var</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">body</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">\rho</span><span class="stt">))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>像 <span class="stt">bool-val</span> 和 <span class="stt">num-val</span> 一样，<span class="stt">proc-val</span>
          是一构造器，生成一个
          <span class="texMathInline">\mathit{Proc}</span> 的表达值。
        </p>
      </blockquote>
      <p>调用过程时，我们要找出操作符和操作数的值。如果操作符是一个 <span class="stt">proc-val</span>，那么我
        们要以操作数的值调用它。</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(value-of (call-exp </span><span class="texMathInline">rator</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">rand</span><span class="stt">) </span><span
                    class="texMathInline">\rho</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (let ((proc (expval->proc (value-of </span><span
                    class="texMathInline">rator</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">\rho</span><span class="stt">)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">(arg (value-of
                  </span><span class="texMathInline">rand</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">\rho</span><span
                    class="stt">)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(apply-procedure proc
                    arg))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>这里，我们用了一个判断式 <span class="stt">expval->proc</span>，像 <span class="stt">expval->num</span>，它判断表达值
          <span class="stt">(value-of </span><span class="texMathInline">rator</span><span class="stt"> </span><span
            class="texMathInline">\rho</span><span class="stt">)</span> 是否由 <span class="stt">proc-val</span>
          生成，如果是，则从中提取
          出包含的过程。
        </p>
      </blockquote>
      <p>最后，我们考虑调用 <span class="stt">apply-procedure</span> 时发生了什么。词法作用域规则告诉我们，调
        用过程时，过程主体的求值环境将其形参绑定到调用时的实参；而且，任何其他变量的值必
        须和过程创建时相同。因此，这些过程应满足条件</p>
      <blockquote class="EoplEquationInset">
        <p>
        <div class="SIntrapara">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(apply-procedure (procedure </span><span class="texMathInline">var</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">body</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">\rho</span><span class="stt">) </span><span
                    class="texMathInline">val</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of </span><span class="texMathInline">body</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">[</span><span
                    class="texMathInline">var=val</span><span class="stt">]</span><span
                    class="texMathInline">\rho</span><span class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._424))"></a>
          <a name="(idx._(gentag._425))"></a>
          <a name="(idx._(gentag._426))"></a>
          <a name="(idx._(gentag._427))"></a>
          <a name="(idx._(gentag._428))"></a>
          <a name="(idx._(gentag._429))"></a>
          <a name="(idx._(gentag._430))"></a>
        </div>
        </p>
      </blockquote>
      <h5>3.3.1<tt> </tt><a name="(part._s3..3..1)"></a>一个例子</h5>
      <p>我们用一个例子展示定义的各部分是如何配合的。由于我们还没有写出过程的实现，这个计
        算过程用<span class="emph">规范</span>表示。令 <span class="texMathInline">\rho</span> 为任一环境。</p>
      <blockquote class="Small">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(value-of</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                  <<let x=200</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">in let f = proc (z)
                  -(z,x)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">in let x = 100</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">          </span><span class="stt">in let g = proc (z)
                  -(z,x)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">             </span><span class="stt">in -((f 1), (g
                  1))>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                  <<let f=proc (z) -(z,x)</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in let x = 100</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">         </span><span class="stt">in let g = proc (z)
                  -(z,x)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">            </span><span class="stt">in -((f 1), (g
                  1))>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">[x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                  <<let x=100</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in let g = proc (z)
                  -(z,x)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">         </span><span class="stt">in -((f 1), (g
                  1))>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">[f=(proc-val (procedure z
                  <<-(z,x)>> [x=</span><span class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">))]</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">     </span><span class="stt">[x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                  <<let g=proc (z) -(z,x)</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in -((f 1), (g
                  1))>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">[x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">100</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">     </span><span class="stt">[f=(proc-val (procedure z
                  <<-(z,x)>> [x=</span><span class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">))]</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">[x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                  <<let g=proc (z) -(z,x)</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in -((f 1), (g
                  1))>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">[g=(proc-val (procedure z
                  <<-(z,x)>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">                            </span><span
                  class="stt">[x=</span><span class="texMathInline">\lceil</span><span class="stt">100</span><span
                  class="texMathInline">\rceil</span><span class="stt">][f=...][x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">))]</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">     </span><span class="stt">[x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">100</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">[f=(proc-val (procedure z
                  <<-(z,x)>> [x=</span><span class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">))]</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">[x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(-</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of <<(f 1)>></span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">[g=(proc-val (procedure z
                  <<-(z,x)>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">                              </span><span
                  class="stt">[x=</span><span class="texMathInline">\lceil</span><span class="stt">100</span><span
                  class="texMathInline">\rceil</span><span class="stt">][f=...][x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">))]</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">[x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">100</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">        </span><span class="stt">[f=(proc-val (procedure
                  z <<-(z,x)>> [x=</span><span class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">))]</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">         </span><span class="stt">[x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of <<(g 1)>></span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">[g=(proc-val (procedure z
                  <<-(z,x)>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">                              </span><span
                  class="stt">[x=</span><span class="texMathInline">\lceil</span><span class="stt">100</span><span
                  class="texMathInline">\rceil</span><span class="stt">][f=...][x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">))]</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">[x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">100</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">        </span><span class="stt">[f=(proc-val (procedure
                  z <<-(z,x)>> [x=</span><span class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">))]</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">         </span><span class="stt">[x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">))</span><span
                  class="texMathInline">\rceil</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(-</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(apply-procedure</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(procedure z <<-(z,x)>>
                    [x=</span><span class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt"></span><span
                  class="texMathInline">\lceil</span><span class="stt">1</span><span
                  class="texMathInline">\rceil</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(apply-procedure</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(procedure z <<-(z,x)>>
                    [x=</span><span class="texMathInline">\lceil</span><span class="stt">100</span><span
                  class="texMathInline">\rceil</span><span class="stt">][f=...][x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt"></span><span
                  class="texMathInline">\lceil</span><span class="stt">1</span><span
                  class="texMathInline">\rceil</span><span class="stt">))</span><span
                  class="texMathInline">\rceil</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(-</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of <<-(z,x)>>
                    [z=</span><span class="texMathInline">\lceil</span><span class="stt">1</span><span
                  class="texMathInline">\rceil</span><span class="stt">][x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of <<-(z,x)>>
                    [z=</span><span class="texMathInline">\lceil</span><span class="stt">1</span><span
                  class="texMathInline">\rceil</span><span class="stt">][x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">100</span><span
                  class="texMathInline">\rceil</span><span class="stt">][f=...][x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">200</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">))</span><span
                  class="texMathInline">\rceil</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">(- -199
                  -99)</span><span class="texMathInline">\rceil</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= </span><span class="texMathInline">\lceil</span><span class="stt">-100</span><span
                  class="texMathInline">\rceil</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>其中，绑定到的 <span class="stt">f</span> 过程将实参减 200，绑定到 <span class="stt">g</span> 的过程将实参减 100，所以
        <span class="stt">(f 1)</span> 的值是 -199，<span class="stt">(g 1)</span> 的值是 -99。
      </p>
      <h5>3.3.2<tt> </tt><a name="(part._s3..3..2)"></a>表示过程</h5>
      <p><a name="(idx._(gentag._431))"></a>
        <a name="(idx._(gentag._432))"></a>
        根据<a href="da.html#%28part._s2..2..3%29" data-pltdoc="x">过程表示法</a>中介绍的方法，我们可以按照过程表示法，用过程在
        <span class="stt">apply-procedure</span> 中的动作表示它们。欲如此，我们将 <span class="stt">procedure</span> 的值定义为
        实现语言的过程，它取一实参，返回下面规范要求的值：
      </p>
      <blockquote class="SubFlow">
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(apply-procedure (procedure </span><span class="texMathInline">var</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">body</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">\rho</span><span class="stt">) </span><span
                    class="texMathInline">val</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of </span><span class="texMathInline">body</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">(extend-env </span><span
                    class="texMathInline">var</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">val</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">\rho</span><span
                    class="stt">))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>因此，完整的实现是：</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">proc?</span></span> : <span
                    class="texMathInline">\mathit{SchemeVal} \to \mathit{Bool}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">proc?</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">procedure?</span><span class="hspace"> </span><span class="RktSym">val</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">procedure</span></span> : <span
                    class="texMathInline">\mathit{Var} \times \mathit{Exp} \times \mathit{Env} \to \mathit{Proc}</span>
                </td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">procedure</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                    class="hspace"> </span><span class="RktSym">body</span><span class="hspace"> </span><span
                    class="RktSym">env</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">body</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">extend-env</span><span
                    class="hspace"> </span><span class="RktSym">var</span><span class="hspace"> </span><span
                    class="RktSym">val</span><span class="hspace"> </span><span class="RktSym">env</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">apply-procedure</span></span> : <span
                    class="texMathInline">\mathit{Proc} \times \mathit{ExpVal} \to \mathit{ExpVal}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">apply-procedure</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">proc1</span><span
                    class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">proc1</span><span
                    class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>这里定义的函数 <span class="stt">proc?</span> 不完全准确，因为不是每个 Scheme 过程都能作为我们语言中
          的过程。我们需要它，只是为了定义数据类型 <span class="stt">expval</span>。
          <a name="(idx._(gentag._433))"></a>
          <a name="(idx._(gentag._434))"></a>
        </p>
      </blockquote>
      <p><a name="(idx._(gentag._435))"></a>
        <a name="(idx._(gentag._436))"></a>
        另一种方式是用<a href="da.html#%28part._s2..2..2%29" data-pltdoc="x">数据结构表示法</a>那样的数据结构表示法。
      </p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">proc?</span></span> : <span
                  class="texMathInline">\mathit{SchemeVal} \to \mathit{Bool}</span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">procedure</span></span> : <span
                  class="texMathInline">\mathit{Var} \times \mathit{Exp} \times \mathit{Env} \to \mathit{Proc}</span>
              </td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define-datatype</span><span
                  class="hspace"> </span><span class="RktSym">proc</span><span class="hspace"> </span><span
                  class="RktSym">proc?</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">procedure</span></td>
            </tr>
            <tr>
              <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">identifier?</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">saved-env</span><span
                  class="hspace"> </span><span class="RktSym">environment?</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">apply-procedure</span></span> : <span
                  class="texMathInline">\mathit{Proc} \times \mathit{ExpVal} \to \mathit{ExpVal}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-procedure</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">proc1</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">proc</span><span class="hspace"> </span><span
                  class="RktSym">proc1</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">procedure</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">extend-env</span><span
                  class="hspace"> </span><span class="RktSym">var</span><span class="hspace"> </span><span
                  class="RktSym">val</span><span class="hspace"> </span><span class="RktSym">saved-env</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p><a name="(idx._(gentag._437))"></a>
        这些数据结构常称为<span class="emph">闭包</span> (<span class="emph">closure</span>)，因为它们自给自足，包含过程调用所需要的
        一切。有时，我们说过程<span class="emph">闭合于</span> (<span class="emph">closed over</span>, <span class="emph">closed
          in</span>) 创建时的环境。</p>
      <p>显然，这些实现都满足过程接口的定义。</p>
      <p>不论哪种实现，我们都要给数据类型 <span class="stt">expval</span> 添加变体：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define-datatype</span><span
                    class="hspace"> </span><span class="RktSym">exp-val</span><span class="hspace"> </span><span
                    class="RktSym">exp-val?</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">num-val</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                    class="hspace"> </span><span class="RktSym">number?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">bool-val</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                    class="hspace"> </span><span class="RktSym">boolean?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">proc-val</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                    class="hspace"> </span><span class="RktSym">proc?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>同时给 <span class="stt">value-of</span> 添加两条新语句：</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="hspace">       </span><span class="RktPn">(</span><span
                    class="RktSym">proc-exp</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">var</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">body</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">       </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">proc-val</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktPn">(</span><span class="RktSym">procedure</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">var</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">body</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">env</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">       </span><span class="RktMeta"> </span></td>
              </tr>
              <tr>
                <td><span class="hspace">       </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                    class="RktSym">call-exp</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">rator</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">rand</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">       </span><span class="RktMeta"></span><span class="hspace">  </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">proc</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktPn">(</span><span class="RktSym">expval->proc</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                    class="RktSym">value-of</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">rator</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">env</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">       </span><span class="RktMeta"></span><span
                    class="hspace">        </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                    class="RktSym">arg</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktPn">(</span><span class="RktSym">value-of</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">rand</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">env</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
              <tr>
                <td><span class="hspace">       </span><span class="RktMeta"></span><span
                    class="hspace">    </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                    class="RktSym">apply-procedure</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">proc</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">arg</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>记住：一定要给语言的每个扩展写出规范。参见<span class="stt">ex-note</span>的说明。
          <a name="(idx._(gentag._438))"></a>
          <a name="(idx._(gentag._439))"></a>
          <a name="(idx._(gentag._440))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..19)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._441))"></a>
          <a name="(idx._(gentag._442))"></a>
          在很多语言中，过程创建和命名必须同时进行。修改本节的语言，用 <span class="stt">letproc</span> 替换
          <span class="stt">proc</span>，以支持此性质。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..20)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._443))"></a>
          <a name="(idx._(gentag._444))"></a>
          在PROC中，过程只能有一个参数，但是可以用返回其他过程的过程来模拟多参数过程。例如，
          可以写出这样的代码：
        </p>
        <blockquote class="SubFlow">
          <blockquote class="EoplCodeInset">
            <table cellspacing="0" cellpadding="0" class="SVerbatim">
              <tr>
                <td>
                  <p><span class="stt">let f = proc (x) proc (y) ...</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">in ((f 3) 4)</span></p>
                </td>
              </tr>
            </table>
          </blockquote>
          <p>这个小技巧叫做<a name="(elem._curry)"></a><span class="emph">咖哩化</span> (<span class="emph">Currying</span>)，该过程则
            称作<span class="emph">咖喱式</span> (<span class="emph">Curried</span>) 的。写出一个咖喱式的过程，它取两个参数，返回
            二者之和。在我们的语言中，可以把 <span class="texMathInline">x+y</span> 写成 <span class="stt">-(x,-(0,y))</span>。</p>
          <p><a name="(idx._(gentag._445))"></a></p>
        </blockquote>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..21)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>扩展本节的语言，添加多参数过程及其调用，语法为：</p>
        <p><span class="Iidentity">\begin{align*}\mathit{Expression} &::= <span class="stt">proc (</span><span
              class="Iidentity">\{\mathit{Identifier}\}^{*(,)}</span><span class="stt">) </span><span
              class="Iidentity">\mathit{Expression}</span> \\[-3pt]
            \mathit{Expression} &::= <span class="stt">(</span><span class="Iidentity">\mathit{Expression}</span><span
              class="stt"> </span><span class="Iidentity">\mathit{\{Expression\}^{*}}</span><span
              class="stt">)</span>\end{align*}</span>
          <a name="(idx._(gentag._446))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..22)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>本节的内置操作（如差值）和过程调用使用不同的具体语法。修改具体语法，不要让语言的
          用户区分哪些是内置操作，哪些是自定义的过程。根据所使用的解析技术，这道练习可能很
          容易，也可能非常难。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..23)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._447))"></a>
          <a name="(idx._(gentag._448))"></a>
          下面的PROC程序值是什么？
        </p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let makemult = proc (maker)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                </span><span class="stt">proc
                    (x)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                 </span><span class="stt">if
                    zero?(x)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                 </span><span class="stt">then 0</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                 </span><span class="stt">else
                    -(((maker maker) -(x,1)), -4)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in let times4 = proc (x) ((makemult makemult) x)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in (times4 3)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>用这个程序里的小技巧写出PROC阶乘过程。提示：你可以使用<a href="#%28elem._curry%29" data-pltdoc="x">咖
            喱化</a>（<span class="EoplExerciseRef"></span>）定义双参数过程 <span class="stt">times</span>。
          <a name="(idx._(gentag._449))"></a>
          <a name="(idx._(gentag._450))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..24)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._451))"></a>
          <a name="(idx._(gentag._452))"></a>
          用上述程序里的小技巧写出<span class="EoplExerciseRef"></span> 中的互递归程序 <span class="stt">odd</span> 和 <span
            class="stt">even</span>。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..25)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._453))"></a>
          提炼上述练习中的技巧，用它在 PROC 中定义任意递归过程。考虑下面的代码：</p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let makerec = proc (f)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">               </span><span class="stt">let d = proc
                    (x)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                        </span><span class="stt">proc
                    (z) ((f (x x)) z)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">               </span><span class="stt">in proc (n) ((f
                    (d d)) n)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in let maketimes4 = proc (f)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                     </span><span class="stt">proc
                    (x)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                      </span><span class="stt">if
                    zero?(x)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                      </span><span class="stt">then
                    0</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                      </span><span class="stt">else
                    -((f -(x,1)), -4)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in let times4 = (makerec
                    maketimes4)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in (times4 3)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>证明它返回12。
          <a name="(idx._(gentag._454))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..26)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._455))"></a>
          <a name="(idx._(gentag._456))"></a>
          我们用数据结构表示过程时，在闭包中记录了整个环境。但是显然，我们只需要自由变量的
          绑定。修改过程的表示，只保留自由变量。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..27)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>给语言添加另一种过程 <span class="stt">traceproc</span>。<span class="stt">traceproc</span> 类似
          <span class="stt">proc</span>，但会在入口和
          出口处打印跟踪消息。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..28)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._457))"></a>
          <a name="(idx._(gentag._458))"></a>
          <a name="(idx._(gentag._459))"></a>
          <a name="(idx._(gentag._460))"></a>
          <a name="(idx._(gentag._461))"></a>
          <a name="(idx._(gentag._462))"></a>
          设计过程的另一种方法是<span class="emph">动态绑定</span> (<span class="emph">dynamic binding</span>)（或称<span
            class="emph">动态定界</span> (<span class="emph">dynamic
            scoping</span>)）：求值过程主体的环境由调用处的环境扩展而得。例如，在
        </p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let a = 3</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in let p = proc (x) -(x,a)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">       </span><span class="stt">a = 5</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in -(a, (p 2))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>中，过程主体内的 <span class="stt">a</span> 绑定到 5，而不是 3。修改语言，使用动态绑定。做两次，一次
          用过程表示法表示过程，一次用数据结构表示法。
          <a name="(idx._(gentag._463))"></a>
          <a name="(idx._(gentag._464))"></a>
          <a name="(idx._(gentag._465))"></a>
          <a name="(idx._(gentag._466))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..29)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>很不幸的是，使用动态绑定的程序很可能异常晦涩。例如，在词法绑定中，批量替换过程的
          绑定变量，决不会改变程序的行为：我们甚至可以像<a href="#%28part._s3..6%29" data-pltdoc="x">消除变量名</a>那样，删除所有变量，
          将它们替换为词法地址。但在动态绑定中，这种转换就危险了。</p>
        <p>例如，在动态绑定中，过程 <span class="stt">proc (z) a</span> 返回调用者环境中的变量 <span class="stt">a</span>。那么程序</p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let a = 3</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in let p = proc (z) a</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in let f = proc (x) (p
                    0)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">in let a = 5</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">         </span><span class="stt">in (f 2)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>返回 5，因为调用处 <span class="stt">a</span> 的值为 5。如果 <span class="stt">f</span> 的形参为 <span class="stt">a</span> 呢？
          <a name="(idx._(gentag._467))"></a>
          <a name="(idx._(gentag._468))"></a>
        </p>
      </blockquote>
      <h4>3.4<tt> </tt><a name="(part._s3..4)"></a>LETREC：支持递归过程的语言</h4>
      <p><a name="(idx._(gentag._469))"></a>
        <a name="(idx._(gentag._470))"></a>
        <a name="(idx._(gentag._471))"></a>
        现在我们来定义支持递归的新语言 LETREC。因为我们的语言只有单参数过程，所以我们降
        低难度，只让 <span class="stt">letrec</span> 表达式声明一个单参数过程，例如：
      </p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">letrec double (x)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">        </span><span class="stt">= if zero?(x) then 0
                  else -((double -(x,1)), -2)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">in (double 6)</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>递归声明的左边是递归过程的名字和绑定变量，<span class="stt">=</span> 右边是过程主体，其生成式为：</p>
      <blockquote class="Small">
        <p><span class="Iidentity">\begin{align*}\mathit{Expression} &::= <span class="stt">letrec </span><span
              class="Iidentity">\mathit{Identifier}</span><span class="stt"> (</span><span
              class="Iidentity">\mathit{Identifier}</span><span class="stt">) = </span><span
              class="Iidentity">\mathit{Expression}</span><span class="stt"> in </span><span
              class="Iidentity">\mathit{Expression}</span> \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">letrec-exp (p-name b-var p-body
              letrec-body)</span>}\end{align*}</span></p>
      </blockquote>
      <p><span class="stt">letrec</span> 表达式的值是其主体的值，在符合期望行为的环境中求出：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(letrec-exp </span><span
                    class="texMathInline">proc\mbox{-}name</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">bound\mbox{-}var</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">proc\mbox{-}body</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">letrec\mbox{-}body</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                    class="texMathInline">letrec\mbox{-}body</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(extend-env-rec
                  </span><span class="texMathInline">proc\mbox{-}name</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">bound\mbox{-}var</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">proc\mbox{-}body</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">\rho</span><span
                    class="stt">))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p><a name="(idx._(gentag._472))"></a>
          这里，我们给环境接口新增一个过程 <span class="stt">extend-env-rec</span>。但我们仍然得回答这个问题：
          <span class="stt">(extend-env-rec </span><span class="texMathInline">proc\mbox{-}name</span><span class="stt">
          </span><span class="texMathInline">bound\mbox{-}var</span><span class="stt">
          </span><span class="texMathInline">proc\mbox{-}body</span><span class="stt"> </span><span
            class="texMathInline">\rho</span><span class="stt">)</span> 的期望行为是什么？
        </p>
      </blockquote>
      <p><a name="(idx._(gentag._473))"></a>
        我们定义该环境的行为如下：设 <span class="texMathInline">\rho_1</span> 为 <span class="stt">(extend-env-rec</span><span
          class="stt">
        </span><span class="texMathInline">proc\mbox{-}name</span><span class="stt"> </span><span
          class="texMathInline">bound\mbox{-}var</span><span class="stt"> </span><span
          class="texMathInline">proc\mbox{-}body</span><span class="stt"> </span><span
          class="texMathInline">\rho</span><span class="stt">)</span> 产生的
        环境。那么 <span class="stt">(apply-env </span><span class="texMathInline">\rho_1</span><span class="stt">
        </span><span class="texMathInline">var</span><span class="stt">)</span> 应返回什么？</p>
      <ol>
        <li>
          <p>如果变量 <span class="texMathInline">var</span> 与 <span class="texMathInline">proc\mbox{-}name</span> 相同，那么
            <span class="stt">(apply-env</span><span class="stt">
            </span><span class="texMathInline">\rho_1</span><span class="stt"> </span><span
              class="texMathInline">var</span><span class="stt">)</span> 应返回一个闭包，其绑定变量为 <span
              class="texMathInline">bound\mbox{-}var</span>，主体为
            <span class="texMathInline">proc\mbox{-}body</span>，环境为绑定 <span
              class="texMathInline">proc\mbox{-}name</span> 时所在的环境。而我们已经
            有这个环境了：就是 <span class="texMathInline">\rho_1</span>！所以：
          </p>
          <blockquote class="EoplEquationInset">
            <table cellspacing="0" cellpadding="0" class="SVerbatim">
              <tr>
                <td>
                  <p><span class="stt">(apply-env </span><span class="texMathInline">\rho_1</span><span
                      class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                      class="texMathInline">proc\mbox{-}name</span><span class="stt">)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">= (proc-val (procedure </span><span
                      class="texMathInline">bound\mbox{-}var</span><span class="stt"></span><span
                      class="hspace"> </span><span class="stt"></span><span
                      class="texMathInline">proc\mbox{-}name</span><span class="stt"></span><span
                      class="hspace"> </span><span class="stt"></span><span class="texMathInline">\rho_1</span><span
                      class="stt">))</span></p>
                </td>
              </tr>
            </table>
          </blockquote>
        </li>
        <li>
          <p>如果 <span class="texMathInline">var</span> 与 <span class="texMathInline">proc\mbox{-}name</span> 不同，那么：</p>
          <blockquote class="EoplEquationInset">
            <table cellspacing="0" cellpadding="0" class="SVerbatim">
              <tr>
                <td>
                  <p><span class="stt">(apply-env </span><span class="texMathInline">\rho_1</span><span
                      class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                      class="texMathInline">var</span><span class="stt">) = (apply-env </span><span
                      class="texMathInline">\rho</span><span class="stt"></span><span class="hspace"> </span><span
                      class="stt"></span><span class="texMathInline">var</span><span class="stt">)</span></p>
                </td>
              </tr>
            </table>
          </blockquote>
        </li>
      </ol>
      <p><span class="EoplFigureRef"></span> 和 <span class="stt">fig-3.11</span> 展示了一个例子。
        <span class="EoplFigureRef"></span> 的最后一行递归调用 <span class="stt">double</span>，找出了原来的 <span
          class="stt">double</span>，
        正合所愿。
      </p>
      <p>满足这些要求的任何方法都能够用来实现 <span class="stt">extend-env-rec</span>。这里我们使用对应于抽象
        语法表示的方法。练习讨论了其他实现策略。</p>
      <p>如<span class="EoplFigureRef"></span>，在抽象语法表示中，我们为 <span class="stt">extend-env-rec</span> 新增一种变
        体。<span class="stt">apply-env</span> 倒数第二行的 <span class="stt">env</span> 对应上述 <span
          class="texMathInline">\rho_1</span>。
        <a name="(idx._(gentag._474))"></a>
      </p>
      <blockquote class="EoplFigure">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(value-of <<letrec double(x)=if zero?(x)</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">                               </span><span
                  class="stt">then 0</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">                               </span><span
                  class="stt">else -((double -(x,1)), -2)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">            </span><span class="stt">in (double 6)>>
                </span><span class="texMathInline">\rho_0</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of <<(double 6)>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(extend-env-rec double x
                  <<if zero?(x) ...>> </span><span class="texMathInline">\rho_0</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (apply-procedure</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of <<double>>
                    (extend-env-rec double x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">                           </span><span class="stt">
                  <<if zero?(x) ...>>
                </span><span class="texMathInline">\rho_0</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of <<6>>
                    (extend-env-rec double x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">                      </span><span class="stt">
                  <<if zero?(x) ...>>
                </span><span class="texMathInline">\rho_0</span><span class="stt">)))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (apply-procedure</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of <<double>>
                    (extend-env-rec double x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">                           </span><span class="stt">
                  <<if zero?(x) ...>>
                </span><span class="texMathInline">\rho_0</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                  class="texMathInline">\lceil</span><span class="stt">6</span><span
                  class="texMathInline">\rceil</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                  <<if zero?(x) ...>>
                </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">[x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">6</span><span
                  class="texMathInline">\rceil</span><span class="stt">](extend-env-rec</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">                   </span><span class="stt">double x <<if
                    zero?(x) ...>> </span><span class="texMathInline">\rho_0</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">...</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (-</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(value-of</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">
                  <<(double -(x,1))>>
                </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">[x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">6</span><span
                  class="texMathInline">\rceil</span><span class="stt">](extend-env-rec</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">                      </span><span class="stt">double x
                  <<if zero?(x) ...>> </span><span class="texMathInline">\rho_0</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">-2)</span></p>
            </td>
          </tr>
        </table>
        <blockquote class="caption">
          <p><span class="stt">extend-env-rec</span> 计算过程<a name="(elem._fig-3..10)"></a></p>
        </blockquote>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!ht]</div>
        <div class="SIntrapara">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(apply-procedure</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">
                    <<double>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">[x=</span><span
                    class="texMathInline">\lceil</span><span class="stt">6</span><span
                    class="texMathInline">\rceil</span><span class="stt">](extend-env-rec</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                      </span><span class="stt">double x
                    <<if zero?(x) ...>> </span><span class="texMathInline">\rho_0</span><span class="stt">))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">
                    <<(double -(x,1))>>
                  </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">[x=</span><span
                    class="texMathInline">\lceil</span><span class="stt">6</span><span
                    class="texMathInline">\rceil</span><span class="stt">](extend-env-rec</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">                      </span><span class="stt">double x
                    <<if zero?(x) ...>> </span><span class="texMathInline">\rho_0</span><span class="stt">)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">-2)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (-</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(apply-procedure</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(procedure x <<if
                      zero?(x) ...>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">        </span><span class="stt">(extend-env-rec double
                    x <<if zero?(x) ...>> </span><span class="texMathInline">\rho_0</span><span class="stt">))</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">      </span><span class="stt"></span><span
                    class="texMathInline">\lceil</span><span class="stt">5</span><span
                    class="texMathInline">\rceil</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">-2)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= ...</span></p>
              </td>
            </tr>
          </table>
        </div>
        </p>
        <blockquote class="caption">
          <p><span class="stt">extend-env-rec</span> 计算过程，续<a name="(elem._fig-3..11)"></a></p>
        </blockquote>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!ht]</div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define-datatype</span><span
                    class="hspace"> </span><span class="RktSym">environment</span><span class="hspace"> </span><span
                    class="RktSym">environment?</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">empty-env</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">extend-env</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                    class="hspace"> </span><span class="RktSym">identifier?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                    class="hspace"> </span><span class="RktSym">expval?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">env</span><span
                    class="hspace"> </span><span class="RktSym">environment?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">extend-env-rec</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">p-name</span><span
                    class="hspace"> </span><span class="RktSym">identifier?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">b-var</span><span
                    class="hspace"> </span><span class="RktSym">identifier?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">body</span><span
                    class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">env</span><span
                    class="hspace"> </span><span class="RktSym">environment?</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">apply-env</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">env</span><span
                    class="hspace"> </span><span class="RktSym">search-var</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">environment</span><span class="hspace"> </span><span
                    class="RktSym">env</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">empty-env</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">report-no-binding-found</span><span class="hspace"> </span><span
                    class="RktSym">search-var</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">extend-env</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">saved-var</span><span class="hspace"> </span><span
                    class="RktSym">saved-val</span><span class="hspace"> </span><span
                    class="RktSym">saved-env</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">eqv?</span><span
                    class="hspace"> </span><span class="RktSym">saved-var</span><span class="hspace"> </span><span
                    class="RktSym">search-var</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktSym">saved-val</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">apply-env</span><span class="hspace"> </span><span
                    class="RktSym">saved-env</span><span class="hspace"> </span><span
                    class="RktSym">search-var</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">extend-env-rec</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">p-name</span><span class="hspace"> </span><span class="RktSym">b-var</span><span
                    class="hspace"> </span><span class="RktSym">p-body</span><span class="hspace"> </span><span
                    class="RktSym">saved-env</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">eqv?</span><span
                    class="hspace"> </span><span class="RktSym">search-var</span><span class="hspace"> </span><span
                    class="RktSym">p-name</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">proc-val</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">procedure</span><span class="hspace"> </span><span class="RktSym">b-var</span><span
                    class="hspace"> </span><span class="RktSym">p-body</span><span class="hspace"> </span><span
                    class="RktSym">env</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">apply-env</span><span class="hspace"> </span><span
                    class="RktSym">saved-env</span><span class="hspace"> </span><span
                    class="RktSym">search-var</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <blockquote class="caption">
          <p>向环境添加 <span class="stt">extend-env-rec</span><a name="(elem._fig-3..12)"></a></p>
        </blockquote>
      </blockquote>
      <p><a name="(idx._(gentag._475))"></a>
        <a name="(idx._(gentag._476))"></a>
        <a name="(idx._(gentag._477))"></a>
        <a name="(idx._(gentag._478))"></a>
      </p>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..30)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><span class="stt">apply-env</span> 倒数第二行调用 <span class="stt">proc-val</span> 的目的是什么？
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..31)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._479))"></a>
          扩展上面的语言，允许声明任意数量参数的过程，像<span class="EoplExerciseRef"></span> 那样。
          <a name="(idx._(gentag._480))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..32)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._481))"></a>
          <a name="(idx._(gentag._482))"></a>
          <a name="(idx._(gentag._483))"></a>
          扩展上面的语言，允许声明任意数量的单参数互递归过程，例如：
        </p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">letrec</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">even(x) = if zero?(x) then 1
                    else (odd -(x,1))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">odd(x)</span><span
                    class="hspace">  </span><span class="stt">= if zero?(x) then 0 else (even -(x,1))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in (odd 13)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..33)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._484))"></a>
          扩展上面的语言，允许声明任意数量的互递归过程，每个过程的参数数量也任意，就
          像<span class="EoplExerciseRef"></span> 那样。
          <a name="(idx._(gentag._485))"></a>
          <a name="(idx._(gentag._486))"></a>
          <a name="(idx._(gentag._487))"></a>
          <a name="(idx._(gentag._488))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..34)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._489))"></a>
          <a name="(idx._(gentag._490))"></a>
          用<a href="da.html#%28part._s2..2..3%29" data-pltdoc="x">过程表示法</a>中环境的过程表示法实现 <span
            class="stt">extend-env-rec</span>。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..35)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._491))"></a>
          <a name="(idx._(gentag._492))"></a>
          目前为止，我们看到的表示法都很低效，因为每次查找过程时，它们都要新创建一个闭包，
          但每次的闭包都相同。我们可以只创建一次闭包，把值放入长度为 1 的向量，再将其放入
          一个显式循环结构中，像这样：
        </p>
        <blockquote class="SCentered">
          <p><img src="vector-env.svg" alt="vector环境" width="799.2pt" height="174.6pt" /></p>
        </blockquote>
        <p>这里是创建这种数据结构的代码：</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">extend-env-rec</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">p-names</span><span
                    class="hspace"> </span><span class="RktSym">b-vars</span><span class="hspace"> </span><span
                    class="RktSym">bodies</span><span class="hspace"> </span><span class="RktSym">saved-env</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">vec</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">make-vector</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">length</span><span class="hspace"> </span><span class="RktSym">p-names</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">new-env</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">extend-env</span><span class="hspace"> </span><span
                    class="RktSym">p-names</span><span class="hspace"> </span><span class="RktSym">vec</span><span
                    class="hspace"> </span><span class="RktSym">saved-env</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">vector-set!</span><span class="hspace"> </span><span class="RktSym">vec</span><span
                    class="hspace"> </span><span class="RktVal">0</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">proc-val</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">procedure</span><span class="hspace"> </span><span class="RktSym">b-var</span><span
                    class="hspace"> </span><span class="RktSym">body</span><span class="hspace"> </span><span
                    class="RktSym">new-env</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktSym">new-env</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>修改环境数据类型和 <span class="stt">apply-env</span> 的定义，完成这种表示的实现。确保
          <span class="stt">apply-env</span> 总是返回表达值。
          <a name="(idx._(gentag._493))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..36)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._494))"></a>
          <a name="(idx._(gentag._495))"></a>
          <a name="(idx._(gentag._496))"></a>
          扩展这种实现，处理<span class="EoplExerciseRef"></span> 中的语言。
          <a name="(idx._(gentag._497))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..37)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._498))"></a>
          <a name="(idx._(gentag._499))"></a>
          <a name="(idx._(gentag._500))"></a>
          <a name="(idx._(gentag._501))"></a>
          使用动态绑定（<span class="EoplExerciseRef"></span>），不需要任何特殊机制，靠 <span class="stt">let</span> 就能创建
          递归过程。这是出于历史兴趣。在早年的编程语言设计中，<a href="#%28part._s3..4%29" data-pltdoc="x">LETREC：支持递归过程的语言</a>讨论的那些方法
          还鲜为人知。要验证动态绑定实现的递归，试试程序：
        </p>
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let fact = proc (n) add1(n)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in let fact = proc (n)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">               </span><span class="stt">if
                    zero?(n)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">               </span><span class="stt">then 1</span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">               </span><span class="stt">else *(n, (fact
                    -(n,1)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in (fact 5)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>试试词法绑定，再试试动态绑定。用动态绑定的被定语言写出<a href="#%28part._s3..4%29" data-pltdoc="x">LETREC：支持递归过程的语言</a>中的互递归过
          程 <span class="stt">even</span> 和 <span class="stt">odd</span>。
          <a name="(idx._(gentag._502))"></a>
          <a name="(idx._(gentag._503))"></a>
          <a name="(idx._(gentag._504))"></a>
          <a name="(idx._(gentag._505))"></a>
          <a name="(idx._(gentag._506))"></a>
          <a name="(idx._(gentag._507))"></a>
          <a name="(idx._(gentag._508))"></a>
        </p>
      </blockquote>
      <h4>3.5<tt> </tt><a name="(part._s3..5)"></a>定界和变量绑定</h4>
      <p><a name="(idx._(gentag._509))"></a>
        <a name="(idx._(gentag._510))"></a>
        <a name="(idx._(gentag._511))"></a>
        <a name="(idx._(gentag._512))"></a>
        <a name="(idx._(gentag._513))"></a>
        我们已经在很多地方见到过变量的声明和使用，现在我们来系统讨论这些思想。
      </p>
      <p>在大多数编程语言中，变量只能以两种方式出现：<span class="emph">引用</span> (<span class="emph">reference</span>)
        或<span class="emph">声明</span> (<span class="emph">declaration</span>)。变量引用就是使用变量。例如，在 Scheme 表达式</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">f</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">x</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktSym">y</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>中出现的变量 <span class="stt">f</span>、<span class="stt">x</span> 和 <span class="stt">y</span> 均为引用。但在</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                    class="RktSym">x</span><span class="RktPn">)</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                    class="RktSym">+</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">x</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktVal">3</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>或</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">let</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                    class="RktPn">(</span><span class="RktSym">x</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktPn">(</span><span
                    class="RktSym">+</span><span class="RktMeta"></span><span class="hspace"> </span><span
                    class="RktMeta"></span><span class="RktSym">y</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktVal">7</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktPn">(</span><span class="RktSym">+</span><span class="RktMeta"></span><span
                    class="hspace"> </span><span class="RktMeta"></span><span class="RktSym">x</span><span
                    class="RktMeta"></span><span class="hspace"> </span><span class="RktMeta"></span><span
                    class="RktVal">3</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktMeta"></span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>中，第一个出现的 <span class="stt">x</span> 是声明：引入一个变量，作为某个值的名字。在 <span class="stt">lambda</span>
          表达式中，变量的值在过程调用时提供。在 <span class="stt">let</span> 表达式中，变量的值由表达式
          <span class="stt">(+ y z)</span> 求得。
        </p>
      </blockquote>
      <p>我们说变量引用由对应的声明<span class="emph">绑定</span> (<span class="emph">bound</span>)，且<span class="emph">绑定</span>到它的值。
        在<a href="isd.html#%28part._s1..2..4%29" data-pltdoc="x"><span
            class="stt">occurs-free?</span></a>，我们已经见过用声明绑定变量的例子。</p>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!t]</div>
        <div class="SIntrapara">
          <blockquote class="SCentered">
            <p><img src="simple-contour.svg" alt="简单等深线" width="535.5pt" height="198.0pt" /></p>
          </blockquote>
        </div>
        </p>
        <blockquote class="caption">
          <p>简单等深线<a name="(elem._fig-3..13)"></a></p>
        </blockquote>
      </blockquote>
      <p>大多数编程语言中的声明都有有限的作用域，所以同一个变量名在程序的不同部分可用于不
        同的目的。例如，我们反复把 <span class="stt">lst</span> 用作绑定变量，它的作用域每次都限制在对应的
        <span class="stt">lambda</span> 表达式主体内。
      </p>
      <p>每种编程语言都有一些规则来判断各个变量引用指代哪一声明。这些规则通常
        叫做<span class="emph">定界</span> (<span class="emph">scoping</span>) 规则。声明在程序中生效的部分叫做声明
        的<span class="emph">作用域</span> (<span class="emph">scope</span>)。</p>
      <p>我们可以不加执行地判断程序中的各个变量引用对应于哪个声明。这样的性质不必执行程序
        就能计算出来，名为<span class="emph">静态</span> (<span class="emph">static</span>) 性质。
        <a name="(idx._(gentag._514))"></a>
      </p>
      <p>要找出某个变量引用对应于哪一声明，我们<span class="emph">向外</span> (<span class="emph">outward</span>) 查找，直到找
        出变量的声明。这里是一个简单的 Scheme 示例。</p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(let ((x 3)</span><span class="hspace">              </span><span
                  class="stt"></span><span class="emph">称之为 <span class="stt">x1</span></span><span class="stt"></span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(y 4))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(+ (let ((x</span><span
                  class="hspace">            </span><span class="stt"></span><span class="emph">称之为 <span
                    class="stt">x2</span></span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">             </span><span class="stt">(+ y 5)))</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">(* x y))</span><span
                  class="hspace">          </span><span class="stt"></span><span class="emph">这个 <span
                    class="stt">x</span> 指代 <span class="stt">x2</span></span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">     </span><span class="stt">x))</span><span
                  class="hspace">                 </span><span class="stt"></span><span class="emph">这个 <span
                    class="stt">x</span> 指代 <span class="stt">x1</span></span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>在这个例子中，内层的 <span class="stt">x</span> 绑定到 9，所以表达式的值为</p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(let ((x 3)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(y 4))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(+ (let ((x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">             </span><span class="stt">(+ y 5)))</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">(* x y))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">     </span><span class="stt">x))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (+ (let ((x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">             </span><span class="stt">(+ 4 5)))</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">(* x 4))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">     </span><span class="stt">3)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (+ (let ((x 9))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">(* x 4))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">     </span><span class="stt">3)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (+ 36</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">     </span><span class="stt">3)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= 39</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p><a name="(idx._(gentag._515))"></a>
        这样的定界规则叫做<span class="emph">词法定界</span> (<span class="emph">lexical scoping</span>) 规则，这样声明的变量
        叫做<span class="emph">词法变量</span> (<span class="emph">lexical variable</span>)。
        <a name="(idx._(gentag._516))"></a>
        <a name="(idx._(gentag._517))"></a>
      </p>
      <p>使用词法定界，我们可以重新声明一个变量，给作用域戳个“洞
        ”。这样的内层声明<span class="emph">遮蔽</span> (<span class="emph">shadow</span>) <a name="(idx._(gentag._518))"></a>
        <a name="(idx._(gentag._519))"></a>
        外层声明。 例如，在上例的乘式 <span class="stt">(* x y)</span> 中，内层的 <span class="stt">x</span> 遮蔽了外层的。
      </p>
      <p><a name="(idx._(gentag._520))"></a>
        词法作用域是嵌套式的：每个作用域完全包裹在另一个里面。我们用<span class="emph">等深线</span> (<span class="emph">contour
          diagram</span>) 解释这点。<span class="EoplFigureRef"></span> 展示了上例的等深线。每个作用域
        用一个框圈起来，箭头连接声明与其作用域。</p>
      <p><span class="EoplFigureRef"></span> 展示了一个更复杂的程序和它的等深线。其中的第 5 行、第 7 行
        和第 8 行，表达式 <span class="stt">(+ x y z)</span> 出现了三次。第 5 行在 <span class="stt">x2</span> 和 <span
          class="stt">z2</span> 的作用
        域内，<span class="stt">x2</span> 和 <span class="stt">z2</span> 的作用域在 <span class="stt">z1</span> 的作用域内，<span
          class="stt">z1</span> 的作用域在
        <span class="stt">x1</span> 和 <span class="stt">y1</span> 的作用域内。所以，第5行的 <span class="stt">x</span> 指代 <span
          class="stt">x2</span>，<span class="stt">y</span> 指代
        <span class="stt">y1</span>，<span class="stt">z</span> 指代 <span class="stt">z2</span>。第 7 行在 <span
          class="stt">x4</span> 和 <span class="stt">y2</span> 的作用域内，<span class="stt">x4</span>
        和<span class="stt">y2</span> 的作用域在 <span class="stt">x2</span> 和 <span class="stt">z2</span> 的作用域内，<span
          class="stt">x2</span> 和 <span class="stt">z2</span> 的作用域
        在<span class="stt">z1</span> 的作用域内，<span class="stt">z1</span> 的作用域在 <span class="stt">x1</span> 和 <span
          class="stt">y1</span> 的作用域内。所以，第
        7行的 <span class="stt">x</span> 指代 <span class="stt">x4</span>，<span class="stt">y</span> 指代 <span
          class="stt">y2</span>，<span class="stt">z</span> 指代 <span class="stt">z2</span>。最后，第 8
        行在 <span class="stt">x3</span> 的作用域内，<span class="stt">x3</span> 的作用域在 <span class="stt">x2</span> 和 <span
          class="stt">z2</span> 的作用域内，
        <span class="stt">x2</span> 和 <span class="stt">z2</span> 的作用域在 <span class="stt">z1</span> 的作用域内，<span
          class="stt">z1</span> 的作用域在 <span class="stt">x1</span> 和
        <span class="stt">y1</span> 的作用域内。所以，第8行的 <span class="stt">x</span> 指代 <span class="stt">x3</span>，<span
          class="stt">y</span> 指代 <span class="stt">y1</span>，
        <span class="stt">z</span> 指代<span class="stt">z2</span>。
      </p>
      <blockquote class="EoplFigure">
        <blockquote class="SCentered">
          <p><img src="complicated-contour.svg" alt="较复杂的等深线" width="598.5pt" height="213.0pt" /></p>
        </blockquote>
        <blockquote class="caption">
          <p>较复杂的等深线<a name="(elem._fig-3..14)"></a></p>
        </blockquote>
      </blockquote>
      <p>变量与值的对应关系叫做<span class="emph">绑定</span> (<span class="emph">binding</span>)。我们可以通过规范来理解如何创
        建绑定。</p>
      <p><a name="(idx._(gentag._521))"></a>
        <a name="(idx._(gentag._522))"></a>
        由 <span class="stt">proc</span> 声明的变量在过程调用时绑定。
      </p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(apply-procedure (procedure </span><span class="texMathInline">var</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">body</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">\rho</span><span class="stt">) </span><span
                  class="texMathInline">val</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of </span><span class="texMathInline">body</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt">(extend-env </span><span
                  class="texMathInline">var</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">val</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt"></span><span class="texMathInline">\rho</span><span
                  class="stt">))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p><a name="(idx._(gentag._523))"></a>
        <a name="(idx._(gentag._524))"></a>
        <span class="stt">let</span> 声明的变量绑定到声明右边的值。
      </p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(value-of (let-exp </span><span class="texMathInline">var</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">val</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">body</span><span class="stt">) </span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of </span><span class="texMathInline">body</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt">(extend-env </span><span
                  class="texMathInline">var</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">val</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt"></span><span class="texMathInline">\rho</span><span
                  class="stt">))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p><a name="(idx._(gentag._525))"></a>
        <a name="(idx._(gentag._526))"></a>
        <span class="stt">letrec</span> 声明的变量也要绑定到声明右边的值。
      </p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(value-of</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(letrec-exp </span><span
                  class="texMathInline">proc\mbox{-}name</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">bound\mbox{-}var</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">proc\mbox{-}body</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">letrec\mbox{-}body</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                  class="texMathInline">letrec\mbox{-}body</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(extend-env-rec </span><span
                  class="texMathInline">proc\mbox{-}name</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">bound\mbox{-}var</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">proc\mbox{-}body</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt"></span><span class="texMathInline">\rho</span><span
                  class="stt">))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p><a name="(idx._(gentag._527))"></a>
        <a name="(idx._(gentag._528))"></a>
        <a name="(idx._(gentag._529))"></a>
        <a name="(idx._(gentag._530))"></a>
        <a name="(idx._(gentag._531))"></a>
        绑定的<span class="emph">期限</span> (<span class="emph">extent</span>) 指绑定保持的时长。在我们的语言中，就像在
        Scheme 中一样，所有的绑定都是<span class="emph">半无限</span> (<span class="emph">semi-infinite</span>) 的，意思是变量
        一旦绑定，该绑定就要（至少是有可能）无限期地保留。这是因为绑定可能隐藏在已返回的
        闭包之中。在半无限的语言中，垃圾回收器收集不能再访问的绑定。这只能在运行时判定，
        因此我们说这是一条<span class="emph">动态</span> (<span class="emph">dynamic</span>) 性质。
      </p>
      <p>很可惜的是，“动态”有时表示“在表达式求
        值期间”，有时又表示“无法事先计算”。如
        果我们不允许 <span class="stt">let</span> 的值为过程，那么 let 绑定会在 <span class="stt">let</span> 主体求值结束时到期。
        这叫做<span class="emph">动态</span>期限，而它是一条<span class="emph">静态</span>性质。
        <a name="(idx._(gentag._532))"></a>
        因为这种期限是一条静态性质，所以我们可以准确预测绑定何时可以抛弃。
        <span class="stt">ex3.28</span> 等几道练习中的动态绑定表现类似。
        <a name="(idx._(gentag._533))"></a>
        <a name="(idx._(gentag._534))"></a>
        <a name="(idx._(gentag._535))"></a>
        <a name="(idx._(gentag._536))"></a>
        <a name="(idx._(gentag._537))"></a>
        <a name="(idx._(gentag._538))"></a>
      </p>
      <h4>3.6<tt> </tt><a name="(part._s3..6)"></a>消除变量名</h4>
      <p><a name="(idx._(gentag._539))"></a>
        <a name="(idx._(gentag._540))"></a>
        <a name="(idx._(gentag._541))"></a>
        <a name="(idx._(gentag._542))"></a>
        <a name="(idx._(gentag._543))"></a>
        定界算法的执行过程可以看作始自变量引用的外出旅行。在旅途中，到达对应的声明之前可
        能会跨越多条等深线。跨越的等深线数目叫做变量引用的<span class="emph">词深</span> (<span class="emph">lexical
          depth</span>)（或<span class="emph">静深</span> (<span class="emph">static depth</span>)）。由于惯用“从0开始的
        索引”，所以不计最后跨过的等深线。例如，在 Scheme 表达式
      </p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">x</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">a</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">     </span><span class="RktPn">(</span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktSym">a</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktSym">x</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>中，最后一行 <span class="stt">x</span> 的引用以及 <span class="stt">a</span> 的引用词深均为 0，而第三行 <span class="stt">x</span>
          的引用词
          深为 1。</p>
      </blockquote>
      <p>因此，我们可以完全消除变量名，写成这样</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(nameless-lambda</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">((nameless-lambda</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">     </span><span class="stt">(#1 #0))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">#0))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>这里，每个 <span class="stt">nameless-lambda</span> 都声明了一个新的无名变量，每个变量引用由其词深替
          代；这个数字准确标示了要使用的声明。这些数字叫做<span class="emph">词法地址</span> (<span class="emph">lexical
            address</span>) 或<span class="emph">德布鲁金索引</span> (<span class="emph">de Bruijn index</span>)。编译器例行计算每个变量
          引用的词法地址。除非用来提供调试信息，计算一旦完成，变量名即可丢弃。</p>
      </blockquote>
      <p>这样记录信息有用，因为词法地址<span class="emph">预测</span>了怎样从环境中找出某个变量。</p>
      <p>考虑我们语言中的表达式</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let x = </span><span class="texMathInline">exp_1</span><span class="stt"></span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in let y = </span><span class="texMathInline">exp_2</span><span class="stt"></span>
                </p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in -(x,y)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>在差值表达式中，<span class="stt">y</span> 和 <span class="stt">x</span> 的词深分别为0和1。</p>
      </blockquote>
      <p>现在假设在某个适当环境中求得 <span class="texMathInline">exp_1</span> 和 <span class="texMathInline">exp_2</span> 的值，分别为 <span
          class="texMathInline">val_1</span> 和
        <span class="texMathInline">val_2</span>，那么这个表达式的值为
      </p>
      <blockquote class="SubFlow">
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<let x=</span><span class="texMathInline">exp_1</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">in let y = </span><span
                    class="texMathInline">exp_2</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">       </span><span class="stt">in -(x,y)>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                    class="texMathInline">\rho</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">=</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                    <<let y=</span><span class="texMathInline">exp_2</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">in -(x,y)>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">[x=</span><span
                    class="texMathInline">val_1</span><span class="stt">]</span><span
                    class="texMathInline">\rho</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">=</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(value-of</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt"><<-(x,y)>></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">[y=</span><span
                    class="texMathInline">val_2</span><span class="stt">][x=</span><span
                    class="texMathInline">val_1</span><span class="stt">]</span><span
                    class="texMathInline">\rho</span><span class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>所以，求差值表达式的值时，<span class="stt">y</span> 深度为 0，<span class="stt">x</span> 深度为 1，正如词深预测的那样。</p>
      </blockquote>
      <p>如果用关联列表表示环境（见<span class="EoplExerciseRef"></span>），那么环境看起来像是</p>
      <blockquote class="SubFlow">
        <blockquote class="SCentered">
          <p><img src="lexical-addr-env.svg" alt="关联列表表示的词法地址环境" width="289.8pt" height="165.6pt" /></p>
        </blockquote>
        <p>所以不论 <span class="texMathInline">val_1</span> 和 <span class="texMathInline">val_2</span> 值为何，<span
            class="stt">x</span> 和 <span class="stt">y</span> 的值都是取环境中第 1 个
          元素的余项和第 0 个元素的余项。</p>
      </blockquote>
      <p>过程的主体也是这样。考虑</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let a = 5</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in proc (x) -(x,1)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>在过程的主体中，<span class="stt">x</span> 的词深是 0，<span class="stt">a</span> 的词深是 1。</p>
      </blockquote>
      <p>这个表达式的值为：</p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(value-of</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt">
                  <<let a=5 in proc (x) -(x,a)>>
                </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of <<proc (x) -(x,a)>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(extend-env a </span><span
                  class="texMathInline">\lceil</span><span class="stt">5</span><span
                  class="texMathInline">\rceil</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">\rho</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (proc-val (procedure x <<-(x,a)>> [a=</span><span
                  class="texMathInline">\lceil</span><span class="stt">5</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>这个过程的主体只能通过 <span class="stt">apply-procedure</span> 求值：</p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(apply-procedure</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(procedure x <<-(x,a)>>
                    [a=</span><span class="texMathInline">\lceil</span><span class="stt">5</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">  </span><span class="stt"></span><span
                  class="texMathInline">\lceil</span><span class="stt">7</span><span
                  class="texMathInline">\rceil</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of <<-(x,a)>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">[x=</span><span
                  class="texMathInline">\lceil</span><span class="stt">7</span><span
                  class="texMathInline">\rceil</span><span class="stt">][a=</span><span
                  class="texMathInline">\lceil</span><span class="stt">5</span><span
                  class="texMathInline">\rceil</span><span class="stt">]</span><span
                  class="texMathInline">\rho</span><span class="stt">)</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>每个变量又一次出现在词深预测的环境位置。
        <a name="(idx._(gentag._544))"></a>
        <a name="(idx._(gentag._545))"></a>
      </p>
      <h4>3.7<tt> </tt><a name="(part._s3..7)"></a>实现词法地址</h4>
      <p><a name="(idx._(gentag._546))"></a>
        现在，我们来实现上述词法地址分析。我们写出过程 <span class="stt">translation-of-program</span>，它取
        一程序，从声明中移除所有变量，并将每个变量引用替换为词深。</p>
      <p>例如，程序</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><a name="(elem._s3..7-eg)"></a><span class="stt">let x = 37</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in proc (y)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">let z = -(y,x)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">in -(x,y)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>将翻译为</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktVal">#</span><span class="RktVal">(</span><span
                    class="RktVal">struct:a-program</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktVal">#</span><span class="RktVal">(</span><span
                    class="RktVal">struct:nameless-let-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktVal">#</span><span class="RktVal">(</span><span
                    class="RktVal">struct:const-exp</span><span class="hspace"> </span><span
                    class="RktVal">37</span><span class="RktVal">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktVal">#</span><span class="RktVal">(</span><span
                    class="RktVal">struct:nameless-proc-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">         </span><span class="RktVal">#</span><span class="RktVal">(</span><span
                    class="RktVal">struct:nameless-let-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">            </span><span class="RktVal">#</span><span
                    class="RktVal">(</span><span class="RktVal">struct:diff-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">               </span><span class="RktVal">#</span><span
                    class="RktVal">(</span><span class="RktVal">struct:nameless-var-exp</span><span
                    class="hspace"> </span><span class="RktVal">0</span><span class="RktVal">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">               </span><span class="RktVal">#</span><span
                    class="RktVal">(</span><span class="RktVal">struct:nameless-var-exp</span><span
                    class="hspace"> </span><span class="RktVal">1</span><span class="RktVal">)</span><span
                    class="RktVal">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">            </span><span class="RktVal">#</span><span
                    class="RktVal">(</span><span class="RktVal">struct:diff-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">               </span><span class="RktVal">#</span><span
                    class="RktVal">(</span><span class="RktVal">struct:nameless-var-exp</span><span
                    class="hspace"> </span><span class="RktVal">2</span><span class="RktVal">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">               </span><span class="RktVal">#</span><span
                    class="RktVal">(</span><span class="RktVal">struct:nameless-var-exp</span><span
                    class="hspace"> </span><span class="RktVal">1</span><span class="RktVal">)</span><span
                    class="RktVal">)</span><span class="RktVal">)</span><span class="RktVal">)</span><span
                    class="RktVal">)</span><span class="RktVal">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>然后，我们写出新版的 <span class="stt">value-of-program</span> 来求无名程序的值，它不需要把变量放入
          环境中。</p>
      </blockquote>
      <h5>3.7.1<tt> </tt><a name="(part._s3..7..1)"></a>翻译器</h5>
      <p>因为是写翻译器，我们得知道源语言和目标语言。目标语言中的某些部分源语言中没有，例
        如 <span class="stt">nameless-var-exp</span> 和 <span class="stt">nameless-let-exp</span>；源语言中的某些部分目标语言中
        没有，它们由后者中的对应结构取代，例如 <span class="stt">var-exp</span> 和 <span class="stt">let-exp</span>。</p>
      <p>我们可以为每种语言写一个 <span class="stt">define-datatype</span>，也可以让二者共用一个。因为我们使
        用的前端是 SLLGEN，后者更容易。我们给 SLLGEN 的语法添加生成式：</p>
      <p><span class="Iidentity">\begin{align*}\mathit{Expression} &::= <span class="stt">%lexref </span><span
            class="Iidentity">\mathit{number}</span> \\[-3pt]
          &\mathrel{\phantom{::=}} \fbox{<span class="stt">nameless-var-exp (num)</span>} \\[5pt]
          \mathit{Expression} &::= <span class="stt">%let </span><span class="Iidentity">\mathit{Expression}</span><span
            class="stt"> in </span><span class="Iidentity">\mathit{Expression}</span> \\[-3pt]
          &\mathrel{\phantom{::=}} \fbox{<span class="stt">nameless-let-exp (exp1 body)</span>} \\[5pt]
          \mathit{Expression} &::= <span class="stt">%lexproc </span><span class="Iidentity">\mathit{Expression}</span>
          \\[-3pt]
          &\mathrel{\phantom{::=}} \fbox{<span class="stt">nameless-proc-exp (body)</span>}\end{align*}</span></p>
      <p>新的构造器名字用 <span class="stt">%</span> 开头，因为在我们的语言中，<span class="stt">%</span> 通常是注释字符。</p>
      <p>我们的翻译器将拒绝任何含有无名结构（<span class="stt">nameless-var-exp</span>、<span class="stt">nameless-let-exp</span>
        或 <span class="stt">nameless-proc-exp</span>）的程序。我们的解释器将拒绝任何含有原先具名结构
        （<span class="stt">var-exp</span>、<span class="stt">let-exp</span> 或 <span
          class="stt">proc-exp</span>）的程序，因为它们理应被替换。</p>
      <p>要计算任何变量引用的词法地址，我们需要它所在的作用域。这是一种<span class="emph">上下文</span> (<span class="emph">context</span>) 信息，所以它和<a
          href="isd.html#%28part._s1..3%29" data-pltdoc="x">辅助过程和上下文参数</a>的继承属性类似。</p>
      <p><a name="(idx._(gentag._547))"></a>
        <a name="(idx._(gentag._548))"></a>
        所以 <span class="stt">translation-of-program</span> 将取两个参数：一个表达式和一个<span class="emph">静态环境</span> (<span
          class="emph">static
          environment</span>)。静态环境是一个变量列表，表示当前表达式所在的作用域。最
        内部作用域声明的变量成为列表的第一个元素。
      </p>
      <p>例如，翻译上例中的最后一行时，静态环境为：</p>
      <blockquote class="SubFlow">
        <blockquote class="SCentered">
          <p><span class="stt">(z y x)</span></p>
        </blockquote>
        <p>所以，在静态环境中搜索变量就是查找它在静态环境中的位置，也就是词法地址：查得
          <span class="stt">x</span> 为 2，<span class="stt">y</span> 为 1，<span class="stt">z</span> 为 0。
        </p>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!t]
        </div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="texMathInline">\mathit{Senv}</span> = <span
                    class="texMathInline">\mathit{Listof}</span><span class="stt">(</span><span
                    class="texMathInline">\mathit{Sym}</span><span class="stt">)</span></td>
              </tr>
              <tr>
                <td><span class="texMathInline">\mathit{Lexaddr}</span> = <span class="texMathInline">\mathit{N}</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">empty-senv</span></span> : <span
                    class="texMathInline">\mathit{()} \to \mathit{Senv}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">empty-senv</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktVal">'</span><span class="RktVal">(</span><span
                    class="RktVal">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">extend-senv</span></span> : <span
                    class="texMathInline">\mathit{Var} \times \mathit{Senv} \to \mathit{Senv}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">extend-senv</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                    class="hspace"> </span><span class="RktSym">senv</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cons</span><span
                    class="hspace"> </span><span class="RktSym">var</span><span class="hspace"> </span><span
                    class="RktSym">senv</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">apply-senv</span></span> : <span
                    class="texMathInline">\mathit{Senv} \times \mathit{Var} \to \mathit{Lexaddr}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">apply-senv</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">senv</span><span
                    class="hspace"> </span><span class="RktSym">var</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cond</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">null?</span><span class="hspace"> </span><span class="RktSym">senv</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">       </span><span class="RktPn">(</span><span
                    class="RktSym">report-no-binding-found</span><span class="hspace"> </span><span
                    class="RktSym">var</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">eqv?</span><span class="hspace"> </span><span class="RktSym">var</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">car</span><span
                    class="hspace"> </span><span class="RktSym">senv</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">       </span><span class="RktVal">0</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">else</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">+</span><span
                    class="hspace"> </span><span class="RktVal">1</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">apply-senv</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">cdr</span><span class="hspace"> </span><span
                    class="RktSym">senv</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="RktSym">var</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <blockquote class="caption">
          <p>实现静态环境<a name="(elem._fig-3..15)"></a></p>
        </blockquote>
      </blockquote>
      <p>进入新的作用域就要给静态环境添加一个新元素。我们添加过程 <span class="stt">extend-senv</span> 来完成
        这一步。</p>
      <p>由于静态环境只是变量列表，这些过程很容易实现，如<span class="EoplFigureRef"></span> 所示。</p>
      <p>翻译器有两个过程：<span class="stt">translation-of</span> 处理表达式，<span class="stt">translation-of-program</span> 处
        理程序。</p>
      <p><span class="stt">senv</span> 表示一些声明，我们从中翻译表达式 <span class="stt">e</span>。要完成这点，我们像<span
          class="EoplExerciseRef"></span> 或
        <span class="stt">ex2.26</span> 那样递归复制语法树，除了<br />
      </p>
      <blockquote class="SubFlow">
        <ol>
          <li>
            <p>调用 <span class="stt">apply-senv</span>，用正确的词法地址，把每个 <span class="stt">var-exp</span> 替换为
              <span class="stt">nameless-var-exp</span>。
            </p>
          </li>
          <li>
            <p>把每个 <span class="stt">let-exp</span> 替换为一个 <span class="stt">nameless-let-exp</span>。新表达式的右侧由旧
              表达式的右侧译得。它与原式的作用域相同，所以我们在同样的静态环境 <span class="stt">senv</span> 中翻
              译它。新表达式的主体由旧表达式的主体译得。但是主体位于新的作用域内，多了一个绑
              定变量 <span class="texMathInline">var</span>。所以我们在静态环境 <span class="stt">(extend-senv </span><span
                class="texMathInline">var</span><span class="stt"> </span><span class="texMathInline">senv</span><span
                class="stt">)</span> 中翻译主
              体。</p>
          </li>
          <li>
            <p>把每个 <span class="stt">proc-exp</span> 替换为一个 <span class="stt">nameless-proc-exp</span>，主体在新的作用域
              内译得，该作用域由静态环境 <span class="stt">(extend-senv </span><span class="texMathInline">var</span><span
                class="stt"> senv)</span> 表示。</p>
          </li>
        </ol>
        <p><span class="stt">translation-of</span> 代码如<span class="EoplFigureRef"></span> 所示。</p>
      </blockquote>
      <p>过程 <span class="stt">translation-of-program</span> 在适当的初始静态环境中执行 <span class="stt">translation-of</span>。
        <a name="(idx._(gentag._549))"></a>
        <a name="(idx._(gentag._550))"></a>
      </p>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">translation-of</span></span> : <span
                  class="texMathInline">\mathit{Exp} \times \mathit{Senv} \to \mathit{Nameless\mbox{-}exp}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">translation-of</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                  class="hspace"> </span><span class="RktSym">senv</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                  class="RktSym">exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">const-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">num</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">const-exp</span><span class="hspace"> </span><span class="RktSym">num</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">diff-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">diff-exp</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">translation-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">senv</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">translation-of</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">senv</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">zero?-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">zero?-exp</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">translation-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">senv</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">if-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">exp2</span><span class="hspace"> </span><span
                  class="RktSym">exp3</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">if-exp</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">translation-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">senv</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">translation-of</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">senv</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">translation-of</span><span class="hspace"> </span><span class="RktSym">exp3</span><span
                  class="hspace"> </span><span class="RktSym">senv</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">var-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">nameless-var-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">apply-senv</span><span class="hspace"> </span><span class="RktSym">senv</span><span
                  class="hspace"> </span><span class="RktSym">var</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">let-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">exp1</span><span class="hspace"> </span><span
                  class="RktSym">body</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">nameless-let-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">translation-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">senv</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">translation-of</span><span class="hspace"> </span><span class="RktSym">body</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">extend-senv</span><span class="hspace"> </span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">senv</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">nameless-proc-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">translation-of</span><span class="hspace"> </span><span class="RktSym">body</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">extend-senv</span><span class="hspace"> </span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">senv</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">call-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">rator</span><span class="hspace"> </span><span class="RktSym">rand</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">call-exp</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">translation-of</span><span class="hspace"> </span><span
                  class="RktSym">rator</span><span class="hspace"> </span><span class="RktSym">senv</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">translation-of</span><span class="hspace"> </span><span class="RktSym">rand</span><span
                  class="hspace"> </span><span class="RktSym">senv</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">else</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">report-invalid-source-expression</span><span class="hspace"> </span><span
                  class="RktSym">exp</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <blockquote class="caption">
          <p>词法地址翻译器
            <a name="(idx._(gentag._551))"></a><a name="(elem._fig-3..16)"></a>
          </p>
        </blockquote>
      </blockquote>
      <blockquote class="EoplCodeInset">
        <p>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">translation-of</span></span> : <span
                    class="texMathInline">\mathit{Program} \to \mathit{Nameless\mbox{-}exp}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">translation-of-program</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">pgm</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">program</span><span class="hspace"> </span><span
                    class="RktSym">pgm</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">a-program</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">a-program</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">translation-of</span><span class="hspace"> </span><span
                    class="RktSym">exp1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">init-senv</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">translation-of</span></span> : <span
                    class="texMathInline">\mathit{()} \to \mathit{Senv}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">init-senv</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">extend-senv</span><span class="hspace"> </span><span class="RktVal">'</span><span
                    class="RktVal">i</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">extend-senv</span><span class="hspace"> </span><span class="RktVal">'</span><span
                    class="RktVal">v</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">extend-senv</span><span class="hspace"> </span><span class="RktVal">'</span><span
                    class="RktVal">x</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">empty-senv</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._552))"></a></div>
        </p>
      </blockquote>
      <h5>3.7.2<tt> </tt><a name="(part._s3..7..2)"></a>无名解释器</h5>
      <p>凭借词法地址分析器的预测，我们的解释器不必在运行时直接搜索变量。</p>
      <p>由于我们的程序中没有任何变量，我们不能把变量放入环境中；但是因为我们明确知道如何
        从环境中寻找它们，我们不需要！</p>
      <p>我们的顶层过程是 <span class="stt">run</span>：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">run</span></span> : <span
                  class="texMathInline">\mathit{String} \to \mathit{ExpVal}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">run</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">string</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span
                  class="RktSym">value-of-program</span></td>
            </tr>
            <tr>
              <td><span class="hspace">     </span><span class="RktPn">(</span><span
                  class="RktSym">translation-of-program</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">scan&parse</span><span class="hspace"> </span><span class="RktSym">string</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p><a name="(idx._(gentag._553))"></a>
        <a name="(idx._(gentag._554))"></a>
        我们不用全功能的环境，而是用无名环境，其接口如下：
      </p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span style="font-weight: bold"><span class="stt">nameless-environment?</span></span><span
                  class="stt">: </span><span class="texMathInline">\mathit{SchemeVal} \to \mathit{Bool}</span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span style="font-weight: bold"><span
                    class="stt">empty-nameless-env</span></span><span class="stt">: </span><span
                  class="texMathInline">\mathit{()} \to \mathit{Nameless\mbox{-}env}</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span style="font-weight: bold"><span
                    class="stt">extend-nameless-env</span></span><span class="stt">: </span><span
                  class="texMathInline">\mathit{ExpVal} \times \mathit{Nameless\mbox{-}env} \to
                  \mathit{Nameless\mbox{-}env}</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span style="font-weight: bold"><span
                    class="stt">apply-nameless-env</span></span><span class="stt">: </span><span
                  class="texMathInline">\mathit{Nameless\mbox{-}env} \times \mathit{Lexaddr} \to \mathit{DenVal}</span>
              </p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>我们可以用指代值列表实现无名环境，这样 <span class="stt">apply-nameless-env</span> 只需调用
        <span class="stt">list-ref</span>。这种实现如<span class="EoplFigureRef"></span> 所示。
      </p>
      <p><span class="stt">s3.7-eg</span>例子中最后一行的无名环境如下</p>
      <blockquote class="SCentered">
        <p><img src="nameless-env.svg" alt="无名环境" width="365.4pt" height="77.4pt" /></p>
      </blockquote>
      <p>由于更改了环境接口，我们需要查看代码中所有依赖这套接口的地方。我们的解释器中使用
        环境的只有两处：过程和 <span class="stt">value-of</span>。</p>
      <p>修改过程规范时，只需把旧规范中的变量名移除：</p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(apply-procedure (procedure </span><span class="texMathInline">var</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">body</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">\rho</span><span class="stt">) </span><span
                  class="texMathInline">val</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (value-of </span><span class="texMathInline">body</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt">(extend-nameless-env </span><span
                  class="texMathInline">val</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">\rho</span><span class="stt">))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!ht]
        </div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">nameless-environment?</span></span> : <span
                    class="texMathInline">\mathit{SchemeVal} \to \mathit{Bool}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">nameless-environment?</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">x</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">list-of</span><span class="hspace"> </span><span class="RktSym">exp-val?</span><span
                    class="RktPn">)</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">empty-nameless-env</span></span> : <span
                    class="texMathInline">\mathit{()} \to \mathit{Nameless\mbox{-}env}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">empty-nameless-env</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktVal">'</span><span class="RktVal">(</span><span
                    class="RktVal">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">extend-nameless-env</span></span> : <span
                    class="texMathInline">\mathit{Expval} \times \mathit{Nameless\mbox{-}env} \to
                    \mathit{Nameless\mbox{-}env}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">extend-nameless-env</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                    class="hspace"> </span><span class="RktSym">nameless-env</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cons</span><span
                    class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                    class="RktSym">nameless-env</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">apply-nameless-env</span></span> : <span
                    class="texMathInline">\mathit{Nameless\mbox{-}env} \times \mathit{Lexaddr} \to
                    \mathit{DenVal}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">apply-nameless-env</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">nameless-env</span><span
                    class="hspace"> </span><span class="RktSym">n</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">list-ref</span><span class="hspace"> </span><span
                    class="RktSym">nameless-env</span><span class="hspace"> </span><span class="RktSym">n</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <blockquote class="caption">
          <p>无名环境
            <a name="(idx._(gentag._555))"></a>
            <a name="(idx._(gentag._556))"></a><a name="(elem._fig-3..17)"></a>
          </p>
        </blockquote>
      </blockquote>
      <p>这一规范的实现可定义为：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">procedure</span></span> : <span
                  class="texMathInline">\mathit{Nameless\mbox{-}exp} \times \mathit{Nameless\mbox{-}env} \to
                  \mathit{Proc}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define-datatype</span><span
                  class="hspace"> </span><span class="RktSym">proc</span><span class="hspace"> </span><span
                  class="RktSym">proc?</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">procedure</span></td>
            </tr>
            <tr>
              <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktSym">expression?</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">   </span><span class="RktPn">(</span><span
                  class="RktSym">saved-nameless-env</span><span class="hspace"> </span><span
                  class="RktSym">nameless-environment?</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">apply-procedure</span></span> : <span
                  class="texMathInline">\mathit{Proc} \times \mathit{ExpVal} \to \mathit{ExpVal}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-procedure</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">proc1</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">proc</span><span class="hspace"> </span><span
                  class="RktSym">proc1</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">procedure</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktSym">saved-nameless-env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">body</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">extend-nameless-env</span><span class="hspace"> </span><span
                  class="RktSym">val</span><span class="hspace"> </span><span
                  class="RktSym">saved-nameless-env</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p><a name="(idx._(gentag._557))"></a>
        现在，我们可以写出 <span class="stt">value-of</span>。它的大部分与前一个解释器相同，只是原先使用
        <span class="stt">env</span> 的地方现在用 <span class="stt">nameless-env</span>。但我们要处理新的部分：
        <span class="stt">nameless-var-exp</span>、<span class="stt">nameless-let-exp</span> 和 <span
          class="stt">nameless-proc-exp</span>，它们分别
        取代对应的 <span class="stt">var-exp</span>、<span class="stt">let-exp</span> 和 <span
          class="stt">proc-exp</span>。其实现如<span class="EoplFigureRef"></span>
        所示。<span class="stt">nameless-var-exp</span> 用于环境查询。<span class="stt">nameless-let-exp</span> 先求出式子右边的
        <span class="texMathInline">exp_1</span>，然后用式子右边的值扩展环境，并在新环境内求主体的值。这和 <span class="stt">let</span> 所
        做相同，只是没有变量。<span class="stt">nameless-proc</span> 生成一个 <span class="stt">proc</span>，随后可供
        <span class="stt">apply-procedure</span> 调用。
        <a name="(idx._(gentag._558))"></a>
      </p>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!t]
        </div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">value-of</span></span> : <span
                    class="texMathInline">\mathit{Nameless\mbox{-}exp} \times \mathit{Nameless\mbox{-}env} \to
                    \mathit{ExpVal}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">value-of</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktSym">nameless-env</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                    class="RktSym">exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">const-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">num</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="texMathInline">\ldots</span> <span class="emph">同前</span> <span
                    class="texMathInline">\ldots</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">diff-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                    class="RktPn">)</span><span class="hspace"> </span><span class="texMathInline">\ldots</span> <span
                    class="emph">同前</span> <span class="texMathInline">\ldots</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">zero?-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="texMathInline">\ldots</span> <span class="emph">同前</span> <span
                    class="texMathInline">\ldots</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">if-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                    class="hspace"> </span><span class="RktSym">exp3</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="texMathInline">\ldots</span> <span class="emph">同前</span> <span
                    class="texMathInline">\ldots</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">call-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">rator</span><span class="hspace"> </span><span class="RktSym">rand</span><span
                    class="RktPn">)</span><span class="hspace"> </span><span class="texMathInline">\ldots</span> <span
                    class="emph">同前</span> <span class="texMathInline">\ldots</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">nameless-var-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">n</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">apply-nameless-env</span><span class="hspace"> </span><span
                    class="RktSym">nameless-env</span><span class="hspace"> </span><span class="RktSym">n</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">nameless-let-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">body</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">val</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                    class="hspace"> </span><span class="RktSym">nameless-env</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">body</span></td>
              </tr>
              <tr>
                <td><span class="hspace">            </span><span class="RktPn">(</span><span
                    class="RktSym">extend-nameless-env</span><span class="hspace"> </span><span
                    class="RktSym">val</span><span class="hspace"> </span><span class="RktSym">nameless-env</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">nameless-proc-exp</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">body</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">proc-val</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">procedure</span><span class="hspace"> </span><span class="RktSym">body</span><span
                    class="hspace"> </span><span class="RktSym">nameless-env</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">else</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">report-invalid-translated-expression</span><span class="hspace"> </span><span
                    class="RktSym">exp</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p>无名解释器的 <span class="stt">value-of</span><a name="(elem._fig-3..18)"></a></p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._559))"></a></div>
        </p>
      </blockquote>
      <p>最后是新的 <span class="stt">value-of-program</span>：</p>
      <blockquote class="EoplCodeInset">
        <p>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">value-of-program</span></span> : <span
                    class="texMathInline">\mathit{Nameless\mbox{-}program} \to \mathit{ExpVal}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">value-of-program</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">pgm</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">program</span><span class="hspace"> </span><span
                    class="RktSym">pgm</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">a-program</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">value-of</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">init-nameless-env</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._560))"></a>
          <a name="(idx._(gentag._561))"></a>
          <a name="(idx._(gentag._562))"></a>
        </div>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..38)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._563))"></a>
          扩展词法地址翻译器和解释器，处理<span class="EoplExerciseRef"></span> 中的 <span class="stt">cond</span>。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..39)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._564))"></a>
          扩展词法地址翻译器和解释器，处理<span class="EoplExerciseRef"></span> 中的 <span class="stt">unpack</span>。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..40)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._565))"></a>
          扩展词法地址翻译器和解释器，处理 <span class="stt">letrec</span>。修改 <span class="stt">translation-of</span> 的上下文
          参数，不仅记录每个绑定变量的名字，也记录变量是否由 <span class="stt">letrec</span> 绑定。对
          <span class="stt">letrec</span> 绑定变量的引用，生成一种新的引用，名为 <span class="stt">nameless-letrec-var-exp</span>。
          然后你可以继续用上面的无名环境表示，解释器则要以适当的方式处理<span class="Shtt">nameless-letrec-var-exp</span>。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..41)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._566))"></a>
          <a name="(idx._(gentag._567))"></a>
          修改词法地址翻译器和解释器，像<span class="EoplExerciseRef"></span> 那样处理多参数的 <span class="stt">let</span> 表
          达式、过程和过程调用。用肋排表示法（<span class="EoplExerciseRef"></span>）表示无名环境。在这种
          表示法中，词法地址包含两个非负数：词深，指明跨越的等深线数目，与之前相同；位置，
          指明变量在声明中的位置。
          <a name="(idx._(gentag._568))"></a>
          <a name="(idx._(gentag._569))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..42)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._570))"></a>
          <a name="(idx._(gentag._571))"></a>
          修改词法地址翻译器和解释器，使用<span class="EoplExerciseRef"></span> 中的瘦身过程表示法。要如此，
          你不能在 <span class="stt">(extend-senv </span><span class="texMathInline">var</span><span class="stt">
          </span><span class="texMathInline">senv</span><span class="stt">)</span> 中翻译过程的主体，而是在一个新的静
          态环境中，它指明了各个变量在瘦身表示中的位置。
          <a name="(idx._(gentag._572))"></a>
          <a name="(idx._(gentag._573))"></a>
          <a name="(idx._(gentag._574))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..43)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._575))"></a>
          <a name="(idx._(gentag._576))"></a>
          <a name="(idx._(gentag._577))"></a>
          翻译器不止能记录变量的名字。例如，考虑程序
        </p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let x = 3</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in let f = proc (y) -(y,x)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">in (f 13)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>这里，不必运行我们就能看出：在过程调用处，<span class="stt">f</span> 绑定到一个过程，其主体为
          <span class="stt">-(y,x)</span>，<span class="stt">x</span> 的值与过程创建处相同。因此我们完全可以避免在环境中查找
          <span class="stt">f</span>。扩展翻译器，记录“已知过程”，生成代码，避免在
          调用这样的过程时搜索环境。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex3..44)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>在前一个例子中，<span class="stt">f</span> 的唯一用途是作为一个已知过程。因此，由表达式 <span class="stt">proc (y)
            -(y,x)</span> 产生的过程从未使用。修改翻译器，避免产生这样的过程。
          <a name="(idx._(gentag._578))"></a>
          <a name="(idx._(gentag._579))"></a>
          <a name="(idx._(gentag._580))"></a>
        </p>
      </blockquote>
      <div class="navsetbottom"><span class="navleft">
          <div class="nosearchform"></div>  <span class="tocsettoggle">  <a href="javascript:void(0);"
              title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span>
        </span><span class="navright">  <a href="da.html" title="backward to " 2 数据抽象"" data-pltdoc="x">← prev</a>  <a
            href="index.html" title="up to " 编程语言要素"" data-pltdoc="x">up</a>  <a href="state.html" title="forward to " 4
            状态"" data-pltdoc="x">next →</a></span> </div>
    </div>
  </div>
  <div id="contextindicator"> </div>
</body>

</html>