<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.8" />
  <title>6 续文传递风格</title>
  <link rel="stylesheet" type="text/css" href="scribble.css" title="default" />
  <link rel="stylesheet" type="text/css" href="racket.css" title="default" />
  <link rel="stylesheet" type="text/css" href="tip.css" title="default" />
  <script type="text/javascript" src="scribble-common.js"></script>
  <script src="katex/katex.min.js"></script>
  <script src="onload.js"></script>

</head>

<body id="scribble-racket-lang-org">
  <div class="tocset">
    <div class="tocview">
      <div class="tocviewlist tocviewlisttopspace">
        <div class="tocviewtitle">
          <table cellspacing="0" cellpadding="0">
            <tr>
              <td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle"
                  onclick="TocviewToggle(this," tocview_0");">▼</a></td>
              <td></td>
              <td><a href="index.html" class="tocviewlink" data-pltdoc="x">编程语言要素</a></td>
            </tr>
          </table>
        </div>
        <div class="tocviewsublisttop" style="display: block;" id="tocview_0">
          <table cellspacing="0" cellpadding="0">
            <tr>
              <td align="right"></td>
              <td><a href="fw-trans.html" class="tocviewlink" data-pltdoc="x">译者的话</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="glo.html" class="tocviewlink" data-pltdoc="x">译名表</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="fw.html" class="tocviewlink" data-pltdoc="x">序</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="pf.html" class="tocviewlink" data-pltdoc="x">前言</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="awk.html" class="tocviewlink" data-pltdoc="x">致谢</a></td>
            </tr>
            <tr>
              <td align="right">1 </td>
              <td><a href="isd.html" class="tocviewlink" data-pltdoc="x">归纳式数据集</a></td>
            </tr>
            <tr>
              <td align="right">2 </td>
              <td><a href="da.html" class="tocviewlink" data-pltdoc="x">数据抽象</a></td>
            </tr>
            <tr>
              <td align="right">3 </td>
              <td><a href="expr.html" class="tocviewlink" data-pltdoc="x">表达式</a></td>
            </tr>
            <tr>
              <td align="right">4 </td>
              <td><a href="state.html" class="tocviewlink" data-pltdoc="x">状态</a></td>
            </tr>
            <tr>
              <td align="right">5 </td>
              <td><a href="cpi.html" class="tocviewlink" data-pltdoc="x">传递续文的解释器</a></td>
            </tr>
            <tr>
              <td align="right">6 </td>
              <td><a href="" class="tocviewselflink" data-pltdoc="x">续文传递风格</a></td>
            </tr>
            <tr>
              <td align="right">7 </td>
              <td><a href="types.html" class="tocviewlink" data-pltdoc="x">类型</a></td>
            </tr>
            <tr>
              <td align="right">8 </td>
              <td><a href="modules.html" class="tocviewlink" data-pltdoc="x">模块</a></td>
            </tr>
            <tr>
              <td align="right">9 </td>
              <td><a href="oac.html" class="tocviewlink" data-pltdoc="x">对象和类</a></td>
            </tr>
            <tr>
              <td align="right">10 </td>
              <td><a href="further-reading.html" class="tocviewlink" data-pltdoc="x">扩展阅读</a></td>
            </tr>
            <tr>
              <td align="right">11 </td>
              <td><a href="sllgen-parsing-system.html" class="tocviewlink" data-pltdoc="x">SLLGEN解析系统</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="bib.html" class="tocviewlink" data-pltdoc="x">参考书目</a></td>
            </tr>
            <tr>
              <td align="right"></td>
              <td><a href="indices.html" class="tocviewlink" data-pltdoc="x">索引</a></td>
            </tr>
          </table>
        </div>
      </div>
      <div class="tocviewlist">
        <table cellspacing="0" cellpadding="0">
          <tr>
            <td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle"
                onclick="TocviewToggle(this," tocview_1");">►</a></td>
            <td>6 </td>
            <td><a href="" class="tocviewselflink" data-pltdoc="x">续文传递风格</a></td>
          </tr>
        </table>
        <div class="tocviewsublistbottom" style="display: none;" id="tocview_1">
          <table cellspacing="0" cellpadding="0">
            <tr>
              <td align="right">6.1 </td>
              <td><a href="#%28part._s6..1%29" class="tocviewlink" data-pltdoc="x">写出续文传递风格的程序</a></td>
            </tr>
            <tr>
              <td align="right">6.2 </td>
              <td><a href="#%28part._s6..2%29" class="tocviewlink" data-pltdoc="x">尾式</a></td>
            </tr>
            <tr>
              <td align="right">6.3 </td>
              <td><a href="#%28part._s6..3%29" class="tocviewlink" data-pltdoc="x">转换为续文传递风格</a></td>
            </tr>
            <tr>
              <td align="right">6.4 </td>
              <td><a href="#%28part._s6..4%29" class="tocviewlink" data-pltdoc="x">建模计算效果</a></td>
            </tr>
          </table>
        </div>
      </div>
    </div>
    <div class="tocsub">
      <div class="tocsubtitle">On this page:</div>
      <table class="tocsublist" cellspacing="0">
        <tr>
          <td><span class="tocsublinknumber">6.1<tt> </tt></span><a href="#%28part._s6..1%29" class="tocsubseclink"
              data-pltdoc="x">写出续文传递风格的程序</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">6.2<tt> </tt></span><a href="#%28part._s6..2%29" class="tocsubseclink"
              data-pltdoc="x">尾式</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">6.3<tt> </tt></span><a href="#%28part._s6..3%29" class="tocsubseclink"
              data-pltdoc="x">转换为续文传递风格</a></td>
        </tr>
        <tr>
          <td><span class="tocsublinknumber">6.4<tt> </tt></span><a href="#%28part._s6..4%29" class="tocsubseclink"
              data-pltdoc="x">建模计算效果</a></td>
        </tr>
      </table>
    </div>
  </div>
  <div class="maincolumn">
    <div class="main">
      <div class="navsettop"><span class="navleft">
          <div class="nosearchform"></div>  <span class="tocsettoggle">  <a href="javascript:void(0);"
              title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span>
        </span><span class="navright">  <a href="cpi.html" title="backward to " 5 传递续文的解释器"" data-pltdoc="x">←
            prev</a>  <a href="index.html" title="up to " 编程语言要素"" data-pltdoc="x">up</a>  <a href="types.html"
            title="forward to " 7 类型"" data-pltdoc="x">next →</a></span> </div>
      <h3>6<tt> </tt><a name="(part._cps)"></a>续文传递风格</h3>
      <p><a name="(idx._(gentag._918))"></a>
        <a name="(idx._(gentag._919))"></a>
        在<a href="cpi.html" data-pltdoc="x">传递续文的解释器</a>，我们把解释器中的所有主要过程调用重写成<span class="emph">尾调用</span>。这样，我们
        保证任何时候，不论执行的程序多大或多复杂，解释器只使用有限的控制上下文。这种性质
        叫做<span class="emph">迭代性控制行为</span>。
        <a name="(idx._(gentag._920))"></a>
      </p>
      <p><a name="(idx._(gentag._921))"></a>
        我们通过给每个过程多传一个<span class="emph">续文</span>参数实现这一目标。这种编程风格
        叫做<span class="emph">续文传递风格</span> (<span class="emph">continuation-passing style</span>) 或 <span
          class="emph">CPS</span>，且不限
        于解释器。</p>
      <p>本章，我们介绍一种系统性的方法，将任一过程转换为具有迭代性控制行为的等效过程。实
        现这一点需要将过程转换为续文传递风格。</p>
      <h4>6.1<tt> </tt><a name="(part._s6..1)"></a>写出续文传递风格的程序</h4>
      <p><a name="(idx._(gentag._922))"></a>
        除了写解释器，CPS 还有别的作用。我们考虑“老熟人”阶乘程序：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fact</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                  class="hspace"> </span><span class="RktSym">n</span><span class="RktPn">)</span><span
                  class="hspace"> </span><span class="RktVal">1</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">*</span><span class="hspace"> </span><span
                  class="RktSym">n</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">fact</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym"><span class="nobreak">-</span></span><span class="hspace"> </span><span
                  class="RktSym">n</span><span class="hspace"> </span><span class="RktVal">1</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>阶乘的传递续文版本是：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">fact</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">fact/k</span><span
                    class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">end-cont</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">fact/k</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                    class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                    class="hspace"> </span><span class="RktSym">n</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">apply-cont</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">fact/k</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym"><span class="nobreak">-</span></span><span class="hspace"> </span><span
                    class="RktSym">n</span><span class="hspace"> </span><span class="RktVal">1</span><span
                    class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">fact1-cont</span><span class="hspace"> </span><span class="RktSym">n</span><span
                    class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>其中，</p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(apply-cont (end-cont) </span><span class="texMathInline">val</span><span
                    class="stt">) = </span><span class="texMathInline">val</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(apply-cont (fact1-cont </span><span class="texMathInline">n</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">cont</span><span class="stt">) </span><span
                    class="texMathInline">val</span><span class="stt">) = </span><span
                    class="texMathInline">val</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (apply-cont </span><span class="texMathInline">cont</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">(* </span><span
                    class="texMathInline">n</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">val</span><span class="stt">))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>在这一版内，<span class="stt">fact/k</span> 和 <span class="stt">apply-cont</span> 中的所有调用都在末尾，因此不产生控制
        上下文。</p>
      <p><a name="(idx._(gentag._923))"></a>
        <a name="(idx._(gentag._924))"></a>
        我们可以用数据结构实现这些续文：
      </p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define-datatype</span><span
                  class="hspace"> </span><span class="RktSym">continuation</span><span class="hspace"> </span><span
                  class="RktSym">continuation?</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">end-cont</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">fact1-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktSym">integer?</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">continuation?</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">continuation</span><span class="hspace"> </span><span
                  class="RktSym">cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">end-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">fact1-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">saved-n</span><span class="hspace"> </span><span class="RktSym">saved-cont</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">*</span><span class="hspace"> </span><span class="RktSym">saved-n</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p><a name="(idx._(gentag._925))"></a>
        我们还能以多种方式转换这一程序，比如寄存它，如<span class="EoplFigureRef"></span> 所示。</p>
      <p><a name="(idx._(gentag._926))"></a>
        我们甚至能将其转为跳跃式，如<span class="EoplFigureRef"></span> 所示。如果用普通的指令式语言，
        我们自然能将跳床替换为适当的循环。
        <a name="(idx._(gentag._927))"></a>
      </p>
      <p><a name="(idx._(gentag._928))"></a>
        但是，本章我们主要关心，用过程表示法（如<span class="EoplFigureRef"></span>）时会发生什么。回忆
        一下，在过程表示法中，续文用它在 <span class="stt">apply-cont</span> 中的动作表示。过程表示为：
        <a name="(idx._(gentag._929))"></a>
      </p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">end-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fact1-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">*</span><span class="hspace"> </span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!ht]</div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">n</span><span class="hspace"> </span><span class="RktVal">'</span><span
                    class="RktVal">uninitialized</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">cont</span><span class="hspace"> </span><span class="RktVal">'</span><span
                    class="RktVal">uninitialized</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">val</span><span class="hspace"> </span><span class="RktVal">'</span><span
                    class="RktVal">uninitialized</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">fact</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">arg-n</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                    class="hspace"> </span><span class="RktSym">cont</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">end-cont</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                    class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                    class="RktSym">arg-n</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">fact/k</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">fact/k</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                    class="hspace"> </span><span class="RktSym">n</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">begin</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">val</span><span
                    class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">apply-cont</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">begin</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">fact1-cont</span><span
                    class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                    class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">n</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                      class="nobreak">-</span></span><span class="hspace"> </span><span class="RktSym">n</span><span
                    class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">fact/k</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">apply-cont</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">continuation</span><span class="hspace"> </span><span
                    class="RktSym">cont</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">end-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktPn">)</span><span class="hspace"> </span><span class="RktSym">val</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">fact1-cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">saved-n</span><span class="hspace"> </span><span
                    class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">set!</span><span class="hspace"> </span><span class="RktSym">val</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">*</span><span
                    class="hspace"> </span><span class="RktSym">saved-n</span><span class="hspace"> </span><span
                    class="RktSym">val</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">apply-cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <blockquote class="caption">
          <p>寄存后的 <span class="stt">fact/k</span>
            <a name="(idx._(gentag._930))"></a><a name="(elem._fig-6..1)"></a>
          </p>
        </blockquote>
      </blockquote>
      <p><a name="(idx._(gentag._931))"></a>
        我们还可以更进一步，将程序中所有调用续文构造器的地方替换为其定义。因为定义在行内
        展开，这一转换叫做<span class="emph">内联</span> (<span class="emph">inlining</span>)。我们还要内联 <span
          class="stt">apply-cont</span> 的调用，
        不再写 <span class="stt">(apply-cont cont val)</span>，而是直接写 <span class="stt">(cont val)</span>。</p>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">n</span><span class="hspace"> </span><span class="RktVal">'</span><span
                  class="RktVal">uninitialized</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="hspace"> </span><span class="RktVal">'</span><span
                  class="RktVal">uninitialized</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">val</span><span class="hspace"> </span><span class="RktVal">'</span><span
                  class="RktVal">uninitialized</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">pc</span><span class="hspace"> </span><span class="RktVal">'</span><span
                  class="RktVal">uninitialized</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fact</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">arg-n</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">end-cont</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                  class="RktSym">arg-n</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">pc</span><span class="hspace"> </span><span
                  class="RktSym">fact/k</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span
                  class="RktSym">trampoline!</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">trampoline!</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">procedure?</span><span
                  class="hspace"> </span><span class="RktSym">pc</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">begin</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">pc</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">trampoline!</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fact/k</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                  class="hspace"> </span><span class="RktSym">n</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">begin</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                  class="RktVal">1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">pc</span><span class="hspace"> </span><span
                  class="RktSym">apply-cont</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">begin</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">fact1-cont</span><span class="hspace"> </span><span
                  class="RktSym">n</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym"><span class="nobreak">-</span></span><span
                  class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                  class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">pc</span><span class="hspace"> </span><span
                  class="RktSym">fact/k</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">continuation</span><span class="hspace"> </span><span
                  class="RktSym">cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">end-cont</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">pc</span><span class="hspace"> </span><span
                  class="RktVal">#f</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">fact1-cont</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="hspace"> </span><span
                  class="RktSym">saved-cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">*</span><span class="hspace"> </span><span
                  class="RktSym">n</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">set!</span><span
                  class="hspace"> </span><span class="RktSym">pc</span><span class="hspace"> </span><span
                  class="RktSym">apply-cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <blockquote class="caption">
          <p>寄存后的跳跃式 <span class="stt">fact/k</span>
            <a name="(idx._(gentag._932))"></a><a name="(elem._fig-6..2)"></a>
          </p>
        </blockquote>
      </blockquote>
      <p><a name="(idx._(gentag._933))"></a>
        如果我们按这种方式内联所有用到续文的地方，我们得到：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fact</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">fact/k</span><span
                  class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fact/k</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                  class="hspace"> </span><span class="RktSym">n</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">fact/k</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                    class="nobreak">-</span></span><span class="hspace"> </span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">*</span><span class="hspace"> </span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p><span class="stt">fact/k</span> 的定义可以读作：</p>
      <blockquote>
        <p><span class="emph">若 <span class="texMathInline">n</span> 为 0，将 1 传给续文；否则，求 <span
              class="texMathInline">n-1</span> 的 <span class="stt">fact</span>，求值所在的续文，取
            其结果 <span class="stt">val</span>，然后将 <span class="stt">(* </span><span class="texMathInline">n</span><span
              class="stt"> val)</span> 的值传给当前续文。
          </span></p>
      </blockquote>
      <p><a name="(idx._(gentag._934))"></a>
        过程 <span class="stt">fact/k</span> 具有性质 <span class="stt">(fact/k </span><span
          class="texMathInline">n</span><span class="stt"> </span><span class="texMathInline">g</span><span
          class="stt">) = (</span><span class="texMathInline">g</span><span class="stt"> </span><span
          class="texMathInline">n!</span><span class="stt">)</span>。对 <span class="texMathInline">n</span>
        使用归纳法很容易证明这条性质。第一步，当 <span class="texMathInline">n = 0</span>，我们计算：</p>
      <blockquote class="SubFlow">
        <blockquote class="Small">
          <blockquote class="SCodeFlow">
            <p><span class="stt">(fact/k 0 </span><span class="texMathInline">g</span><span class="stt">) =
                (</span><span class="texMathInline">g</span><span class="stt"> 1) = (</span><span
                class="texMathInline">g</span><span class="stt"> (fact 0))</span></p>
          </blockquote>
        </blockquote>
        <p>归纳步骤中，对某个 <span class="texMathInline">n</span>，设 <span class="stt">(fact/k </span><span
            class="texMathInline">n</span><span class="stt"> </span><span class="texMathInline">g</span><span
            class="stt">) = (</span><span class="texMathInline">g</span><span class="stt"> </span><span
            class="texMathInline">n!</span><span class="stt">)</span>，试证明
          <span class="stt">(fact/k </span><span class="texMathInline">(n + 1)</span><span class="stt"> </span><span
            class="texMathInline">g</span><span class="stt">) = (</span><span class="texMathInline">g</span><span
            class="stt"> </span><span class="texMathInline">(n + 1)!</span><span class="stt">)</span>。要证明它，我们计算：
        </p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(fact/k </span><span class="texMathInline">n + 1</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">g</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (fact/k </span><span class="texMathInline">n</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt">(lambda (val) (</span><span
                    class="texMathInline">g</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt">(* </span><span class="texMathInline">n + 1</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt">val))))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= ((lambda (val) (</span><span class="texMathInline">g</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">(* </span><span
                    class="texMathInline">n + 1</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt">val)))</span><span class="hspace">   </span><span class="stt"></span>（根据归纳假设）<span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">   </span><span class="stt">(fact </span><span
                    class="texMathInline">n</span><span class="stt">))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (</span><span class="texMathInline">g</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt">(* </span><span class="texMathInline">n + 1</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">(fact </span><span
                    class="texMathInline">n</span><span class="stt">)))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (</span><span class="texMathInline">g</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt">(fact </span><span class="texMathInline">n + 1</span><span
                    class="stt">))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>归纳完毕。</p>
      </blockquote>
      <p>像<a href="isd.html#%28part._s1..3%29" data-pltdoc="x">辅助过程和上下文参数</a>一样，这里的 <span class="texMathInline">g</span>
        是上下文参数；性质 <span class="stt">(fact/k </span><span class="texMathInline">n</span><span class="stt"> </span><span
          class="texMathInline">g</span><span class="stt">) =</span><span class="stt">
        </span><span class="stt">(</span><span class="texMathInline">g</span><span class="stt"> </span><span
          class="texMathInline">n!</span><span class="stt">)</span> 作为独立规范，遵循我们的原则<a href="isd.html#%28elem._no-myth%29"
          data-pltdoc="x"><span style="font-weight: bold">避免神秘小工具</span></a>。
        <a name="(idx._(gentag._935))"></a>
        <a name="(idx._(gentag._936))"></a>
      </p>
      <p><a name="(idx._(gentag._937))"></a>
        现在，我们用同样的方式转换计算斐波那契数列的 <span class="stt">fib</span>。我们从下面的过程开始：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fib</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">
                  << /span><span class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                      class="RktVal">2</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktVal">1</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">+</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">fib</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                    class="nobreak">-</span></span><span class="hspace"> </span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">fib</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                    class="nobreak">-</span></span><span class="hspace"> </span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktVal">2</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>这里我们两次递归调用 <span class="stt">fib</span>，所以我们需要一个 <span class="stt">end-cont</span> 和两个续文构造器，
        二者各对应一个参数，就像处理<a href="cpi.html#%28part._s5..1%29" data-pltdoc="x">传递续文的解释器</a>中的差值表达式那样。</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fib</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">fib/k</span><span
                  class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">end-cont</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fib/k</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">
                  << /span><span class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                      class="RktVal">2</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">fib/k</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                    class="nobreak">-</span></span><span class="hspace"> </span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">fib1-cont</span><span
                  class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(apply-cont (end-cont) </span><span class="texMathInline">val</span><span
                  class="stt">) = </span><span class="texMathInline">val</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(apply-cont (fib1-cont </span><span class="texMathInline">n</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">cont</span><span class="stt">) </span><span
                  class="texMathInline">val1</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (fib/k (- </span><span class="texMathInline">n</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt">2) (fib2-cont </span><span
                  class="texMathInline">val1</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">cont</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace"> </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">(apply-cont (fib2-cont </span><span class="texMathInline">val1</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">cont</span><span class="stt">) </span><span
                  class="texMathInline">val2</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (apply-cont </span><span class="texMathInline">cont</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt">(+ </span><span
                  class="texMathInline">val1</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">val2</span><span class="stt">))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p><a name="(idx._(gentag._938))"></a>
        <a name="(idx._(gentag._939))"></a>
        在过程表示法中，我们有：
      </p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">end-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fib1-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val1</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">fib/k</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                    class="nobreak">-</span></span><span class="hspace"> </span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktVal">2</span><span class="RktPn">)</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">fib2-cont</span><span
                  class="hspace"> </span><span class="RktSym">val1</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fib2-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val1</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val2</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">+</span><span
                  class="hspace"> </span><span class="RktSym">val1</span><span class="hspace"> </span><span
                  class="RktSym">val2</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>如果我们内联所有使用这些过程的地方，可得：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fib</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">fib/k</span><span
                  class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fib/k</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">
                  << /span><span class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                      class="RktVal">2</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">fib/k</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                    class="nobreak">-</span></span><span class="hspace"> </span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">val1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">fib/k</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym"><span class="nobreak">-</span></span><span class="hspace"> </span><span
                  class="RktSym">n</span><span class="hspace"> </span><span class="RktVal">2</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">val2</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">              </span><span class="RktPn">(</span><span
                  class="RktSym">cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">+</span><span class="hspace"> </span><span class="RktSym">val1</span><span
                  class="hspace"> </span><span class="RktSym">val2</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>类似阶乘，我们可以把这个定义读作：</p>
      <blockquote>
        <p><span class="emph">若 <span class="texMathInline">n < 2</span>，将 1 传给续文。否则，处理 <span
                  class="texMathInline">n-1</span>，求值所在的续文，取其结果
                <span class="stt">val1</span>，然后处理 <span class="stt">val2</span>，求值所在的续文，取其结果 <span
                  class="stt">val2</span>，然后将 <span class="stt">(+
                  val1 val2)</span> 的值传给当前续文。
                <a name="(idx._(gentag._940))"></a></span></p>
      </blockquote>
      <p>用推导 <span class="stt">fact</span> 的方式，很容易得出，对任意 <span class="texMathInline">g</span>，<span class="stt">(fib/k
        </span><span class="texMathInline">n</span><span class="stt"> </span><span class="texMathInline">g</span><span
          class="stt">) =</span><span class="stt">
        </span><span class="stt">(</span><span class="texMathInline">g</span><span class="stt"> (fib </span><span
          class="texMathInline">n</span><span class="stt">))</span>。这里有个假想的例子，推广了这一想法：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">x</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">cond</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">zero?</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="RktPn">)</span><span class="hspace"> </span><span class="RktVal">17</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">2</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">+</span><span
                    class="hspace"> </span><span class="RktVal">22</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">f</span><span class="hspace"> </span><span
                    class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">3</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">g</span><span
                    class="hspace"> </span><span class="RktVal">22</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">f</span><span class="hspace"> </span><span
                    class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">4</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">+</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktVal">33</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">g</span><span class="hspace"> </span><span
                    class="RktSym">y</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">else</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">h</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                      class="nobreak">-</span></span><span class="hspace"> </span><span class="RktVal">44</span><span
                    class="hspace"> </span><span class="RktSym">y</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">g</span><span
                    class="hspace"> </span><span class="RktSym">y</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>变成：</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">x</span><span class="hspace"> </span><span
                    class="RktSym">cont</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">cond</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">zero?</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">cont</span><span class="hspace"> </span><span class="RktVal">17</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="hspace"> </span><span
                    class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">2</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">v1</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">+</span><span
                    class="hspace"> </span><span class="RktVal">22</span><span class="hspace"> </span><span
                    class="RktSym">v1</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">3</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">v1</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">g</span><span
                    class="hspace"> </span><span class="RktVal">22</span><span class="hspace"> </span><span
                    class="RktSym">v1</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">4</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">v1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                   </span><span class="RktPn">(</span><span
                    class="RktSym">g</span><span class="hspace"> </span><span class="RktSym">y</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">v2</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                          </span><span class="RktPn">(</span><span
                    class="RktSym">cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">+</span><span class="hspace"> </span><span class="RktSym">v1</span><span
                    class="hspace"> </span><span class="RktVal">33</span><span class="hspace"> </span><span
                    class="RktSym">v2</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">   </span><span class="RktPn">(</span><span class="RktSym">else</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">v1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                </span><span class="RktPn">(</span><span
                    class="RktSym">g</span><span class="hspace"> </span><span class="RktSym">y</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">v2</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                       </span><span class="RktPn">(</span><span
                    class="RktSym">h</span><span class="hspace"> </span><span class="RktSym">v1</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                      class="nobreak">-</span></span><span class="hspace"> </span><span class="RktVal">44</span><span
                    class="hspace"> </span><span class="RktSym">y</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktSym">v2</span><span class="hspace"> </span><span
                    class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>其中，过程 <span class="stt">f</span>、<span class="stt">g</span> 和 <span class="stt">h</span> 都以类似方式转换。</p>
        <ul>
          <li>
            <p>在 <span class="stt">(zero? x)</span> 这一行，我们将 17 返回给续文。</p>
          </li>
          <li>
            <p>在 <span class="stt">(= x 1)</span> 这一行，我们按尾递归的方式调用 <span class="stt">f</span>。</p>
          </li>
          <li>
            <p>在 <span class="stt">(= x 2)</span> 这一行，我们在加法的操作数位置调用 <span class="stt">f</span>。</p>
          </li>
          <li>
            <p>在 <span class="stt">(= x 3)</span> 这一行，我们在过程调用的操作数位置调用 <span class="stt">f</span>。</p>
          </li>
          <li>
            <p>在 <span class="stt">(= x 4)</span> 这一行，有两个过程调用在加法的操作数位置。</p>
          </li>
          <li>
            <p>在 <span class="stt">else</span> 这一行，有两个过程调用在另一个过程调用内的操作数位置。</p>
          </li>
        </ul>
      </blockquote>
      <p>从这些例子中浮现出一种模式。</p>
      <blockquote class="Tip">
        <blockquote class="SCentered">
          <p><a name="(elem._cps-recipe)"></a><span style="font-weight: bold">CPS 秘方</span>
            <a name="(idx._(gentag._941))"></a>
            <a name="(idx._(gentag._942))"></a>
          </p>
        </blockquote>
        <blockquote class="TipContent">
          <p>要将程序转换为续文传递风格：</p>
          <ol>
            <li>
              <p>给每个过程传一个额外参数（通常是 <span class="stt">cont</span> 或 <span class="stt">k</span>）。</p>
            </li>
            <li>
              <p>不论过程返回常量还是变量，都将返回值传给续文，就像上面的 <span class="stt">(cont 17)</span>。</p>
            </li>
            <li>
              <p>过程调用在尾部时，用同样的续文 <span class="stt">cont</span> 调用过程。</p>
            </li>
            <li>
              <p>过程调用在操作数位置时，在新的续文中求过程调用的值，这个续文给调用结果命
                名，继续进行计算。</p>
            </li>
          </ol>
        </blockquote>
      </blockquote>
      <p>这些规则虽不正式，但足以解释这种模式。
        <a name="(idx._(gentag._943))"></a>
      </p>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..1)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>考虑<span class="EoplFigureRef"></span>，为什么移除 <span class="stt">fact/k</span> 定义中的
          <span class="stt">(set! pc fact/k)</span>
          和 <span class="stt">apply-cont</span> 中定义的 <span class="stt">(set! pc apply-cont)</span>，程序仍能正常运行？</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..2)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>用归纳法证明：对任意 <span class="texMathInline">g</span>，<span class="stt">(fib/k </span><span
            class="texMathInline">n</span><span class="stt"> </span><span class="texMathInline">g</span><span
            class="stt">) = (</span><span class="texMathInline">g</span><span class="stt"> (fib </span><span
            class="texMathInline">n</span><span class="stt">))</span>，归纳
          变量为 <span class="texMathInline">n</span>。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..3)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>把下面每个 Scheme 表达式重写为续文传递风格。假设所有未知函数都已经重写成 CPS 风
          格。</p>
        <ol>
          <li>
            <p><span class="stt">(lambda (x y) (p (+ 8 x) (q y)))</span></p>
          </li>
          <li>
            <p><span class="stt">(lambda (x y u v) (+ 1 (f (g x y) (+ u v))))</span></p>
          </li>
          <li>
            <p><span class="stt">(+ 1 (f (g x y) (+ u (h v))))</span></p>
          </li>
          <li>
            <p><span class="stt">(zero? (if a (p x) (p y)))</span></p>
          </li>
          <li>
            <p><span class="stt">(zero? (if (f a) (p x) (p y)))</span></p>
          </li>
          <li>
            <p><span class="stt">(let ((x (let ((y 8)) (p y)))) x)</span></p>
          </li>
          <li>
            <p><span class="stt">(let ((x (if a (p x) (p y)))) x)</span></p>
          </li>
        </ol>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..4)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._944))"></a>
          <a name="(idx._(gentag._945))"></a>
          <a name="(idx._(gentag._946))"></a>
          <a name="(idx._(gentag._947))"></a>
          <a name="(idx._(gentag._948))"></a>
          <a name="(idx._(gentag._949))"></a>
          <a name="(idx._(gentag._950))"></a>
          <a name="(idx._(gentag._951))"></a>
          <a name="(idx._(gentag._952))"></a>
          <a name="(idx._(gentag._953))"></a>
          <a name="(idx._(gentag._954))"></a>
          把下面的所有过程重写为续文传递风格。表示每个过程的续文时，先用数据结构表示法，然
          后用过程表示法，然后用内联过程表示法。最后，写出寄存版本。照<a href="cpi.html" data-pltdoc="x">传递续文的解释器</a>那样定义
          <span class="stt">end-cont</span>，验证你实现的这四个版本是尾调用：
        </p>
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(apply-cont (end-cont) </span><span class="texMathInline">val</span><span
                    class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (begin</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(eopl:printf
                    "计算结束.~%")</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(eopl:printf
                    "这句话只能出现一次.~%")</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt"></span><span
                    class="texMathInline">val</span><span class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <ol>
          <li>
            <p><span class="stt">remove-first</span>（<a href="isd.html#%28elem._remove-first%29" data-pltdoc="x">1.2.3
                节</a>）</p>
          </li>
          <li>
            <p><span class="stt">list-sum</span>（<a href="isd.html#%28elem._list-sum%29" data-pltdoc="x">1.3 节</a>）</p>
          </li>
          <li>
            <p><span class="stt">occurs-free?</span>（<a href="isd.html#%28elem._occurs-free-1~3f%29"
                data-pltdoc="x">1.2.4 节</a>）</p>
          </li>
          <li>
            <p><span class="stt">subst</span>（<a href="isd.html#%28elem._subst%29" data-pltdoc="x">1.2.5 节</a>）
              <a name="(idx._(gentag._955))"></a>
              <a name="(idx._(gentag._956))"></a>
              <a name="(idx._(gentag._957))"></a>
              <a name="(idx._(gentag._958))"></a>
              <a name="(idx._(gentag._959))"></a>
              <a name="(idx._(gentag._960))"></a>
              <a name="(idx._(gentag._961))"></a>
              <a name="(idx._(gentag._962))"></a>
              <a name="(idx._(gentag._963))"></a>
              <a name="(idx._(gentag._964))"></a>
            </p>
          </li>
        </ol>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..5)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>当我们把表达式重写为CPS时，我们就为表达式中的过程选择了一种求值顺序。把前面的每
          个例子重写为CPS，且使过程调用从右向左求值。
          <a name="(idx._(gentag._965))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..6)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>在 <span class="stt">(lambda (x y) (+ (f (g x)) (h (j y))))</span> 中，过程调用有多少种不同的求值顺
          序？对每种求值顺序，写出对应的 CPS 表达式。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..7)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._966))"></a>
          <a name="(idx._(gentag._967))"></a>
          <a name="(idx._(gentag._968))"></a>
          <a name="(idx._(gentag._969))"></a>
          写出<span class="EoplFigureRef"></span>、<span class="stt">fig-5.5</span> 和 <span class="stt">fig-5.6</span>
          中解释器的过
          程表示和内联过程表示。
          <a name="(idx._(gentag._970))"></a>
          <a name="(idx._(gentag._971))"></a>
          <a name="(idx._(gentag._972))"></a>
          <a name="(idx._(gentag._973))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..8)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._974))"></a>
          <a name="(idx._(gentag._975))"></a>
          写出<a href="cpi.html#%28part._s5..4%29" data-pltdoc="x">异常</a>解释器的过程表示和内联过程表示。这极富挑战性，因为我们实际上有
          两个观测器，<span class="stt">apply-cont</span> 和 <span class="stt">apply-handler</span>。提示：考虑修改
          <span class="stt">cps-recipe</span>的秘方，给每个过程添加两个参数，一个表示 <span class="stt">apply-cont</span> 中
          续文的行为，一个表示 <span class="stt">apply-handler</span> 中续文的行为。<br />
          <a name="(idx._(gentag._976))"></a>
          <a name="(idx._(gentag._977))"></a>
        </p>
      </blockquote>
      <p><a name="(idx._(gentag._978))"></a>
        有时，我们能发现更巧妙的方式表示续文。我们重新考虑用过程表示续文的 <span class="stt">fact</span>。其
        中，我们有两个续文构造器，写作：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">end-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fact1-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">cont</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">*</span><span class="hspace"> </span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>在这个系统中，所有续文都用某个数乘以参数。<span class="stt">end-cont</span> 将其参数乘 1，若
        <span class="texMathInline">cont</span> 将参数乘 <span class="texMathInline">k</span>，那么 <span class="stt">(fact1
        </span><span class="texMathInline">n</span><span class="stt"> </span><span
          class="texMathInline">cont</span><span class="stt">)</span> 将其值乘 <span class="texMathInline">k * n</span>。
      </p>
      <p>所以每个续文都形如 <span class="stt">(lambda (val) (* </span><span class="texMathInline">k</span><span class="stt">
          val))</span>。这意味着我们可以用每个续文
        仅有的自由变量——数字 <span class="texMathInline">k</span>——表示它。用这种表示方式，我们有：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">end-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktVal">1</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fact1-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">*</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="hspace"> </span><span
                  class="RktSym">n</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cont</span><span
                  class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">*</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="hspace"> </span><span
                  class="RktSym">val</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>如果我们在 <span class="stt">fact/k</span> 的原始定义中内联这些过程，并使用性质 <span class="stt">(* </span><span
          class="texMathInline">cont</span><span class="stt"> 1) =</span><span class="stt">
        </span><span class="texMathInline">cont</span>，可得：</p>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fact</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">fact/k</span><span
                  class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                  class="RktVal">1</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">fact/k</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                  class="hspace"> </span><span class="RktSym">n</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktSym">cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">fact/k</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                    class="nobreak">-</span></span><span class="hspace"> </span><span class="RktSym">n</span><span
                  class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">*</span><span
                  class="hspace"> </span><span class="RktSym">cont</span><span class="hspace"> </span><span
                  class="RktSym">n</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>但是这和 <span class="stt">fact-iter</span>（<span class="stt">fact-iter</span>）完全相同！所以我们明白了，
        <a name="(idx._(gentag._979))"></a>累加器通常只是续文的一种表示方式。这令人印象深刻。相当一
        部分经典的程序优化问题原来是这一思想的特例。
        <a name="(idx._(gentag._980))"></a>
      </p>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..9)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>乘法的什么性质使这种程序优化成为可能？</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..10)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._981))"></a>
          给 <span class="stt">list-sum</span> 设计一种简便的续文表示方式，就像上面的 <span class="stt">fact/k</span> 那样。</p>
      </blockquote>
      <h4>6.2<tt> </tt><a name="(part._s6..2)"></a>尾式</h4>
      <p><a name="(idx._(gentag._982))"></a>
        <a name="(idx._(gentag._983))"></a>
        要写出程序来做续文传递风格变换，我们需要找出输入和输出语言。我们选择 LETREC 作为
        输入语言，并补充多参数过程和多声明的 <span class="stt">letrec</span> 表达式。
        <a name="(idx._(gentag._984))"></a>
        其语法如<span class="EoplFigureRef"></span> 所示，我们称之为 CPS-IN。为了区分这种语言和输出语言
        的表达式，我们把这些叫做<span class="emph">输入表达式</span> (<span class="emph">input expression</span>)。
      </p>
      <p><a name="(idx._(gentag._985))"></a>
        要定义 CPS 变换算法的可能输出，我们要找出 CPI-IN 的子集，在这个集合中，过程调用
        不产生任何控制上下文。
        <a name="(idx._(gentag._986))"></a>
      </p>
      <p>回忆<a href="cpi.html" data-pltdoc="x">传递续文的解释器</a>中的原则：</p>
      <blockquote class="SubFlow">
        <blockquote class="Tip">
          <blockquote class="SCentered">
            <p><span style="font-weight: bold">不是过程调用，而是操作数的求值导致控制上下文扩大。</span>
              <a name="(idx._(gentag._987))"></a>
              <a name="(idx._(gentag._988))"></a>
            </p>
          </blockquote>
        </blockquote>
        <p><a name="(idx._(gentag._989))"></a>
          那么，在</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">fact</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                    class="hspace"> </span><span class="RktSym">n</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktVal">1</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">*</span><span class="hspace"> </span><span
                    class="RktSym">n</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">fact</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym"><span class="nobreak">-</span></span><span class="hspace"> </span><span
                    class="RktSym">n</span><span class="hspace"> </span><span class="RktVal">1</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>中，是 <span class="stt">fact</span> 的调用位置<span class="emph">作为操作数</span>导致了控制上下文的产生。相反，在</p>
        <blockquote class="EoplCodeInset">
          <p>
          <div class="SIntrapara">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                      class="RktSym">fact-iter</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span
                      class="RktSym">fact-iter-acc</span><span class="hspace"> </span><span class="RktSym">n</span><span
                      class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span><span
                      class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace"> </span></td>
                </tr>
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                      class="RktSym">fact-iter-acc</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                      class="hspace"> </span><span class="RktSym">a</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                      class="hspace"> </span><span class="RktSym">n</span><span class="RktPn">)</span><span
                      class="hspace"> </span><span class="RktSym">a</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym">fact-iter-acc</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym"><span class="nobreak">-</span></span><span
                      class="hspace"> </span><span class="RktSym">n</span><span class="hspace"> </span><span
                      class="RktVal">1</span><span class="RktPn">)</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym">*</span><span class="hspace"> </span><span
                      class="RktSym">n</span><span class="hspace"> </span><span class="RktSym">a</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
              </table>
            </blockquote>
          </div>
          <div class="SIntrapara"><a name="(idx._(gentag._990))"></a></div>
          </p>
        </blockquote>
        <p><a name="(idx._(gentag._991))"></a>
          中， 过程调用都不在操作数位置。我们说这些调用在<span class="emph">尾端</span> (<span class="emph">tail position</span>)，因
          为它们的值就是整个调用的结果。我们称之为<span class="emph">尾调用</span> (<span class="emph">tail call</span>)。</p>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>[!ht]
          <br />
          <span class="Iidentity">\begin{align*}\mathit{Program} &::= \mathit{InpExp} \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">a-program (exp1)</span>} \\[5pt]
            \mathit{InpExp} &::= \mathit{Number} \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">const-exp (num)</span>} \\[5pt]
            \mathit{InpExp} &::= <span class="stt">(- </span><span class="Iidentity">\mathit{InpExp}</span><span
              class="stt"> , </span><span class="Iidentity">\mathit{InpExp}</span><span class="stt">)</span> \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">diff-exp (exp1 exp2)</span>} \\[5pt]
            \mathit{InpExp} &::= <span class="stt">(zero? </span><span class="Iidentity">\mathit{InpExp}</span><span
              class="stt">)</span> \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">zero?-exp (exp1)</span>} \\[5pt]
            \mathit{InpExp} &::= <span class="stt">if </span><span class="Iidentity">\mathit{InpExp}</span><span
              class="stt"> then </span><span class="Iidentity">\mathit{InpExp}</span><span class="stt"> else
            </span><span class="Iidentity">\mathit{InpExp}</span> \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">if-exp (exp1 exp2 exp3)</span>} \\[5pt]
            \mathit{InpExp} &::= \mathit{Identifier} \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">var-exp (var)</span>} \\[5pt]
            \mathit{InpExp} &::= <span class="stt">let </span><span class="Iidentity">\mathit{Identifier}</span><span
              class="stt"> = </span><span class="Iidentity">\mathit{InpExp}</span><span class="stt"> in </span><span
              class="Iidentity">\mathit{InpExp}</span> \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">let-exp (var exp1 body)</span>} \\[5pt]
            \mathit{InpExp} &::= <span class="stt">letrec </span><span class="Iidentity">\{\mathit{Identifier}\ }<span
                class="stt">(</span><span class="Iidentity">\{\mathit{Identifier}\}^{*(,)}</span><span
                class="stt">)</span> = <span class="Iidentity">\mathit{InpExp}\</span>^{*}</span><span class="stt"> in
            </span><span class="Iidentity">\mathit{InpExp}</span> \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">letrec-exp (p-names b-varss p-bodies letrec-body)</span>}
            \\[5pt]
            \mathit{InpExp} &::= <span class="stt">proc (</span><span
              class="Iidentity">\mathit{\{Identifier\}^{*(,)}}</span><span class="stt">) </span><span
              class="Iidentity">\mathit{InpExp}</span> \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">proc-exp (vars body)</span>} \\[5pt]
            \mathit{InpExp} &::= <span class="stt">(</span><span class="Iidentity">\mathit{InpExp}</span><span
              class="stt"> </span><span class="Iidentity">\{\mathit{InpExp}\}^{*}</span><span class="stt">)</span>
            \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">call-exp (rator rands)</span>}\end{align*}</span>
        </p>
        <blockquote class="caption">
          <p>CPS-IN的语法
            <a name="(idx._(gentag._992))"></a><a name="(elem._fig-6..3)"></a>
          </p>
        </blockquote>
      </blockquote>
      <p>再回忆一下原则<span style="font-weight: bold">尾调用不扩大续文</span>：</p>
      <blockquote class="Tip">
        <blockquote class="SCentered">
          <p><span style="font-weight: bold">尾调用不扩大续文</span>
            <a name="(idx._(gentag._993))"></a>
            <a name="(idx._(gentag._994))"></a>
          </p>
        </blockquote>
        <p class="TipContent">若 <span class="texMathInline">exp_1</span> 的值作为 <span class="texMathInline">exp_2</span>
          的值返回，则
          <span class="texMathInline">exp_1</span> 和<span class="texMathInline">exp_2</span> 应在同样的续文中执行。
        </p>
      </blockquote>
      <p>若所有过程调用和所有包含过程调用的子表达式都在尾端，我们称一个表达式
        为<span class="emph">尾式</span> (<span class="emph">tail form</span>)。这个条件表明所有过程调用都不会产生控制上下文。</p>
      <p>因此，在 Scheme 中，</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <p><span class="RktPn">(</span><span class="RktSym">if</span><span class="hspace"> </span><span
                class="RktPn">(</span><span class="RktSym">zero?</span><span class="hspace"> </span><span
                class="RktSym">x</span><span class="RktPn">)</span><span class="hspace"> </span><span
                class="RktPn">(</span><span class="RktSym">f</span><span class="hspace"> </span><span
                class="RktSym">y</span><span class="RktPn">)</span><span class="hspace"> </span><span
                class="RktPn">(</span><span class="RktSym">g</span><span class="hspace"> </span><span
                class="RktSym">z</span><span class="RktPn">)</span><span class="RktPn">)</span></p>
          </blockquote>
        </blockquote>
        <p>是尾式，</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">if</span><span class="hspace"> </span><span
                    class="RktSym">b</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">y</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">g</span><span
                    class="hspace"> </span><span class="RktSym">z</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">h</span><span
                    class="hspace"> </span><span class="RktSym">u</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>也是尾式，但</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">+</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">zero?</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">y</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">g</span><span
                    class="hspace"> </span><span class="RktSym">z</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktVal">37</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>不是。因为 <span class="stt">if</span> 表达式包含一个不在尾端的过程调用。</p>
      </blockquote>
      <p>通常，要判定语言的尾端，我们必须理解其含义。处于尾端的子表达式具有如下性质：该表
        达式求值后，其值随即成为整个表达式的值。一个表达式可能有多个尾端。例如，<span class="stt">if</span>
        表达式可能选择真值分支，也可能选择假值分支。对尾端的子表达式，不需要保存信息，因
        此也就不会产生控制上下文。</p>
      <p>CPS-IN 中的尾端如<span class="EoplFigureRef"></span> 所示。尾端每个子表达式的值都可能成为整个表
        达式的值。在传递续文的解释器中，操作数位置的子表达式会产生新的续文。尾端的子表达
        式在原表达式的续文中求值，如<span class="stt">tail-call-explain</span>所述。
        <a name="(idx._(gentag._995))"></a>
      </p>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!t]</div>
        <div class="SIntrapara">
          <blockquote class="EoplEquationInset">
            <table cellspacing="0" cellpadding="0" class="SVerbatim">
              <tr>
                <td>
                  <p><span class="stt">zero?(</span><span class="texMathInline">O</span><span class="stt">)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">-(</span><span class="texMathInline">O</span><span class="stt">,</span><span
                      class="texMathInline">O</span><span class="stt">)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">if </span><span class="texMathInline">O</span><span class="stt"></span><span
                      class="hspace"> </span><span class="stt">then </span><span class="texMathInline">T</span><span
                      class="stt"></span><span class="hspace"> </span><span class="stt">else </span><span
                      class="texMathInline">T</span><span class="stt"></span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">let </span><span class="texMathInline">Var</span><span class="stt"></span><span
                      class="hspace"> </span><span class="stt">= </span><span class="texMathInline">O</span><span
                      class="stt"></span><span class="hspace"> </span><span class="stt">in </span><span
                      class="texMathInline">T</span><span class="stt"></span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">letrec </span><span class="texMathInline">\{Var \ <span
                        class="stt">(</span>\{Var\}^{*(,)}<span class="stt">)</span> \ <span class="stt">=</span> \
                      T\}^{*}</span><span class="stt"></span><span class="hspace"> </span><span class="stt">in
                    </span><span class="texMathInline">T</span><span class="stt"></span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">proc (</span><span class="texMathInline">\{Var\}^{*(,)}</span><span class="stt">)
                      = </span><span class="texMathInline">T</span><span class="stt"></span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt">(</span><span class="texMathInline">O</span><span class="stt"></span><span
                      class="hspace"> </span><span class="stt"></span><span class="texMathInline">O</span><span
                      class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                      class="texMathInline">...</span><span class="stt"></span><span class="hspace"> </span><span
                      class="stt"></span><span class="texMathInline">O</span><span class="stt">)</span></p>
                </td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <blockquote class="caption">
          <p>CPS-IN 中的尾端和操作数位置。尾端记为 <span class="texMathInline">T</span>。操作数位置
            记为 <span class="texMathInline">O</span>。<a name="(idx._(gentag._996))"></a><a name="(elem._fig-6..4)"></a>
          </p>
        </blockquote>
      </blockquote>
      <p><a name="(idx._(gentag._997))"></a>
        我们根据这种区别设计 CPS 转换算法的目标语言 CPS-OUT。这种语言的语法
        如<span class="EoplFigureRef"></span> 所示。这套语法定义了 CPS-IN 的子集，但略有不同。生成式的
        名字总以 <span class="stt">cps-</span> 开头，这样它们不会与 CPS-IN 中生成式的名字混淆。</p>
      <p><a name="(idx._(gentag._998))"></a>
        <a name="(idx._(gentag._999))"></a>
        新的语法有两个非终结符，<span class="texMathInline">\mathit{SimpleExp}</span> 和 <span
          class="texMathInline">\mathit{TfExp}</span>。这种设计中，
        <span class="texMathInline">\mathit{SimpleExp}</span> 表达式不包含任何过程调用，<span
          class="texMathInline">\mathit{TfExp}</span> 表达式一定是
        尾式。
      </p>
      <p>因为 <span class="texMathInline">\mathit{SimpleExp}</span> 表达式不包含任何过程调用，它们大致可以看成只有一行的
        简单代码，对我们来说，它们简单到不需使用控制堆栈。简单表达式包括 <span class="stt">proc</span> 表达
        式，因为 <span class="stt">proc</span> 表达式直接返回一个过程值，但过程的主体必须是尾式。
        <a name="(idx._(gentag._1000))"></a>
      </p>
      <p>尾表达式的传递续文解释器如<span class="EoplFigureRef"></span> 所示。由于这种语言的过程取多个参
        数，我们用<span class="EoplExerciseRef"></span> 中的 <span class="stt">extend-env*</span> 创建多个绑定，并用类似方式
        扩展 <span class="stt">extend-env-rec</span>，得到 <span class="stt">extend-env-rec*</span>。</p>
      <p>在这个解释器中，所有递归调用都在（Scheme 的）尾端，所以运行解释器不会在 Scheme
        中产生控制上下文（不全是这样：过程
        <span class="stt">value-of-simple-exp</span>（<span class="EoplExerciseRef"></span>）会在 Scheme 中产生控制上下文，
        但这可以避免（参见<span class="EoplExerciseRef"></span>））。
      </p>
      <p>更重要的是，解释器不会产生新的续文。过程 <span class="stt">value-of/k</span> 取一个续文参数，原封不
        动地传给每个递归调用。所以，我们可以很容易地移除续文参数。</p>
      <p>当然，没有通用的方式判断一个过程的控制行为是否是迭代式的。考虑</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">n</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">strange-predicate?</span><span class="hspace"> </span><span
                    class="RktSym">n</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">fact</span><span
                    class="hspace"> </span><span class="RktSym">n</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">fact-iter</span><span class="hspace"> </span><span class="RktSym">n</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>只有 <span class="stt">strange-predicate?</span> 对所有足够大的 <span class="stt">n</span> 都返回假时，这个过程才是迭代
          式的。但即使能查看 <span class="stt">strange-predicate?</span> 的代码，也可能无法判断这一条件的真假。
          因此，我们最多只能寄希望于程序中的过程调用不产生控制上下文，而不论其是否执行。
          <a name="(idx._(gentag._1001))"></a>
          <a name="(idx._(gentag._1002))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara"><br />
        </div>
        <div class="SIntrapara">
          <blockquote class="Small">
            <p><span class="Iidentity">\begin{align*}\mathit{Program} &::= \mathit{TfExp} \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-a-program (exp1)</span>} \\[5pt]
                \mathit{SimpleExp} &::= \mathit{Number} \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-const-exp (num)</span>} \\[5pt]
                \mathit{SimpleExp} &::= \mathit{Identifier} \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-var-exp (var)</span>} \\[5pt]
                \mathit{SimpleExp} &::= <span class="stt">(- </span><span
                  class="Iidentity">\mathit{SimpleExp}</span><span class="stt"> , </span><span
                  class="Iidentity">\mathit{SimpleExp}</span><span class="stt">)</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-diff-exp (simple1 simple2)</span>} \\[5pt]
                \mathit{SimpleExp} &::= <span class="stt">(zero? </span><span
                  class="Iidentity">\mathit{SimpleExp}</span><span class="stt">)</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-zero?-exp (simple1)</span>} \\[5pt]
                \mathit{SimpleExp} &::= <span class="stt">proc (</span><span
                  class="Iidentity">\mathit{\{Identifier\}^{*(,)}}</span><span class="stt">) </span><span
                  class="Iidentity">\mathit{TfExp}</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-proc-exp (vars body)</span>} \\[5pt]
                \mathit{TfExp} &::= <span class="Iidentity">\mathit{SimpleExp}</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">simple-exp->exp (simple-exp1)</span>} \\[5pt]
                \mathit{TfExp} &::= <span class="stt">let </span><span class="Iidentity">\mathit{Identifier}</span><span
                  class="stt"> = </span><span class="Iidentity">\mathit{SimpleExp}</span><span class="stt"> in
                </span><span class="Iidentity">\mathit{TfExp}</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-let-exp (var simple1 body)</span>} \\[5pt]
                \mathit{TfExp} &::= <span class="stt">letrec </span><span class="Iidentity">\{\mathit{Identifier}\
                  }<span class="stt">(</span><span class="Iidentity">\{\mathit{Identifier}\}^{*(,)}</span><span
                    class="stt">)</span> = <span class="Iidentity">\mathit{TfExp}\</span>^{*}</span><span class="stt">
                  in </span><span class="Iidentity">\mathit{TfExp}</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-letrec-exp (p-names b-varss p-bodies body)</span>}
                \\[5pt]
                \mathit{TfExp} &::= <span class="stt">if </span><span class="Iidentity">\mathit{SimpleExp}</span><span
                  class="stt"> then </span><span class="Iidentity">\mathit{TfExp}</span><span class="stt"> else
                </span><span class="Iidentity">\mathit{TfExp}</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-if-exp (simple1 body1 body2)</span>} \\[5pt]
                \mathit{TfExp} &::= <span class="stt">(</span><span class="Iidentity">\mathit{SimpleExp}</span><span
                  class="stt"> </span><span class="Iidentity">\{\mathit{SimpleExp}\}^{*}</span><span
                  class="stt">)</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">call-exp (rator rands)</span>}\end{align*}</span></p>
          </blockquote>
        </div>
        </p>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p>CPS-OUT 的语法
              <a name="(idx._(gentag._1003))"></a><a name="(elem._fig-6..5)"></a>
            </p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._1004))"></a></div>
        </p>
      </blockquote>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">value-of/k</span></span> : <span
                  class="texMathInline">\mathit{TfExp} \times \mathit{Env} \times \mathit{Cont} \to
                  \mathit{FinalAnswer}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">value-of/k</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">tfexp</span><span class="hspace"> </span><span
                  class="RktSym">exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">simple-exp->exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">simple</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">apply-cont</span><span class="hspace"> </span><span class="RktSym">cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">value-of-simple-exp</span><span class="hspace"> </span><span
                  class="RktSym">simple</span><span class="hspace"> </span><span class="RktSym">env</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">cps-let-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">var</span><span class="hspace"> </span><span class="RktSym">rhs</span><span
                  class="hspace"> </span><span class="RktSym">body</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">val</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">value-of-simple-exp</span><span class="hspace"> </span><span
                  class="RktSym">rhs</span><span class="hspace"> </span><span class="RktSym">env</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">body</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">extend-env</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">var</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">val</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktSym">env</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktSym">cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">cps-letrec-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">p-names</span><span class="hspace"> </span><span class="RktSym">b-varss</span><span
                  class="hspace"> </span><span class="RktSym">p-bodies</span><span class="hspace"> </span><span
                  class="RktSym">letrec-body</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">letrec-body</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">extend-env-rec**</span><span class="hspace"> </span><span
                  class="RktSym">p-names</span><span class="hspace"> </span><span class="RktSym">b-varss</span><span
                  class="hspace"> </span><span class="RktSym">p-bodies</span><span class="hspace"> </span><span
                  class="RktSym">env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktSym">cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">cps-if-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">simple1</span><span class="hspace"> </span><span class="RktSym">body1</span><span
                  class="hspace"> </span><span class="RktSym">body2</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">expval->bool</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">value-of-simple-exp</span><span class="hspace"> </span><span
                  class="RktSym">simple1</span><span class="hspace"> </span><span class="RktSym">env</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">body1</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">body2</span><span
                  class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">cps-call-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">rator</span><span class="hspace"> </span><span class="RktSym">rands</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                  class="RktSym">rator-proc</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                </span><span class="RktPn">(</span><span
                  class="RktSym">expval->proc</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                  </span><span class="RktPn">(</span><span
                  class="RktSym">value-of-simple-exp</span><span class="hspace"> </span><span
                  class="RktSym">rator</span><span class="hspace"> </span><span class="RktSym">env</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">               </span><span class="RktPn">(</span><span
                  class="RktSym">rand-vals</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                 </span><span class="RktPn">(</span><span
                  class="RktSym">map</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                   </span><span class="RktPn">(</span><span
                  class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">simple</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                     </span><span class="RktPn">(</span><span
                  class="RktSym">value-of-simple-exp</span><span class="hspace"> </span><span
                  class="RktSym">simple</span><span class="hspace"> </span><span class="RktSym">env</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">                   </span><span class="RktSym">rands</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">apply-procedure/k</span><span class="hspace"> </span><span
                  class="RktSym">rator-proc</span><span class="hspace"> </span><span
                  class="RktSym">rand-vals</span><span class="hspace"> </span><span class="RktSym">cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">apply-procedure/k</span></span> : <span
                  class="texMathInline">\mathit{Proc} \times \mathit{ExpVal} \times \mathit{Cont} \to
                  \mathit{ExpVal}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">apply-procedure/k</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">proc1</span><span
                  class="hspace"> </span><span class="RktSym">args</span><span class="hspace"> </span><span
                  class="RktSym">cont</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">proc</span><span class="hspace"> </span><span
                  class="RktSym">proc1</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">procedure</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">vars</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktSym">saved-env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">body</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">extend-env*</span><span class="hspace"> </span><span class="RktSym">vars</span><span
                  class="hspace"> </span><span class="RktSym">args</span><span class="hspace"> </span><span
                  class="RktSym">saved-env</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktSym">cont</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <p>
        <div class="SIntrapara">
          <blockquote class="caption">
            <p>CPS-OUT 中的尾式解释器<a name="(elem._fig-6..6)"></a></p>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._1005))"></a></div>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..11)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>写出 <span class="stt">value-of-simple-exp</span>，完成<span class="EoplFigureRef"></span>
          中的解释器。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..12)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>判断下列表达式是否是简单的。</p>
        <ol>
          <li>
            <p><span class="stt">-((f -(x,1)),1)</span></p>
          </li>
          <li>
            <p><span class="stt">(f -(-(x,y),1))</span></p>
          </li>
          <li>
            <p><span class="stt">if zero?(x) then -(x,y) else -(-(x,y),1)</span></p>
          </li>
          <li>
            <p><span class="stt">let x = proc (y) (y x) in -(x,3)</span></p>
          </li>
          <li>
            <p><span class="stt">let f = proc (x) x in (f 3)</span></p>
          </li>
        </ol>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..13)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>用上面<span class="stt">cps-recipe</span>的 CPS 秘方，把下列 CPS-IN 表达式翻译为续文传递风格。
          用<span class="EoplFigureRef"></span> 中的解释器运行转换后的程序，测试它们，确保原程序和转换后
          的版本对所有输入都给出同样的结果。</p>
        <ol>
          <li>
            <p><span class="stt">removeall</span>。</p>
            <blockquote class="EoplCodeInset">
              <table cellspacing="0" cellpadding="0" class="SVerbatim">
                <tr>
                  <td>
                    <p><span class="stt">letrec</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace"> </span><span class="stt">removeall(n,s) =</span>
                    </p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">if null?(s)</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">then emptylist</span>
                    </p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">else if
                        number?(car(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">       </span><span class="stt">then if
                        equal?(n,car(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">            </span><span class="stt">then
                        (removeall n cdr(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">            </span><span class="stt">else
                        cons(car(s),</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">                      </span><span
                        class="stt">(removeall n cdr(s)))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">       </span><span class="stt">else
                        cons((removeall n car(s)),</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">                 </span><span
                        class="stt">(removeall n cdr(s)))</span></p>
                  </td>
                </tr>
              </table>
            </blockquote>
          </li>
          <li>
            <p><span class="stt">occurs-in?</span>。</p>
            <blockquote class="EoplCodeInset">
              <table cellspacing="0" cellpadding="0" class="SVerbatim">
                <tr>
                  <td>
                    <p><span class="stt">letrec</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace"> </span><span class="stt">occurs-in?(n,s) =</span>
                    </p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">if null?(s)</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">then 0</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">else if
                        number?(car(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">       </span><span class="stt">then if
                        equal?(n,car(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">            </span><span class="stt">then 1</span>
                    </p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">            </span><span class="stt">else
                        (occurs-in? n cdr(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">       </span><span class="stt">else if (occurs-in?
                        n car(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">            </span><span class="stt">then 1</span>
                    </p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">            </span><span class="stt">else
                        (occurs-in? n cdr(s))</span></p>
                  </td>
                </tr>
              </table>
            </blockquote>
          </li>
          <li>
            <p><span class="stt">remfirst</span>。它使用前面例子中的 <span class="stt">occurs-in?</span>。</p>
            <blockquote class="EoplCodeInset">
              <table cellspacing="0" cellpadding="0" class="SVerbatim">
                <tr>
                  <td>
                    <p><span class="stt">letrec</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace"> </span><span class="stt">remfirst(n,s) =</span>
                    </p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">letrec</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">   </span><span class="stt">loop(s) =</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">    </span><span class="stt">if null?(s)</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">    </span><span class="stt">then emptylist</span>
                    </p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">    </span><span class="stt">else if
                        number?(car(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">         </span><span class="stt">then if
                        equal?(n,car(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">              </span><span class="stt">then
                        cdr(s)</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">              </span><span class="stt">else
                        cons(car(s),(loop cdr(s)))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">         </span><span class="stt">else if
                        (occurs-in? n car(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">              </span><span class="stt">then
                        cons((remfirst n car(s)),</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">                        </span><span
                        class="stt">cdr(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">              </span><span class="stt">else
                        cons(car(s),</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">                        </span><span
                        class="stt">(remfirst n cdr(s)))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">in (loop s)</span></p>
                  </td>
                </tr>
              </table>
            </blockquote>
          </li>
          <li>
            <p><span class="stt">depth</span>。</p>
            <blockquote class="EoplCodeInset">
              <table cellspacing="0" cellpadding="0" class="SVerbatim">
                <tr>
                  <td>
                    <p><span class="stt">letrec</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace"> </span><span class="stt">depth(s) =</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">if null?(s)</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">then 1</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">else if
                        number?(car(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">       </span><span class="stt">then (depth
                        cdr(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">       </span><span class="stt">else if
                        less?(add1((depth car(s))),</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">                     </span><span
                        class="stt">(depth cdr(s)))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">            </span><span class="stt">then (depth
                        cdr(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">            </span><span class="stt">else
                        add1((depth car(s)))</span></p>
                  </td>
                </tr>
              </table>
            </blockquote>
          </li>
          <li>
            <p><span class="stt">depth-with-let</span>。</p>
            <blockquote class="EoplCodeInset">
              <table cellspacing="0" cellpadding="0" class="SVerbatim">
                <tr>
                  <td>
                    <p><span class="stt">letrec</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace"> </span><span class="stt">depth(s) =</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">if null?(s)</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">then 1</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">else if
                        number?(car(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">       </span><span class="stt">then (depth
                        cdr(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">       </span><span class="stt">else let dfirst =
                        add1((depth car(s)))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">                </span><span class="stt">drest =
                        (depth cdr(s))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">            </span><span class="stt">in if
                        less?(dfirst,drest)</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">               </span><span class="stt">then
                        drest</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">               </span><span class="stt">else
                        dfirst</span></p>
                  </td>
                </tr>
              </table>
            </blockquote>
          </li>
          <li>
            <p><span class="stt">map</span>。</p>
            <blockquote class="EoplCodeInset">
              <table cellspacing="0" cellpadding="0" class="SVerbatim">
                <tr>
                  <td>
                    <p><span class="stt">letrec</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace"> </span><span class="stt">map(f, l) = if
                        null?(l)</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">             </span><span class="stt">then
                        emptylist</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">             </span><span class="stt">else cons((f
                        car(l)),</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">                       </span><span
                        class="stt">(map f cdr(l)))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace"> </span><span class="stt">square(n) = *(n,n)</span>
                    </p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt">in (map square list(1,2,3,4,5))</span></p>
                  </td>
                </tr>
              </table>
            </blockquote>
          </li>
          <li>
            <p><span class="stt">fnlrgtn</span>。n-list 类似 s-list（<span class="stt">s-list</span>），只不过其中的元素不
              是符号，而是数字。<span class="stt">fnlrgtn</span> 取一 n-list，一个数字 <span class="stt">n</span>，返回列表中（从左向
              右数）第一个大于 <span class="stt">n</span> 的数字。一旦找到结果，就不再检查列表中剩余元素。例如，</p>
            <blockquote class="EoplCodeInset">
              <table cellspacing="0" cellpadding="0" class="SVerbatim">
                <tr>
                  <td>
                    <p><span class="stt">(fnlrgtn list(1,list(3,list(2),7,list(9)))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace"> </span><span class="stt">6)</span></p>
                  </td>
                </tr>
              </table>
            </blockquote>
            <p>返回 7。</p>
          </li>
          <li>
            <p><span class="stt">every</span>。这个过程取一谓词，一个列表，当且仅当谓词对列表中所有元素都为
              真时，返回真。</p>
            <blockquote class="EoplCodeInset">
              <table cellspacing="0" cellpadding="0" class="SVerbatim">
                <tr>
                  <td>
                    <p><span class="stt">letrec</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace"> </span><span class="stt">every(pred, l) =</span>
                    </p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">if null?(l)</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">then 1</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">  </span><span class="stt">else if (pred
                        car(l))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">       </span><span class="stt">then (every pred
                        cdr(l))</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt"></span><span class="hspace">       </span><span class="stt">else 0</span></p>
                  </td>
                </tr>
                <tr>
                  <td>
                    <p><span class="stt">in (every proc(n) greater?(n,5) list(6,7,8,9))</span></p>
                  </td>
                </tr>
              </table>
            </blockquote>
          </li>
        </ol>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..14)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>补充 <span class="stt">value-of-program</span> 和 <span
            class="stt">apply-cont</span>，完成<span class="EoplFigureRef"></span> 中的解释
          器。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..15)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>观察前一道练习中的解释器可知，<span class="stt">cont</span> 只有一个值。根据这一观察完全移除
          <span class="stt">cont</span> 参数。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..16)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._1006))"></a>
          寄存<span class="EoplFigureRef"></span> 中的解释器。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..17)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._1007))"></a>
          把<span class="EoplFigureRef"></span> 中的解释器转换为跳跃式。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..18)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>修改
          CPS-OUT 的语法，把简单 <span class="stt">diff-exp</span> 和 <span class="stt">zero?-exp</span> 的参数限制为常量和变
          量。这样，语言中的 <span class="stt">value-of-simple-exp</span> 就不必递归。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..19)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>写出
          Scheme 过程 <span class="stt">tail-form?</span>，它取一 CPS-IN 程序的语法树，语法
          如<span class="EoplFigureRef"></span> 所示，判断同一字符串是否是<span class="EoplFigureRef"></span> 中语法定义
          的尾式。</p>
      </blockquote>
      <h4>6.3<tt> </tt><a name="(part._s6..3)"></a>转换为续文传递风格</h4>
      <p><a name="(idx._(gentag._1008))"></a>
        <a name="(idx._(gentag._1009))"></a>
        本节，我们开发算法，将任意程序从 CPS-IN 转换为 CPS-OUT。
      </p>
      <p>就像传递续文的解释器一样，我们的翻译器<span class="emph">跟随语法</span>。也像传递续文的解释器一样，
        我们的翻译器再取一个表示续文的参数。多出的这个参数是一个表示续文的简单表达式。</p>
      <p>像之前那样，我们首先给出例子，然后提出规范，最后写出程序。<span class="EoplFigureRef"></span>
        展示了与前一节类似的 Scheme 例子，只是更加详细。</p>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!ht]
        </div>
        <div class="SIntrapara">
          <blockquote class="EoplCodeInset">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym">x</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">cond</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                      class="RktSym">zero?</span><span class="hspace"> </span><span class="RktSym">x</span><span
                      class="RktPn">)</span><span class="hspace"> </span><span class="RktVal">17</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                      class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                      class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                        class="nobreak">-</span></span><span class="hspace"> </span><span class="RktSym">x</span><span
                      class="hspace"> </span><span class="RktVal">13</span><span class="RktPn">)</span><span
                      class="hspace"> </span><span class="RktVal">7</span><span class="RktPn">)</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                      class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                      class="hspace"> </span><span class="RktVal">2</span><span class="RktPn">)</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">+</span><span
                      class="hspace"> </span><span class="RktVal">22</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym"><span class="nobreak">-</span></span><span
                      class="hspace"> </span><span class="RktSym">x</span><span class="hspace"> </span><span
                      class="RktVal">3</span><span class="RktPn">)</span><span class="hspace"> </span><span
                      class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                      class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                      class="hspace"> </span><span class="RktVal">3</span><span class="RktPn">)</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">+</span><span
                      class="hspace"> </span><span class="RktVal">22</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym">f</span><span class="hspace"> </span><span
                      class="RktSym">x</span><span class="RktPn">)</span><span class="hspace"> </span><span
                      class="RktVal">37</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                      class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                      class="hspace"> </span><span class="RktVal">4</span><span class="RktPn">)</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">g</span><span
                      class="hspace"> </span><span class="RktVal">22</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym">f</span><span class="hspace"> </span><span
                      class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                      class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                      class="hspace"> </span><span class="RktVal">5</span><span class="RktPn">)</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">+</span><span
                      class="hspace"> </span><span class="RktVal">22</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym">f</span><span class="hspace"> </span><span
                      class="RktSym">x</span><span class="RktPn">)</span><span class="hspace"> </span><span
                      class="RktVal">33</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">g</span><span class="hspace"> </span><span class="RktSym">y</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">else</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">h</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                      class="hspace"> </span><span class="RktSym">x</span><span class="RktPn">)</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                        class="nobreak">-</span></span><span class="hspace"> </span><span class="RktVal">44</span><span
                      class="hspace"> </span><span class="RktSym">y</span><span class="RktPn">)</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">g</span><span
                      class="hspace"> </span><span class="RktSym">y</span><span class="RktPn">)</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span></td>
                </tr>
              </table>
            </blockquote>
          </blockquote>
        </div>
        </p>
        <p>变换为</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">x</span><span class="hspace"> </span><span
                    class="RktSym">k</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">cond</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">zero?</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">k</span><span class="hspace"> </span><span class="RktVal">17</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">1</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                      class="nobreak">-</span></span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">13</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktVal">7</span><span class="hspace"> </span><span
                    class="RktSym">k</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">2</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">k</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">+</span><span
                    class="hspace"> </span><span class="RktVal">22</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym"><span class="nobreak">-</span></span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="hspace"> </span><span
                    class="RktVal">3</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="RktSym">x</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">3</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">v1</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">k</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">+</span><span
                    class="hspace"> </span><span class="RktVal">22</span><span class="hspace"> </span><span
                    class="RktSym">v1</span><span class="hspace"> </span><span class="RktVal">37</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">4</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">v1</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">g</span><span
                    class="hspace"> </span><span class="RktVal">22</span><span class="hspace"> </span><span
                    class="RktSym">v1</span><span class="hspace"> </span><span class="RktSym">k</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">=</span><span class="hspace"> </span><span class="RktSym">x</span><span
                    class="hspace"> </span><span class="RktVal">5</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">v1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                    </span><span class="RktPn">(</span><span
                    class="RktSym">g</span><span class="hspace"> </span><span class="RktSym">y</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">v2</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                           </span><span class="RktPn">(</span><span
                    class="RktSym">k</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">+</span><span class="hspace"> </span><span class="RktVal">22</span><span
                    class="hspace"> </span><span class="RktSym">v1</span><span class="hspace"> </span><span
                    class="RktVal">33</span><span class="hspace"> </span><span class="RktSym">v2</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">else</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">f</span><span
                    class="hspace"> </span><span class="RktSym">x</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">lambda</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">v1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                   </span><span class="RktPn">(</span><span
                    class="RktSym">g</span><span class="hspace"> </span><span class="RktSym">y</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">v2</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                          </span><span class="RktPn">(</span><span
                    class="RktSym">h</span><span class="hspace"> </span><span class="RktSym">v1</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym"><span
                      class="nobreak">-</span></span><span class="hspace"> </span><span class="RktVal">44</span><span
                    class="hspace"> </span><span class="RktSym">y</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktSym">v2</span><span class="hspace"> </span><span
                    class="RktSym">k</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <blockquote class="caption">
          <p>CPS 变换示例（Scheme）<a name="(elem._fig-6..7)"></a></p>
        </blockquote>
      </blockquote>
      <p>第一种情况是常量。常量直接传给续文，就像上面 <span class="stt">(zero? x)</span> 这一行。</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(cps-of-exp </span><span class="texMathInline">n</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">K</span><span class="stt">) = (</span><span
                    class="texMathInline">K</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">n</span><span class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>其中，<span class="texMathInline">K</span> 表示续文，是一个 simple-exp。</p>
      </blockquote>
      <p>同样，变量直接传给续文。</p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(cps-of-exp </span><span class="texMathInline">var</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">K</span><span class="stt">) = (</span><span class="texMathInline">K</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                  class="texMathInline">var</span><span class="stt">)</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>当然，我们算法的输入输出都是抽象语法树，所以我们应该用抽象语法构造器，而不是具体
        语法，就像：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(cps-of-exp (const-exp </span><span class="texMathInline">n</span><span
                    class="stt">) </span><span class="texMathInline">K</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (make-send-to-cont </span><span class="texMathInline">K</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">(cps-const-exp </span><span
                    class="texMathInline">n</span><span class="stt">))</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(cps-of-exp (var-exp </span><span class="texMathInline">var</span><span
                    class="stt">) </span><span class="texMathInline">K</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (make-send-to-cont </span><span class="texMathInline">K</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">(cps-var-exp </span><span
                    class="texMathInline">var</span><span class="stt">))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>其中：</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">make-send-to-cont</span></span> : <span
                    class="texMathInline">\mathit{SimpleExp} \times \mathit{SimpleExp} \to \mathit{TfExp}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">make-send-to-cont</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">k-exp</span><span
                    class="hspace"> </span><span class="RktSym">simple-exp</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">cps-call-exp</span><span class="hspace"> </span><span
                    class="RktSym">k-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">simple-exp</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>我们需要 <span class="stt">list</span>，因为在 CPS-OUT 中，每个调用表达式都取一个操作数列表。</p>
      </blockquote>
      <p>但是在规范中，我们仍然使用具体语法，因为具体语法通常更容易读懂。</p>
      <p><a name="(idx._(gentag._1010))"></a>
        <a name="(idx._(gentag._1011))"></a>
        过程呢？我们转换<span class="EoplFigureRef"></span> 中那样的 <span class="stt">(lambda (x) ...)</span> 过程时，为其
        新增一个参数 <span class="stt">k</span>，然后转换主体，并将主体的值传给续文 <span class="stt">k</span>。我们
        在<span class="EoplFigureRef"></span> 中正是这样做的。所以
      </p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">proc (</span><span class="texMathInline">var_1</span><span class="stt">, ...,
                  </span><span class="texMathInline">var_n</span><span class="stt">) </span><span
                    class="texMathInline">exp</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>变成：</p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">proc (</span><span class="texMathInline">var_1</span><span class="stt">, ...,
                  </span><span class="texMathInline">var_n</span><span class="stt">, k) (cps-of-exp </span><span
                    class="texMathInline">exp</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt">k)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>就像图中那样。但是，这还没完。我们的目标是生成代码，求 <span class="stt">proc</span> 表达式的值，并
          将结果传给续文 <span class="texMathInline">K</span>。所以 <span class="stt">proc</span> 表达式的完整规范为：</p>
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(cps-of-exp <<proc (</span><span class="texMathInline">var_1</span><span
                        class="stt">, ..., </span><span class="texMathInline">var_n</span><span class="stt">)
                      </span><span class="texMathInline">exp</span><span class="stt">>> </span><span
                        class="texMathInline">K</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (</span><span class="texMathInline">K</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt">
                    <<proc (</span><span class="texMathInline">var_1</span><span class="stt">, ..., </span><span
                        class="texMathInline">var_n</span><span class="stt">, k) (cps-of-exp </span><span
                        class="texMathInline">exp</span><span class="stt"></span><span class="hspace"> </span><span
                        class="stt">k)>>)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p>其中，<span class="stt">k</span> 是新变量，<span class="texMathInline">K</span> 表示续文，是任意简单表达式。</p>
      <p><a name="(idx._(gentag._1012))"></a>
        有操作数的表达式呢？我们暂时给语言添加任意多个操作数的求和表达式。要添加这种表达
        式，我们给 CPS-IN 的语法添加生成式：</p>
      <blockquote class="Small">
        <p><span class="Iidentity">\begin{align*}\mathit{InpExp} &::= <span class="stt">+(</span><span
              class="Iidentity">\mathit{\{InpExp\}^{*(,)}}</span><span class="stt">)</span> \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">sum-exp (exps)</span>}\end{align*}</span></p>
      </blockquote>
      <p>给 CPS-OUT 的语法添加生成式：</p>
      <blockquote class="Small">
        <p><span class="Iidentity">\begin{align*}\mathit{SimpleExp} &::= <span class="stt">+(</span><span
              class="Iidentity">\mathit{\{SimpleExp\}^{*(,)}}</span><span class="stt">)</span> \\[-3pt]
            &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-sum-exp (simple-exps)</span>}\end{align*}</span></p>
      </blockquote>
      <p>这个新生成式仍保持性质：简单表达式内不会出现过程调用。</p>
      <p><span class="stt">(cps-of-exp </span><span class="texMathInline">\textnormal{\guillemotleft}</span><span
          class="stt">+(</span><span class="texMathInline">exp_1</span><span class="stt">, ...,</span><span class="stt">
        </span><span class="texMathInline">exp_n</span><span class="stt">)</span><span
          class="texMathInline">\textnormal{\guillemotright}</span><span class="stt"> </span><span
          class="texMathInline">K</span><span class="stt">)</span> 可能是什么呢？可能 <span class="texMathInline">exp_1</span>,
        <span class="texMathInline">\dots</span>, <span class="texMathInline">exp_n</span> 都是简单的，就像<span
          class="EoplFigureRef"></span> 中的 <span class="stt">(= x 2)</span>。那
        么，整个表达式都是简单的，我们可以将它的值接传给续文。设 <span class="texMathInline">simp</span> 为一简单表达式，
        那么有：
      </p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(cps-of-exp <<+(< /span><span class="texMathInline">simp_1</span><span class="stt">,
                      ..., </span><span class="texMathInline">simp_n</span><span class="stt">)>> </span><span
                      class="texMathInline">K</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (</span><span class="texMathInline">K</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt">
                  <<+(< /span><span class="texMathInline">simp_1</span><span class="stt">, ..., </span><span
                      class="texMathInline">simp_n</span><span class="stt">)>>)</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>如果操作数不是简单的呢？那么求值续文需要给其值命名，然后继续求和，就像上面
        <span class="stt">(= x 3)</span> 这行。其中的第二个是首个复杂操作数。那么我们的 CPS 转换器应具有性质：
      </p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(cps-of-exp <<+(< /span><span class="texMathInline">simp_1</span><span class="stt">,
                    </span><span class="texMathInline">exp_2</span><span class="stt">, </span><span
                      class="texMathInline">simp_3</span><span class="stt">, ..., </span><span
                      class="texMathInline">simp_n</span><span class="stt">)>> </span><span
                      class="texMathInline">K</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (cps-of-exp </span><span class="texMathInline">exp_2</span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                  <<proc (</span><span class="texMathInline">var_2</span><span class="stt">) (</span><span
                      class="texMathInline">K</span><span class="stt"></span><span class="hspace"> </span><span
                      class="stt">+(</span><span class="texMathInline">simp_1</span><span class="stt">, </span><span
                      class="texMathInline">var_2</span><span class="stt">, </span><span
                      class="texMathInline">simp_3</span><span class="stt">, ..., </span><span
                      class="texMathInline">simp_n</span><span class="stt">))>>)</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>如果 <span class="texMathInline">exp_2</span> 只是一个过程调用，那么输出和图中相同。但 <span class="texMathInline">exp_2</span>
        可能更复杂，所
        以我们递归调用 <span class="stt">cps-of-exp</span> 处理 <span class="texMathInline">exp_2</span> 和更大的续文：</p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">proc (</span><span class="texMathInline">var_2</span><span class="stt">)
                  (</span><span class="texMathInline">K</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt">+(</span><span class="texMathInline">simp_1</span><span
                  class="stt">, </span><span class="texMathInline">var_2</span><span class="stt">, </span><span
                  class="texMathInline">simp_3</span><span class="stt">, ..., </span><span
                  class="texMathInline">simp_n</span><span class="stt">))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>而求和表达式中，还有另一种复杂操作数，就像 <span class="stt">(= x 5)</span> 这种。所以，不是直接使用
        续文</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">proc (</span><span class="texMathInline">var_2</span><span class="stt">)
                    (</span><span class="texMathInline">K</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt">+(</span><span class="texMathInline">simp_1</span><span
                    class="stt">, </span><span class="texMathInline">var_2</span><span class="stt">, ..., </span><span
                    class="texMathInline">simp_n</span><span class="stt">))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>我们还要递归处理更大的参数。我们可以把这条规则总结为：</p>
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(cps-of-exp <<+(< /span><span class="texMathInline">simp_1</span><span
                        class="stt">, </span><span class="texMathInline">exp_2</span><span class="stt">, </span><span
                        class="texMathInline">exp_3</span><span class="stt">, ..., </span><span
                        class="texMathInline">exp_n</span><span class="stt">)>> </span><span
                        class="texMathInline">K</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (cps-of-exp </span><span class="texMathInline">exp_2</span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                    <<proc (</span><span class="texMathInline">var_2</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">       </span><span class="stt">(cps-of-exp <<+(<
                      /span><span class="texMathInline">simp_1</span><span class="stt">, </span><span
                        class="texMathInline">var_2</span><span class="stt">, </span><span
                        class="texMathInline">exp_3</span><span class="stt">, ..., </span><span
                        class="texMathInline">exp_n</span><span class="stt">))>> </span><span
                        class="texMathInline">K</span><span class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <p><span class="stt">cps-of-exp</span> 的每个递归调用都保证会终止。第一个调用会终止是因为 <span class="texMathInline">exp_2</span> 比
        原表达式小。第二个调用会终止是还是因为其参数也比原来的小：<span class="texMathInline">var_2</span> 总是比
        <span class="texMathInline">exp_2</span> 小。
      </p>
      <p>例如，查看 <span class="stt">(= x 5)</span> 这一行，并使用 CPS-IN 的语法，我们有：</p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(cps-of-exp <<+((f x), 33, (g y))>> </span><span class="texMathInline">K</span><span
                  class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (cps-of-exp <<(f x)>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                  <<proc (</span><span class="texMathInline">v1</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">(cps-of-exp <<+(v1, 33,
                    (g y))>> </span><span class="texMathInline">K</span><span class="stt">)>>)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (cps-of-exp <<(f x)>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                  <<proc (</span><span class="texMathInline">v1</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">(cps-of-exp <<(g y)>
                    ></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">         </span><span class="stt">
                  <<proc </span><span class="texMathInline">v2</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">            </span><span class="stt">(cps-of-exp <<+(v1,
                    33, v2)>> </span><span class="texMathInline">K</span><span class="stt">)))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (cps-of-exp <<(f x)>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                  <<proc (</span><span class="texMathInline">v1</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">(cps-of-exp <<(g y)>
                    ></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">         </span><span class="stt">
                  <<proc </span><span class="texMathInline">v2</span><span class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">            </span><span class="stt">(</span><span
                  class="texMathInline">K</span><span class="stt"></span><span class="hspace"> </span><span class="stt">
                  <<+(v1, 33, v2)>>)))
                </span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (f x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">   </span><span class="stt">proc (v1)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(g y</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">     </span><span class="stt">proc (v2)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(</span><span
                  class="texMathInline">K</span><span class="stt"></span><span class="hspace"> </span><span class="stt">
                  <<+(v1, 33, v2)>>)))
                </span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p><a name="(idx._(gentag._1013))"></a>
        过程调用与之类似。如果操作符和操作数都是简单的，那么我们添加续文参数，直接调用过
        程，就像 <span class="stt">(= x 2)</span> 这行。</p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(cps-of-exp <<(< /span><span class="texMathInline">simp_0</span><span
                      class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                      class="texMathInline">simp_1</span><span class="stt"></span><span class="hspace"> </span><span
                      class="stt">... </span><span class="texMathInline">simp_n</span><span class="stt">)>> </span><span
                      class="texMathInline">K</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (</span><span class="texMathInline">simp_0</span><span class="stt"></span><span
                  class="hspace"> </span><span class="stt"></span><span class="texMathInline">simp_1</span><span
                  class="stt"></span><span class="hspace"> </span><span class="stt">... </span><span
                  class="texMathInline">simp_n</span><span class="stt"></span><span class="hspace"> </span><span
                  class="stt"></span><span class="texMathInline">K</span><span class="stt">)</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>另一方面，如果某个操作数是复杂的，那么我们必须先求它的值，像 <span class="stt">(= x 4)</span> 这行。</p>
      <blockquote class="EoplEquationInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(cps-of-exp <<(< /span><span class="texMathInline">simp_0</span><span
                      class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                      class="texMathInline">simp_1</span><span class="stt"></span><span class="hspace"> </span><span
                      class="stt"></span><span class="texMathInline">exp_2</span><span class="stt"></span><span
                      class="hspace"> </span><span class="stt"></span><span class="texMathInline">exp_3</span><span
                      class="stt"></span><span class="hspace"> </span><span class="stt">... </span><span
                      class="texMathInline">exp_n</span><span class="stt">)>> </span><span
                      class="texMathInline">K</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (cps-of-exp </span><span class="texMathInline">exp_2</span><span
                  class="stt"></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                  <<proc (</span><span class="texMathInline">var_2</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">(cps-of-exp <<(< /span>
                    <span class="texMathInline">simp_0</span><span class="stt"></span><span class="hspace"> </span><span
                      class="stt"></span><span class="texMathInline">simp_1</span><span class="stt"></span><span
                      class="hspace"> </span><span class="stt"></span><span class="texMathInline">var_2</span><span
                      class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                      class="texMathInline">exp_3</span><span class="stt"></span><span class="hspace"> </span><span
                      class="stt">... </span><span class="texMathInline">exp_n</span><span class="stt">)>> </span><span
                      class="texMathInline">K</span><span class="stt">)>>)</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>而且，像之前那样，<span class="stt">cps-of-exp</span> 的第二个调用递归进入过程调用之中，为每个复杂参
        数调用 <span class="stt">cps-of-exp</span>，直到所有参数都是简单参数。</p>
      <p>写成 CPS-IN 的例子 <span class="stt">(= x 5)</span> 可用这些规则处理如下：</p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(cps-of-exp <<(h (f x) -(44,y) (g y))>> </span><span
                  class="texMathInline">K</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (cps-of-exp <<(f x)>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                  <<proc (v1)</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">(cps-of-exp <<(h v1
                    -(44,y) (g y))>> </span><span class="texMathInline">K</span><span class="stt">)>>)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (f x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">   </span><span class="stt">proc (v1)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(cps-of-exp <<(h v1 -(44,y)
                    (g y))>> </span><span class="texMathInline">K</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (f x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">   </span><span class="stt">proc (v1)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(cps-of-exp <<(g y)>></span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">
                  <<proc (v2)</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">         </span><span class="stt">(cps-of-exp <<(h v1
                    -(44,y) v2)>> </span><span class="texMathInline">K</span><span class="stt">)))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (f x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">   </span><span class="stt">proc (v1)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(g y</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">     </span><span class="stt">proc (v2)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(cps-of-exp <<(h v1
                    -(44,y) v2)>> </span><span class="texMathInline">K</span><span class="stt">)))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (f x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">   </span><span class="stt">proc (v1)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(g y</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">     </span><span class="stt">proc (v2)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">(h v1 -(44,y) v2
                </span><span class="texMathInline">K</span><span class="stt">)))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>求和表达式和过程调用的规范遵循同样的模式：找出第一个复杂操作数，递归处理那个操作
        数和修改过的操作数列表。这对任何求值操作数的表达式都有效。如果 <span class="stt">complex-exp</span>
        是某个需要求值操作数的 CPS-IN 表达式，那么我们有：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(cps-of-exp (complex-exp </span><span class="texMathInline">simp_0</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">simp_1</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">exp_2</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">exp_3</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">... </span><span
                    class="texMathInline">exp_n</span><span class="stt">) </span><span
                    class="texMathInline">K</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (cps-of-exp </span><span class="texMathInline">exp_2</span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                    <<proc (</span><span class="texMathInline">var_2</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">       </span><span class="stt">(cps-of-exp</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">         </span><span class="stt">(complex-exp
                  </span><span class="texMathInline">simp_0</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">simp_1</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">exp_2</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">exp_3</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt">... </span><span class="texMathInline">exp_n</span><span
                    class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">         </span><span class="stt"></span><span
                    class="texMathInline">K</span><span class="stt">)>>)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>其中，<span class="texMathInline">var_2</span> 是一个新变量。</p>
      </blockquote>
      <p>处理求和表达式和过程调用的唯一不同之处是在所有参数都简单时。在这种情况下，我们要
        把每个参数转换为 CPS-OUT 中的 <span class="stt">simple-exp</span>，并用转换结果生成一个尾式。</p>
      <p>我们可以把这种行为封装到过程 <span class="stt">cps-of-exps</span> 中，如<span class="EoplFigureRef"></span> 所示。
        它的参数是输入表达式的列表和过程 <span class="stt">builder</span>。它用<span class="EoplExerciseRef"></span> 中的
        <span class="stt">list-index</span>，找出列表中第一个复杂表达式的位置。如果有这样的复杂表达式，那么
        它转换该表达式，转换所在的续文给表达式的结果命名（绑定到 <span class="stt">var</span> 的标识符），然
        后递归处理修改后的表达式列表。
      </p>
      <p>如果不存在复杂表达式，那么我们用 <span class="stt">builder</span> 处理表达式列表。但这些表达式虽是简
        单的，它们仍属于 CPS-IN 的语法。因此，我们用过程 <span class="stt">cps-of-simple-exp</span> 把每个表
        达式转换为 CPS-OUT 的语法。然后，我们把 <span class="texMathInline">\mathit{SimpleExp}</span> 的列表传给
        <span class="stt">builder</span>（<span class="stt">list-set</span> 如<span class="EoplExerciseRef"></span> 所述）。
      </p>
      <p>过程 <span class="stt">inp-exp-simple?</span> 取一 CPS-IN 表达式，判断表示它的字符串能否解析为
        <span class="texMathInline">\mathit{SimpleExp}</span>。它使用<span class="EoplExerciseRef"></span> 中的过程 <span
          class="stt">every?</span>。若
        <span class="texMathInline">lst</span> 中的所有元素满足 <span class="texMathInline">pred</span>，<span
          class="stt">(every? </span><span class="texMathInline">pred</span><span class="stt"> </span><span
          class="texMathInline">lst</span><span class="stt">)</span> 返回 <span class="stt">#t</span>，
        否则返回<span class="stt">#f</span>。
      </p>
      <p><span class="stt">cps-of-simple-exp</span> 的代码直截了当，如<span class="EoplFigureRef"></span> 所示。它还将
        <span class="stt">proc-exp</span> 的主体翻译做 CPS 变换。若要使输出为 <span class="texMathInline">\mathit{SimpleExp}</span>，这是必
        要的。
      </p>
      <p>我们可以用 <span class="stt">cps-of-exps</span> 生成求和表达式和过程调用的尾式。</p>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!ht]
        </div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">cps-of-exps</span></span> : <span
                    class="texMathInline">\mathit{Listof(InpExp)} \times \mathit{(Listof(InpExp) \to TfExp)} \to
                    \mathit{TfExp}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">cps-of-exps</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exps</span><span
                    class="hspace"> </span><span class="RktSym">builder</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="hspace"> </span><span class="RktSym">cps-of-rest</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">exps</span><span
                    class="hspace"> </span><span class="RktSym">exps</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span style="font-weight: bold"><span
                      class="stt">cps-of-rest</span></span> : <span class="texMathInline">\mathit{Listof(InpExp)} \to
                    \mathit{TfExp}</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">pos</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">list-index</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                   </span><span class="RktPn">(</span><span
                    class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                     </span><span class="RktPn">(</span><span
                    class="RktSym">not</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">inp-exp-simple?</span><span class="hspace"> </span><span
                    class="RktSym">exp</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                   </span><span class="RktSym">exps</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">not</span><span
                    class="hspace"> </span><span class="RktSym">pos</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">builder</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">map</span><span class="hspace"> </span><span
                    class="RktSym">cps-of-simple-exp</span><span class="hspace"> </span><span
                    class="RktSym">exps</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">let</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktPn">(</span><span class="RktSym">var</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">fresh-identifier</span><span class="hspace"> </span><span
                    class="RktVal">'</span><span class="RktVal">var</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">            </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">              </span><span class="RktPn">(</span><span
                    class="RktSym">list-ref</span><span class="hspace"> </span><span class="RktSym">exps</span><span
                    class="hspace"> </span><span class="RktSym">pos</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">              </span><span class="RktPn">(</span><span
                    class="RktSym">cps-proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">var</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-rest</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                  </span><span class="RktPn">(</span><span
                    class="RktSym">list-set</span><span class="hspace"> </span><span class="RktSym">exps</span><span
                    class="hspace"> </span><span class="RktSym">pos</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">var-exp</span><span class="hspace"> </span><span
                    class="RktSym">var</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace"> </span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold"><span class="stt">inp-exp-simple?</span></span> : <span
                    class="texMathInline">\mathit{InpExp} \to \mathit{Bool}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">inp-exp-simple?</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                    class="RktSym">exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">const-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">num</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="RktVal">#t</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">var-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">var</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="RktVal">#t</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">diff-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">and</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">inp-exp-simple?</span><span
                    class="hspace"> </span><span class="RktSym">exp1</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">inp-exp-simple?</span><span
                    class="hspace"> </span><span class="RktSym">exp2</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">zero?-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">inp-exp-simple?</span><span class="hspace"> </span><span
                    class="RktSym">exp1</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">ids</span><span class="hspace"> </span><span class="RktSym">exp</span><span
                    class="RktPn">)</span><span class="hspace"> </span><span class="RktVal">#t</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">sum-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exps</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">every?</span><span class="hspace"> </span><span
                    class="RktSym">inp-exp-simple?</span><span class="hspace"> </span><span
                    class="RktSym">exps</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">else</span><span
                    class="hspace"> </span><span class="RktVal">#f</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <blockquote class="caption">
          <p><span class="stt">cps-of-exps</span><a name="(elem._fig-6..8)"></a></p>
        </blockquote>
      </blockquote>
      <blockquote class="EoplCodeInset">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">cps-of-sum-exp</span></span> : <span
                  class="texMathInline">\mathit{Listof(InpExp)} \times \mathit{SimpleExp} \to \mathit{TfExp}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">cps-of-sum-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exps</span><span
                  class="hspace"> </span><span class="RktSym">k-exp</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-exps</span><span class="hspace"> </span><span class="RktSym">exps</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">simples</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">make-send-to-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktSym">k-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">cps-sum-exp</span><span class="hspace"> </span><span class="RktSym">simples</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <blockquote class="EoplFigure">
        <p>
        <div class="SIntrapara">[!ht]
        </div>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">cps-of-simple-exp</span></span> : <span
                    class="texMathInline">\mathit{InpExp} \to \mathit{SimpleExp}</span></td>
              </tr>
              <tr>
                <td><span style="font-weight: bold">用法</span> : <span class="stt">设 (inp-exp-simple? exp) = #f</span>
                </td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">cps-of-simple-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                    class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                    class="RktSym">exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">const-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">num</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">cps-const-exp</span><span class="hspace"> </span><span
                    class="RktSym">num</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">var-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">var</span><span class="RktPn">)</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">cps-var-exp</span><span class="hspace"> </span><span
                    class="RktSym">var</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">diff-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">cps-diff-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-simple-exp</span><span class="hspace"> </span><span
                    class="RktSym">exp1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-simple-exp</span><span class="hspace"> </span><span
                    class="RktSym">exp2</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">zero?-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exp1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">cps-zero?-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-simple-exp</span><span class="hspace"> </span><span
                    class="RktSym">exp1</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">ids</span><span class="hspace"> </span><span class="RktSym">exp</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">cps-proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">append</span><span class="hspace"> </span><span class="RktSym">ids</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">list</span><span
                    class="hspace"> </span><span class="RktVal">'</span><span class="RktVal">k%00</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-exp</span><span class="hspace"> </span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cps-var-exp</span><span
                    class="hspace"> </span><span class="RktVal">'</span><span class="RktVal">k%00</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">sum-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">exps</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">cps-sum-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">map</span><span class="hspace"> </span><span
                    class="RktSym">cps-of-simple-exp</span><span class="hspace"> </span><span
                    class="RktSym">exps</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">else</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">report-invalid-exp-to-cps-of-simple-exp</span><span class="hspace"> </span><span
                    class="RktSym">exp</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        </p>
        <blockquote class="caption">
          <p><span class="stt">cps-of-simple-exp</span><a name="(elem._fig-6..9)"></a></p>
        </blockquote>
      </blockquote>
      <blockquote class="EoplCodeInset">
        <p>
        <div class="SIntrapara">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">cps-of-call-exp</span></span> : <span
                    class="texMathInline">\mathit{InpExp} \times \mathit{Listof(InpExp)} \times \mathit{SimpleExp} \to
                    \mathit{TfExp}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">cps-of-call-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">rator</span><span
                    class="hspace"> </span><span class="RktSym">rands</span><span class="hspace"> </span><span
                    class="RktSym">k-exp</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-exps</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">cons</span><span class="hspace"> </span><span class="RktSym">rator</span><span
                    class="hspace"> </span><span class="RktSym">rands</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">simples</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">cps-call-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">car</span><span class="hspace"> </span><span class="RktSym">simples</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">append</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">cdr</span><span class="hspace"> </span><span class="RktSym">simples</span><span
                    class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">k-exp</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </div>
        <div class="SIntrapara"><a name="(idx._(gentag._1014))"></a>
          <a name="(idx._(gentag._1015))"></a>
        </div>
        </p>
      </blockquote>
      <p>现在，我们可以写出 CPS 翻译器的剩余部分
        （<span class="EoplFigureRef"></span>–<span class="stt">fig-6.12</span>）。它<span class="emph">跟随语法</span>。当表达式总是
        简单的，如常量、变量和过程，我们直接用 <span class="stt">make-send-to-cont</span> 生成代码。否则，我
        们调用辅助过程，每个辅助过程都调用 <span class="stt">cps-of-exps</span> 求子表达式的值，用适当的生成
        器构造 CPS 输出的最内部。一个例外是 <span class="stt">cps-of-letrec-exp</span>，它没有紧邻的子表达式，
        所以它直接生成 CPS 输出。最后，我们调用 <span class="stt">cps-of-exps</span> 翻译整个程序，它取一生
        成器，该生成器直接返回一个简单表达式。
        <a name="(idx._(gentag._1016))"></a>
      </p>
      <p>在下面的练习中，用 CPS-OUT 的语法和解释器运行输出表达式，确保它们是尾式。</p>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">cps-of-exp</span></span> : <span
                  class="texMathInline">\mathit{InpExp} \times \mathit{SimpleExp} \to \mathit{TfExp}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">cps-of-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                  class="hspace"> </span><span class="RktSym">k-exp</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">expression</span><span class="hspace"> </span><span
                  class="RktSym">exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">const-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">num</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">make-send-to-cont</span><span class="hspace"> </span><span
                  class="RktSym">k-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">cps-const-exp</span><span class="hspace"> </span><span class="RktSym">num</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">var-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">make-send-to-cont</span><span class="hspace"> </span><span
                  class="RktSym">k-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">cps-var-exp</span><span class="hspace"> </span><span class="RktSym">var</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">vars</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">make-send-to-cont</span><span class="hspace"> </span><span class="RktSym">k-exp</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">cps-proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">append</span><span class="hspace"> </span><span class="RktSym">vars</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">list</span><span
                  class="hspace"> </span><span class="RktVal">'</span><span class="RktVal">k%00</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-exp</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cps-var-exp</span><span
                  class="hspace"> </span><span class="RktVal">'</span><span class="RktVal">k%00</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">zero?-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-zero?-exp</span><span class="hspace"> </span><span
                  class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">k-exp</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">diff-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-diff-exp</span><span class="hspace"> </span><span
                  class="RktSym">exp1</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">k-exp</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">sum-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exps</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-sum-exp</span><span class="hspace"> </span><span class="RktSym">exps</span><span
                  class="hspace"> </span><span class="RktSym">k-exp</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">if-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">exp2</span><span class="hspace"> </span><span
                  class="RktSym">exp3</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-if-exp</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">exp2</span><span class="hspace"> </span><span
                  class="RktSym">exp3</span><span class="hspace"> </span><span class="RktSym">k-exp</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">let-exp</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">exp1</span><span class="hspace"> </span><span
                  class="RktSym">body</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-let-exp</span><span class="hspace"> </span><span class="RktSym">var</span><span
                  class="hspace"> </span><span class="RktSym">exp1</span><span class="hspace"> </span><span
                  class="RktSym">body</span><span class="hspace"> </span><span class="RktSym">k-exp</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">letrec-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">p-names</span><span class="hspace"> </span><span class="RktSym">b-varss</span><span
                  class="hspace"> </span><span class="RktSym">p-bodies</span><span class="hspace"> </span><span
                  class="RktSym">letrec-body</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-letrec-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktSym">p-names</span><span
                  class="hspace"> </span><span class="RktSym">b-varss</span><span class="hspace"> </span><span
                  class="RktSym">p-bodies</span><span class="hspace"> </span><span
                  class="RktSym">letrec-body</span><span class="hspace"> </span><span class="RktSym">k-exp</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">call-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">rator</span><span class="hspace"> </span><span class="RktSym">rands</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-call-exp</span><span class="hspace"> </span><span
                  class="RktSym">rator</span><span class="hspace"> </span><span class="RktSym">rands</span><span
                  class="hspace"> </span><span class="RktSym">k-exp</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">cps-of-zero?-exp</span></span> : <span
                  class="texMathInline">\mathit{InpExp} \times \mathit{SimpleExp} \to \mathit{TfExp}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">cps-of-zero?-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">k-exp</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-exps</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">simples</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">make-send-to-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktSym">k-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">cps-zero?-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">car</span><span class="hspace"> </span><span class="RktSym">simples</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <blockquote class="caption">
          <p><span class="stt">cps-of-exp</span>，第1部分
            <a name="(idx._(gentag._1017))"></a>
            <a name="(idx._(gentag._1018))"></a><a name="(elem._fig-6..10)"></a>
          </p>
        </blockquote>
      </blockquote>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">cps-of-diff-exp</span></span> : <span
                  class="texMathInline">\mathit{InpExp} \times \mathit{InpExp} \times \mathit{SimpleExp} \to
                  \mathit{TfExp}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">cps-of-diff-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">exp2</span><span class="hspace"> </span><span
                  class="RktSym">k-exp</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cps-of-exps</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">list</span><span
                  class="hspace"> </span><span class="RktSym">exp1</span><span class="hspace"> </span><span
                  class="RktSym">exp2</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">simples</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">make-send-to-cont</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktSym">k-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">cps-diff-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">car</span><span class="hspace"> </span><span class="RktSym">simples</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">cadr</span><span class="hspace"> </span><span class="RktSym">simples</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">cps-of-if-exp</span></span> : <span
                  class="texMathInline">\mathit{InpExp} \times \mathit{InpExp} \times \mathit{SimpleExp} \to
                  \mathit{TfExp}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">cps-of-if-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                  class="hspace"> </span><span class="RktSym">exp2</span><span class="hspace"> </span><span
                  class="RktSym">exp3</span><span class="hspace"> </span><span class="RktSym">k-exp</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-exps</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">simples</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">cps-if-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">car</span><span class="hspace"> </span><span class="RktSym">simples</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-exp</span><span class="hspace"> </span><span class="RktSym">exp2</span><span
                  class="hspace"> </span><span class="RktSym">k-exp</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-exp</span><span class="hspace"> </span><span class="RktSym">exp3</span><span
                  class="hspace"> </span><span class="RktSym">k-exp</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">cps-of-let-exp</span></span> : <span
                  class="texMathInline">\mathit{Var} \times \mathit{InpExp} \times \mathit{InpExp} \times
                  \mathit{SimpleExp} \to \mathit{TfExp}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">cps-of-let-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">id</span><span
                  class="hspace"> </span><span class="RktSym">rhs</span><span class="hspace"> </span><span
                  class="RktSym">body</span><span class="hspace"> </span><span class="RktSym">k-exp</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cps-of-exp</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">call-exp</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">id</span><span
                  class="RktPn">)</span><span class="hspace"> </span><span class="RktSym">body</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">list</span><span
                  class="hspace"> </span><span class="RktSym">rhs</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktSym">k-exp</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace"> </span></td>
            </tr>
            <tr>
              <td><span style="font-weight: bold"><span class="stt">cps-of-letrec-exp</span></span> : <br /> <span
                  class="texMathInline">\phantom{x}\mathit{Listof(Var)} \times \mathit{Listof(Listof(Var))} \times
                  \mathit{Listof(InpExp)} \times \mathit{InpExp} \times \mathit{SimpleExp} \to \mathit{TfExp}</span>
              </td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">cps-of-letrec-exp</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">p-names</span><span
                  class="hspace"> </span><span class="RktSym">b-varss</span><span class="hspace"> </span><span
                  class="RktSym">p-bodies</span><span class="hspace"> </span><span
                  class="RktSym">letrec-body</span><span class="hspace"> </span><span class="RktSym">k-exp</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cps-letrec-exp</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktSym">p-names</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">map</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">b-vars</span><span class="RktPn">)</span><span class="hspace"> </span><span
                  class="RktPn">(</span><span class="RktSym">append</span><span class="hspace"> </span><span
                  class="RktSym">b-vars</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">list</span><span class="hspace"> </span><span class="RktVal">'</span><span
                  class="RktVal">k%00</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktSym">b-varss</span><span class="RktPn">)</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">map</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">p-body</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-exp</span><span class="hspace"> </span><span class="RktSym">p-body</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">cps-var-exp</span><span
                  class="hspace"> </span><span class="RktVal">'</span><span class="RktVal">k%00</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktSym">p-bodies</span><span class="RktPn">)</span>
              </td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-exp</span><span class="hspace"> </span><span
                  class="RktSym">letrec-body</span><span class="hspace"> </span><span class="RktSym">k-exp</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <blockquote class="caption">
          <p><span class="stt">cps-of-exp</span>，第2部分<a name="(elem._fig-6..11)"></a></p>
        </blockquote>
      </blockquote>
      <blockquote class="EoplFigure">
        <blockquote class="SCodeFlow">
          <table cellspacing="0" cellpadding="0" class="RktBlk">
            <tr>
              <td><span style="font-weight: bold"><span class="stt">cps-of-program</span></span> : <span
                  class="texMathInline">\mathit{InpExp} \to \mathit{TfExp}</span></td>
            </tr>
            <tr>
              <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                  class="RktSym">cps-of-program</span></td>
            </tr>
            <tr>
              <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                  class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">pgm</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">cases</span><span
                  class="hspace"> </span><span class="RktSym">program</span><span class="hspace"> </span><span
                  class="RktSym">pgm</span></td>
            </tr>
            <tr>
              <td><span class="hspace">      </span><span class="RktPn">(</span><span
                  class="RktSym">a-program</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">exp1</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">        </span><span class="RktPn">(</span><span
                  class="RktSym">cps-a-program</span></td>
            </tr>
            <tr>
              <td><span class="hspace">          </span><span class="RktPn">(</span><span
                  class="RktSym">cps-of-exps</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                  class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">            </span><span class="RktPn">(</span><span
                  class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">new-args</span><span class="RktPn">)</span></td>
            </tr>
            <tr>
              <td><span class="hspace">              </span><span class="RktPn">(</span><span
                  class="RktSym">simple-exp->exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                  class="RktSym">car</span><span class="hspace"> </span><span class="RktSym">new-args</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                  class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
            </tr>
          </table>
        </blockquote>
        <blockquote class="caption">
          <p><span class="stt">cps-of-exp</span>，第3部分
            <a name="(idx._(gentag._1019))"></a>
            <a name="(idx._(gentag._1020))"></a><a name="(elem._fig-6..12)"></a>
          </p>
        </blockquote>
      </blockquote>
      <p><a name="(idx._(gentag._1021))"></a></p>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..20)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._1022))"></a>
          <a name="(idx._(gentag._1023))"></a>
          我们的过程 <span class="stt">cps-of-exps</span> 迫使子表达式按从左向右的顺序求值。修改
          <span class="stt">cps-of-exps</span>，使子表达式从右向左求值。
          <a name="(idx._(gentag._1024))"></a>
          <a name="(idx._(gentag._1025))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..21)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>修改 <span class="stt">cps-of-call-exp</span>，先从左向右求出操作数的值，再求操作符的值。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..22)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>有时，当我们生成 <span class="stt">(</span><span class="texMathInline">K</span><span
            class="stt"> </span><span class="texMathInline">simp</span><span class="stt">)</span>，<span
            class="texMathInline">K</span> 已经是一个 <span class="stt">proc-exp</span>。所以，不
          是生成：</p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(proc (</span><span class="texMathInline">var_1</span><span class="stt">) ...
                  </span><span class="texMathInline">simp</span><span class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>而应生成：</p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let </span><span class="texMathInline">var_1</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt">= </span><span class="texMathInline">simp</span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in ...</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>那么，CPS 代码具有性质：形如</p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(proc (</span><span class="texMathInline">var</span><span class="stt">)
                  </span><span class="texMathInline">exp_1</span><span class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span><span class="stt"></span><span
                    class="texMathInline">simp</span><span class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>的子表达式若不在原表达式中，则不会出现在 CPS 代码中。</p>
        <p>修改 <span class="stt">make-send-to-cont</span>，生成更好的代码。新的规则何时生效？</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..23)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._1026))"></a>
          观察可知，<span class="stt">if</span> 的规则导致续文 <span class="texMathInline">K</span> 复制两次，所以在嵌套的 <span
            class="stt">if</span> 中，转换后
          的代码尺寸呈指数增长。运行一个例子，验证这一观察。然后，修改转换，把 <span class="texMathInline">K</span> 绑定
          到新的变量，从而避免这种增长。
          <a name="(idx._(gentag._1027))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..24)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._1028))"></a>
          给语言添加列表（<span class="EoplExerciseRef"></span>）。记住：列表的参数不在尾端。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..25)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._1029))"></a>
          扩展 CPS-IN，让 <span class="stt">let</span> 表达式声明任意数量的变量（<span class="EoplExerciseRef"></span>）。
          <a name="(idx._(gentag._1030))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..26)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>由 <span
            class="stt">cps-of-exps</span> 引入的续文变量在续文中只会只会出现一次。修改
          <span class="stt">make-send-to-cont</span>，不是生成<span class="EoplExerciseRef"></span> 中的
        </p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">let </span><span class="texMathInline">var_1</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt">= </span><span class="texMathInline">simp_1</span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">in </span><span class="texMathInline">T</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>而是生成 <span class="texMathInline">T[simp_1/var_1]</span>。其中，符号 <span class="texMathInline">E_1[E_2/var]</span>
          意为，把表达式 <span class="texMathInline">E_1</span>
          中自由出现的所有变量 <span class="texMathInline">var</span> 替换为 <span class="texMathInline">E_2</span>。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..27)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>按当前方式，<span class="stt">cps-of-let-exp</span> 生成一个无用的 <span class="stt">let</span>
          表达式（为什么？）。修改
          这个过程，直接把 <span class="stt">let</span> 变量作为续文变量。那么，若 <span class="texMathInline">exp_1</span> 是复杂的，</p>
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(cps-of-exp <<let </span><span class="texMathInline">var_1</span><span
                        class="stt"></span><span class="hspace"> </span><span class="stt">= </span><span
                        class="texMathInline">exp_1</span><span class="stt"></span><span class="hspace"> </span><span
                        class="stt">in </span><span class="texMathInline">exp_2</span><span class="stt">>> </span><span
                        class="texMathInline">K</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (cps-of-exp </span><span class="texMathInline">exp_1</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">
                    <<proc (</span><span class="texMathInline">var_1</span><span class="stt">) (cps-of-exp </span><span
                        class="texMathInline">exp_2</span><span class="stt"></span><span class="hspace"> </span><span
                        class="stt"></span><span class="texMathInline">K</span><span class="stt">)>>)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..28)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>试想：有一个 Scheme 程序的 CPS 转换器，用它转换<a href="expr.html" data-pltdoc="x">表达式</a>中的第一个解释器，结
          果会怎样？</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..29)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>考虑 <span
            class="stt">cps-of-exps</span> 的变体。</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">cps-of-exps</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exps</span><span
                    class="hspace"> </span><span class="RktSym">builder</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="hspace"> </span><span class="RktSym">cps-of-rest</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktPn">(</span><span class="RktSym">exps</span><span
                    class="hspace"> </span><span class="RktSym">exps</span><span class="RktPn">)</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">acc</span><span
                    class="hspace"> </span><span class="RktVal">'</span><span class="RktVal">(</span><span
                    class="RktVal">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span style="font-weight: bold"><span
                      class="stt">cps-of-rest</span></span> : <span class="texMathInline">\mathit{Listof(InpExp)} \times
                    \mathit{Listof(SimpleExp)} \to \mathit{TfExp}</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">cond</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">null?</span><span class="hspace"> </span><span class="RktSym">exps</span><span
                    class="RktPn">)</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">builder</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">reverse</span><span class="hspace"> </span><span class="RktSym">acc</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">inp-exp-simple?</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">car</span><span class="hspace"> </span><span class="RktSym">exps</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-rest</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">cdr</span><span class="hspace"> </span><span class="RktSym">exps</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">            </span><span class="RktPn">(</span><span class="RktSym">cons</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">              </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-simple-exp</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">car</span><span class="hspace"> </span><span
                    class="RktSym">exps</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">              </span><span class="RktSym">acc</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">else</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">let</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktPn">(</span><span class="RktSym">var</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">fresh-identifier</span><span class="hspace"> </span><span
                    class="RktVal">'</span><span class="RktVal">var</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">            </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">car</span><span class="hspace"> </span><span class="RktSym">exps</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">              </span><span class="RktPn">(</span><span
                    class="RktSym">cps-proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">var</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-rest</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">cdr</span><span class="hspace"> </span><span class="RktSym">exps</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                  </span><span class="RktPn">(</span><span
                    class="RktSym">cons</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                    </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-simple-exp</span><span class="hspace"> </span><span
                    class="RktPn">(</span><span class="RktSym">var-exp</span><span class="hspace"> </span><span
                    class="RktSym">var</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">                    </span><span class="RktSym">acc</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>为什么 <span class="stt">cps-of-exp</span> 的这种变体比<span class="EoplFigureRef"></span> 中的更高效？</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..30)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>调用 <span
            class="stt">cps-of-exps</span> 处理长度为 1 的表达式列表可以简化如下：</p>
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(cps-of-exps (list </span><span class="texMathInline">exp</span><span class="stt">)
                  </span><span class="texMathInline">builder</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (cps-of-exp/ctx </span><span class="texMathInline">exp</span><span
                    class="stt"></span><span class="hspace"> </span><span class="stt">(lambda (simp) (</span><span
                    class="texMathInline">builder</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt">(list simp))))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>其中，</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span style="font-weight: bold"><span class="stt">cps-of-exp/ctx</span></span> : <span
                    class="texMathInline">\mathit{InpExp} \times \mathit{(SimpleExp \rightarrow{} TfExp)} \to
                    \mathit{TfExp}</span></td>
              </tr>
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">cps-of-exp/ctx</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp</span><span
                    class="hspace"> </span><span class="RktSym">context</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">inp-exp-simple?</span><span
                    class="hspace"> </span><span class="RktSym">exp</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">context</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-simple-exp</span><span class="hspace"> </span><span
                    class="RktSym">exp</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">var</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">fresh-identifier</span><span class="hspace"> </span><span
                    class="RktVal">'</span><span class="RktVal">var</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-exp</span><span class="hspace"> </span><span class="RktSym">exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">cps-proc-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">var</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">            </span><span class="RktPn">(</span><span
                    class="RktSym">context</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">cps-var-exp</span><span class="hspace"> </span><span class="RktSym">var</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>这样，由于列表的参数数量已经确定，我们可以简化出现 <span class="stt">(cps-of-exps (list ...))</span>
          的地方。那么，诸如 <span class="stt">cps-of-diff-exp</span> 可以用 <span class="stt">cps-of-exp/ctx</span> 定义，而不需
          要 <span class="stt">cps-of-exps</span>。</p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">cps-of-diff-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                    class="hspace"> </span><span class="RktSym">exp2</span><span class="hspace"> </span><span
                    class="RktSym">k-exp</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-exp/ctx</span><span class="hspace"> </span><span class="RktSym">exp1</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span
                    class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">simp1</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span
                    class="RktSym">cps-of-exp/ctx</span><span class="hspace"> </span><span class="RktSym">exp2</span>
                </td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span
                    class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">simp2</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">            </span><span class="RktPn">(</span><span
                    class="RktSym">make-send-to-cont</span><span class="hspace"> </span><span
                    class="RktSym">k-exp</span></td>
              </tr>
              <tr>
                <td><span class="hspace">              </span><span class="RktPn">(</span><span
                    class="RktSym">cps-diff-exp</span><span class="hspace"> </span><span
                    class="RktSym">simp1</span><span class="hspace"> </span><span class="RktSym">simp2</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>对 <span class="stt">cps-of-call-exp</span> 中用到的 <span class="stt">cps-of-exps</span>，我们可以用
          <span class="stt">cps-of-exp/ctx</span> 处理 <span class="stt">rator</span>，但仍需使用 <span
            class="stt">cps-of-exps</span> 处理 <span class="stt">rands</span>。
          删除翻译器中其他地方出现的 <span class="stt">cps-of-exps</span>。
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..31)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._1031))"></a>
          <a name="(idx._(gentag._1032))"></a>
          <a name="(idx._(gentag._1033))"></a>
          写一个翻译器，它取 <span class="stt">cps-of-program</span> 的输出，生成一个等价程序，其中所有的续文
          都用<a href="cpi.html" data-pltdoc="x">传递续文的解释器</a>中的数据结构表示。用列表表示那些用 <span class="stt">define-datatype</span>
          生成的数
          据结构。由于我们的语言不支持符号，你可以在首项位置使用整数标签，以此区分数据类型
          的变体。
          <a name="(idx._(gentag._1034))"></a>
          <a name="(idx._(gentag._1035))"></a>
          <a name="(idx._(gentag._1036))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..32)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._1037))"></a>
          写一个翻译器，它类似<span class="EoplExerciseRef"></span>，但把所有过程表示为数据结构。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..33)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._1038))"></a>
          写一个翻译器，它取<span class="EoplExerciseRef"></span> 的输出，将其转换为<span class="EoplFigureRef"></span>
          那样的寄存器程序。
          <a name="(idx._(gentag._1039))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..34)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._1040))"></a>
          <a name="(idx._(gentag._1041))"></a>
          <a name="(idx._(gentag._1042))"></a>
          我们把程序转换为 CPS 时，不仅将程序中的控制上下文变为显式的，而且还确定了操作的
          执行顺序，以及所有中间结果的名字。后者叫做<span class="emph">序列化</span> (<span class="emph">sequentialization</span>)。如
          果我们不关心能否获得迭代性控制行为，我们序列化程序时可将其转换为
          <span class="emph">A-normal form</span>，或称<span class="emph">ANF</span>。这里是一个 ANF 程序的例子。
        </p>
        <blockquote class="EoplCodeInset">
          <blockquote class="SCodeFlow">
            <table cellspacing="0" cellpadding="0" class="RktBlk">
              <tr>
                <td><span class="RktPn">(</span><span class="RktSym">define</span><span class="hspace"> </span><span
                    class="RktSym">fib/anf</span></td>
              </tr>
              <tr>
                <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">lambda</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">n</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">if</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">
                    << /span><span class="hspace"> </span><span class="RktSym">n</span><span
                        class="hspace"> </span><span class="RktVal">2</span><span class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktVal">1</span></td>
              </tr>
              <tr>
                <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">val1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">fib/anf</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym"><span class="nobreak">-</span></span><span class="hspace"> </span><span
                    class="RktSym">n</span><span class="hspace"> </span><span class="RktVal">1</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">        </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                    class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                    class="RktSym">val2</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym">fib/anf</span><span class="hspace"> </span><span class="RktPn">(</span><span
                    class="RktSym"><span class="nobreak">-</span></span><span class="hspace"> </span><span
                    class="RktSym">n</span><span class="hspace"> </span><span class="RktVal">2</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
              <tr>
                <td><span class="hspace">          </span><span class="RktPn">(</span><span class="RktSym">+</span><span
                    class="hspace"> </span><span class="RktSym">val1</span><span class="hspace"> </span><span
                    class="RktSym">val2</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                    class="RktPn">)</span></td>
              </tr>
            </table>
          </blockquote>
        </blockquote>
        <p>CPS 程序传递命名中间结果的续文，从而序列化计算；ANF 程序用 <span class="stt">let</span> 表达式命名所
          有中间结果，从而序列化计算。</p>
        <p>重写 <span class="stt">cps-of-exp</span>，生成 ANF 程序而非 CPS 程序（对不在尾端的条件表达式，
          用<span class="EoplExerciseRef"></span> 中的方法处理）。然后，用修改后的 <span class="stt">cps-of-exp</span> 处理例
          <span class="stt">fib</span> 的定义，验证其结果是否为 <span class="stt">fib/anf</span>。最后，验证对已经是 ANF 的输入程
          序，你的翻译器产生的程序与输入只有绑定变量名不同。
          <a name="(idx._(gentag._1043))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..35)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>用几个例子验证：若采用<span class="EoplExerciseRef"></span> 中的优化方法，对 ANF 转换器
          （<span class="EoplExerciseRef"></span>）的输入和输出程序进行 CPS 变换，所得结果相同。
          <a name="(idx._(gentag._1044))"></a>
          <a name="(idx._(gentag._1045))"></a>
        </p>
      </blockquote>
      <h4>6.4<tt> </tt><a name="(part._s6..4)"></a>建模计算效果</h4>
      <p><a name="(idx._(gentag._1046))"></a>
        CPS 的另一重要应用是提供模型，将计算效果变为显式的。计算效果——像是打印或给变量赋
        值——很难用<a href="expr.html" data-pltdoc="x">表达式</a>使用的方程推理建模。通过 CPS 变换，我们可以将这些效果变为
        显式的，就像我们在<a href="cpi.html" data-pltdoc="x">传递续文的解释器</a>中处理非局部控制流一样。</p>
      <p><a name="(idx._(gentag._1047))"></a>
        <a name="(idx._(gentag._1048))"></a>
        <a name="(idx._(gentag._1049))"></a>
        用 CPS 建模效果时，我们的基本原则是简单表达式不应有任何效果。简单表达式不应含有
        过程调用也是基于这一原则，因为过程调用可能不终止（这当然是一种效果！）。
      </p>
      <p>本节，我们研究三种效果：打印，存储器（用显式引用模型），以及非标准控制流。</p>
      <p>我们首先考虑打印。打印当然是一种效果：</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(f print(3) print(4))</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>和</p>
        <blockquote class="EoplCodeInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(f 1 1)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>即使返回同样的答案，也具有不同效果。效果还取决于参数的求值顺序。迄今为止，我们的
          语言总是按从左向右的顺序求参数的值，但其他语言可能不是这样。</p>
      </blockquote>
      <p>要建模这些想法，我们按照下面的方式修改 CPS 变换：</p>
      <ul>
        <li>
          <p>我们给 CPS-IN 添加 <span class="stt">print</span> 表达式：
            <a name="(idx._(gentag._1050))"></a>
          </p>
          <blockquote class="Small">
            <p><span class="Iidentity">\begin{align*}\mathit{InpExp} &::= <span class="stt">print (</span><span
                  class="Iidentity">\mathit{InpExp}</span><span class="stt">)</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">print-exp (exp1)</span>}\end{align*}</span></p>
          </blockquote>
          <p>我们尚未写出 CPS-IN 的解释器，但解释器应当扩展，从而处理 <span class="stt">print-exp</span>；它打印
            出参数的值，返回某个值（我们选任意值 38）。</p>
        </li>
        <li>
          <p>我们给 CPS-OUT 添加 <span class="stt">printk</span> 表达式：</p>
          <blockquote class="Small">
            <p><span class="Iidentity">\begin{align*}\mathit{TfExp} &::= <span class="stt">printk (</span><span
                  class="Iidentity">\mathit{SimpleExp}</span><span class="stt">) ; </span><span
                  class="Iidentity">\mathit{TfExp}</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-printk-exp (simple-exp1
                  body)</span>}\end{align*}</span></p>
          </blockquote>
          <p>表达式 <span class="stt">printk(</span><span class="texMathInline">simp</span><span class="stt">);</span><span
              class="texMathInline">exp</span> 有一种效果：打印。因此，它必须是一个
            <span class="texMathInline">\mathit{TfExp}</span>，而非 <span
              class="texMathInline">\mathit{SimpleExp}</span>，且只能出现在尾端。<span class="texMathInline">exp</span> 的值
            成为整个 <span class="stt">printk</span>表达式的值，所以 <span class="texMathInline">exp</span> 本身在尾端，可以是一个 <span
              class="stt">tfexp</span>。
            那么，这部分代码可以写作：
          </p>
          <blockquote class="EoplCodeInset">
            <table cellspacing="0" cellpadding="0" class="SVerbatim">
              <tr>
                <td>
                  <p><span class="stt">proc (v1)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace"> </span><span class="stt">printk(-(v1,1));</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">  </span><span class="stt">(f v1 </span><span
                      class="texMathInline">K</span><span class="stt">)</span></p>
                </td>
              </tr>
            </table>
          </blockquote>
          <p>要实现它，我们给 CPS-OUT 的解释器添加：</p>
          <blockquote class="EoplCodeInset">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">printk-exp</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">simple</span><span
                      class="hspace"> </span><span class="RktSym">body</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">begin</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span
                      class="RktSym">eopl:printf</span><span class="hspace"> </span><span class="RktVal">"~s~%"</span>
                  </td>
                </tr>
                <tr>
                  <td><span class="hspace">      </span><span class="RktPn">(</span><span
                      class="RktSym">value-of-simple-exp</span><span class="hspace"> </span><span
                      class="RktSym">simple</span><span class="hspace"> </span><span class="RktSym">env</span><span
                      class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span
                      class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">body</span><span
                      class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                      class="RktSym">cont</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span></td>
                </tr>
              </table>
            </blockquote>
          </blockquote>
        </li>
        <li>
          <p>我们给 <span class="stt">cps-of-exp</span> 添加一行代码，把 <span class="stt">print</span> 表达式翻译为
            <span class="stt">printk</span> 表达式。我们为 <span class="stt">print</span> 选择任意返回值 38。所以，我们的翻译应为：
          </p>
          <blockquote class="EoplEquationInset">
            <table cellspacing="0" cellpadding="0" class="SVerbatim">
              <tr>
                <td>
                  <p><span class="stt">(cps-of-exp <<print(< /span><span class="texMathInline">simp_1</span><span
                          class="stt">)>> </span><span class="texMathInline">K</span><span class="stt">) =
                          printk(</span><span class="texMathInline">simp_1</span><span class="stt">) ; (</span><span
                          class="texMathInline">K</span><span class="stt"></span><span class="hspace"> </span><span
                          class="stt">38)</span></p>
                </td>
              </tr>
            </table>
          </blockquote>
          <p>然后，由于 <span class="stt">print</span> 的参数可能是复杂的，我们用 <span class="stt">cps-of-exps</span> 处理。这样，
            我们给 <span class="stt">cps-of-exp</span> 新增这几行代码：</p>
          <blockquote class="EoplCodeInset">
            <p>
            <div class="SIntrapara">
              <blockquote class="SCodeFlow">
                <table cellspacing="0" cellpadding="0" class="RktBlk">
                  <tr>
                    <td><span class="RktPn">(</span><span class="RktSym">print-exp</span><span
                        class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">rator</span><span
                        class="RktPn">)</span></td>
                  </tr>
                  <tr>
                    <td><span class="hspace">  </span><span class="RktPn">(</span><span
                        class="RktSym">cps-of-exps</span><span class="hspace"> </span><span class="RktPn">(</span><span
                        class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">rator</span><span
                        class="RktPn">)</span></td>
                  </tr>
                  <tr>
                    <td><span class="hspace">    </span><span class="RktPn">(</span><span
                        class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                        class="RktSym">simples</span><span class="RktPn">)</span></td>
                  </tr>
                  <tr>
                    <td><span class="hspace">      </span><span class="RktPn">(</span><span
                        class="RktSym">cps-printk-exp</span></td>
                  </tr>
                  <tr>
                    <td><span class="hspace">        </span><span class="RktPn">(</span><span
                        class="RktSym">car</span><span class="hspace"> </span><span class="RktSym">simples</span><span
                        class="RktPn">)</span></td>
                  </tr>
                  <tr>
                    <td><span class="hspace">        </span><span class="RktPn">(</span><span
                        class="RktSym">make-send-to-cont</span><span class="hspace"> </span><span
                        class="RktSym">k-exp</span></td>
                  </tr>
                  <tr>
                    <td><span class="hspace">          </span><span class="RktPn">(</span><span
                        class="RktSym">cps-const-exp</span><span class="hspace"> </span><span
                        class="RktVal">38</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                        class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                        class="RktPn">)</span></td>
                  </tr>
                </table>
              </blockquote>
            </div>
            <div class="SIntrapara"><a name="(idx._(gentag._1051))"></a></div>
            </p>
          </blockquote>
        </li>
      </ul>
      <p>来看一个更复杂的例子。</p>
      <blockquote class="EoplCodeInset">
        <table cellspacing="0" cellpadding="0" class="SVerbatim">
          <tr>
            <td>
              <p><span class="stt">(cps-of-exp <<(f print((g x)) print(4))>> </span><span
                  class="texMathInline">K</span><span class="stt">)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (cps-of-exp <<print((g x))>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                  <<proc (v1)</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">(cps-of-exp <<(f v1
                    print(4))>> </span><span class="texMathInline">K</span><span class="stt">)>>)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (cps-of-exp <<(g x)>></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">
                  <<proc (v2)</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">(cps-of-exp <<(print v2)>
                    ></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">         </span><span class="stt">
                  <<proc (v1)</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">            </span><span class="stt">(cps-of-exp <<(f v1
                    print(4))>> </span><span class="texMathInline">K</span><span class="stt">)>>)>>)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (g x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">   </span><span class="stt">proc (v2)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">(cps-of-exp <<(print v2)>
                    ></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">      </span><span class="stt">
                  <<proc (v1)</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">        </span><span class="stt">(cps-of-exp <<(f v1
                    print(4))>> </span><span class="texMathInline">K</span><span class="stt">)>>))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (g x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">   </span><span class="stt">proc (v2)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">printk(v2);</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">let v1 = 38</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">in (cps-of-exp <<(f v1
                    print(4))>> </span><span class="texMathInline">K</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (g x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">   </span><span class="stt">proc (v2)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">printk(v2);</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">let v1 = 38</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">in (cps-of-exp <<print(4)>
                    ></span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">         </span><span class="stt">
                  <<proc (v3)</span>
              </p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">            </span><span class="stt">(cps-of-exp <<(f v1
                    v3)>> </span><span class="texMathInline">K</span><span class="stt">)>>))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (g x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">   </span><span class="stt">proc (v2)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">printk(v2);</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">let v1 = 38</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">in printk(4);</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">let v3 = 38</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">in (cps-of-exp <<(f v1
                    v3)>> </span><span class="texMathInline">K</span><span class="stt">))</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt">= (g x</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">   </span><span class="stt">proc (v2)</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">printk(v2);</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">let v1 = 38</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">    </span><span class="stt">in printk(4);</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">let v3 = 38</span></p>
            </td>
          </tr>
          <tr>
            <td>
              <p><span class="stt"></span><span class="hspace">       </span><span class="stt">in (f v1 v3 </span><span
                  class="texMathInline">k</span><span class="stt">))</span></p>
            </td>
          </tr>
        </table>
      </blockquote>
      <p>这里，我们调用 <span class="stt">g</span>，调用所在的续文把结果命名为 <span class="stt">v2</span>。续文打印出 <span class="stt">v2</span>
        的
        值，把 38 传给下一续文，下一续文将 <span class="stt">v1</span> 绑定到实参 38，打印出 4，然后调用下一
        续文，下一续文把 <span class="stt">v2</span> 绑定到实参（也是 38），然后用 <span class="stt">v1</span>，<span class="stt">v3</span> 和
        <span class="texMathInline">K</span>
        调用 <span class="stt">f</span>。</p>
      <p><a name="(idx._(gentag._1052))"></a>
        <a name="(idx._(gentag._1053))"></a>
        我们按照同样的步骤建模显式引用（<a href="state.html#%28part._s4..2%29" data-pltdoc="x">EXPLICIT-REFS：显式引用语言</a>）。我们给 CPS-IN 和
        CPS-OUT 添加新
        的语法，给 CPS-OUT 的解释器添加代码，处理新的语法，给 <span class="stt">cps-of-exp</span> 添加代码，
        将新的 CPS-IN 语法翻译为 CPS-OUT。对显式引用，我们需要添加创建引用，解引用和赋值
        的语法。
      </p>
      <ul>
        <li>
          <p>我们给 CPS-IN 添加语法：
            <a name="(idx._(gentag._1054))"></a>
            <a name="(idx._(gentag._1055))"></a>
            <a name="(idx._(gentag._1056))"></a>
            <a name="(idx._(gentag._1057))"></a>
          </p>
          <blockquote class="Small">
            <p><span class="Iidentity">\begin{align*}\mathit{InpExp} &::= <span class="stt">newref (</span><span
                  class="Iidentity">\mathit{InpExp}</span><span class="stt">)</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">newref-exp (exp1)</span>} \\[5pt]
                \mathit{InpExp} &::= <span class="stt">deref (</span><span class="Iidentity">\mathit{InpExp}</span><span
                  class="stt">)</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">deref-exp (exp1)</span>} \\[5pt]
                \mathit{InpExp} &::= <span class="stt">setref (</span><span
                  class="Iidentity">\mathit{InpExp}</span><span class="stt"> , </span><span
                  class="Iidentity">\mathit{InpExp}</span><span class="stt">)</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">setref-exp (exp1 exp2)</span>}\end{align*}</span></p>
          </blockquote>
        </li>
        <li>
          <p>我们给 CPS-OUT 添加语法：</p>
          <blockquote class="Small">
            <p><span class="Iidentity">\begin{align*}\mathit{TfExp} &::= <span class="stt">newrefk (</span><span
                  class="Iidentity">\mathit{simple\mbox{-}exp}</span><span class="stt">, </span><span
                  class="Iidentity">\mathit{simple\mbox{-}exp}</span><span class="stt">)</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-newrefk-exp (simple1 simpe2)</span>} \\[5pt]
                \mathit{TfExp} &::= <span class="stt">derefk (</span><span
                  class="Iidentity">\mathit{simple\mbox{-}exp}</span><span class="stt">, </span><span
                  class="Iidentity">\mathit{simple\mbox{-}exp}</span><span class="stt">)</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-derefk-exp (simple1 simpe2)</span>} \\[5pt]
                \mathit{TfExp} &::= <span class="stt">setrefk (</span><span
                  class="Iidentity">\mathit{simple\mbox{-}exp}</span><span class="stt">, </span><span
                  class="Iidentity">\mathit{simple\mbox{-}exp}</span><span class="stt">) ; </span><span
                  class="Iidentity">\mathit{TfExp}</span> \\[-3pt]
                &\mathrel{\phantom{::=}} \fbox{<span class="stt">cps-setrefk-exp (simple1
                  simpe2)</span>}\end{align*}</span></p>
          </blockquote>
          <p><span class="stt">newrefk</span> 表达式取两个参数：放入新分配单元的值，接收新位置引用的续文。
            <span class="stt">derefk</span> 与之类似。由于 <span class="stt">setrefk</span> 的执行通常只求效果，<span
              class="stt">setrefk</span> 的设计
            与 <span class="stt">printk</span> 类似。它将第二个参数的值赋给第一个参数的值，后者应是一个引用，然
            后尾递归式地执行第三个参数。
          </p>
          <p>在这门语言中，我们写：</p>
          <blockquote class="EoplCodeInset">
            <table cellspacing="0" cellpadding="0" class="SVerbatim">
              <tr>
                <td>
                  <p><span class="stt">newrefk(33, proc (loc1)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">             </span><span class="stt">newrefk(44,
                      proc (loc2)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">                          </span><span
                      class="stt">setrefk(loc1,22);</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">                          </span><span
                      class="stt">derefk(loc1, proc (val)</span></p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><span class="stt"></span><span class="hspace">                                        </span><span
                      class="stt">-(val,1))))</span></p>
                </td>
              </tr>
            </table>
          </blockquote>
          <p>这个程序新分配一个位置，值为 33，把 <span class="stt">loc1</span> 绑定到那个位置。然后，它新分配一个
            位置，值为 44，把 <span class="stt">loc2</span> 绑定到那个位置。然后，它把位置 <span class="stt">loc1</span> 的内容设为
            22。最后，它取出 <span class="stt">loc1</span> 的值，把结果（应为 22）绑定到 <span class="stt">val</span>，求出并返回
            <span class="stt">-(val,1)</span> 的结果 21。
          </p>
          <p>要得到这种行为，我们给 CPS-OUT 的解释器添加这几行代码：</p>
          <blockquote class="EoplCodeInset">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">cps-newrefk-exp</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">simple1</span><span
                      class="hspace"> </span><span class="RktSym">simple2</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                      class="RktSym">val1</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">value-of-simple-exp</span><span class="hspace"> </span><span
                      class="RktSym">simple1</span><span class="hspace"> </span><span class="RktSym">env</span><span
                      class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">        </span><span class="RktPn">(</span><span
                      class="RktSym">val2</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">value-of-simple-exp</span><span class="hspace"> </span><span
                      class="RktSym">simple2</span><span class="hspace"> </span><span class="RktSym">env</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                      class="RktSym">newval</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">ref-val</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">newref</span><span class="hspace"> </span><span class="RktSym">val1</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">      </span><span class="RktPn">(</span><span
                      class="RktSym">apply-procedure/k</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">        </span><span class="RktPn">(</span><span
                      class="RktSym">expval->proc</span><span class="hspace"> </span><span
                      class="RktSym">val2</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">        </span><span class="RktPn">(</span><span
                      class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">newval</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">        </span><span class="RktSym">k-exp</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace"> </span></td>
                </tr>
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">cps-derefk-exp</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">simple1</span><span
                      class="hspace"> </span><span class="RktSym">simple2</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span
                      class="RktSym">apply-procedure/k</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span
                      class="RktSym">expval->proc</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">value-of-simple-exp</span><span class="hspace"> </span><span
                      class="RktSym">simple2</span><span class="hspace"> </span><span class="RktSym">env</span><span
                      class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">list</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">      </span><span class="RktPn">(</span><span class="RktSym">deref</span>
                  </td>
                </tr>
                <tr>
                  <td><span class="hspace">        </span><span class="RktPn">(</span><span
                      class="RktSym">expval->ref</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">          </span><span class="RktPn">(</span><span
                      class="RktSym">value-of-simple-exp</span><span class="hspace"> </span><span
                      class="RktSym">simple1</span><span class="hspace"> </span><span class="RktSym">env</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktSym">k-exp</span><span class="RktPn">)</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace"> </span></td>
                </tr>
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">cps-setrefk-exp</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">simple1</span><span
                      class="hspace"> </span><span class="RktSym">simple2</span><span class="hspace"> </span><span
                      class="RktSym">body</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span class="RktSym">let</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktPn">(</span><span
                      class="RktSym">ref</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">expval->ref</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">              </span><span class="RktPn">(</span><span
                      class="RktSym">value-of-simple-exp</span><span class="hspace"> </span><span
                      class="RktSym">simple1</span><span class="hspace"> </span><span class="RktSym">env</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">         </span><span class="RktPn">(</span><span
                      class="RktSym">val</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">value-of-simple-exp</span><span class="hspace"> </span><span
                      class="RktSym">simple2</span><span class="hspace"> </span><span class="RktSym">env</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span class="RktSym">begin</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">      </span><span class="RktPn">(</span><span
                      class="RktSym">setref!</span><span class="hspace"> </span><span class="RktSym">ref</span><span
                      class="hspace"> </span><span class="RktSym">val</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">      </span><span class="RktPn">(</span><span
                      class="RktSym">value-of/k</span><span class="hspace"> </span><span class="RktSym">body</span><span
                      class="hspace"> </span><span class="RktSym">env</span><span class="hspace"> </span><span
                      class="RktSym">k-exp</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
              </table>
            </blockquote>
          </blockquote>
        </li>
        <li>
          <p>最后，我们给 <span class="stt">cps-of-exp</span> 添加这几行代码来做翻译：</p>
          <blockquote class="EoplCodeInset">
            <blockquote class="SCodeFlow">
              <table cellspacing="0" cellpadding="0" class="RktBlk">
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">newref-exp</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span
                      class="RktSym">cps-of-exps</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span
                      class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">simples</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">      </span><span class="RktPn">(</span><span
                      class="RktSym">cps-newrefk-exp</span><span class="hspace"> </span><span
                      class="RktPn">(</span><span class="RktSym">car</span><span class="hspace"> </span><span
                      class="RktSym">simples</span><span class="RktPn">)</span><span class="hspace"> </span><span
                      class="RktSym">k-exp</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace"> </span></td>
                </tr>
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">deref-exp</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span
                      class="RktSym">cps-of-exps</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span
                      class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">simples</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">      </span><span class="RktPn">(</span><span
                      class="RktSym">cps-derefk-exp</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">car</span><span class="hspace"> </span><span class="RktSym">simples</span><span
                      class="RktPn">)</span><span class="hspace"> </span><span class="RktSym">k-exp</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace"> </span></td>
                </tr>
                <tr>
                  <td><span class="RktPn">(</span><span class="RktSym">setref-exp</span><span
                      class="hspace"> </span><span class="RktPn">(</span><span class="RktSym">exp1</span><span
                      class="hspace"> </span><span class="RktSym">exp2</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">  </span><span class="RktPn">(</span><span
                      class="RktSym">cps-of-exps</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">list</span><span class="hspace"> </span><span class="RktSym">exp1</span><span
                      class="hspace"> </span><span class="RktSym">exp2</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">    </span><span class="RktPn">(</span><span
                      class="RktSym">lambda</span><span class="hspace"> </span><span class="RktPn">(</span><span
                      class="RktSym">simples</span><span class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">      </span><span class="RktPn">(</span><span
                      class="RktSym">cps-setrefk-exp</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">        </span><span class="RktPn">(</span><span
                      class="RktSym">car</span><span class="hspace"> </span><span class="RktSym">simples</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">        </span><span class="RktPn">(</span><span
                      class="RktSym">cadr</span><span class="hspace"> </span><span class="RktSym">simples</span><span
                      class="RktPn">)</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">        </span><span class="RktPn">(</span><span
                      class="RktSym">make-send-to-cont</span><span class="hspace"> </span><span
                      class="RktSym">k-exp</span></td>
                </tr>
                <tr>
                  <td><span class="hspace">          </span><span class="RktPn">(</span><span
                      class="RktSym">cps-const-exp</span><span class="hspace"> </span><span
                      class="RktVal">23</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span
                      class="RktPn">)</span></td>
                </tr>
              </table>
            </blockquote>
          </blockquote>
          <p>在最后一行，我们让 <span class="stt">setref</span> 返回 23，这与 EXPLICIT-REFS 一致。
            <a name="(idx._(gentag._1058))"></a>
            <a name="(idx._(gentag._1059))"></a>
            <a name="(idx._(gentag._1060))"></a>
            <a name="(idx._(gentag._1061))"></a>
            <a name="(idx._(gentag._1062))"></a>
            <a name="(idx._(gentag._1063))"></a>
          </p>
        </li>
      </ul>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..36)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span><a
            name="(idx._(gentag._1064))"></a>
          给 CPS-IN 添加 <span class="stt">begin</span> 表达式（<span class="EoplExerciseRef"></span>）。CPS-OUT 应该不需要修改。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..37)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span><a name="(idx._(gentag._1065))"></a>
          给 CPS-IN 添加隐式引用（<a href="state.html#%28part._s4..3%29" data-pltdoc="x">IMPLICIT-REFS：隐式引用语言</a>）。用和显式引用相同的
          CPS-OUT，确保翻译器
          在适当的地方插入分配和解引用。提示：回忆一下，在隐式引用出现的地方，<span class="stt">var-exp</span>
          不再是简单的，因为它需要读取存储器。
          <a name="(idx._(gentag._1066))"></a>
        </p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..38)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}{\star}\textnormal{]}</span><span
            class="hspace"> </span>如果一个变量不会出现在 <span class="stt">set</span> 表达式的左边，它是不可变的，因此可以视为简单的。
          扩展前一题的解答，按简单表达式处理所有这样的变量。<br /></p>
      </blockquote>
      <p><a name="(idx._(gentag._1067))"></a>
        <a name="(idx._(gentag._1068))"></a>
        <a name="(idx._(gentag._1069))"></a>
        <a name="(idx._(gentag._1070))"></a>
        最后是非局部控制流。我们来考虑<span class="EoplExerciseRef"></span> 中的 <span class="stt">letcc</span>。<span
          class="stt">letcc</span>
        表达式 <span class="stt">letcc </span><span class="texMathInline">var</span><span class="stt"> in </span><span
          class="texMathInline">body</span> 将当前续文绑定到变量 <span class="texMathInline">var</span>。<span
          class="texMathInline">body</span> 为
        该绑定的作用域。续文的唯一操作是 <span class="stt">throw</span>。我们用语法 <span class="stt">throw </span><span
          class="texMathInline">Expression</span><span class="stt">
        </span><span class="stt">to </span><span class="texMathInline">Expression</span>，它需要求出两个子表达式的值。第二个表达式应返回一个续文，该续
        文作用于第一个表达式的值。<span class="stt">throw</span> 当前的续文则被忽略。
      </p>
      <p>我们首先按照本章的方式分析这些表达式。这些表达式一定是复杂的。<span class="stt">letcc</span> 的主体
        部分在尾端，因为它的值就是整个表达式的值。由于 <span class="stt">throw</span> 中的两个位置都需求值，
        且都不是 <span class="stt">throw</span> 的值（确实，<span class="stt">throw</span> 没有值，因为它不会返回到紧邻的续文），
        因此它们都在操作数位置。</p>
      <p>现在，我们可以写出转换这两个表达式的规则。</p>
      <blockquote class="SubFlow">
        <blockquote class="EoplEquationInset">
          <table cellspacing="0" cellpadding="0" class="SVerbatim">
            <tr>
              <td>
                <p><span class="stt">(cps-of-exp <<letcc </span><span class="texMathInline">var</span><span
                        class="stt"></span><span class="hspace"> </span><span class="stt">in </span><span
                        class="texMathInline">body</span><span class="stt">>> </span><span
                        class="texMathInline">K</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= let </span><span class="texMathInline">var</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt">= </span><span class="texMathInline">K</span><span
                    class="stt"></span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace">  </span><span class="stt">in (cps-of-exp </span><span
                    class="texMathInline">body</span><span class="stt"></span><span class="hspace"> </span><span
                    class="stt"></span><span class="texMathInline">var</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt"></span><span class="hspace"> </span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">(cps-of-exp <<throw </span><span class="texMathInline">simp_1</span><span
                        class="stt"></span><span class="hspace"> </span><span class="stt">to </span><span
                        class="texMathInline">simp_2</span><span class="stt">>> </span><span
                        class="texMathInline">K</span><span class="stt">)</span></p>
              </td>
            </tr>
            <tr>
              <td>
                <p><span class="stt">= (</span><span class="texMathInline">simp_2</span><span class="stt"></span><span
                    class="hspace"> </span><span class="stt"></span><span class="texMathInline">simp_1</span><span
                    class="stt">)</span></p>
              </td>
            </tr>
          </table>
        </blockquote>
        <p>我们仍用 <span class="stt">cps-of-exps</span> 处理 <span class="stt">throw</span> 可能含有的复杂参数。这里，<span
            class="texMathInline">K</span> 如期望
          的那样忽略。</p>
      </blockquote>
      <p>这个例子中，我们不需要给给 CPS-OUT 添加语法，因为我们操作的正是控制结构。
        <a name="(idx._(gentag._1071))"></a>
        <a name="(idx._(gentag._1072))"></a>
        <a name="(idx._(gentag._1073))"></a>
        <a name="(idx._(gentag._1074))"></a>
      </p>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..39)"></a><span class="texMathInline">\textnormal{[}{\star}\textnormal{]}</span><span
            class="hspace"> </span>在 CPS 翻译器中实现 <span class="stt">letcc</span> 和 <span class="stt">throw</span>。</p>
      </blockquote>
      <blockquote class="EoplExercise">
        <p><a name="(elem._ex6..40)"></a><span
            class="texMathInline">\textnormal{[}{\star}{\star}\textnormal{]}</span><span class="hspace"> </span>在 CPS
          翻译器中添加和实现<a href="cpi.html#%28part._s5..4%29" data-pltdoc="x">异常</a>中的 <span class="stt">try/catch</span> 和
          <span class="stt">throw</span>。CPS-OUT
          应该不需要添加任何东西，而 <span class="stt">cps-of-exp</span> 改取两个续文：一个成功续文，一个错误
          续文。
          <a name="(idx._(gentag._1075))"></a>
        </p>
      </blockquote>
      <div class="navsetbottom"><span class="navleft">
          <div class="nosearchform"></div>  <span class="tocsettoggle">  <a href="javascript:void(0);"
              title="show/hide table of contents" onclick="TocsetToggle();">contents</a></span>
        </span><span class="navright">  <a href="cpi.html" title="backward to " 5 传递续文的解释器"" data-pltdoc="x">←
            prev</a>  <a href="index.html" title="up to " 编程语言要素"" data-pltdoc="x">up</a>  <a href="types.html"
            title="forward to " 7 类型"" data-pltdoc="x">next →</a></span> </div>
    </div>
  </div>
  <div id="contextindicator"> </div>
</body>

</html>